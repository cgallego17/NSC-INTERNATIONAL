{% extends 'base.html' %}
{% load static %}

{% block title %}Reservar Hotel - NCS International{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-calendar-check me-2"></i>Nueva Reserva de Hotel
            </h1>
            <p class="text-muted">Completa la información para realizar tu reserva</p>
        </div>
        <a href="{% url 'locations:front_hotel_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver a Hoteles
        </a>
    </div>

    <form method="post" id="reservationForm" class="needs-validation" novalidate>
        {% csrf_token %}

        <div class="row">
            <!-- Formulario Principal -->
            <div class="col-lg-8">
                <!-- Selección de Hotel y Habitación -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-hotel me-2"></i>Hotel y Habitación</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="hotel" class="form-label">Hotel <span class="text-danger">*</span></label>
                                <select id="hotel" name="hotel" class="form-select" required>
                                    <option value="">Selecciona un Hotel</option>
                                    {% for hotel in hotels %}
                                        <option value="{{ hotel.id }}"
                                                {% if selected_hotel and selected_hotel.id == hotel.id %}selected{% endif %}>
                                            {{ hotel.hotel_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if form.hotel.errors %}
                                    <div class="text-danger">{{ form.hotel.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="room" class="form-label">Habitación <span class="text-danger">*</span></label>
                                <select id="room" name="room" class="form-select" required>
                                    <option value="">Primero selecciona un hotel</option>
                                    {% for room in rooms %}
                                        <option value="{{ room.id }}"
                                                data-price="{{ room.price_per_night }}"
                                                {% if form.room.value == room.id %}selected{% endif %}>
                                            Habitación #{{ room.room_number }} - {{ room.get_room_type_display }}
                                            ({{ room.capacity }} personas) - ${{ room.price_per_night }}/noche
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if form.room.errors %}
                                    <div class="text-danger">{{ form.room.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fechas y Huéspedes -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Fechas y Huéspedes</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="check_in" class="form-label">Check-in <span class="text-danger">*</span></label>
                                <input type="date" id="check_in" name="check_in" class="form-control"
                                       value="{{ form.check_in.value|default:'' }}" required>
                                {% if form.check_in.errors %}
                                    <div class="text-danger">{{ form.check_in.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="check_out" class="form-label">Check-out <span class="text-danger">*</span></label>
                                <input type="date" id="check_out" name="check_out" class="form-control"
                                       value="{{ form.check_out.value|default:'' }}" required>
                                {% if form.check_out.errors %}
                                    <div class="text-danger">{{ form.check_out.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="number_of_guests" class="form-label">Número de Huéspedes <span class="text-danger">*</span></label>
                                <input type="number" id="number_of_guests" name="number_of_guests" class="form-control"
                                       value="{{ form.number_of_guests.value|default:'1' }}" min="1" required>
                                {% if form.number_of_guests.errors %}
                                    <div class="text-danger">{{ form.number_of_guests.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información del Huésped -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user me-2"></i>Información del Huésped</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="guest_name" class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                                <input type="text" id="guest_name" name="guest_name" class="form-control"
                                       value="{{ form.guest_name.value|default:user.get_full_name|default:user.username }}" required>
                                {% if form.guest_name.errors %}
                                    <div class="text-danger">{{ form.guest_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="guest_email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" id="guest_email" name="guest_email" class="form-control"
                                       value="{{ form.guest_email.value|default:user.email }}" required>
                                {% if form.guest_email.errors %}
                                    <div class="text-danger">{{ form.guest_email.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="guest_phone" class="form-label">Teléfono <span class="text-danger">*</span></label>
                                <input type="text" id="guest_phone" name="guest_phone" class="form-control"
                                       value="{{ form.guest_phone.value|default:user.profile.phone|default:'' }}" required>
                                {% if form.guest_phone.errors %}
                                    <div class="text-danger">{{ form.guest_phone.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Servicios Adicionales -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-concierge-bell me-2"></i>Servicios Adicionales (Opcional)</h5>
                    </div>
                    <div class="card-body">
                        <div id="servicesContainer">
                            {% if services %}
                                {% for service in services %}
                                    <div class="service-item mb-3 p-3 border rounded">
                                        <div class="form-check">
                                            <input class="form-check-input service-checkbox" type="checkbox"
                                                   name="services" value="{{ service.id }}"
                                                   id="service_{{ service.id }}"
                                                   data-price="{{ service.price }}"
                                                   data-per-person="{% if service.is_per_person %}true{% else %}false{% endif %}"
                                                   data-per-night="{% if service.is_per_night %}true{% else %}false{% endif %}">
                                            <label class="form-check-label w-100" for="service_{{ service.id }}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ service.service_name }}</strong>
                                                        <br>
                                                        <small class="text-muted">{{ service.get_service_type_display }}</small>
                                                        {% if service.description %}
                                                            <br><small class="text-muted">{{ service.description|truncatewords:10 }}</small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-end">
                                                        <strong>${{ service.price|floatformat:2 }}</strong>
                                                        {% if service.is_per_person %}
                                                            <br><small class="text-muted">por persona</small>
                                                        {% endif %}
                                                        {% if service.is_per_night %}
                                                            <br><small class="text-muted">por noche</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="service-quantity mt-2" style="display: none;">
                                            <label class="form-label">Cantidad:</label>
                                            <input type="number" name="quantities" class="form-control form-control-sm quantity-input"
                                                   value="1" min="1" data-service-id="{{ service.id }}">
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No hay servicios disponibles para este hotel.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Notas -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Notas Adicionales</h5>
                    </div>
                    <div class="card-body">
                        <textarea id="notes" name="notes" class="form-control" rows="4"
                                  placeholder="Notas adicionales sobre tu reserva...">{{ form.notes.value|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Sidebar - Resumen y Total -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumen de Reserva</h5>
                    </div>
                    <div class="card-body">
                        <div id="reservationSummary">
                            <div class="mb-3">
                                <strong>Habitación:</strong>
                                <div id="roomSummary" class="text-muted">Selecciona una habitación</div>
                            </div>
                            <div class="mb-3">
                                <strong>Noches:</strong>
                                <div id="nightsSummary" class="text-muted">-</div>
                            </div>
                            <div class="mb-3">
                                <strong>Huéspedes:</strong>
                                <div id="guestsSummary" class="text-muted">-</div>
                            </div>
                            <hr>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Habitación:</span>
                                    <span id="roomTotal">$0.00</span>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Servicios:</span>
                                    <span id="servicesTotal">$0.00</span>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>TOTAL:</strong>
                                <strong class="text-primary" id="totalAmount" style="font-size: 1.5rem;">$0.00</strong>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 btn-lg">
                                <i class="fas fa-credit-card me-2"></i>Continuar al Pago
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hotelSelect = document.getElementById('hotel');
    const roomSelect = document.getElementById('room');
    const checkInInput = document.getElementById('check_in');
    const checkOutInput = document.getElementById('check_out');
    const guestsInput = document.getElementById('number_of_guests');
    const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
    const quantityInputs = document.querySelectorAll('.quantity-input');

    let selectedRoom = null;
    let selectedServices = [];

    // Cargar habitaciones cuando se selecciona un hotel
    hotelSelect.addEventListener('change', function() {
        const hotelId = this.value;
        if (hotelId) {
            loadRooms(hotelId);
            loadServices(hotelId);
        } else {
            roomSelect.innerHTML = '<option value="">Primero selecciona un hotel</option>';
            document.getElementById('servicesContainer').innerHTML = '<p class="text-muted">Selecciona un hotel para ver servicios disponibles.</p>';
        }
        updateTotal();
    });

    // Actualizar total cuando cambia la habitación
    roomSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            selectedRoom = {
                id: selectedOption.value,
                price: parseFloat(selectedOption.dataset.price || 0),
                text: selectedOption.text
            };
        } else {
            selectedRoom = null;
        }
        updateTotal();
    });

    // Actualizar total cuando cambian las fechas
    checkInInput.addEventListener('change', updateTotal);
    checkOutInput.addEventListener('change', updateTotal);
    guestsInput.addEventListener('input', updateTotal);

    // Manejar selección de servicios
    serviceCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const quantityDiv = this.closest('.service-item').querySelector('.service-quantity');
            if (this.checked) {
                quantityDiv.style.display = 'block';
            } else {
                quantityDiv.style.display = 'none';
                const quantityInput = quantityDiv.querySelector('.quantity-input');
                if (quantityInput) quantityInput.value = 1;
            }
            updateTotal();
        });
    });

    // Actualizar total cuando cambia la cantidad de servicios
    quantityInputs.forEach(input => {
        input.addEventListener('input', updateTotal);
    });

    // Cargar habitaciones desde AJAX
    function loadRooms(hotelId) {
        const checkIn = checkInInput.value;
        const checkOut = checkOutInput.value;
        let url = `/locations/ajax/hotels/${hotelId}/rooms/`;
        if (checkIn && checkOut) {
            url += `?check_in=${checkIn}&check_out=${checkOut}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                roomSelect.innerHTML = '<option value="">Selecciona una habitación</option>';
                data.rooms.forEach(room => {
                    if (room.is_available) {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.dataset.price = room.price_per_night;
                        option.textContent = `Habitación #${room.room_number} - ${room.room_type} (${room.capacity} personas) - $${room.price_per_night}/noche`;
                        roomSelect.appendChild(option);
                    }
                });
                updateTotal();
            })
            .catch(error => {
                console.error('Error cargando habitaciones:', error);
            });
    }

    // Cargar servicios desde AJAX
    function loadServices(hotelId) {
        fetch(`/locations/ajax/hotels/${hotelId}/services/`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('servicesContainer');
                if (data.services && data.services.length > 0) {
                    container.innerHTML = '';
                    data.services.forEach(service => {
                        const serviceDiv = document.createElement('div');
                        serviceDiv.className = 'service-item mb-3 p-3 border rounded';
                        serviceDiv.innerHTML = `
                            <div class="form-check">
                                <input class="form-check-input service-checkbox" type="checkbox"
                                       name="services" value="${service.id}"
                                       id="service_${service.id}"
                                       data-price="${service.price}"
                                       data-per-person="${service.is_per_person}"
                                       data-per-night="${service.is_per_night}">
                                <label class="form-check-label w-100" for="service_${service.id}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${service.service_name}</strong>
                                            <br>
                                            <small class="text-muted">${service.service_type}</small>
                                            ${service.description ? `<br><small class="text-muted">${service.description}</small>` : ''}
                                        </div>
                                        <div class="text-end">
                                            <strong>$${parseFloat(service.price).toFixed(2)}</strong>
                                            ${service.is_per_person ? '<br><small class="text-muted">por persona</small>' : ''}
                                            ${service.is_per_night ? '<br><small class="text-muted">por noche</small>' : ''}
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="service-quantity mt-2" style="display: none;">
                                <label class="form-label">Cantidad:</label>
                                <input type="number" name="quantities" class="form-control form-control-sm quantity-input"
                                       value="1" min="1" data-service-id="${service.id}">
                            </div>
                        `;
                        container.appendChild(serviceDiv);

                        // Agregar event listeners
                        const checkbox = serviceDiv.querySelector('.service-checkbox');
                        const quantityInput = serviceDiv.querySelector('.quantity-input');

                        checkbox.addEventListener('change', function() {
                            const quantityDiv = this.closest('.service-item').querySelector('.service-quantity');
                            if (this.checked) {
                                quantityDiv.style.display = 'block';
                            } else {
                                quantityDiv.style.display = 'none';
                                quantityInput.value = 1;
                            }
                            updateTotal();
                        });

                        quantityInput.addEventListener('input', updateTotal);
                    });
                } else {
                    container.innerHTML = '<p class="text-muted">No hay servicios disponibles para este hotel.</p>';
                }
                updateTotal();
            })
            .catch(error => {
                console.error('Error cargando servicios:', error);
            });
    }

    // Calcular y actualizar el total
    function updateTotal() {
        let roomTotal = 0;
        let servicesTotal = 0;
        let nights = 0;
        const guests = parseInt(guestsInput.value) || 1;

        // Calcular noches
        if (checkInInput.value && checkOutInput.value) {
            const checkIn = new Date(checkInInput.value);
            const checkOut = new Date(checkOutInput.value);
            if (checkOut > checkIn) {
                nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
            }
        }

        // Calcular total de habitación
        if (selectedRoom && nights > 0) {
            roomTotal = selectedRoom.price * nights;
        }

        // Calcular total de servicios
        const checkedServices = document.querySelectorAll('.service-checkbox:checked');
        checkedServices.forEach(checkbox => {
            const serviceId = checkbox.value;
            const quantityInput = checkbox.closest('.service-item').querySelector('.quantity-input');
            const quantity = parseInt(quantityInput ? quantityInput.value : 1) || 1;
            const price = parseFloat(checkbox.dataset.price || 0);
            const isPerPerson = checkbox.dataset.perPerson === 'true';
            const isPerNight = checkbox.dataset.perNight === 'true';

            let servicePrice = price * quantity;
            if (isPerPerson) {
                servicePrice = servicePrice * guests;
            }
            if (isPerNight && nights > 0) {
                servicePrice = servicePrice * nights;
            }

            servicesTotal += servicePrice;
        });

        // Actualizar resumen
        document.getElementById('roomSummary').textContent = selectedRoom ? selectedRoom.text.split(' - ')[0] : 'Selecciona una habitación';
        document.getElementById('nightsSummary').textContent = nights > 0 ? `${nights} noche${nights !== 1 ? 's' : ''}` : '-';
        document.getElementById('guestsSummary').textContent = `${guests} persona${guests !== 1 ? 's' : ''}`;
        document.getElementById('roomTotal').textContent = `$${roomTotal.toFixed(2)}`;
        document.getElementById('servicesTotal').textContent = `$${servicesTotal.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `$${(roomTotal + servicesTotal).toFixed(2)}`;
    }

    // Inicializar
    if (hotelSelect.value) {
        hotelSelect.dispatchEvent(new Event('change'));
    }
    updateTotal();
});
</script>
{% endblock %}










