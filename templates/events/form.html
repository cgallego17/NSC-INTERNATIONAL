{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Editar Evento{% else %}Crear Evento{% endif %} - NSC International
{% endblock %}

{% block breadcrumb %}
    <span>Eventos</span> / <span>{% if object %}Editar{% else %}Crear{% endif %}</span>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card event-form-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="fas fa-calendar-plus me-2"></i>
                                {% if object %}Editar Evento{% else %}Crear Nuevo Evento{% endif %}
                            </h4>
                            <p class="text-muted mb-0 mt-1">
                                {% if object %}Modifica la información del evento{% else %}Completa la información para crear un nuevo evento{% endif %}
                            </p>
                        </div>
                        <a href="{% url 'events:list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver a Eventos
                        </a>
                    </div>
    </div>

                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <!-- INFORMACIÓN BÁSICA -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-info-circle me-2"></i>Información Básica
                            </h5>
                        
                            <!-- Season - Campo Completo -->
                            <div class="form-group mb-3">
                                <label for="{{ form.season.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>{{ form.season.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.season }}
                                {% if form.season.errors %}
                                    <div class="text-danger">{{ form.title.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Event Name - Campo Completo -->
                            <div class="form-group mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    <i class="fas fa-tag me-1"></i>{{ form.title.label }} <span class="text-danger">*</span>
                                </label>
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                    <div class="text-danger">{{ form.title.errors.0 }}</div>
                                    {% endif %}
                                </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.short_name.id_for_label }}" class="form-label">
                                            <i class="fas fa-tag me-1"></i>{{ form.short_name.label }}
                                        </label>
                                        {{ form.short_name }}
                                        {% if form.short_name.help_text %}
                                            <div class="form-text">
                                                <i class="fas fa-question-circle me-1"></i>{{ form.short_name.help_text }}
                            </div>
                                        {% endif %}
                                        {% if form.short_name.errors %}
                                            <div class="text-danger">{{ form.short_name.errors.0 }}</div>
                                    {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="tags-input" class="form-label">
                                            <i class="fas fa-hashtag me-1"></i>{{ form.tags.label }}
                                        </label>
                                        <div class="tags-container">
                                            <div class="tags-input-wrapper">
                                                <input type="text" id="tags-input" class="form-control tags-input" placeholder="Escribe un tag y presiona Enter, coma o espacio">
                                                <div class="tags-list" id="tags-list"></div>
                                            </div>
                                            {{ form.tags.as_hidden }}
                            </div>
                                        {% if form.tags.errors %}
                                            <div class="text-danger">{{ form.tags.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                            <div class="form-group mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    <i class="fas fa-align-left me-1"></i>{{ form.description.label }} <span class="text-danger">*</span>
                                </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                    <div class="text-danger">{{ form.description.errors.0 }}</div>
                            {% endif %}
                        </div>
                        </div>

                        <!-- UBICACIÓN -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-map-marker-alt me-2"></i>Ubicación
                            </h5>

                        <div class="row">
                            <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.country.id_for_label }}" class="form-label">
                                            <i class="fas fa-globe me-1"></i>{{ form.country.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.country }}
                                        {% if form.country.errors %}
                                            <div class="text-danger">{{ form.country.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.state.id_for_label }}" class="form-label">
                                            <i class="fas fa-map me-1"></i>{{ form.state.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.state }}
                                        {% if form.state.errors %}
                                            <div class="text-danger">{{ form.state.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                            <div class="form-group mb-3">
                                <label for="{{ form.city.id_for_label }}" class="form-label">
                                    <i class="fas fa-city me-1"></i>{{ form.city.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.city }}
                                {% if form.city.errors %}
                                    <div class="text-danger">{{ form.city.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- SITIOS -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-building me-2"></i>Sitios del Evento
                            </h5>
                            
                            <!-- Primary Site -->
                            <div class="form-group mb-4">
                                <label for="primary-site-select" class="form-label">
                                    <i class="fas fa-star me-1"></i>Primary Site <span class="text-danger">*</span>
                                </label>
                                <select id="primary-site-select" name="primary_site" class="form-select" required>
                                    <option value="">Select Primary Site</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                                {% if form.primary_site.errors %}
                                    <div class="text-danger">{{ form.primary_site.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>Sitio principal donde se realizará el evento
                                </div>
                            </div>
                            
                            <!-- Additional Sites -->
                            <div class="form-group mb-3">
                                <label class="form-label">
                                    <i class="fas fa-plus-circle me-1"></i>Additional Site(s)
                                </label>
                                
                                <div class="modern-sites-container">
                                    <!-- Search and Filter Controls -->
                                    <div class="sites-controls mb-3">
                                        <div class="row align-items-center">
                            <div class="col-md-6">
                                                <div class="search-box">
                                                    <i class="fas fa-search search-icon"></i>
                                                    <input type="text" id="sites-search" class="form-control" placeholder="Buscar por nombre, ciudad, estado o abreviación...">
                                                    <button type="button" class="btn btn-sm btn-outline-secondary search-clear" id="clear-search" title="Limpiar búsqueda">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex gap-2 align-items-center">
                                                    <div class="form-check">
                                                        <input type="checkbox" id="show-all-sites" class="form-check-input">
                                                        <label for="show-all-sites" class="form-check-label">
                                                            Mostrar todos los sitios
                                                        </label>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="clear-selection">
                                                        <i class="fas fa-times me-1"></i>Limpiar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Selected Sites Chips -->
                                    <div class="selected-sites-chips mb-3">
                                        <h6 class="chips-title">
                                            <i class="fas fa-check-circle me-1"></i>Sitios Seleccionados
                                            <span class="badge bg-primary ms-2" id="selected-count">0</span>
                                        </h6>
                                        <div class="chips-container" id="selected-sites-chips">
                                            <div class="no-sites-message">
                                                <i class="fas fa-info-circle me-2"></i>No hay sitios seleccionados
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Available Sites Grid -->
                                    <div class="available-sites-grid">
                                        <h6 class="grid-title">
                                            <i class="fas fa-building me-1"></i>Sitios Disponibles
                                        </h6>
                                        <div class="sites-grid" id="available-sites-grid">
                                            <div class="loading-sites">
                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                Cargando sitios...
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden input to store selected sites -->
                                    <div class="selected-sites-input">
                                        {% for choice in form.additional_sites %}
                                            <input type="checkbox" name="additional_sites" value="{{ choice.choice_value }}" 
                                                   id="{{ choice.id_for_label }}" class="hidden-site-checkbox" 
                                                   {% if choice.choice_value in form.additional_sites.value %}checked{% endif %}>
                                        {% endfor %}
                                    </div>
                                    
                                    {% if form.additional_sites.errors %}
                                        <div class="text-danger mt-2">{{ form.additional_sites.errors.0 }}</div>
                                    {% endif %}
                                    
                                    <div class="form-text mt-3">
                                        <i class="fas fa-info-circle me-1"></i>Haz clic en los sitios para seleccionarlos. Puedes buscar y filtrar por estado.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FECHAS Y HORARIOS -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-calendar me-2"></i>Fechas y Horarios
                            </h5>

                        <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.start_date.id_for_label }}" class="form-label">
                                            <i class="fas fa-calendar-day me-1"></i>{{ form.start_date.label }} <span class="text-danger">*</span>
                                        </label>
                                    {{ form.start_date }}
                                    {% if form.start_date.errors %}
                                            <div class="text-danger">{{ form.start_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                            <i class="fas fa-calendar-day me-1"></i>{{ form.end_date.label }} <span class="text-danger">*</span>
                                        </label>
                                    {{ form.end_date }}
                                    {% if form.end_date.errors %}
                                            <div class="text-danger">{{ form.end_date.errors.0 }}</div>
                                    {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.entry_deadline.id_for_label }}" class="form-label">
                                            <i class="fas fa-clock me-1"></i>{{ form.entry_deadline.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.entry_deadline }}
                                        {% if form.entry_deadline.errors %}
                                            <div class="text-danger">{{ form.entry_deadline.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CONFIGURACIÓN DEL EVENTO -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-cog me-2"></i>Configuración del Evento
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.rule.id_for_label }}" class="form-label">
                                            <i class="fas fa-ruler me-1"></i>{{ form.rule.label }} <span class="text-danger">*</span>
                                </label>
                                        {{ form.rule }}
                                        {% if form.rule.errors %}
                                            <div class="text-danger">{{ form.rule.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.stature.id_for_label }}" class="form-label">
                                            <i class="fas fa-trophy me-1"></i>{{ form.stature.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.stature }}
                                        {% if form.stature.errors %}
                                            <div class="text-danger">{{ form.stature.errors.0 }}</div>
                                    {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TARIFAS Y PAGOS -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-dollar-sign me-2"></i>Tarifas y Pagos
                            </h5>

                        <div class="row">
                            <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.default_entry_fee.id_for_label }}" class="form-label">
                                            <i class="fas fa-dollar-sign me-1"></i>{{ form.default_entry_fee.label }}
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.default_entry_fee }}
                                        </div>
                                        {% if form.default_entry_fee.errors %}
                                            <div class="text-danger">{{ form.default_entry_fee.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.payment_deadline.id_for_label }}" class="form-label">
                                            <i class="fas fa-calendar-check me-1"></i>{{ form.payment_deadline.label }}
                                        </label>
                                        {{ form.payment_deadline }}
                                        {% if form.payment_deadline.errors %}
                                            <div class="text-danger">{{ form.payment_deadline.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <div class="form-check">
                                            {{ form.accept_deposits }}
                                            <label class="form-check-label" for="{{ form.accept_deposits.id_for_label }}">
                                                <i class="fas fa-piggy-bank me-1"></i>{{ form.accept_deposits.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                            <div class="form-check">
                                            {{ form.allow_online_pay }}
                                            <label class="form-check-label" for="{{ form.allow_online_pay.id_for_label }}">
                                                <i class="fas fa-credit-card me-1"></i>{{ form.allow_online_pay.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Campo condicional para monto de depósito -->
                            <div class="form-group mb-3 conditional-field" id="deposit-amount-field" style="display: none;">
                                <label for="{{ form.default_deposit_amount.id_for_label }}" class="form-label">
                                    <i class="fas fa-coins me-1"></i>{{ form.default_deposit_amount.label }}
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.default_deposit_amount }}
                                </div>
                                {% if form.default_deposit_amount.errors %}
                                    <div class="text-danger">{{ form.default_deposit_amount.errors.0 }}</div>
                            {% endif %}
                            </div>
                        </div>

                        <!-- TARIFAS DE ENTRADA -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-ticket-alt me-2"></i>Tarifas de Entrada
                            </h5>
                            
                            <div class="form-group mb-3">
                                <div class="form-check">
                                    {{ form.has_gate_fee }}
                                    <label class="form-check-label" for="{{ form.has_gate_fee.id_for_label }}">
                                        <i class="fas fa-ticket-alt me-1"></i>{{ form.has_gate_fee.label }}
                                    </label>
                                </div>
                            </div>

                            <!-- Campos condicionales para tarifas de entrada -->
                            <div class="row conditional-field" id="gate-fee-fields" style="display: none;">
                            <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.gate_fee_type.id_for_label }}" class="form-label">
                                            <i class="fas fa-list me-1"></i>{{ form.gate_fee_type.label }}
                                        </label>
                                        {{ form.gate_fee_type }}
                                        {% if form.gate_fee_type.errors %}
                                            <div class="text-danger">{{ form.gate_fee_type.errors.0 }}</div>
                            {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.gate_fee_amount.id_for_label }}" class="form-label">
                                            <i class="fas fa-dollar-sign me-1"></i>{{ form.gate_fee_amount.label }}
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.gate_fee_amount }}
                                        </div>
                                        {% if form.gate_fee_amount.errors %}
                                            <div class="text-danger">{{ form.gate_fee_amount.errors.0 }}</div>
                                    {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CONFIGURACIÓN DE PARTICIPACIÓN -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-users me-2"></i>Configuración de Participación
                            </h5>

                        <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                    <div class="form-check">
                                            {{ form.allow_withdrawals }}
                                            <label class="form-check-label" for="{{ form.allow_withdrawals.id_for_label }}">
                                                <i class="fas fa-undo me-1"></i>{{ form.allow_withdrawals.label }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                    <div class="form-check">
                                            {{ form.freeze_rosters }}
                                            <label class="form-check-label" for="{{ form.freeze_rosters.id_for_label }}">
                                                <i class="fas fa-lock me-1"></i>{{ form.freeze_rosters.label }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            </div>

                            <!-- Campos condicionales -->
                            <div class="form-group mb-3 conditional-field" id="withdraw-deadline-field" style="display: none;">
                                <label for="{{ form.withdraw_deadline.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-times me-1"></i>{{ form.withdraw_deadline.label }}
                                </label>
                                {{ form.withdraw_deadline }}
                                {% if form.withdraw_deadline.errors %}
                                    <div class="text-danger">{{ form.withdraw_deadline.errors.0 }}</div>
                            {% endif %}
                        </div>

                            <div class="form-group mb-3 conditional-field" id="roster-freeze-field" style="display: none;">
                                <label for="{{ form.roster_freeze_date.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-lock me-1"></i>{{ form.roster_freeze_date.label }}
                                </label>
                                {{ form.roster_freeze_date }}
                                {% if form.roster_freeze_date.errors %}
                                    <div class="text-danger">{{ form.roster_freeze_date.errors.0 }}</div>
                            {% endif %}
                            </div>
                        </div>

                        <!-- RECORDATORIOS Y SOLICITUDES -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-bell me-2"></i>Recordatorios y Solicitudes
                            </h5>

                        <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <div class="form-check">
                                            {{ form.send_payment_reminders }}
                                            <label class="form-check-label" for="{{ form.send_payment_reminders.id_for_label }}">
                                                <i class="fas fa-bell me-1"></i>{{ form.send_payment_reminders.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                    <div class="form-check">
                                            {{ form.accept_schedule_requests }}
                                            <label class="form-check-label" for="{{ form.accept_schedule_requests.id_for_label }}">
                                                <i class="fas fa-calendar-plus me-1"></i>{{ form.accept_schedule_requests.label }}
                                        </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Campos condicionales -->
                            <div class="form-group mb-3 conditional-field" id="payment-reminder-field" style="display: none;">
                                <label for="{{ form.payment_reminder_date.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-bell me-1"></i>{{ form.payment_reminder_date.label }}
                                </label>
                                {{ form.payment_reminder_date }}
                                {% if form.payment_reminder_date.errors %}
                                    <div class="text-danger">{{ form.payment_reminder_date.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="form-group mb-3 conditional-field" id="schedule-request-field" style="display: none;">
                                <label for="{{ form.schedule_request_deadline.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-check me-1"></i>{{ form.schedule_request_deadline.label }}
                                </label>
                                {{ form.schedule_request_deadline }}
                                {% if form.schedule_request_deadline.errors %}
                                    <div class="text-danger">{{ form.schedule_request_deadline.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- INFORMACIÓN ADICIONAL -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-info me-2"></i>Información Adicional
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.max_attendees.id_for_label }}" class="form-label">
                                            <i class="fas fa-users me-1"></i>Límite de Asistentes
                                        </label>
                                    {{ form.max_attendees }}
                                    {% if form.max_attendees.errors %}
                                            <div class="text-danger">{{ form.max_attendees.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                    <div class="form-check">
                                        {{ form.requires_registration }}
                                        <label class="form-check-label" for="{{ form.requires_registration.id_for_label }}">
                                                <i class="fas fa-user-plus me-1"></i>Requiere Registro
                                        </label>
                                        </div>
                                </div>
                            </div>
                        </div>

                            <div class="form-group mb-3">
                                <label for="{{ form.external_link.id_for_label }}" class="form-label">
                                    <i class="fas fa-link me-1"></i>Enlace Externo
                                </label>
                                {{ form.external_link }}
                                {% if form.external_link.errors %}
                                    <div class="text-danger">{{ form.external_link.errors.0 }}</div>
                                    {% endif %}
                                </div>

                            <div class="form-group mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    <i class="fas fa-sticky-note me-1"></i>Notas Internas
                                </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                    <div class="text-danger">{{ form.notes.errors.0 }}</div>
                            {% endif %}
                            </div>
                        </div>

                        <!-- Botones de envío -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% url 'events:list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-corporate">
                                <i class="fas fa-save me-2"></i>
                                {% if object %}Actualizar Evento{% else %}Crear Evento{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
                </div>
                    </div>
{% endblock %}

{% block extra_css %}
<style>
/* ===== FORMULARIO DE EVENTOS SIN PESTAÑAS ===== */
.event-form-card {
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* ===== SISTEMA MODERNO DE SELECCIÓN DE SITIOS ===== */
.modern-sites-container {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.modern-sites-container:hover {
    border-color: #4f46e5;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
}

/* Search Box */
.search-box {
    position: relative;
    display: flex;
    align-items: center;
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    z-index: 2;
}

.search-box .form-control {
    padding-left: 2.5rem;
    padding-right: 3rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    flex: 1;
}

.search-box .form-control:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
}

.search-clear {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    padding: 0.25rem 0.5rem;
    border: none;
    background: transparent;
    color: #6b7280;
    z-index: 2;
    opacity: 0;
    transition: all 0.2s ease;
}

.search-box:hover .search-clear,
.search-box .form-control:focus + .search-clear,
.search-box .form-control:not(:placeholder-shown) + .search-clear {
    opacity: 1;
}

.search-clear:hover {
    color: #374151;
    background: #f3f4f6;
    border-radius: 0.25rem;
}

/* Search highlighting */
.search-highlight {
    background: #fef3c7;
    color: #92400e;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-weight: 600;
}

[data-theme="dark"] .search-highlight {
    background: #451a03;
    color: #fbbf24;
}

/* Selected Sites Chips */
.selected-sites-chips {
    background: #f8fafc;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    min-height: 80px;
}

.chips-title {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
}

.chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    min-height: 40px;
    align-items: flex-start;
}

.no-sites-message {
    color: #6b7280;
    font-style: italic;
    display: flex;
    align-items: center;
    width: 100%;
    justify-content: center;
    padding: 1rem;
}

.site-chip {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 2rem;
    font-size: 0.875rem;
    font-weight: 500;
    gap: 0.75rem;
    animation: chipSlideIn 0.3s ease-out;
    box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
    transition: all 0.2s ease;
    max-width: 100%;
}

.site-chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
}

.chip-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
    min-width: 0;
}

.chip-name {
    font-weight: 600;
    font-size: 0.875rem;
    line-height: 1.2;
}

.chip-location {
    font-weight: 400;
    font-size: 0.75rem;
    opacity: 0.9;
    line-height: 1.2;
    font-style: italic;
}

.site-chip .chip-remove {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.25rem;
    margin: 0;
    font-size: 0.75rem;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.site-chip .chip-remove:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

@keyframes chipSlideIn {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Available Sites Grid */
.available-sites-grid {
    margin-top: 1rem;
}

.grid-title {
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
}

.sites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    background: #fafbfc;
}

.site-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.site-card:hover {
    border-color: #4f46e5;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15);
}

.site-card.selected {
    border-color: #10b981;
    background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
}

.site-card.selected::before {
    content: '✓';
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: #10b981;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: bold;
}

.site-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.site-card-name {
    font-weight: 600;
    font-size: 1rem;
    color: #374151;
    margin: 0;
}

.site-card-abbreviation {
    background: #f3f4f6;
    color: #6b7280;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.site-card-location {
    color: #6b7280;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.site-card-location i {
    color: #9ca3af;
}

.loading-sites {
    padding: 3rem;
    text-align: center;
    color: #6b7280;
    font-style: italic;
    grid-column: 1 / -1;
}

/* Hidden inputs */
.selected-sites-input {
    display: none;
}

.hidden-site-checkbox {
    display: none;
}

/* Tema oscuro */
[data-theme="dark"] .modern-sites-container {
    background: #374151;
    border-color: #4b5563;
}

[data-theme="dark"] .selected-sites-chips {
    background: #4b5563;
    border-color: #6b7280;
}

[data-theme="dark"] .chips-title,
[data-theme="dark"] .grid-title {
    color: #f9fafb;
}

[data-theme="dark"] .no-sites-message {
    color: #9ca3af;
}

[data-theme="dark"] .sites-grid {
    background: #4b5563;
    border-color: #6b7280;
}

[data-theme="dark"] .site-card {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

[data-theme="dark"] .site-card:hover {
    border-color: #6b7280;
}

[data-theme="dark"] .site-card-name {
    color: #f9fafb;
}

[data-theme="dark"] .site-card-abbreviation {
    background: #6b7280;
    color: #d1d5db;
}

[data-theme="dark"] .site-card-location {
    color: #d1d5db;
}

[data-theme="dark"] .loading-sites {
    color: #9ca3af;
}

/* Responsive */
@media (max-width: 768px) {
    .sites-grid {
        grid-template-columns: 1fr;
    }
    
    .sites-controls .row {
        flex-direction: column;
        gap: 1rem;
    }
    
    .chips-container {
        justify-content: center;
    }
}

/* Primary Site Select Styling */
#primary-site-select {
    font-size: 0.875rem;
}

#primary-site-select option {
    padding: 0.5rem;
    font-size: 0.875rem;
}

/* Make sure the select shows the full text */
#primary-site-select option[value=""] {
    color: #6b7280;
    font-style: italic;
}

[data-theme="dark"] #primary-site-select option[value=""] {
    color: #9ca3af;
}

/* Tema oscuro */
[data-theme="dark"] .list-title {
    background-color: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

[data-theme="dark"] .sites-list {
    background-color: #374151;
    border-color: #4b5563;
}

[data-theme="dark"] .site-item {
    border-bottom-color: #4b5563;
}

[data-theme="dark"] .site-item:hover {
    background-color: #4b5563;
}

[data-theme="dark"] .site-item.selected {
    background-color: #1e3a8a;
    border-color: #3b82f6;
}

[data-theme="dark"] .site-name {
    color: #f9fafb;
}

[data-theme="dark"] .site-location {
    color: #d1d5db;
}

/* Responsive */
@media (max-width: 768px) {
    .dual-lists {
        flex-direction: column;
    }
    
    .list-buttons {
        flex-direction: row;
        justify-content: center;
        order: 2;
    }
    
    .available-sites,
    .selected-sites {
        min-width: 100%;
    }
}

.event-form-card .card-header {
    background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
    color: white;
    border-radius: 0.75rem 0.75rem 0 0;
    border: none;
}

.event-form-card .card-header h4 {
    color: white;
}

.event-form-card .card-header .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

/* Soporte para tema oscuro del header */
[data-theme="dark"] .event-form-card .card-header {
    background: linear-gradient(180deg, #0f1419 0%, #1a1a1a 100%);
}

/* Botón Volver a Eventos - Tema oscuro */
[data-theme="dark"] .btn-outline-secondary {
    border: 2px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.8);
    background-color: rgba(255, 255, 255, 0.05);
}

[data-theme="dark"] .btn-outline-secondary:hover {
    background-color: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.4);
    color: white;
}

/* Secciones del formulario */
.form-section {
    margin-bottom: 2.5rem;
    padding: 1.5rem;
    background: #f8fafc;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb;
}

.section-title {
    color: #374151;
    font-weight: 600;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
}

.section-title i {
    color: #4f46e5;
}

/* Campos del formulario */
.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.form-label i {
    color: #6b7280;
    margin-right: 0.5rem;
}

.form-control, .form-select {
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
}

.form-check-input:checked {
    background-color: #4f46e5;
    border-color: #4f46e5;
}

.form-check-label {
    font-weight: 500;
    color: #374151;
    display: flex;
    align-items: center;
}

.form-check-label i {
    color: #6b7280;
    margin-right: 0.5rem;
}

/* Input groups */
.input-group-text {
    background-color: #f9fafb;
    border: 2px solid #e5e7eb;
    color: #6b7280;
    font-weight: 600;
}

/* Sistema de Tags */
.tags-container {
    position: relative;
}

.tags-input-wrapper {
    position: relative;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    min-height: 38px;
    background: white;
    transition: all 0.3s ease;
}

.tags-input-wrapper:focus-within {
    border-color: #4f46e5;
    box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
}

.tags-input {
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    padding: 0;
    font-size: 0.95rem;
    width: 100%;
    background: transparent;
    height: auto;
}

.tags-input::placeholder {
    color: #9ca3af;
    font-style: italic;
}

.tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
    min-height: 0;
}

.tag-item {
    display: inline-flex;
    align-items: center;
    background: #4f46e5;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    gap: 0.5rem;
    animation: tagSlideIn 0.2s ease-out;
}

.tag-item .tag-remove {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    margin: 0;
    font-size: 0.875rem;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
}

.tag-item .tag-remove:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

@keyframes tagSlideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Botones */
.btn-corporate {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.75rem 2rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-corporate:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    color: white;
}

.btn-outline-secondary {
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.9);
    background-color: rgba(255, 255, 255, 0.1);
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-outline-secondary:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Campos condicionales */
.conditional-field {
    transition: all 0.3s ease;
    overflow: hidden;
}

.conditional-field[style*="display: none"] {
    max-height: 0;
    margin: 0;
    padding: 0;
    opacity: 0;
}

.conditional-field[style*="display: block"] {
    max-height: 200px;
    opacity: 1;
}

/* Responsive */
@media (max-width: 768px) {
    .form-section {
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .event-form-card .card-header {
        padding: 1rem;
    }
    
    .event-form-card .card-header h4 {
        font-size: 1.1rem;
    }
    
    .section-title {
        font-size: 1.1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== AUTO-RESIZE TEXTAREAS =====
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });

    // ===== SISTEMA DE TAGS =====
    const tagsInput = document.getElementById('tags-input');
    const tagsList = document.getElementById('tags-list');
    const hiddenTagsInput = document.querySelector('input[name="tags"]');
    let tags = [];

    // Cargar tags existentes si estamos editando
    if (hiddenTagsInput && hiddenTagsInput.value) {
        const existingTags = hiddenTagsInput.value.split(',').filter(tag => tag.trim() !== '');
        existingTags.forEach(tag => {
            addTag(tag.trim());
        });
    }

    function addTag(tagText) {
        if (tagText.trim() === '' || tags.includes(tagText.trim())) {
            return;
        }

        const tag = tagText.trim();
        tags.push(tag);

        const tagElement = document.createElement('div');
        tagElement.className = 'tag-item';
        tagElement.innerHTML = `
            <span>${tag}</span>
            <button type="button" class="tag-remove" onclick="removeTag('${tag}')">×</button>
        `;

        tagsList.appendChild(tagElement);
        updateHiddenInput();
        tagsInput.value = '';
    }

    function removeTag(tagToRemove) {
        tags = tags.filter(tag => tag !== tagToRemove);
        
        const tagElements = tagsList.querySelectorAll('.tag-item');
        tagElements.forEach(element => {
            if (element.querySelector('span').textContent === tagToRemove) {
                element.remove();
            }
        });
        
        updateHiddenInput();
    }

    function updateHiddenInput() {
        if (hiddenTagsInput) {
            hiddenTagsInput.value = tags.join(',');
        }
    }

    // Event listeners para el input de tags
    if (tagsInput) {
        tagsInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',' || e.key === ' ') {
                e.preventDefault();
                addTag(this.value);
            }
        });

        tagsInput.addEventListener('blur', function() {
            if (this.value.trim() !== '') {
                addTag(this.value);
            }
        });
    }

    // Hacer removeTag disponible globalmente
    window.removeTag = removeTag;

    // ===== UBICACIÓN DETALLADA =====
    
    // Elementos de ubicación
    const countrySelectEl = document.querySelector('select[name="country"]');
    const stateSelectEl = document.querySelector('select[name="state"]');
    const citySelectEl = document.querySelector('select[name="city"]');
    const seasonSelectEl = document.querySelector('select[name="season"]');
    
    console.log('Elementos encontrados:');
    console.log('seasonSelectEl:', seasonSelectEl);
    console.log('countrySelectEl:', countrySelectEl);
    console.log('stateSelectEl:', stateSelectEl);
    console.log('citySelectEl:', citySelectEl);
    
    // Configurar estado inicial de los selects
    if (stateSelectEl) {
        stateSelectEl.disabled = true;
        stateSelectEl.innerHTML = '<option value="">Primero selecciona un país</option>';
    }
    
    if (citySelectEl) {
        citySelectEl.disabled = true;
        citySelectEl.innerHTML = '<option value="">Primero selecciona un estado</option>';
    }
    
    // Cargar temporadas
    async function loadSeasons() {
        try {
            console.log('Cargando temporadas...');
            const response = await fetch('/locations/seasons/api/');
            console.log('Response status:', response.status);
            const seasons = await response.json();
            console.log('Temporadas recibidas:', seasons);
            
            if (seasonSelectEl) {
                seasonSelectEl.innerHTML = '<option value="">Selecciona temporada</option>';
                seasons.forEach(season => {
                    const option = document.createElement('option');
                    option.value = season.id;
                    option.textContent = season.name;
                    seasonSelectEl.appendChild(option);
                });
                console.log('Temporadas cargadas en el select');
            } else {
                console.error('seasonSelectEl no encontrado');
            }
        } catch (error) {
            console.error('Error cargando temporadas:', error);
        }
    }

    // Cargar reglas
    async function loadRules() {
        try {
            console.log('Cargando reglas...');
            const response = await fetch('/locations/rules/api/');
            console.log('Response status:', response.status);
            const rules = await response.json();
            console.log('Reglas recibidas:', rules);
            
            const ruleSelectEl = document.querySelector('select[name="rule"]');
            if (ruleSelectEl) {
                ruleSelectEl.innerHTML = '<option value="">Selecciona regla</option>';
                rules.forEach(rule => {
                    const option = document.createElement('option');
                    option.value = rule.id;
                    option.textContent = rule.name;
                    ruleSelectEl.appendChild(option);
                });
                console.log('Reglas cargadas en el select');
            } else {
                console.error('ruleSelectEl no encontrado');
            }
        } catch (error) {
            console.error('Error cargando reglas:', error);
        }
    }
    
    // Cargar países
    async function loadCountries() {
        try {
            console.log('Cargando países...');
            const response = await fetch('/locations/countries/api/');
            console.log('Response status:', response.status);
            const countries = await response.json();
            console.log('Países recibidos:', countries);
            
            if (countrySelectEl) {
                countrySelectEl.innerHTML = '<option value="">Selecciona país</option>';
                let usaId = null;
                
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.id;
                    option.textContent = country.name;
                    countrySelectEl.appendChild(option);
                    
                    // Buscar USA para seleccionarlo por defecto
                    if (country.name.toLowerCase().includes('united states') || 
                        country.name.toLowerCase().includes('usa') ||
                        country.name.toLowerCase().includes('estados unidos')) {
                        usaId = country.id;
                    }
                });
                
                // Seleccionar USA por defecto si existe
                if (usaId) {
                    countrySelectEl.value = usaId;
                    console.log('USA seleccionado por defecto, ID:', usaId);
                    // Cargar estados de USA automáticamente
                    await loadStates(usaId);
                }
                
                console.log('Países cargados en el select');
            } else {
                console.error('countrySelectEl no encontrado');
            }
        } catch (error) {
            console.error('Error cargando países:', error);
        }
    }
    
    // Cargar estados por país
    async function loadStates(countryId) {
        console.log('loadStates llamada con countryId:', countryId);
        console.log('stateSelectEl disponible:', !!stateSelectEl);
        
        if (!countryId) {
            if (stateSelectEl) {
                stateSelectEl.innerHTML = '<option value="">Primero selecciona un país</option>';
                stateSelectEl.disabled = true;
            }
            return;
        }
        
        if (!stateSelectEl) {
            console.error('stateSelectEl no está disponible');
            return;
        }
        
        try {
            console.log('Cargando estados para país:', countryId);
            const response = await fetch(`/locations/states/api/?country=${countryId}`);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const states = await response.json();
            console.log('Estados recibidos:', states);
            
            stateSelectEl.innerHTML = '<option value="">Selecciona estado</option>';
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state.id;
                option.textContent = state.name;
                stateSelectEl.appendChild(option);
            });
            stateSelectEl.disabled = false;
            console.log('Estados cargados en el select');
            
            // Si hay estados disponibles, seleccionar el primer estado y cargar sus ciudades
            if (states.length > 0) {
                const firstStateId = states[0].id;
                console.log('Seleccionando primer estado:', firstStateId);
                
                // Seleccionar el primer estado en el select
                stateSelectEl.value = firstStateId;
                
                // Cargar ciudades del primer estado
                console.log('Cargando ciudades del primer estado:', firstStateId);
                await loadCities(firstStateId);
            }
        } catch (error) {
            console.error('Error cargando estados:', error);
        }
    }
    
    // Cargar ciudades por estado
    async function loadCities(stateId) {
        console.log('loadCities llamada con stateId:', stateId);
        console.log('citySelectEl disponible:', !!citySelectEl);
        
        if (!stateId) {
            if (citySelectEl) {
                citySelectEl.innerHTML = '<option value="">Primero selecciona un estado</option>';
                citySelectEl.disabled = true;
            }
            return;
        }
        
        if (!citySelectEl) {
            console.error('citySelectEl no está disponible');
            return;
        }
        
        try {
            console.log('Cargando ciudades para estado:', stateId);
            const response = await fetch(`/locations/cities/api/?state=${stateId}`);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const cities = await response.json();
            console.log('Ciudades recibidas:', cities);
            
            citySelectEl.innerHTML = '<option value="">Selecciona ciudad</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.id;
                option.textContent = city.name;
                citySelectEl.appendChild(option);
            });
            citySelectEl.disabled = false;
            console.log('Ciudades cargadas en el select, campo habilitado:', !citySelectEl.disabled);
        } catch (error) {
            console.error('Error cargando ciudades:', error);
            if (citySelectEl) {
                citySelectEl.innerHTML = '<option value="">Error cargando ciudades</option>';
                citySelectEl.disabled = true;
            }
        }
    }
    
    // Event listeners para dependencias
    if (countrySelectEl) {
        countrySelectEl.addEventListener('change', function() {
            const countryId = this.value;
            console.log('País seleccionado:', countryId);
            loadStates(countryId);
        });
    }
    
    if (stateSelectEl) {
        stateSelectEl.addEventListener('change', function() {
            const stateId = this.value;
            console.log('Estado seleccionado:', stateId);
            loadCities(stateId);
        });
    }
    
    // ===== CAMPOS CONDICIONALES =====
    function toggleConditionalFields() {
        // Accept Deposits -> Deposit Amount
        const acceptDeposits = document.querySelector('input[name="accept_deposits"]');
        const depositAmountField = document.getElementById('deposit-amount-field');
        
        if (acceptDeposits && depositAmountField) {
            acceptDeposits.addEventListener('change', function() {
                if (this.checked) {
                    depositAmountField.style.display = 'block';
                } else {
                    depositAmountField.style.display = 'none';
                    const depositAmountInput = depositAmountField.querySelector('input');
                    if (depositAmountInput) {
                        depositAmountInput.value = '';
                    }
                }
            });
        }
        
        // Has Gate Fee -> Gate Fee Fields
        const hasGateFee = document.querySelector('input[name="has_gate_fee"]');
        const gateFeeFields = document.getElementById('gate-fee-fields');
        
        if (hasGateFee && gateFeeFields) {
            hasGateFee.addEventListener('change', function() {
                if (this.checked) {
                    gateFeeFields.style.display = 'block';
                } else {
                    gateFeeFields.style.display = 'none';
                    const gateFeeInputs = gateFeeFields.querySelectorAll('input, select');
                    gateFeeInputs.forEach(input => {
                        input.value = '';
                    });
                }
            });
        }
        
        // Allow Withdrawals -> Withdraw Deadline
        const allowWithdrawals = document.querySelector('input[name="allow_withdrawals"]');
        const withdrawDeadlineField = document.getElementById('withdraw-deadline-field');
        
        if (allowWithdrawals && withdrawDeadlineField) {
            allowWithdrawals.addEventListener('change', function() {
                if (this.checked) {
                    withdrawDeadlineField.style.display = 'block';
                } else {
                    withdrawDeadlineField.style.display = 'none';
                    const withdrawDeadlineInput = withdrawDeadlineField.querySelector('input');
                    if (withdrawDeadlineInput) {
                        withdrawDeadlineInput.value = '';
                    }
                }
            });
        }
        
        // Freeze Rosters -> Roster Freeze Date
        const freezeRosters = document.querySelector('input[name="freeze_rosters"]');
        const rosterFreezeField = document.getElementById('roster-freeze-field');
        
        if (freezeRosters && rosterFreezeField) {
            freezeRosters.addEventListener('change', function() {
                if (this.checked) {
                    rosterFreezeField.style.display = 'block';
                } else {
                    rosterFreezeField.style.display = 'none';
                    const rosterFreezeInput = rosterFreezeField.querySelector('input');
                    if (rosterFreezeInput) {
                        rosterFreezeInput.value = '';
                    }
                }
            });
        }
        
        // Send Payment Reminders -> Payment Reminder Date
        const sendPaymentReminders = document.querySelector('input[name="send_payment_reminders"]');
        const paymentReminderField = document.getElementById('payment-reminder-field');
        
        if (sendPaymentReminders && paymentReminderField) {
            sendPaymentReminders.addEventListener('change', function() {
                if (this.checked) {
                    paymentReminderField.style.display = 'block';
                } else {
                    paymentReminderField.style.display = 'none';
                    const paymentReminderInput = paymentReminderField.querySelector('input');
                    if (paymentReminderInput) {
                        paymentReminderInput.value = '';
                    }
                }
            });
        }
        
        // Accept Schedule Requests -> Schedule Request Deadline
        const acceptScheduleRequests = document.querySelector('input[name="accept_schedule_requests"]');
        const scheduleRequestField = document.getElementById('schedule-request-field');
        
        if (acceptScheduleRequests && scheduleRequestField) {
            acceptScheduleRequests.addEventListener('change', function() {
                if (this.checked) {
                    scheduleRequestField.style.display = 'block';
                } else {
                    scheduleRequestField.style.display = 'none';
                    const scheduleRequestInput = scheduleRequestField.querySelector('input');
                    if (scheduleRequestInput) {
                        scheduleRequestInput.value = '';
                    }
                }
            });
        }
    }
    
    // Función para verificar que todos los elementos estén disponibles
    function initializeForm() {
        console.log('Inicializando formulario...');
        console.log('seasonSelectEl disponible:', !!seasonSelectEl);
        console.log('countrySelectEl disponible:', !!countrySelectEl);
        console.log('stateSelectEl disponible:', !!stateSelectEl);
        console.log('citySelectEl disponible:', !!citySelectEl);
        
        if (seasonSelectEl && countrySelectEl) {
            console.log('Elementos principales encontrados, cargando datos...');
            loadSeasons();
            loadCountries();
            loadRules();
        } else {
            console.error('Algunos elementos principales no están disponibles');
        }
    }
    
    // Cargar datos iniciales
    initializeForm();
    
    // Inicializar campos condicionales
    toggleConditionalFields();
    
    // ===== MODERN SITES SELECTION SYSTEM =====
    const availableSitesGrid = document.getElementById('available-sites-grid');
    const selectedSitesChips = document.getElementById('selected-sites-chips');
    const hiddenCheckboxes = document.querySelectorAll('.hidden-site-checkbox');
    const stateSelect = document.getElementById('{{ form.state.id_for_label }}');
    const showAllSitesCheckbox = document.getElementById('show-all-sites');
    const primarySiteSelect = document.getElementById('primary-site-select');
    const sitesSearch = document.getElementById('sites-search');
    const clearSelectionBtn = document.getElementById('clear-selection');
    const selectedCount = document.getElementById('selected-count');
    
    // Store all sites data for filtering
    let allSitesData = [];
    let selectedSites = new Set();
    let filteredSites = [];
    
    // Load sites data from server
    async function loadSitesData() {
        try {
            const response = await fetch('/locations/sites/api/');
            if (response.ok) {
                allSitesData = await response.json();
                console.log('Sites data loaded:', allSitesData);
                filterAndDisplaySites();
            } else {
                console.error('Error loading sites data');
            }
        } catch (error) {
            console.error('Error loading sites data:', error);
        }
    }
    
    // Filter and display sites based on state and search
    function filterAndDisplaySites() {
        const selectedStateId = stateSelect.value;
        const showAll = showAllSitesCheckbox.checked;
        const searchTerm = sitesSearch ? sitesSearch.value.toLowerCase().trim() : '';
        
        console.log('Filtering sites with:', { selectedStateId, showAll, searchTerm });
        
        // Show loading state only if we have data to filter
        if (allSitesData.length > 0) {
            availableSitesGrid.innerHTML = '<div class="loading-sites"><i class="fas fa-spinner fa-spin me-2"></i>Filtrando sitios...</div>';
        }
        
        setTimeout(() => {
            // Filter by state
            let sitesToShow = allSitesData;
            if (!showAll && selectedStateId) {
                sitesToShow = allSitesData.filter(site => site.state_id == selectedStateId);
                console.log(`After state filter: ${sitesToShow.length} sites`);
            }
            
            // Filter by search term
            if (searchTerm) {
                const originalCount = sitesToShow.length;
                sitesToShow = sitesToShow.filter(site => {
                    const siteName = (site.site_name || '').toLowerCase();
                    const cityName = (site.city_name || '').toLowerCase();
                    const stateName = (site.state_name || '').toLowerCase();
                    const abbreviation = (site.abbreviation || '').toLowerCase();
                    
                    return siteName.includes(searchTerm) ||
                           cityName.includes(searchTerm) ||
                           stateName.includes(searchTerm) ||
                           abbreviation.includes(searchTerm);
                });
                console.log(`After search filter: ${sitesToShow.length} sites (from ${originalCount})`);
            }
            
            filteredSites = sitesToShow;
            
            // Clear and populate grid
            availableSitesGrid.innerHTML = '';
            
            if (sitesToShow.length === 0) {
                let message = 'No se encontraron sitios';
                if (searchTerm) {
                    message = `No se encontraron sitios que coincidan con "${searchTerm}"`;
                } else if (!showAll && selectedStateId) {
                    message = 'No hay sitios disponibles para el estado seleccionado';
                } else if (allSitesData.length === 0) {
                    message = 'No hay sitios disponibles';
                }
                availableSitesGrid.innerHTML = `<div class="loading-sites">${message}</div>`;
            } else {
                sitesToShow.forEach(site => {
                    createSiteCard(site);
                });
            }
            
            // Update primary site select
            updatePrimarySiteSelect(selectedStateId, showAll);
            
            console.log(`Displaying ${sitesToShow.length} sites`);
        }, 200);
    }
    
    // Create site card element
    function createSiteCard(site) {
        const siteCard = document.createElement('div');
        siteCard.className = 'site-card';
        siteCard.dataset.siteId = site.id;
        
        const isSelected = selectedSites.has(site.id.toString());
        if (isSelected) {
            siteCard.classList.add('selected');
        }
        
        // Highlight search terms
        const searchTerm = sitesSearch ? sitesSearch.value.toLowerCase().trim() : '';
        const highlightText = (text, term) => {
            if (!term || !text) return text;
            const regex = new RegExp(`(${term})`, 'gi');
            return text.replace(regex, '<mark class="search-highlight">$1</mark>');
        };
        
        siteCard.innerHTML = `
            <div class="site-card-header">
                <h6 class="site-card-name">${highlightText(site.site_name, searchTerm)}</h6>
                ${site.abbreviation ? `<span class="site-card-abbreviation">${highlightText(site.abbreviation, searchTerm)}</span>` : ''}
            </div>
            <div class="site-card-location">
                <i class="fas fa-map-marker-alt"></i>
                ${highlightText(site.city_name || 'N/A', searchTerm)}, ${highlightText(site.state_name || 'N/A', searchTerm)}
            </div>
        `;
        
        // Add click handler
        siteCard.addEventListener('click', function() {
            toggleSiteSelection(site.id.toString());
        });
        
        availableSitesGrid.appendChild(siteCard);
        return siteCard;
    }
    
    // Toggle site selection
    function toggleSiteSelection(siteId) {
        if (selectedSites.has(siteId)) {
            selectedSites.delete(siteId);
        } else {
            selectedSites.add(siteId);
        }
        
        updateSelectedSitesDisplay();
        updateHiddenCheckboxes();
        updateSelectedCount();
    }
    
    // Update selected sites display
    function updateSelectedSitesDisplay() {
        selectedSitesChips.innerHTML = '';
        
        if (selectedSites.size === 0) {
            selectedSitesChips.innerHTML = '<div class="no-sites-message"><i class="fas fa-info-circle me-2"></i>No hay sitios seleccionados</div>';
            return;
        }
        
        selectedSites.forEach(siteId => {
            const site = allSitesData.find(s => s.id.toString() === siteId);
            if (site) {
                const chip = document.createElement('div');
                chip.className = 'site-chip';
                chip.innerHTML = `
                    <div class="chip-content">
                        <span class="chip-name">${site.site_name}</span>
                        <span class="chip-location">${site.city_name || 'N/A'}, ${site.state_name || 'N/A'}</span>
                    </div>
                    <button type="button" class="chip-remove" onclick="removeSiteChip('${siteId}')">×</button>
                `;
                selectedSitesChips.appendChild(chip);
            }
        });
        
        // Update card selection states
        document.querySelectorAll('.site-card').forEach(card => {
            const siteId = card.dataset.siteId;
            if (selectedSites.has(siteId)) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }
    
    // Remove site chip
    function removeSiteChip(siteId) {
        selectedSites.delete(siteId);
        updateSelectedSitesDisplay();
        updateHiddenCheckboxes();
        updateSelectedCount();
    }
    
    // Update hidden checkboxes
    function updateHiddenCheckboxes() {
        hiddenCheckboxes.forEach(checkbox => {
            checkbox.checked = selectedSites.has(checkbox.value);
        });
    }
    
    // Update selected count
    function updateSelectedCount() {
        selectedCount.textContent = selectedSites.size;
    }
    
    // Update primary site select with filtered sites
    function updatePrimarySiteSelect(selectedStateId, showAll) {
        // Clear current options
        primarySiteSelect.innerHTML = '<option value="">Select Primary Site</option>';
        
        let sitesToShow = allSitesData;
        if (!showAll && selectedStateId) {
            sitesToShow = allSitesData.filter(site => site.state_id == selectedStateId);
        }
        
        // Add filtered sites to primary select
        sitesToShow.forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;
            option.textContent = `${site.site_name} - ${site.city_name || 'N/A'}, ${site.state_name || 'N/A'}`;
            primarySiteSelect.appendChild(option);
        });
        
        console.log(`Primary site select updated with ${sitesToShow.length} sites`);
    }
    
    // Initialize selected sites from form data
    function initializeSelectedSites() {
        // Wait a bit for the sites to be loaded and filtered
        setTimeout(() => {
            // Initialize primary site
            const primarySiteValue = '{{ form.primary_site.value|default:"" }}';
            if (primarySiteValue) {
                primarySiteSelect.value = primarySiteValue;
                console.log('Primary site initialized:', primarySiteValue);
            }
            
            // Initialize additional sites
            hiddenCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedSites.add(checkbox.value);
                }
            });
            
            updateSelectedSitesDisplay();
            updateSelectedCount();
            console.log('Selected sites initialized:', Array.from(selectedSites));
        }, 500);
    }
    
    // Clear all selections
    function clearAllSelections() {
        selectedSites.clear();
        updateSelectedSitesDisplay();
        updateHiddenCheckboxes();
        updateSelectedCount();
    }
    
    // Make removeSiteChip available globally
    window.removeSiteChip = removeSiteChip;
    
    // Event listeners
    stateSelect.addEventListener('change', function() {
        console.log('State changed, filtering sites...');
        filterAndDisplaySites();
    });
    
    showAllSitesCheckbox.addEventListener('change', function() {
        console.log('Show all sites toggled:', this.checked);
        filterAndDisplaySites();
    });
    
    // Search functionality with debouncing
    let searchTimeout;
    if (sitesSearch) {
        sitesSearch.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            console.log('Search term changed:', searchTerm);
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Debounce search to avoid too many requests
            searchTimeout = setTimeout(() => {
                filterAndDisplaySites();
            }, 300);
        });
        
        // Clear search functionality
        sitesSearch.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                filterAndDisplaySites();
            }
        });
    }
    
    clearSelectionBtn.addEventListener('click', function() {
        clearAllSelections();
    });
    
    // Clear search button
    const clearSearchBtn = document.getElementById('clear-search');
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            sitesSearch.value = '';
            filterAndDisplaySites();
            sitesSearch.focus();
        });
    }
    
    // Primary site select change handler
    primarySiteSelect.addEventListener('change', function() {
        console.log('Primary site changed to:', this.value);
    });
    
    // Initialize the system
    loadSitesData().then(() => {
        initializeSelectedSites();
    });
});
</script>
{% endblock %}