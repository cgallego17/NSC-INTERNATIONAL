{% extends 'base.html' %}
{% load static %}
{% load url_filters %}

{% block title %}{{ event.title }} - Admin{% endblock %}

{% block breadcrumb %}
    <span>Eventos</span> / <span>{{ event.title }}</span>
{% endblock %}

{% block extra_css %}
<style>
    /* Diseño minimalista y limpio */
    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Header */
    .admin-header {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .admin-header h1 {
        font-size: 1.75rem;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0 0 0.5rem 0;
    }

    .admin-header .meta {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        font-size: 0.875rem;
        color: #666;
    }

    .admin-header .meta-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    /* Tabs minimalistas */
    .admin-tabs {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }

    .admin-tabs .nav-tabs {
        border-bottom: 1px solid #e5e5e5;
        padding: 0 1rem;
        margin: 0;
    }

    .admin-tabs .nav-link {
        border: none;
        color: #666;
        padding: 1rem 1.5rem;
        font-weight: 500;
        font-size: 0.925rem;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
    }

    .admin-tabs .nav-link:hover {
        color: #0d6efd;
        background: transparent;
    }

    .admin-tabs .nav-link.active {
        color: #0d6efd;
        background: transparent;
        border-bottom-color: #0d6efd;
    }

    .admin-tabs .nav-link i {
        margin-right: 0.5rem;
    }

    /* Tab Content */
    .tab-content {
        padding: 1.5rem;
        background: white;
        border-radius: 0 0 8px 8px;
    }

    /* Info Grid minimalista */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .info-item {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #e5e5e5;
    }

    .info-item.primary {
        border-left-color: #0d6efd;
    }

    .info-item.success {
        border-left-color: #198754;
    }

    .info-item.warning {
        border-left-color: #ffc107;
    }

    .info-item.info {
        border-left-color: #0dcaf0;
    }

    .info-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #666;
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .info-value {
        font-size: 1rem;
        color: #1a1a1a;
        font-weight: 500;
    }

    /* Sección */
    .admin-section {
        margin-bottom: 2rem;
    }

    .admin-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e5e5;
    }

    /* Email Form */
    .email-form {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .email-form .form-label {
        font-weight: 600;
        color: #1a1a1a;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .email-form .form-control,
    .email-form .form-select {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 0.625rem 0.875rem;
        font-size: 0.9rem;
    }

    .email-form .form-control:focus,
    .email-form .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }

    .email-preview {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 6px;
        padding: 1.5rem;
        margin-top: 1rem;
    }

    /* Recipients List */
    .recipients-list {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 6px;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .recipient-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.875rem;
    }

    .recipient-item:last-child {
        border-bottom: none;
    }

    .recipient-item .name {
        font-weight: 500;
        color: #1a1a1a;
    }

    .recipient-item .email {
        color: #666;
        margin-left: 0.5rem;
    }

    .recipient-item .badge {
        margin-left: auto;
        font-size: 0.75rem;
    }

    /* Botones minimalistas */
    .btn-minimal {
        border: 1px solid #d1d5db;
        background: white;
        color: #1a1a1a;
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .btn-minimal:hover {
        border-color: #0d6efd;
        color: #0d6efd;
        background: #f8f9ff;
    }

    .btn-primary-minimal {
        background: #0d6efd;
        color: white;
        border: none;
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .btn-primary-minimal:hover {
        background: #0b5ed7;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.25);
    }

    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 6px;
        padding: 1.25rem 1rem;
        text-align: center;
        min-width: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-sizing: border-box;
    }

    .stat-card .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
        line-height: 1.2;
        max-width: 100%;
        word-break: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }

    /* Para valores monetarios, usar tamaño más pequeño */
    .stat-card .stat-value.money-value {
        font-size: 1.35rem;
        letter-spacing: -0.01em;
    }

    .stat-card .stat-label {
        font-size: 0.875rem;
        color: #666;
        font-weight: 500;
    }

    /* Responsive - ajustar tamaño de fuente en móviles */
    @media (max-width: 768px) {
        .stat-card .stat-value {
            font-size: 1.5rem;
        }

        .stat-card .stat-value.money-value {
            font-size: 1.2rem;
        }

        .stats-row {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .admin-container {
            padding: 1rem;
        }

        .admin-header .meta {
            flex-direction: column;
            gap: 0.5rem;
        }

        .admin-tabs .nav-link {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Loading state */
    .loading {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1>{{ event.title }}</h1>
                <div class="meta">
                    <div class="meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>{{ event.start_date|date:"d M Y" }} - {{ event.end_date|date:"d M Y" }}</span>
                    </div>
                    {% if event.city %}
                    <div class="meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ event.city.name }}{% if event.state %}, {{ event.state.name }}{% endif %}</span>
                    </div>
                    {% endif %}
                    <div class="meta-item">
                        <i class="fas fa-users"></i>
                        <span>{{ registered_players_count|default:0 }} registrados</span>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'events:update' event.pk %}" class="btn-minimal">
                    <i class="fas fa-edit"></i> Editar
                </a>
                <a href="{% url 'events:list' %}" class="btn-minimal">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="admin-tabs">
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-chart-line"></i> Resumen
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                    <i class="fas fa-info-circle"></i> Detalles
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="registrations-tab" data-bs-toggle="tab" data-bs-target="#registrations" type="button" role="tab">
                    <i class="fas fa-users"></i> Registros
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab">
                    <i class="fas fa-envelope"></i> Enviar Emails
                </button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            <!-- Tab: Resumen -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value">{{ registered_players_count|default:0 }}</div>
                        <div class="stat-label">Jugadores Registrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ event.divisions.all|length }}</div>
                        <div class="stat-label">Divisiones</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ orders_count|default:0 }}</div>
                        <div class="stat-label">Órdenes de Compra</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value money-value">${{ total_revenue|default:0|floatformat:2|intcomma_dot }}</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                    {% if event.hotel %}
                    <div class="stat-card">
                        <div class="stat-value">{{ hotel_reservations_count|default:0 }}</div>
                        <div class="stat-label">Reservas de Hotel</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ rooms_sold_count|default:0 }}</div>
                        <div class="stat-label">Habitaciones Vendidas</div>
                    </div>
                    {% endif %}
                </div>

                <div class="admin-section">
                    <h3 class="admin-section-title">Información Clave</h3>
                    <div class="info-grid">
                        {% if event.entry_deadline %}
                        <div class="info-item warning">
                            <div class="info-label">Límite de Registro</div>
                            <div class="info-value">{{ event.entry_deadline|date:"d M Y" }}</div>
                        </div>
                        {% endif %}
                        {% if event.payment_deadline %}
                        <div class="info-item warning">
                            <div class="info-label">Límite de Pago</div>
                            <div class="info-value">{{ event.payment_deadline|date:"d M Y" }}</div>
                        </div>
                        {% endif %}
                        {% if event.default_entry_fee %}
                        <div class="info-item success">
                            <div class="info-label">Precio de Entrada</div>
                            <div class="info-value">${{ event.default_entry_fee|floatformat:2|intcomma_dot }}</div>
                        </div>
                        {% endif %}
                        {% if event.status %}
                        <div class="info-item primary">
                            <div class="info-label">Estado</div>
                            <div class="info-value">
                                {% if event.status == 'published' %}Publicado
                                {% elif event.status == 'draft' %}Borrador
                                {% elif event.status == 'cancelled' %}Cancelado
                                {% elif event.status == 'completed' %}Completado
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if divisions_with_counts %}
                <div class="admin-section">
                    <h3 class="admin-section-title">Registros por División</h3>
                    <div class="info-grid">
                        {% for item in divisions_with_counts %}
                        <div class="info-item info">
                            <div class="info-label">{{ item.division.name }}</div>
                            <div class="info-value">{{ item.registered_count|default:0 }} jugadores</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Tab: Detalles -->
            <div class="tab-pane fade" id="details" role="tabpanel">
                <div class="admin-section">
                    <h3 class="admin-section-title">Información del Evento</h3>
                    <div class="info-grid">
                        {% if event.event_type %}
                        <div class="info-item">
                            <div class="info-label">Tipo de Evento</div>
                            <div class="info-value">{{ event.event_type.name }}</div>
                        </div>
                        {% endif %}
                        {% if event.season %}
                        <div class="info-item">
                            <div class="info-label">Temporada</div>
                            <div class="info-value">{{ event.season.name }}</div>
                        </div>
                        {% endif %}
                        {% if event.category %}
                        <div class="info-item">
                            <div class="info-label">Categoría</div>
                            <div class="info-value">{{ event.category.name }}</div>
                        </div>
                        {% endif %}
                        {% if event.gate_fee_amount %}
                        <div class="info-item">
                            <div class="info-label">Gate Fee</div>
                            <div class="info-value">${{ event.gate_fee_amount|floatformat:2|intcomma_dot }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if event.primary_site %}
                <div class="admin-section">
                    <h3 class="admin-section-title">Sitio Principal</h3>
                    <div class="info-item">
                        <div class="info-label">Nombre</div>
                        <div class="info-value">{{ event.primary_site.site_name }}</div>
                        {% if event.primary_site.address_1 %}
                        <div class="info-label mt-2">Dirección</div>
                        <div class="info-value">
                            {{ event.primary_site.address_1 }}
                            {% if event.primary_site.address_2 %}, {{ event.primary_site.address_2 }}{% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if event.hotel %}
                <div class="admin-section">
                    <h3 class="admin-section-title">Hotel Sede</h3>
                    <div class="info-item">
                        <div class="info-label">Nombre</div>
                        <div class="info-value">{{ event.hotel.hotel_name }}</div>
                        {% if event.hotel.address %}
                        <div class="info-label mt-2">Dirección</div>
                        <div class="info-value">{{ event.hotel.address }}</div>
                        {% endif %}
                        {% if event.hotel.contact_phone %}
                        <div class="info-label mt-2">Teléfono</div>
                        <div class="info-value">{{ event.hotel.contact_phone }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if event.description %}
                <div class="admin-section">
                    <h3 class="admin-section-title">Descripción</h3>
                    <div style="line-height: 1.6; color: #333;">
                        {{ event.description|safe }}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Tab: Registros -->
            <div class="tab-pane fade" id="registrations" role="tabpanel">
                <div class="admin-section">
                    <h3 class="admin-section-title">Jugadores Registrados ({{ registered_players_count|default:0 }})</h3>

                    {% if registered_players %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>División</th>
                                    <th>Grado</th>
                                    <th>Edad</th>
                                    <th>Registrado por</th>
                                    <th width="100">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in registered_players %}
                                <tr>
                                    <td class="fw-medium">{{ player.user.first_name }} {{ player.user.last_name }}</td>
                                    <td><small>{{ player.user.email|default:"-" }}</small></td>
                                    <td><span class="badge bg-info">{% if player.division %}{{ player.division.name }}{% else %}-{% endif %}</span></td>
                                    <td>{{ player.get_grade_display|default:"-" }}</td>
                                    <td>{% if player.user.profile.date_of_birth %}{{ player.user.profile.age }}{% else %}-{% endif %}</td>
                                    <td><small>{% if player.parents.exists %}{{ player.parents.first.parent.get_full_name|default:player.parents.first.parent.username }}{% else %}-{% endif %}</small></td>
                                    <td>
                                        <a href="{% url 'accounts:front_player_profile' player.id %}" class="btn btn-sm btn-outline-primary" target="_blank" title="Ver perfil del jugador">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No hay jugadores registrados aún.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Tab: Enviar Emails -->
            <div class="tab-pane fade" id="email" role="tabpanel">
                <div class="admin-section">
                    <h3 class="admin-section-title">Enviar Email a Registrados</h3>

                    <form method="post" action="{% url 'events:send_email' event.pk %}" id="emailForm">
                        {% csrf_token %}

                        <div class="email-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Destinatarios</label>
                                    <select class="form-select" name="recipient_filter" id="recipientFilter">
                                        <option value="all">Todos los registrados ({{ registered_players_count|default:0 }})</option>
                                        <option value="parents">Solo padres/tutores ({{ unique_parents_count|default:0 }})</option>
                                        {% if divisions_with_counts %}
                                        <optgroup label="Por División">
                                            {% for item in divisions_with_counts %}
                                            <option value="division_{{ item.division.id }}">{{ item.division.name }} ({{ item.registered_count|default:0 }})</option>
                                            {% endfor %}
                                        </optgroup>
                                        {% endif %}
                                    </select>
                                    <small class="form-text text-muted">Selecciona quién recibirá el email</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Asunto</label>
                                    <input type="text" class="form-control" name="subject" required placeholder="Asunto del email">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Mensaje</label>
                                <textarea class="form-control" name="message" rows="8" required placeholder="Escribe tu mensaje aquí..."></textarea>
                                <small class="form-text text-muted">Puedes usar HTML básico para formato</small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="previewBefore" checked>
                                    <label class="form-check-label" for="previewBefore">
                                        Mostrar vista previa antes de enviar
                                    </label>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="button" class="btn-primary-minimal" onclick="previewEmail()">
                                    <i class="fas fa-eye"></i> Vista Previa
                                </button>
                                <button type="submit" class="btn-primary-minimal" id="sendBtn">
                                    <i class="fas fa-paper-plane"></i> Enviar Email
                                </button>
                            </div>
                        </div>
                    </form>

                    <div id="emailPreview" class="email-preview" style="display: none;">
                        <h5>Vista Previa</h5>
                        <div id="previewContent"></div>
                        <div class="mt-3">
                            <strong>Destinatarios:</strong> <span id="previewRecipients"></span>
                        </div>
                    </div>
                </div>

                <!-- Lista de destinatarios -->
                <div class="admin-section">
                    <h3 class="admin-section-title">
                        <span id="recipientsTitle">Todos los Destinatarios</span>
                        <span class="badge bg-primary" id="recipientsCount">{{ unique_parents_count|default:0 }}</span>
                    </h3>
                    <div class="recipients-list" id="recipientsList">
                        {% for parent in unique_parents %}
                        <div class="recipient-item" data-parent-id="{{ parent.id }}">
                            <div>
                                <div class="name">{{ parent.get_full_name|default:parent.username }}</div>
                                <div class="email">{{ parent.email }}</div>
                            </div>
                            <span class="badge bg-secondary">{{ parent.players_count }} jugador{{ parent.players_count|pluralize:"es" }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const recipientFilter = document.getElementById('recipientFilter');
    const recipientsList = document.getElementById('recipientsList');
    const recipientsTitle = document.getElementById('recipientsTitle');
    const recipientsCount = document.getElementById('recipientsCount');
    const emailForm = document.getElementById('emailForm');
    const sendBtn = document.getElementById('sendBtn');

    // Filtrar destinatarios
    if (recipientFilter) {
        recipientFilter.addEventListener('change', function() {
            const filterValue = this.value;
            updateRecipientsList(filterValue);
        });
    }

    function updateRecipientsList(filterValue) {
        const option = recipientFilter.options[recipientFilter.selectedIndex];
        recipientsTitle.textContent = option.text.split('(')[0].trim();

        // Hacer petición AJAX para obtener la lista filtrada
        const eventId = window.location.pathname.split('/')[3];
        fetch(`/events/admin/${eventId}/recipients/?filter=${filterValue}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar la lista de destinatarios
                    recipientsList.innerHTML = '';
                    data.recipients.forEach(recipient => {
                        const item = document.createElement('div');
                        item.className = 'recipient-item';
                        item.dataset.parentId = recipient.id;
                        item.innerHTML = `
                            <div>
                                <div class="name">${escapeHtml(recipient.name)}</div>
                                <div class="email">${escapeHtml(recipient.email)}</div>
                            </div>
                            <span class="badge bg-secondary">${recipient.players_count} jugador${recipient.players_count !== 1 ? 'es' : ''}</span>
                        `;
                        recipientsList.appendChild(item);
                    });
                    recipientsCount.textContent = data.count;
                }
            })
            .catch(error => {
                console.error('Error al cargar destinatarios:', error);
            });
    }

    // Vista previa del email
    window.previewEmail = function() {
        const subject = document.querySelector('[name="subject"]').value;
        const message = document.querySelector('[name="message"]').value;
        const filter = recipientFilter.options[recipientFilter.selectedIndex].text;

        if (!subject || !message) {
            alert('Por favor completa el asunto y el mensaje');
            return;
        }

        document.getElementById('previewContent').innerHTML = `
            <div style="border: 1px solid #e5e5e5; padding: 1rem; border-radius: 4px;">
                <h6><strong>Asunto:</strong> ${escapeHtml(subject)}</h6>
                <hr>
                <div>${message}</div>
            </div>
        `;
        document.getElementById('previewRecipients').textContent = filter;
        document.getElementById('emailPreview').style.display = 'block';
    };

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Confirmación antes de enviar
    emailForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const confirmed = confirm('¿Estás seguro de que deseas enviar este email?');
        if (!confirmed) {
            return false;
        }

        // Mostrar loading
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="loading"></span> Enviando...';

        // Enviar formulario via AJAX
        const formData = new FormData(emailForm);

        fetch(emailForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✓ Se enviaron ${data.sent_count} email(s) exitosamente.`);
                // Limpiar formulario
                emailForm.reset();
                document.getElementById('emailPreview').style.display = 'none';
            } else {
                alert('Error: ' + (data.error || 'No se pudo enviar el email'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al enviar el email. Por favor intenta de nuevo.');
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Email';
        });
    });
});
</script>
{% endblock %}
