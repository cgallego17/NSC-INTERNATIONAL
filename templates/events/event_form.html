{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Editar Evento{% else %}Crear Evento{% endif %} - NCS Eventos{% endblock %}

{% block breadcrumb %}
    <span>Eventos</span> / <span>{% if form.instance.pk %}Editar{% else %}Crear{% endif %}</span>
{% endblock %}

{% block extra_css %}
<style>
    .event-form-container {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        padding: 0;
        min-height: 100vh;
    }

    @media (max-width: 992px) {
        .event-form-container {
            padding: 0;
        }
    }

    .form-section {
        background: #ffffff;
        border-radius: 0.5rem;
        padding: 1.75rem;
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: box-shadow 0.2s ease;
    }

    .form-section:hover {
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .form-section .border-bottom {
        border-color: #dee2e6 !important;
        margin-bottom: 1.5rem;
    }

    .form-section h6 {
        font-size: 1.05rem;
        letter-spacing: 0.3px;
        font-weight: 600;
        color: #4a5568 !important; /* Color oscuro para que sea visible */
    }

    .form-section h6.text-primary {
        color: #4a5568 !important; /* Sobrescribir cualquier color primario que sea blanco */
    }

    .form-section .text-primary {
        color: #4a5568 !important; /* Color para iconos también */
    }

    .form-label {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        color: #495057;
    }

    .form-section .row {
        margin-top: 0;
    }

    .form-section .row.g-3 > * {
        padding-top: 0.75rem;
    }

    /* Mejorar espaciado entre secciones */
    .form-section + .form-section {
        margin-top: 0;
    }

    /* Estilo para los iconos de sección */
    .form-section i.text-primary {
        color: #4a5568 !important;
        font-size: 1.1rem;
    }

    /* Mejorar espaciado en sección de hoteles */
    .form-section .border-top {
        border-color: #e9ecef !important;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
    }

    .form-section .border-top h6 {
        font-size: 0.95rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    /* Estilos para autocomplete */
    .autocomplete-wrapper {
        position: relative;
        width: 100%;
    }

    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1050;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        margin-top: -1px;
    }

    .autocomplete-suggestions.show {
        display: block !important;
        visibility: visible !important;
    }

    /* Asegurar que las sugerencias se muestren sobre otros elementos */
    .form-section {
        position: relative;
        z-index: 1;
    }

    /* Estilos para los tabs de Información del Evento */
    #eventInfoTabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 1.5rem;
    }

    #eventInfoTabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        border: none;
        border-bottom: 3px solid transparent;
        background: transparent;
        transition: all 0.3s ease;
    }

    #eventInfoTabs .nav-link:hover {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
        background: rgba(13, 110, 253, 0.05);
    }

    #eventInfoTabs .nav-link.active {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
        background: transparent;
        font-weight: 600;
    }

    #eventInfoTabs .nav-link i,
    #pricingTabs .nav-link i {
        margin-right: 0.5rem;
    }

    #eventInfoTabsContent,
    #pricingTabsContent {
        padding-top: 0;
    }

    #eventInfoTabsContent .tab-pane,
    #pricingTabsContent .tab-pane {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .autocomplete-wrapper {
        z-index: 10;
    }

    .autocomplete-suggestion {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.15s ease;
        user-select: none;
    }

    .autocomplete-suggestion:hover,
    .autocomplete-suggestion.highlighted {
        background-color: #e7f1ff;
        transform: translateX(2px);
    }

    .autocomplete-input:disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
        border-radius: 0 0 0.375rem 0.375rem;
    }

    .autocomplete-suggestion:first-child {
        border-top: none;
    }

    .autocomplete-suggestion .suggestion-name {
        font-weight: 500;
        color: #212529;
        font-size: 0.95rem;
    }

    .autocomplete-suggestion .suggestion-name strong {
        font-weight: 700;
        color: #fff;
        background-color: #0d6efd;
        padding: 2px 5px;
        border-radius: 3px;
    }

    .autocomplete-suggestion .suggestion-meta {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .autocomplete-suggestion .fa-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Asegurar que el input tenga el borde correcto cuando hay sugerencias */
    .autocomplete-input:focus {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }

    .autocomplete-input:focus + .autocomplete-suggestions {
        border-top: 1px solid #ced4da;
    }

    /* Estilos mejorados para el selector de videos y medios - Alta especificidad */
    #videoSelectorModal .modal-dialog,
    #mediaSelectorModal .modal-dialog {
        max-width: 1200px !important;
    }

    #videoSelectorModal .modal-content.video-selector-modal-content,
    #mediaSelectorModal .modal-content.video-selector-modal-content {
        border: none !important;
        border-radius: 16px !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
        overflow: hidden !important;
    }

    #videoSelectorModal .modal-header.video-selector-header,
    #mediaSelectorModal .modal-header.video-selector-header {
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%) !important;
        color: white !important;
        border: none !important;
        border-bottom: none !important;
        padding: 1.5rem 2rem !important;
        position: relative !important;
    }

    #videoSelectorModal .modal-header.video-selector-header .modal-icon-wrapper,
    #mediaSelectorModal .modal-header.video-selector-header .modal-icon-wrapper {
        width: 48px !important;
        height: 48px !important;
        background: rgba(255, 255, 255, 0.2) !important;
        border-radius: 12px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        backdrop-filter: blur(10px) !important;
    }

    #videoSelectorModal .modal-header.video-selector-header .modal-icon-wrapper i,
    #mediaSelectorModal .modal-header.video-selector-header .modal-icon-wrapper i {
        font-size: 1.5rem !important;
        color: white !important;
    }

    #videoSelectorModal .modal-header.video-selector-header .modal-title,
    #mediaSelectorModal .modal-header.video-selector-header .modal-title {
        color: white !important;
        font-weight: 700 !important;
        font-size: 1.5rem !important;
    }

    #videoSelectorModal .modal-header.video-selector-header .modal-subtitle,
    #mediaSelectorModal .modal-header.video-selector-header .modal-subtitle {
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 0.875rem !important;
        margin-top: 0.25rem !important;
    }

    #videoSelectorModal .modal-header.video-selector-header .btn-close,
    #mediaSelectorModal .modal-header.video-selector-header .btn-close {
        filter: brightness(0) invert(1) !important;
        opacity: 0.9 !important;
    }

    #videoSelectorModal .modal-header.video-selector-header .btn-close:hover,
    #mediaSelectorModal .modal-header.video-selector-header .btn-close:hover {
        opacity: 1 !important;
    }

    #videoSelectorModal .modal-body.video-selector-body,
    #mediaSelectorModal .modal-body.video-selector-body {
        padding: 2rem !important;
        background: #f8f9fa !important;
    }

    #videoSelectorModal .video-search-wrapper,
    #mediaSelectorModal .video-search-wrapper {
        position: relative !important;
    }

    #videoSelectorModal .video-search-wrapper .input-group,
    #mediaSelectorModal .video-search-wrapper .input-group {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        border-radius: 12px !important;
        overflow: hidden !important;
    }

    #videoSelectorModal .video-search-wrapper .input-group-text,
    #mediaSelectorModal .video-search-wrapper .input-group-text {
        background: white !important;
        border: none !important;
        padding: 0.875rem 1.25rem !important;
        color: #6c757d !important;
    }

    #videoSelectorModal .video-search-wrapper .form-control,
    #mediaSelectorModal .video-search-wrapper .form-control {
        border: none !important;
        padding: 0.875rem 1rem !important;
        font-size: 0.95rem !important;
    }

    #videoSelectorModal .video-search-wrapper .form-control:focus,
    #mediaSelectorModal .video-search-wrapper .form-control:focus {
        box-shadow: none !important;
        border: none !important;
    }

    #videoSelectorModal .video-search-wrapper .btn-outline-secondary,
    #mediaSelectorModal .video-search-wrapper .btn-outline-secondary {
        border: none !important;
        padding: 0.875rem 1rem !important;
    }

    #videoSelectorModal .video-selector-grid,
    #mediaSelectorModal .video-selector-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important;
        gap: 1.5rem !important;
        max-height: 550px !important;
        overflow-y: auto !important;
        padding: 0.5rem !important;
        margin-top: 1rem !important;
    }

    /* Scrollbar personalizado */
    #videoSelectorModal .video-selector-grid::-webkit-scrollbar,
    #mediaSelectorModal .video-selector-grid::-webkit-scrollbar {
        width: 8px !important;
    }

    #videoSelectorModal .video-selector-grid::-webkit-scrollbar-track,
    #mediaSelectorModal .video-selector-grid::-webkit-scrollbar-track {
        background: #f1f1f1 !important;
        border-radius: 10px !important;
    }

    #videoSelectorModal .video-selector-grid::-webkit-scrollbar-thumb,
    #mediaSelectorModal .video-selector-grid::-webkit-scrollbar-thumb {
        background: #c1c1c1 !important;
        border-radius: 10px !important;
    }

    #videoSelectorModal .video-selector-grid::-webkit-scrollbar-thumb:hover,
    #mediaSelectorModal .video-selector-grid::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8 !important;
    }

    #videoSelectorModal .video-selector-item,
    #mediaSelectorModal .video-selector-item {
        border: 2px solid #e9ecef !important;
        border-radius: 12px !important;
        overflow: hidden !important;
        cursor: pointer !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        background: white !important;
        position: relative !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }

    #videoSelectorModal .video-selector-item::before,
    #mediaSelectorModal .video-selector-item::before {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        border-radius: 12px !important;
        padding: 2px !important;
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%) !important;
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0) !important;
        -webkit-mask-composite: xor !important;
        mask-composite: exclude !important;
        opacity: 0 !important;
        transition: opacity 0.3s !important;
        z-index: 1 !important;
    }

    #videoSelectorModal .video-selector-item:hover,
    #mediaSelectorModal .video-selector-item:hover {
        transform: translateY(-4px) !important;
        box-shadow: 0 8px 24px rgba(74, 85, 104, 0.2) !important;
        border-color: #4a5568 !important;
    }

    #videoSelectorModal .video-selector-item:hover::before,
    #mediaSelectorModal .video-selector-item:hover::before {
        opacity: 1 !important;
    }

    #videoSelectorModal .video-selector-item.selected,
    #mediaSelectorModal .video-selector-item.selected {
        border-color: #4a5568 !important;
        background: linear-gradient(135deg, rgba(74, 85, 104, 0.05) 0%, rgba(45, 55, 72, 0.05) 100%) !important;
        box-shadow: 0 8px 24px rgba(74, 85, 104, 0.25) !important;
        transform: translateY(-2px) !important;
    }

    #videoSelectorModal .video-selector-item.selected::before,
    #mediaSelectorModal .video-selector-item.selected::before {
        opacity: 1 !important;
    }

    #videoSelectorModal .video-selector-item.selected::after,
    #mediaSelectorModal .video-selector-item.selected::after {
        content: '✓' !important;
        position: absolute !important;
        top: 12px !important;
        right: 12px !important;
        width: 28px !important;
        height: 28px !important;
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%) !important;
        color: white !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 0.875rem !important;
        font-weight: bold !important;
        z-index: 2 !important;
        box-shadow: 0 2px 8px rgba(74, 85, 104, 0.4) !important;
    }

    #videoSelectorModal .video-selector-item .video-thumbnail,
    #mediaSelectorModal .video-selector-item .video-thumbnail {
        width: 100% !important;
        height: 160px !important;
        object-fit: cover !important;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        position: relative !important;
        overflow: hidden !important;
    }

    #videoSelectorModal .video-selector-item .video-thumbnail::after,
    #mediaSelectorModal .video-selector-item .video-thumbnail::after {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.1) 100%) !important;
    }

    #videoSelectorModal .video-selector-item .video-thumbnail img,
    #mediaSelectorModal .video-selector-item .video-thumbnail img {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        transition: transform 0.3s !important;
    }

    #videoSelectorModal .video-selector-item:hover .video-thumbnail img,
    #mediaSelectorModal .video-selector-item:hover .video-thumbnail img {
        transform: scale(1.05) !important;
    }

    #videoSelectorModal .video-selector-item .video-thumbnail .placeholder,
    #mediaSelectorModal .video-selector-item .video-thumbnail .placeholder {
        font-size: 3.5rem !important;
        color: #adb5bd !important;
        z-index: 1 !important;
    }

    #videoSelectorModal .video-selector-item .video-info,
    #mediaSelectorModal .video-selector-item .video-info {
        padding: 1rem !important;
        position: relative !important;
        z-index: 1 !important;
    }

    #videoSelectorModal .video-selector-item .video-title,
    #mediaSelectorModal .video-selector-item .video-title {
        font-size: 0.9375rem !important;
        font-weight: 600 !important;
        margin-bottom: 0.5rem !important;
        color: #212529 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        line-height: 1.4 !important;
    }

    #videoSelectorModal .video-selector-item .video-meta,
    #mediaSelectorModal .video-selector-item .video-meta {
        font-size: 0.8125rem !important;
        color: #6c757d !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.75rem !important;
        flex-wrap: wrap !important;
    }

    #videoSelectorModal .video-selector-item .video-meta span,
    #mediaSelectorModal .video-selector-item .video-meta span {
        display: flex !important;
        align-items: center !important;
        gap: 0.375rem !important;
    }

    #videoSelectorModal .video-selector-item .video-meta i,
    #mediaSelectorModal .video-selector-item .video-meta i {
        font-size: 0.75rem !important;
        opacity: 0.7 !important;
    }

    #videoSelectorModal .video-selector-item .video-thumbnail,
    #mediaSelectorModal .video-selector-item .video-thumbnail {
        position: relative !important;
    }

    #videoSelectorModal .video-selector-item .video-play-overlay,
    #mediaSelectorModal .video-selector-item .video-play-overlay {
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 56px !important;
        height: 56px !important;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        opacity: 0 !important;
        transition: all 0.3s !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        z-index: 2 !important;
    }

    #videoSelectorModal .video-selector-item .video-play-overlay i,
    #mediaSelectorModal .video-selector-item .video-play-overlay i {
        font-size: 1.5rem !important;
        color: #4a5568 !important;
        margin-left: 3px !important;
    }

    #videoSelectorModal .video-selector-item:hover .video-play-overlay,
    #mediaSelectorModal .video-selector-item:hover .video-play-overlay {
        opacity: 1 !important;
        transform: translate(-50%, -50%) scale(1.1) !important;
    }

    #videoSelectorModal .video-selector-loading,
    #mediaSelectorModal .video-selector-loading {
        padding: 4rem 2rem !important;
        text-align: center !important;
    }

    #videoSelectorModal .video-selector-loading .loading-spinner,
    #mediaSelectorModal .video-selector-loading .loading-spinner {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
    }

    #videoSelectorModal .video-selector-loading .spinner-border,
    #mediaSelectorModal .video-selector-loading .spinner-border {
        width: 3rem !important;
        height: 3rem !important;
        border-width: 0.3rem !important;
    }

    #videoSelectorModal .video-selector-empty,
    #mediaSelectorModal .video-selector-empty {
        padding: 4rem 2rem !important;
        text-align: center !important;
    }

    #videoSelectorModal .video-selector-empty .empty-state,
    #mediaSelectorModal .video-selector-empty .empty-state {
        max-width: 400px !important;
        margin: 0 auto !important;
    }

    #videoSelectorModal .video-selector-empty .empty-icon,
    #mediaSelectorModal .video-selector-empty .empty-icon {
        width: 80px !important;
        height: 80px !important;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 auto 1.5rem !important;
    }

    #videoSelectorModal .video-selector-empty .empty-icon i,
    #mediaSelectorModal .video-selector-empty .empty-icon i {
        font-size: 2.5rem !important;
        color: #adb5bd !important;
    }

    #videoSelectorModal .video-selector-empty .empty-title,
    #mediaSelectorModal .video-selector-empty .empty-title {
        font-size: 1.125rem !important;
        font-weight: 600 !important;
        color: #495057 !important;
        margin-bottom: 0.5rem !important;
    }

    #videoSelectorModal .video-selector-empty .empty-text,
    #mediaSelectorModal .video-selector-empty .empty-text {
        font-size: 0.9375rem !important;
        color: #6c757d !important;
        margin: 0 !important;
    }

    #videoSelectorModal .modal-footer.video-selector-footer,
    #mediaSelectorModal .modal-footer.video-selector-footer {
        background: white !important;
        border-top: 1px solid #e9ecef !important;
        padding: 1.25rem 2rem !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }

    #videoSelectorModal .modal-footer.video-selector-footer .btn,
    #mediaSelectorModal .modal-footer.video-selector-footer .btn {
        border-radius: 8px !important;
        padding: 0.625rem 1.5rem !important;
        font-weight: 500 !important;
        transition: all 0.3s !important;
    }

    #videoSelectorModal .modal-footer.video-selector-footer .btn-light,
    #mediaSelectorModal .modal-footer.video-selector-footer .btn-light {
        border: 1px solid #dee2e6 !important;
    }

    #videoSelectorModal .modal-footer.video-selector-footer .btn-light:hover,
    #mediaSelectorModal .modal-footer.video-selector-footer .btn-light:hover {
        background: #f8f9fa !important;
        border-color: #adb5bd !important;
    }

    #videoSelectorModal .modal-footer.video-selector-footer .btn-primary,
    #mediaSelectorModal .modal-footer.video-selector-footer .btn-primary {
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%) !important;
        border: none !important;
        box-shadow: 0 4px 12px rgba(74, 85, 104, 0.3) !important;
        color: white !important;
    }

    #videoSelectorModal .modal-footer.video-selector-footer .btn-primary:hover:not(:disabled),
    #mediaSelectorModal .modal-footer.video-selector-footer .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(74, 85, 104, 0.4) !important;
    }

    #videoSelectorModal .modal-footer.video-selector-footer .btn-primary:disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
    }

    /* Estilos para el Itinerario */
    .itinerary-day-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .itinerary-day-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: #adb5bd;
    }

    .itinerary-day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #dee2e6;
    }

    .itinerary-day-title {
        font-weight: 600;
        color: #495057;
        font-size: 1.05rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .itinerary-day-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #0d6efd;
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .itinerary-schedule-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 0.875rem;
        margin-bottom: 0.75rem;
        display: flex;
        gap: 1rem;
        align-items: start;
    }

    .itinerary-schedule-item:last-child {
        margin-bottom: 0;
    }

    .itinerary-time-input {
        flex: 0 0 120px;
    }

    .itinerary-activity-input {
        flex: 1;
    }

    .itinerary-schedule-remove {
        flex: 0 0 auto;
        padding-top: 0.375rem;
    }

    /* Estilos para los Items de "Incluye" */
    .includes-item-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .includes-item-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: #adb5bd;
    }

    .includes-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #dee2e6;
    }

    .includes-item-title-input {
        flex: 1;
        margin-right: 1rem;
    }

    .includes-item-order-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #28a745;
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .includes-item-description-textarea {
        width: 100%;
        margin-bottom: 1rem;
        min-height: 80px;
    }

    .includes-item-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .includes-item-active-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .includes-container {
        margin-top: 1rem;
    }

    .add-include-btn {
        margin-top: 1rem;
    }

    /* Estilos adicionales para editores HTML */
    .html-editor-wrapper {
        position: relative;
    }
    .html-editor-wrapper .ql-container {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
        border: 1px solid #dee2e6;
        border-top: none;
    }
    .html-editor-wrapper .ql-toolbar {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
        border: 1px solid #dee2e6;
        border-bottom: none;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    .html-editor-wrapper .ql-editor {
        min-height: 300px;
        font-family: Inter, sans-serif;
        font-size: 14px;
    }
    /* Ocultar el textarea original pero mantenerlo para el formulario */
    .html-editor-wrapper textarea[name="description"],
    .html-editor-wrapper textarea[name="email_welcome_body"],
    .html-editor-wrapper textarea#id_description,
    .html-editor-wrapper textarea#id_email_welcome_body {
        display: none !important;
        visibility: hidden !important;
        position: absolute !important;
        width: 0 !important;
        height: 0 !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    /* Asegurar que solo el textarea HTML del editor esté visible cuando corresponde */
    #description-html-editor,
    #email-body-html-editor {
        display: none;
    }

    /* Estilos para el botón de alternancia HTML/Visual */
    .ql-html-toggle {
        padding: 4px 8px !important;
        background: #fff !important;
        border: 1px solid #ccc !important;
        border-radius: 3px !important;
        cursor: pointer !important;
        font-size: 12px !important;
        color: #444 !important;
        transition: all 0.2s ease !important;
        display: inline-flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 4px !important;
        margin: 0 !important;
        font-weight: 500 !important;
        white-space: nowrap !important;
        vertical-align: middle !important;
        line-height: 1.4 !important;
        height: 24px !important;
        width: auto !important;
        min-width: auto !important;
        box-sizing: border-box !important;
    }

    .ql-html-toggle:hover {
        background: #f0f0f0 !important;
        border-color: #999 !important;
        color: #000 !important;
    }

    .ql-html-toggle.active {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
        color: #fff !important;
    }

    .ql-html-toggle.active:hover {
        background: #0b5ed7 !important;
        border-color: #0a58ca !important;
        color: #fff !important;
    }

    .ql-html-toggle i {
        font-size: 11px !important;
        line-height: 1 !important;
        display: inline-block !important;
        flex-shrink: 0 !important;
        width: auto !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        vertical-align: middle !important;
    }

    .ql-html-toggle span {
        font-size: 12px !important;
        line-height: 1 !important;
        display: inline-block !important;
        white-space: nowrap !important;
        width: auto !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        vertical-align: middle !important;
    }

    /* Asegurar que el contenedor del botón se alinee correctamente */
    .ql-toolbar .ql-formats:last-child {
        margin-left: auto !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        flex-wrap: nowrap !important;
        border-left: 1px solid #ccc !important;
        padding-left: 8px !important;
        margin-left: 8px !important;
    }

    /* Estilos para el editor HTML (solo visible cuando se activa el modo HTML) */
    #description-html-editor,
    #email-body-html-editor {
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        padding: 12px;
        resize: vertical;
        line-height: 1.5;
        width: 100%;
        box-sizing: border-box;
        background: #fff;
        display: none !important;
    }

    /* Mostrar el editor HTML solo cuando está activo */
    #description-html-editor[style*="display: block"],
    #email-body-html-editor[style*="display: block"] {
        display: block !important;
    }

    #description-html-editor:focus,
    #email-body-html-editor:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Cuando el editor HTML está visible, mantener el borde superior de la toolbar */
    .html-editor-wrapper .ql-toolbar {
        border-bottom: 1px solid #dee2e6;
    }

    /* Asegurar que el contenedor del editor HTML tenga el mismo estilo que el contenedor de Quill */
    #description-editor-container,
    #email-body-editor-container,
    #description-player-editor-container,
    #description-team-manager-editor-container,
    #description-spectator-editor-container {
        position: relative;
        display: block !important;
        visibility: visible !important;
        width: 100%;
    }

    /* Asegurar que el editor Quill sea visible */
    #description-editor,
    #description-player-editor,
    #description-team-manager-editor,
    #description-spectator-editor {
        display: block !important;
        visibility: visible !important;
        min-height: 300px !important;
    }

    /* Asegurar que el editor Quill tenga el estilo correcto */
    #description-editor .ql-editor,
    #description-player-editor .ql-editor,
    #description-team-manager-editor .ql-editor,
    #description-spectator-editor .ql-editor {
        min-height: 300px !important;
        padding: 12px 15px !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
        pointer-events: auto !important;
        user-select: text !important;
        cursor: text !important;
    }

    /* Asegurar que el editor Quill esté habilitado para escribir */
    #description-team-manager-editor .ql-editor[contenteditable="true"],
    #description-spectator-editor .ql-editor[contenteditable="true"],
    #description-team-manager-editor .ql-editor,
    #description-spectator-editor .ql-editor {
        pointer-events: auto !important;
        user-select: text !important;
        cursor: text !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
    }

    /* Asegurar que el contenedor del editor permita interacción */
    #description-team-manager-editor-container,
    #description-spectator-editor-container {
        pointer-events: auto !important;
    }

    /* Asegurar que el contenedor de Quill permita interacción */
    #description-team-manager-editor .ql-container,
    #description-spectator-editor .ql-container {
        pointer-events: auto !important;
    }

    /* Asegurar que la toolbar de Quill sea visible */
    #description-editor .ql-toolbar,
    #description-player-editor .ql-toolbar,
    #description-team-manager-editor .ql-toolbar,
    #description-spectator-editor .ql-toolbar {
        display: flex !important;
        visibility: visible !important;
        border: 1px solid #ccc !important;
        border-bottom: none !important;
        background: #fafafa !important;
    }

    /* Botón flotante de submit (sticky) */
    .floating-submit-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid #dee2e6;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
        padding: 1rem 2rem;
        z-index: 1050;
        display: none;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .floating-submit-container.show {
        display: block;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .floating-submit-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.75rem;
    }

    .floating-submit-container .btn {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
    }

    .floating-submit-container .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .floating-submit-container .btn-outline-light {
        background: white;
        color: #495057;
        border-color: #dee2e6;
    }

    .floating-submit-container .btn-outline-light:hover {
        background: #f8f9fa;
        color: #212529;
        border-color: #adb5bd;
    }

    /* Espaciado adicional al final del formulario para que el botón flotante no cubra contenido */
    #submit-buttons-section {
        margin-bottom: 100px;
    }

    /* Ajustar padding cuando el botón flotante está visible */
    @media (max-width: 768px) {
        .floating-submit-container {
            padding: 0.75rem 1rem;
        }

        .floating-submit-content {
            flex-direction: column;
            gap: 0.5rem;
        }

        .floating-submit-content .btn {
            width: 100%;
        }

        #submit-buttons-section {
            margin-bottom: 120px;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="event-form-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas {% if form.instance.pk %}fa-edit{% else %}fa-calendar-plus{% endif %} me-2 text-primary"></i>
                        {% if form.instance.pk %}Editar Evento{% else %}Crear Nuevo Evento{% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if form.instance.pk %}
                            Modifica la información del evento
                        {% else %}
                            Completa la información para crear un nuevo evento
                        {% endif %}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    {% if form.instance.pk %}
                        <a href="{% url 'events:admin_detail' form.instance.pk %}" class="btn btn-outline-secondary">
                            <i class="fas fa-eye me-2"></i>Ver Detalle
                        </a>
                    {% endif %}
                    <a href="{% url 'events:list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver a Eventos
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0 text-primary">
                        <i class="fas fa-info-circle me-2"></i>
                        Información del Evento
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="eventForm" class="needs-validation" novalidate>
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- INFORMACIÓN GENERAL DEL EVENTO -->
                        <div class="form-section mb-4">
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                <h6 class="mb-0 text-primary fw-bold">Información General del Evento</h6>
                            </div>

                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="{{ form.title.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-heading me-1 text-muted"></i>
                                        Nombre del Evento
                                        {% if form.title.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                        <div class="text-danger small mt-1">{{ form.title.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-12">
                                    <label for="id_description" class="form-label fw-semibold">
                                        <i class="fas fa-align-left me-1 text-muted"></i>
                                        Descripción General del Evento
                                        {% if form.description.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="html-editor-wrapper">
                                        <textarea name="description" id="id_description" class="form-control" style="display: none;">{{ form.description.value|default:'' }}</textarea>
                                        <div id="description-editor-container">
                                            <div id="description-editor" style="min-height: 300px;"></div>
                                            <textarea id="description-html-editor" class="form-control" style="display: none; min-height: 300px; font-family: 'Courier New', monospace; font-size: 13px;" placeholder="Edite el HTML directamente aquí..."></textarea>
                                        </div>
                                    </div>
                                    {% if form.description.errors %}
                                        <div class="text-danger small mt-1">{{ form.description.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>Puede usar HTML para formatear el texto (etiquetas como &lt;strong&gt;, &lt;em&gt;, &lt;p&gt;, &lt;br&gt;, etc.)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- INFORMACIÓN DEL EVENTO POR TIPO DE USUARIO -->
                        <div class="form-section mb-4">
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <i class="fas fa-file-alt text-primary me-2"></i>
                                <h6 class="mb-0 text-primary fw-bold">Información del Evento por Tipo de Usuario</h6>
                            </div>

                            <!-- Tabs Navigation -->
                            <ul class="nav nav-tabs mb-4" id="eventInfoTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="individual-player-tab" data-bs-toggle="tab" data-bs-target="#individual-player" type="button" role="tab" aria-controls="individual-player" aria-selected="true">
                                        <i class="fas fa-user me-2"></i>Individual Player
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="team-manager-tab" data-bs-toggle="tab" data-bs-target="#team-manager" type="button" role="tab" aria-controls="team-manager" aria-selected="false">
                                        <i class="fas fa-users me-2"></i>Team Manager
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="spectator-tab" data-bs-toggle="tab" data-bs-target="#spectator" type="button" role="tab" aria-controls="spectator" aria-selected="false">
                                        <i class="fas fa-eye me-2"></i>Spectator
                                    </button>
                                </li>
                            </ul>

                            <!-- Tabs Content -->
                            <div class="tab-content" id="eventInfoTabsContent">
                                <!-- Individual Player Tab -->
                                <div class="tab-pane fade show active" id="individual-player" role="tabpanel" aria-labelledby="individual-player-tab">
                                    <div class="row g-3">
                                <div class="col-12">
                                    <label for="id_description_player" class="form-label fw-semibold">
                                        <i class="fas fa-align-left me-1 text-muted"></i>
                                        Descripción del Evento (Player)
                                        {% if form.description.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="html-editor-wrapper">
                                        <textarea name="description_player" id="id_description_player" class="form-control" style="display: none;">{{ form.description_player.value|default:'' }}</textarea>
                                        <div id="description-player-editor-container">
                                            <div id="description-player-editor" style="min-height: 300px;"></div>
                                            <textarea id="description-player-html-editor" class="form-control" style="display: none; min-height: 300px; font-family: 'Courier New', monospace; font-size: 13px;" placeholder="Edite el HTML directamente aquí..."></textarea>
                                                </div>
                                    </div>
                                    {% if form.description_player.errors %}
                                        <div class="text-danger small mt-1">{{ form.description_player.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>Puede usar HTML para formatear el texto (etiquetas como &lt;strong&gt;, &lt;em&gt;, &lt;p&gt;, &lt;br&gt;, etc.)
                                    </small>
                                        </div>

                                        <!-- ITINERARIO DEL EVENTO -->
                                        <div class="col-12 mt-4" id="itinerary-section">
                                            <div class="border-top pt-3">
                                                <div class="d-flex align-items-center justify-content-between mb-3">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-route text-primary me-2"></i>
                                                        <h6 class="mb-0 text-primary fw-bold">Itinerario del Evento</h6>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="generate-itinerary-btn" style="display: none;">
                                                        <i class="fas fa-magic me-1"></i>Generar Días Automáticamente
                                                    </button>
                                                </div>

                                                <div class="alert alert-info mb-3">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Nota:</strong> El itinerario se generará automáticamente según las fechas de inicio y fin del evento.
                                                    Puedes agregar, editar o eliminar días según sea necesario.
                                                </div>

                                                <div id="itinerary-container">
                                                    <!-- Los días del itinerario se generarán aquí dinámicamente -->
                                                </div>

                                                <button type="button" class="btn btn-outline-success btn-sm mt-3" id="add-day-btn">
                                                    <i class="fas fa-plus me-1"></i>Agregar Día Manualmente
                                                </button>
                                            </div>
                                        </div>

                                        <!-- PRECIOS Y PAGOS - Individual Player -->
                                        <div class="col-12 mt-4">
                                            <div class="border-top pt-3">
                                                <h6 class="text-muted mb-3">
                                                    <i class="fas fa-dollar-sign me-2"></i>Precios y Pagos
                                                </h6>
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label for="{{ form.default_entry_fee.id_for_label }}" class="form-label fw-semibold">
                                                            <i class="fas fa-money-bill-wave me-1 text-muted"></i>
                                                            {{ form.default_entry_fee.label }}
                                                            {% if form.default_entry_fee.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">$</span>
                                                            {{ form.default_entry_fee }}
                                                        </div>
                                                        {% if form.default_entry_fee.errors %}
                                                            <div class="text-danger small mt-1">{{ form.default_entry_fee.errors }}</div>
                                                        {% endif %}
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="{{ form.payment_deadline.id_for_label }}" class="form-label fw-semibold">
                                                            <i class="fas fa-calendar-exclamation me-1 text-muted"></i>
                                                            {{ form.payment_deadline.label }}
                                                            {% if form.payment_deadline.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        {{ form.payment_deadline }}
                                                        {% if form.payment_deadline.errors %}
                                                            <div class="text-danger small mt-1">{{ form.payment_deadline.errors }}</div>
                                                        {% endif %}
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="{{ form.gate_fee_type.id_for_label }}" class="form-label fw-semibold">
                                                            <i class="fas fa-ticket-alt me-1 text-muted"></i>
                                                            {{ form.gate_fee_type.label }}
                                                            {% if form.gate_fee_type.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        {{ form.gate_fee_type }}
                                                        {% if form.gate_fee_type.errors %}
                                                            <div class="text-danger small mt-1">{{ form.gate_fee_type.errors }}</div>
                                                        {% endif %}
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="{{ form.gate_fee_amount.id_for_label }}" class="form-label fw-semibold">
                                                            <i class="fas fa-dollar-sign me-1 text-muted"></i>
                                                            {{ form.gate_fee_amount.label }}
                                                            {% if form.gate_fee_amount.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">$</span>
                                                            {{ form.gate_fee_amount }}
                                                        </div>
                                                        {% if form.gate_fee_amount.errors %}
                                                            <div class="text-danger small mt-1">{{ form.gate_fee_amount.errors }}</div>
                                                        {% endif %}
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="{{ form.service_fee.id_for_label }}" class="form-label fw-semibold">
                                                            <i class="fas fa-percentage me-1 text-muted"></i>
                                                            {{ form.service_fee.label }}
                                                            {% if form.service_fee.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            {{ form.service_fee }}
                                                            <span class="input-group-text">%</span>
                                                        </div>
                                                        {% if form.service_fee.errors %}
                                                            <div class="text-danger small mt-1">{{ form.service_fee.errors }}</div>
                                                        {% endif %}
                                                        <small class="text-muted d-block mt-1">
                                                            <i class="fas fa-info-circle me-1"></i>Porcentaje que se aplicará al total del checkout
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- INCLUYE - Individual Player -->
                                        <div class="col-12 mt-4" id="includes-section-player">
                                            <div class="border-top pt-3">
                                                <div class="d-flex align-items-center mb-3">
                                                    <i class="fas fa-check-circle text-primary me-2"></i>
                                                    <h6 class="mb-0 text-primary fw-bold">Incluye (Player)</h6>
                                                </div>

                                                <div class="alert alert-info mb-3">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Nota:</strong> Agrega los items que están incluidos en este evento para jugadores individuales.
                                                </div>

                                                <div id="includes-container-player" class="includes-container">
                                                    <!-- Los items incluidos se generarán aquí dinámicamente -->
                                                </div>

                                                <button type="button" class="btn btn-outline-success btn-sm mt-3 add-include-btn" data-user-type="player">
                                                    <i class="fas fa-plus me-1"></i>Agregar Item
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Team Manager Tab -->
                                <div class="tab-pane fade" id="team-manager" role="tabpanel" aria-labelledby="team-manager-tab">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="id_title_team_manager" class="form-label fw-semibold">
                                                <i class="fas fa-heading me-1 text-muted"></i>
                                                Nombre del Evento
                                                {% if form.title.field.required %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            <input type="text" name="title_team_manager" id="id_title_team_manager" class="form-control" placeholder="Nombre del Evento" value="{{ form.title_team_manager.value|default:'' }}">
                                        </div>

                                        <div class="col-12">
                                            <label for="id_description_team_manager" class="form-label fw-semibold">
                                                <i class="fas fa-align-left me-1 text-muted"></i>
                                                Descripción del Evento (Team Manager)
                                            </label>
                                            <div class="html-editor-wrapper">
                                                <textarea name="description_team_manager" id="id_description_team_manager" class="form-control" style="display: none;">{{ form.description_team_manager.value|default:'' }}</textarea>
                                                <div id="description-team-manager-editor-container">
                                                    <div id="description-team-manager-editor" style="min-height: 300px;"></div>
                                                    <textarea id="description-team-manager-html-editor" class="form-control" style="display: none; min-height: 300px; font-family: 'Courier New', monospace; font-size: 13px;" placeholder="Edite el HTML directamente aquí..."></textarea>
                                                </div>
                                            </div>
                                            <small class="text-muted d-block mt-1">
                                                <i class="fas fa-info-circle me-1"></i>Puede usar HTML para formatear el texto (etiquetas como &lt;strong&gt;, &lt;em&gt;, &lt;p&gt;, &lt;br&gt;, etc.)
                                            </small>
                                        </div>

                                        <!-- PRECIOS Y PAGOS - Team Manager -->
                                        <div class="col-12 mt-4">
                                            <div class="border-top pt-3">
                                                <h6 class="text-muted mb-3">
                                                    <i class="fas fa-dollar-sign me-2"></i>Precios y Pagos
                                                </h6>
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label for="id_default_entry_fee_team_manager" class="form-label fw-semibold">
                                                            <i class="fas fa-money-bill-wave me-1 text-muted"></i>
                                                            {{ form.default_entry_fee.label }}
                                                            {% if form.default_entry_fee.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">$</span>
                                                            <input type="number" name="default_entry_fee_team_manager" id="id_default_entry_fee_team_manager" class="form-control" step="0.01" placeholder="0.00" value="{{ form.default_entry_fee_team_manager.value|default:'' }}">
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="id_payment_deadline_team_manager" class="form-label fw-semibold">
                                                            <i class="fas fa-calendar-exclamation me-1 text-muted"></i>
                                                            {{ form.payment_deadline.label }}
                                                            {% if form.payment_deadline.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <input type="date" name="payment_deadline_team_manager" id="id_payment_deadline_team_manager" class="form-control" value="{{ form.payment_deadline_team_manager.value|default:'' }}">
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="id_gate_fee_type_team_manager" class="form-label fw-semibold">
                                                            <i class="fas fa-ticket-alt me-1 text-muted"></i>
                                                            {{ form.gate_fee_type.label }}
                                                            {% if form.gate_fee_type.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <select name="gate_fee_type_team_manager" id="id_gate_fee_type_team_manager" class="form-select">
                                                            <option value="">---------</option>
                                                            {% for value, label in form.gate_fee_type.field.choices %}
                                                                {% if value %}
                                                                    <option value="{{ value }}" {% if form.gate_fee_type_team_manager.value == value %}selected{% endif %}>{{ label }}</option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="id_gate_fee_amount_team_manager" class="form-label fw-semibold">
                                                            <i class="fas fa-dollar-sign me-1 text-muted"></i>
                                                            {{ form.gate_fee_amount.label }}
                                                            {% if form.gate_fee_amount.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">$</span>
                                                            <input type="number" name="gate_fee_amount_team_manager" id="id_gate_fee_amount_team_manager" class="form-control" step="0.01" placeholder="0.00" value="{{ form.gate_fee_amount_team_manager.value|default:'' }}">
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="id_service_fee_team_manager" class="form-label fw-semibold">
                                                            <i class="fas fa-percentage me-1 text-muted"></i>
                                                            {{ form.service_fee.label }}
                                                            {% if form.service_fee.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="number" name="service_fee_team_manager" id="id_service_fee_team_manager" class="form-control" step="0.01" placeholder="0.00" value="{{ form.service_fee_team_manager.value|default:'' }}">
                                                            <span class="input-group-text">%</span>
                                                        </div>
                                                        <small class="text-muted d-block mt-1">
                                                            <i class="fas fa-info-circle me-1"></i>Porcentaje que se aplicará al total del checkout
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- INCLUYE - Team Manager -->
                                        <div class="col-12 mt-4" id="includes-section-team-manager">
                                            <div class="border-top pt-3">
                                                <div class="d-flex align-items-center mb-3">
                                                    <i class="fas fa-check-circle text-primary me-2"></i>
                                                    <h6 class="mb-0 text-primary fw-bold">Incluye (Team Manager)</h6>
                                                </div>

                                                <div class="alert alert-info mb-3">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Nota:</strong> Agrega los items que están incluidos en este evento para team managers.
                                                </div>

                                                <div id="includes-container-team-manager" class="includes-container">
                                                    <!-- Los items incluidos se generarán aquí dinámicamente -->
                                                </div>

                                                <button type="button" class="btn btn-outline-success btn-sm mt-3 add-include-btn" data-user-type="team_manager">
                                                    <i class="fas fa-plus me-1"></i>Agregar Item
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Spectator Tab -->
                                <div class="tab-pane fade" id="spectator" role="tabpanel" aria-labelledby="spectator-tab">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="id_title_spectator" class="form-label fw-semibold">
                                                <i class="fas fa-heading me-1 text-muted"></i>
                                                Nombre del Evento
                                                {% if form.title.field.required %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            <input type="text" name="title_spectator" id="id_title_spectator" class="form-control" placeholder="Nombre del Evento" value="{{ form.title_spectator.value|default:'' }}">
                                        </div>

                                        <div class="col-12">
                                            <label for="id_description_spectator" class="form-label fw-semibold">
                                                <i class="fas fa-align-left me-1 text-muted"></i>
                                                Descripción del Evento (Spectator)
                                            </label>
                                            <div class="html-editor-wrapper">
                                                <textarea name="description_spectator" id="id_description_spectator" class="form-control" style="display: none;">{{ form.description_spectator.value|default:'' }}</textarea>
                                                <div id="description-spectator-editor-container">
                                                    <div id="description-spectator-editor" style="min-height: 300px;"></div>
                                                    <textarea id="description-spectator-html-editor" class="form-control" style="display: none; min-height: 300px; font-family: 'Courier New', monospace; font-size: 13px;" placeholder="Edite el HTML directamente aquí..."></textarea>
                                                </div>
                                            </div>
                                            <small class="text-muted d-block mt-1">
                                                <i class="fas fa-info-circle me-1"></i>Puede usar HTML para formatear el texto (etiquetas como &lt;strong&gt;, &lt;em&gt;, &lt;p&gt;, &lt;br&gt;, etc.)
                                            </small>
                                        </div>

                                        <!-- PRECIOS Y PAGOS - Spectator -->
                                        <div class="col-12 mt-4">
                                            <div class="border-top pt-3">
                                                <h6 class="text-muted mb-3">
                                                    <i class="fas fa-dollar-sign me-2"></i>Precios y Pagos
                                                </h6>
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label for="id_default_entry_fee_spectator" class="form-label fw-semibold">
                                                            <i class="fas fa-money-bill-wave me-1 text-muted"></i>
                                                            {{ form.default_entry_fee.label }}
                                                            {% if form.default_entry_fee.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">$</span>
                                                            <input type="number" name="default_entry_fee_spectator" id="id_default_entry_fee_spectator" class="form-control" step="0.01" placeholder="0.00" value="{{ form.default_entry_fee_spectator.value|default:'' }}">
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="id_payment_deadline_spectator" class="form-label fw-semibold">
                                                            <i class="fas fa-calendar-exclamation me-1 text-muted"></i>
                                                            {{ form.payment_deadline.label }}
                                                            {% if form.payment_deadline.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <input type="date" name="payment_deadline_spectator" id="id_payment_deadline_spectator" class="form-control" value="{{ form.payment_deadline_spectator.value|default:'' }}">
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="id_gate_fee_type_spectator" class="form-label fw-semibold">
                                                            <i class="fas fa-ticket-alt me-1 text-muted"></i>
                                                            {{ form.gate_fee_type.label }}
                                                            {% if form.gate_fee_type.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <select name="gate_fee_type_spectator" id="id_gate_fee_type_spectator" class="form-select">
                                                            <option value="">---------</option>
                                                            {% for value, label in form.gate_fee_type.field.choices %}
                                                                {% if value %}
                                                                    <option value="{{ value }}" {% if form.gate_fee_type_spectator.value == value %}selected{% endif %}>{{ label }}</option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="id_gate_fee_amount_spectator" class="form-label fw-semibold">
                                                            <i class="fas fa-dollar-sign me-1 text-muted"></i>
                                                            {{ form.gate_fee_amount.label }}
                                                            {% if form.gate_fee_amount.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">$</span>
                                                            <input type="number" name="gate_fee_amount_spectator" id="id_gate_fee_amount_spectator" class="form-control" step="0.01" placeholder="0.00" value="{{ form.gate_fee_amount_spectator.value|default:'' }}">
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label for="id_service_fee_spectator" class="form-label fw-semibold">
                                                            <i class="fas fa-percentage me-1 text-muted"></i>
                                                            {{ form.service_fee.label }}
                                                            {% if form.service_fee.field.required %}<span class="text-danger">*</span>{% endif %}
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="number" name="service_fee_spectator" id="id_service_fee_spectator" class="form-control" step="0.01" placeholder="0.00" value="{{ form.service_fee_spectator.value|default:'' }}">
                                                            <span class="input-group-text">%</span>
                                                        </div>
                                                        <small class="text-muted d-block mt-1">
                                                            <i class="fas fa-info-circle me-1"></i>Porcentaje que se aplicará al total del checkout
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- INCLUYE - Spectator -->
                                        <div class="col-12 mt-4" id="includes-section-spectator">
                                            <div class="border-top pt-3">
                                                <div class="d-flex align-items-center mb-3">
                                                    <i class="fas fa-check-circle text-primary me-2"></i>
                                                    <h6 class="mb-0 text-primary fw-bold">Incluye (Spectator)</h6>
                                    </div>

                                                <div class="alert alert-info mb-3">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Nota:</strong> Agrega los items que están incluidos en este evento para espectadores.
                                </div>

                                                <div id="includes-container-spectator" class="includes-container">
                                                    <!-- Los items incluidos se generarán aquí dinámicamente -->
                                                </div>

                                                <button type="button" class="btn btn-outline-success btn-sm mt-3 add-include-btn" data-user-type="spectator">
                                                    <i class="fas fa-plus me-1"></i>Agregar Item
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- INFORMACIÓN BÁSICA -->
                        <div class="form-section mb-4">
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                <h6 class="mb-0 text-primary fw-bold">Información Básica</h6>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.season.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-calendar-alt me-1 text-muted"></i>
                                        {{ form.season.label }}
                                        {% if form.season.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {{ form.season }}
                                    {% if form.season.errors %}
                                        <div class="text-danger small mt-1">{{ form.season.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label for="{{ form.event_type.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-tag me-1 text-muted"></i>
                                        {{ form.event_type.label }}
                                        {% if form.event_type.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {{ form.event_type }}
                                    {% if form.event_type.errors %}
                                        <div class="text-danger small mt-1">{{ form.event_type.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-layer-group me-1 text-muted"></i>
                                        {{ form.divisions.label }}
                                        {% if form.divisions.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>

                                    <!-- Buscador -->
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input
                                                type="text"
                                                id="division_search"
                                                class="form-control"
                                                placeholder="Buscar divisiones..."
                                                autocomplete="off"
                                            />
                                        </div>
                                    </div>

                                    <!-- Lista de divisiones seleccionadas (chips) -->
                                    <div id="selected_divisions_chips" class="mb-3 d-flex flex-wrap gap-2 min-height-50">
                                        <span class="text-muted small" id="no_selected_divisions_message">Ninguna división seleccionada</span>
                                    </div>

                                    <!-- Lista de divisiones disponibles -->
                                    <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                                        <div id="divisions_list" class="list-group list-group-flush">
                                            <!-- Las divisiones se cargarán aquí dinámicamente -->
                                        </div>
                                        <div id="no_divisions_found" class="text-muted text-center py-3" style="display: none;">
                                            <i class="fas fa-search me-2"></i>No se encontraron divisiones
                                        </div>
                                    </div>

                                    <!-- Campos hidden para los valores seleccionados -->
                                    <div id="divisions_hidden" style="display: none;">
                                        {{ form.divisions }}
                                    </div>

                                    <!-- Mensaje cuando no hay divisiones disponibles -->
                                    {% if form.divisions.field.queryset.count == 0 %}
                                    <div class="alert alert-warning mt-2 mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>No hay divisiones disponibles.</strong><br>
                                        <small>Por favor, cree divisiones desde la sección <strong>"Configuración" → "Divisiones"</strong> en el menú lateral.</small>
                                    </div>
                                    {% endif %}

                                    {% if form.divisions.errors %}
                                        <div class="text-danger small mt-1">{{ form.divisions.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- UBICACIÓN -->
                        <div class="form-section mb-4">
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                <h6 class="mb-0 text-primary fw-bold">Ubicación del Evento</h6>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="country_search" class="form-label fw-semibold">
                                        <i class="fas fa-flag me-1 text-muted"></i>
                                        {{ form.country.label }}
                                        {% if form.country.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="autocomplete-wrapper">
                                        <input
                                            type="text"
                                            id="country_search"
                                            class="form-control autocomplete-input"
                                            placeholder="Buscar país..."
                                            autocomplete="off"
                                        />
                                        <div id="country_suggestions" class="autocomplete-suggestions"></div>
                                    </div>
                                    <input type="hidden" id="id_country" name="country" value="{% if form.country.value %}{{ form.country.value }}{% endif %}" />
                                    {% if form.country.errors %}
                                        <div class="text-danger small mt-1">{{ form.country.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label for="state_search" class="form-label fw-semibold">
                                        <i class="fas fa-map me-1 text-muted"></i>
                                        {{ form.state.label }}
                                        {% if form.state.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="autocomplete-wrapper">
                                        <input
                                            type="text"
                                            id="state_search"
                                            class="form-control autocomplete-input"
                                            placeholder="Primero seleccione un país"
                                            autocomplete="off"
                                            disabled
                                        />
                                        <div id="state_suggestions" class="autocomplete-suggestions"></div>
                                    </div>
                                    <input type="hidden" id="id_state" name="state" value="{% if form.state.value %}{{ form.state.value }}{% endif %}" />
                                    {% if form.state.errors %}
                                        <div class="text-danger small mt-1">{{ form.state.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label for="city_search" class="form-label fw-semibold">
                                        <i class="fas fa-city me-1 text-muted"></i>
                                        {{ form.city.label }}
                                        {% if form.city.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="autocomplete-wrapper">
                                        <input
                                            type="text"
                                            id="city_search"
                                            class="form-control autocomplete-input"
                                            placeholder="Primero seleccione país y estado"
                                            autocomplete="off"
                                            disabled
                                        />
                                        <div id="city_suggestions" class="autocomplete-suggestions"></div>
                                    </div>
                                    <input type="hidden" id="id_city" name="city" value="{% if form.city.value %}{{ form.city.value }}{% endif %}" />
                                    {% if form.city.errors %}
                                        <div class="text-danger small mt-1">{{ form.city.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label for="{{ form.rule.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-book me-1 text-muted"></i>
                                        {{ form.rule.label }}
                                        {% if form.rule.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {{ form.rule }}
                                    {% if form.rule.errors %}
                                        <div class="text-danger small mt-1">{{ form.rule.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- SITIOS Y HOTELES -->
                        <div class="form-section mb-4">
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <i class="fas fa-building text-primary me-2"></i>
                                <h6 class="mb-0 text-primary fw-bold">Sitios y Hoteles</h6>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="primary_site_autocomplete" class="form-label fw-semibold">
                                        <i class="fas fa-map-marker-alt me-1 text-muted"></i>
                                        {{ form.primary_site.label }}
                                        {% if form.primary_site.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>

                                    <!-- Campo de autocomplete -->
                                    <div class="position-relative">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input
                                                type="text"
                                                id="primary_site_autocomplete"
                                                class="form-control"
                                                placeholder="Buscar y seleccionar sitio..."
                                                autocomplete="off"
                                            />
                                        </div>

                                        <!-- Dropdown de sugerencias -->
                                        <div id="primary_site_dropdown" class="list-group position-absolute w-100" style="display: none; z-index: 1000; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; background: white; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);">
                                            <!-- Las sugerencias se cargarán aquí -->
                                        </div>

                                    <!-- Campo hidden para el ID del sitio -->
                                    <!-- Campo hidden para el ID del sitio (este es el que se envía) -->
                                    <input type="hidden" id="primary_site_id" name="primary_site" value="{% if form.instance.pk and form.instance.primary_site %}{{ form.instance.primary_site.id }}{% elif form.primary_site.value %}{{ form.primary_site.value }}{% endif %}">

                                    <!-- Ocultar el campo original del formulario (sin name para que no se envíe) -->
                                    <div style="display: none;">
                                        {{ form.primary_site }}
                                    </div>
                                    <script>
                                        // Remover el name del select original para evitar conflictos
                                        // Solo el input hidden debe tener name="primary_site"
                                        (function() {
                                            function removeSelectName() {
                                                // Buscar el select que Django generó para primary_site
                                                const originalSelect = document.querySelector('select[id^="id_primary_site"]');
                                                if (originalSelect && originalSelect.getAttribute('name') === 'primary_site') {
                                                    originalSelect.removeAttribute('name');
                                                    console.log('Removido name del select original de primary_site para evitar conflictos');
                                                    return true;
                                                }
                                                return false;
                                            }

                                            // Intentar inmediatamente
                                            if (!removeSelectName()) {
                                                // Si no se encuentra, intentar después de que el DOM esté listo
                                                if (document.readyState === 'loading') {
                                                    document.addEventListener('DOMContentLoaded', function() {
                                                        setTimeout(removeSelectName, 100);
                                                    });
                                                } else {
                                                    setTimeout(removeSelectName, 100);
                                                }
                                            }
                                        })();
                                    </script>

                                        <!-- Sitio seleccionado (chip) -->
                                        <div id="primary_site_selected" class="mt-2" style="display: none;">
                                            <span class="badge bg-primary d-flex align-items-center gap-2" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span id="primary_site_name"></span>
                                                <button
                                                    type="button"
                                                    class="btn-close btn-close-white"
                                                    style="font-size: 0.7rem;"
                                                    onclick="clearPrimarySite()"
                                                    aria-label="Eliminar"
                                                ></button>
                                            </span>
                                        </div>
                                    </div>

                                    {% if form.primary_site.errors %}
                                        <div class="text-danger small mt-1">{{ form.primary_site.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-map-marked-alt me-1 text-muted"></i>
                                        {{ form.additional_sites.label }}
                                        {% if form.additional_sites.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>

                                    <!-- Buscador -->
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input
                                                type="text"
                                                id="site_search"
                                                class="form-control"
                                                placeholder="Buscar sitios..."
                                                autocomplete="off"
                                            />
                                        </div>
                                    </div>

                                    <!-- Lista de sitios seleccionados (chips) -->
                                    <div id="selected_sites_chips" class="mb-3 d-flex flex-wrap gap-2 min-height-50">
                                        <span class="text-muted small" id="no_selected_message">Ningún sitio seleccionado</span>
                                    </div>

                                    <!-- Lista de sitios disponibles -->
                                    <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                                        <div id="sites_list" class="list-group list-group-flush">
                                            <!-- Los sitios se cargarán aquí dinámicamente -->
                                        </div>
                                        <div id="no_sites_found" class="text-muted text-center py-3" style="display: none;">
                                            <i class="fas fa-search me-2"></i>No se encontraron sitios
                                        </div>
                                    </div>

                                    <!-- Campos hidden para los valores seleccionados -->
                                    <div id="additional_sites_hidden" style="display: none;">
                                        {{ form.additional_sites }}
                                    </div>

                                    {% if form.additional_sites.errors %}
                                        <div class="text-danger small mt-1">{{ form.additional_sites.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Separador visual entre Sitios y Hoteles -->
                            <div class="my-4 border-top pt-4">
                                <h6 class="text-muted mb-3 fw-semibold">
                                    <i class="fas fa-hotel me-2"></i>Hoteles
                                </h6>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="hotel_autocomplete" class="form-label fw-semibold">
                                        <i class="fas fa-hotel me-1 text-muted"></i>
                                        {{ form.hotel.label }}
                                        {% if form.hotel.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>

                                    {% comment %}DEBUG HOTEL:
                                    - form.instance.pk: {{ form.instance.pk|default:"None" }}
                                    - form.instance.hotel: {{ form.instance.hotel|default:"None" }}
                                    - form.instance.hotel.id: {% if form.instance.hotel %}{{ form.instance.hotel.id }}{% else %}None{% endif %}
                                    - form.hotel.value: {{ form.hotel.value|default:"None" }}
                                    - form.hotel.initial: {{ form.hotel.initial|default:"None" }}
                                    - form.hotel.initial.id: {% if form.hotel.initial %}{{ form.hotel.initial.id }}{% else %}None{% endif %}
                                    {% endcomment %}

                                    <!-- Campo de autocomplete -->
                                    <div class="position-relative">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input
                                                type="text"
                                                id="hotel_autocomplete"
                                                class="form-control"
                                                placeholder="Buscar y seleccionar hotel..."
                                                autocomplete="off"
                                            />
                                        </div>

                                        <!-- Dropdown de sugerencias -->
                                        <div id="hotel_dropdown" class="list-group position-absolute w-100" style="display: none; z-index: 1000; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; background: white; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);">
                                            <!-- Las sugerencias se cargarán aquí -->
                                        </div>

                                        <!-- Campo hidden para el ID del hotel -->
                                        {% comment %}
                                        DEBUG HOTEL TEMPLATE:
                                        - form.instance.pk: {{ form.instance.pk|default:"None" }}
                                        - form.instance.hotel: {{ form.instance.hotel|default:"None" }}
                                        - form.instance.hotel.id: {% if form.instance.hotel %}{{ form.instance.hotel.id }}{% else %}None{% endif %}
                                        - form.hotel.value: {{ form.hotel.value|default:"None" }}
                                        - form.hotel.initial: {{ form.hotel.initial|default:"None" }}
                                        - form.hotel.initial.id: {% if form.hotel.initial %}{{ form.hotel.initial.id }}{% else %}None{% endif %}
                                        {% endcomment %}
                                        {% if form.instance.pk and form.instance.hotel %}
                                            <input type="hidden" id="hotel_id" name="hotel" value="{{ form.instance.hotel.id }}" data-debug="from-instance-hotel">
                                        {% elif form.hotel.value %}
                                            <input type="hidden" id="hotel_id" name="hotel" value="{{ form.hotel.value }}" data-debug="from-form-value">
                                        {% elif form.hotel.initial %}
                                            <input type="hidden" id="hotel_id" name="hotel" value="{{ form.hotel.initial.id }}" data-debug="from-form-initial">
                                        {% else %}
                                            <input type="hidden" id="hotel_id" name="hotel" value="" data-debug="empty">
                                        {% endif %}

                                        <!-- Hotel seleccionado (chip) -->
                                        <div id="hotel_selected" class="mt-2" style="display: none;">
                                            <span class="badge bg-primary d-flex align-items-center gap-2" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                                                <i class="fas fa-hotel"></i>
                                                <span id="hotel_name"></span>
                                                <button
                                                    type="button"
                                                    class="btn-close btn-close-white"
                                                    style="font-size: 0.7rem;"
                                                    onclick="clearHotel()"
                                                    aria-label="Eliminar"
                                                ></button>
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Ocultar el campo original del formulario -->
                                    <div style="display: none;">
                                        {{ form.hotel }}
                                    </div>
                                    <script>
                                        // Remover el name del select original para evitar conflictos
                                        // Solo el input hidden debe tener name="hotel"
                                        (function() {
                                            function removeSelectName() {
                                                // Buscar el select que Django generó para hotel
                                                const originalSelect = document.querySelector('select[id^="id_hotel"]');
                                                if (originalSelect && originalSelect.getAttribute('name') === 'hotel') {
                                                    originalSelect.removeAttribute('name');
                                                    console.log('Removido name del select original de hotel para evitar conflictos');
                                                    return true;
                                                }
                                                return false;
                                            }

                                            // Intentar inmediatamente
                                            if (!removeSelectName()) {
                                                // Si no se encuentra, intentar después de que el DOM esté listo
                                                if (document.readyState === 'loading') {
                                                    document.addEventListener('DOMContentLoaded', function() {
                                                        setTimeout(removeSelectName, 100);
                                                    });
                                                } else {
                                                    setTimeout(removeSelectName, 100);
                                                }
                                            }
                                        })();
                                    </script>

                                    {% if form.hotel.errors %}
                                        <div class="text-danger small mt-1">{{ form.hotel.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-hotel me-1 text-muted"></i>
                                        {{ form.additional_hotels.label }}
                                        {% if form.additional_hotels.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>

                                    <!-- Buscador -->
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input
                                                type="text"
                                                id="hotel_search"
                                                class="form-control"
                                                placeholder="Buscar hoteles..."
                                                autocomplete="off"
                                            />
                                        </div>
                                    </div>

                                    <!-- Lista de hoteles seleccionados (chips) -->
                                    <div id="selected_hotels_chips" class="mb-3 d-flex flex-wrap gap-2 min-height-50">
                                        <span class="text-muted small" id="no_selected_hotels_message">Ningún hotel seleccionado</span>
                                    </div>

                                    <!-- Lista de hoteles disponibles -->
                                    <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                                        <div id="hotels_list" class="list-group list-group-flush">
                                            <!-- Los hoteles se cargarán aquí dinámicamente -->
                                        </div>
                                        <div id="no_hotels_found" class="text-muted text-center py-3" style="display: none;">
                                            <i class="fas fa-search me-2"></i>No se encontraron hoteles
                                        </div>
                                    </div>

                                    <!-- Campos hidden para los valores seleccionados -->
                                    <div id="additional_hotels_hidden" style="display: none;">
                                        {{ form.additional_hotels }}
                                    </div>

                                    {% if form.additional_hotels.errors %}
                                        <div class="text-danger small mt-1">{{ form.additional_hotels.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- CONTACTOS -->
                        <div class="form-section mb-4">
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <i class="fas fa-users text-primary me-2"></i>
                                <h6 class="mb-0 text-primary fw-bold">Contactos</h6>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="contact_search" class="form-label fw-semibold">
                                        <i class="fas fa-search me-1 text-muted"></i>
                                        Buscar Contacto
                                    </label>
                                    <input
                                        type="text"
                                        id="contact_search"
                                        class="form-control mb-2"
                                        placeholder="Buscar por nombre o email..."
                                    />

                                    <!-- Lista de contactos seleccionados (chips) -->
                                    <div id="selected_contacts_chips" class="mb-3 d-flex flex-wrap gap-2 min-height-50">
                                        <span class="text-muted small" id="no_selected_contacts_message">Ningún contacto seleccionado</span>
                                    </div>

                                    <!-- Lista de contactos disponibles -->
                                    <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                                        <div id="contacts_list" class="list-group list-group-flush">
                                            <!-- Los contactos se cargarán aquí dinámicamente -->
                                        </div>
                                        <div id="no_contacts_found" class="text-muted text-center py-3" style="display: none;">
                                            <i class="fas fa-info-circle me-2"></i>No se encontraron contactos
                                        </div>
                                    </div>

                                    <!-- Checkboxes ocultos para enviar al servidor -->
                                    <div id="contacts_hidden" style="display: none;">
                                        {{ form.event_contact }}
                                    </div>

                                    {% if form.event_contact.errors %}
                                        <div class="text-danger small mt-1">{{ form.event_contact.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- MEDIOS Y COMUNICACIÓN -->
                        <div class="form-section mb-4">
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <i class="fas fa-images text-primary me-2"></i>
                                <h6 class="mb-0 text-primary fw-bold">Medios y Comunicación</h6>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.video_url.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-video me-1 text-muted"></i>
                                        {{ form.video_url.label }}
                                        {% if form.video_url.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="input-group">
                                    {{ form.video_url }}
                                        <button type="button" class="btn btn-outline-primary" data-media-type="video" data-target-field="id_video_url" data-modal-title="Seleccionar Video" data-modal-subtitle="Elige un video de tu biblioteca multimedia">
                                            <i class="fas fa-folder-open me-1"></i>Elegir de Media
                                        </button>
                                    </div>
                                    {% if form.video_url.errors %}
                                        <div class="text-danger small mt-1">{{ form.video_url.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>Ingrese la URL del video o seleccione uno desde la zona de multimedia
                                    </small>
                                    <!-- Vista previa del video -->
                                    <div id="video_preview" class="mt-2" style="display: none;">
                                        <small class="text-muted d-block mb-2 fw-semibold">
                                            <i class="fas fa-video me-1"></i>Vista previa:
                                        </small>
                                        <img id="video_preview_img" src="" alt="Vista previa del video" class="img-thumbnail" style="max-width: 200px; max-height: 150px; object-fit: cover; border: 2px solid #dee2e6; border-radius: 0.5rem;">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="{{ form.banner.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-image me-1 text-muted"></i>
                                        {{ form.banner.label }}
                                        {% if form.banner.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="input-group">
                                        {{ form.banner }}
                                        <button type="button" class="btn btn-outline-primary" data-media-type="image" data-target-field="id_banner" data-modal-title="Seleccionar Banner" data-modal-subtitle="Elige un banner de tu biblioteca multimedia">
                                            <i class="fas fa-folder-open me-1"></i>Elegir de Media
                                        </button>
                                    </div>
                                    {% if form.banner.errors %}
                                        <div class="text-danger small mt-1">{{ form.banner.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>Seleccione el banner del evento desde la zona de multimedia
                                    </small>
                                    <!-- Vista previa del banner -->
                                    <div id="banner_preview" class="mt-2" style="display: none;">
                                        <small class="text-muted d-block mb-2 fw-semibold">
                                            <i class="fas fa-image me-1"></i>Vista previa:
                                        </small>
                                        <img id="banner_preview_img" src="" alt="Vista previa del banner" class="img-thumbnail" style="max-width: 200px; max-height: 100px; object-fit: cover; border: 2px solid #dee2e6; border-radius: 0.5rem;">
                                    </div>
                                    {% if form.instance.banner %}
                                        <div id="banner_existing_preview" class="mt-2">
                                            <small class="text-muted d-block mb-2 fw-semibold">
                                                <i class="fas fa-image me-1"></i>Banner actual:
                                            </small>
                                            <img src="{{ form.instance.banner }}" alt="Banner del evento" class="img-thumbnail" style="max-width: 200px; max-height: 100px; object-fit: cover; border: 2px solid #dee2e6; border-radius: 0.5rem;">
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label for="{{ form.banner_mobile.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-mobile-alt me-1 text-muted"></i>
                                        {{ form.banner_mobile.label }}
                                        {% if form.banner_mobile.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="input-group">
                                        {{ form.banner_mobile }}
                                        <button type="button" class="btn btn-outline-primary" data-media-type="image" data-target-field="id_banner_mobile" data-modal-title="Seleccionar Banner Móvil" data-modal-subtitle="Elige un banner móvil de tu biblioteca multimedia">
                                            <i class="fas fa-folder-open me-1"></i>Elegir de Media
                                        </button>
                                    </div>
                                    {% if form.banner_mobile.errors %}
                                        <div class="text-danger small mt-1">{{ form.banner_mobile.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>Seleccione el banner móvil del evento desde la zona de multimedia
                                    </small>
                                    <!-- Vista previa del banner móvil -->
                                    <div id="banner_mobile_preview" class="mt-2" style="display: none;">
                                        <small class="text-muted d-block mb-2 fw-semibold">
                                            <i class="fas fa-mobile-alt me-1"></i>Vista previa:
                                        </small>
                                        <img id="banner_mobile_preview_img" src="" alt="Vista previa del banner móvil" class="img-thumbnail" style="max-width: 200px; max-height: 100px; object-fit: cover; border: 2px solid #dee2e6; border-radius: 0.5rem;">
                                    </div>
                                    {% if form.instance.banner_mobile %}
                                        <div id="banner_mobile_existing_preview" class="mt-2">
                                            <small class="text-muted d-block mb-2 fw-semibold">
                                                <i class="fas fa-mobile-alt me-1"></i>Banner móvil actual:
                                            </small>
                                            <img src="{{ form.instance.banner_mobile }}" alt="Banner móvil del evento" class="img-thumbnail" style="max-width: 200px; max-height: 100px; object-fit: cover; border: 2px solid #dee2e6; border-radius: 0.5rem;">
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label for="{{ form.logo.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-image me-1 text-muted"></i>
                                        {{ form.logo.label }}
                                        {% if form.logo.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="input-group">
                                        {{ form.logo }}
                                        <button type="button" class="btn btn-outline-primary" data-media-type="image" data-target-field="id_logo" data-modal-title="Seleccionar Logo" data-modal-subtitle="Elige un logo de tu biblioteca multimedia">
                                            <i class="fas fa-folder-open me-1"></i>Elegir de Media
                                        </button>
                                    </div>
                                    {% if form.logo.errors %}
                                        <div class="text-danger small mt-1">{{ form.logo.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>Seleccione el logo del evento desde la zona de multimedia
                                    </small>
                                    <!-- Vista previa del logo -->
                                    <div id="logo_preview" class="mt-2" style="display: none;">
                                        <small class="text-muted d-block mb-2 fw-semibold">
                                            <i class="fas fa-image me-1"></i>Vista previa:
                                        </small>
                                        <img id="logo_preview_img" src="" alt="Vista previa del logo" class="img-thumbnail" style="max-width: 150px; max-height: 150px; object-fit: contain; border: 2px solid #dee2e6; border-radius: 0.5rem;">
                                    </div>
                                    {% if form.instance.logo %}
                                        <div id="logo_existing_preview" class="mt-2">
                                            <small class="text-muted d-block mb-2 fw-semibold">
                                                <i class="fas fa-image me-1"></i>Logo actual:
                                            </small>
                                            <img src="{{ form.instance.logo }}" alt="Logo del evento" class="img-thumbnail" style="max-width: 150px; max-height: 150px; object-fit: contain; border: 2px solid #dee2e6; border-radius: 0.5rem;">
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-12">
                                    <label for="{{ form.email_welcome_body.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-envelope me-1 text-muted"></i>
                                        {{ form.email_welcome_body.label }}
                                        {% if form.email_welcome_body.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <div class="html-editor-wrapper">
                                        {{ form.email_welcome_body }}
                                        <div id="email-body-editor-container">
                                        <div id="email-body-editor" style="min-height: 300px;"></div>
                                            <textarea id="email-body-html-editor" class="form-control" style="display: none; min-height: 300px; font-family: 'Courier New', monospace; font-size: 13px;" placeholder="Edite el HTML directamente aquí..."></textarea>
                                        </div>
                                    </div>
                                    {% if form.email_welcome_body.errors %}
                                        <div class="text-danger small mt-1">{{ form.email_welcome_body.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle me-1"></i>Contenido HTML del correo de bienvenida que se enviará a los participantes. Puede usar etiquetas HTML completas.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- FECHAS Y HORARIOS -->
                        <div class="form-section mb-4">
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                <h6 class="mb-0 text-primary fw-bold">Fechas y Horarios</h6>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="{{ form.start_date.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-calendar-check me-1 text-muted"></i>
                                        {{ form.start_date.label }}
                                        {% if form.start_date.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {{ form.start_date }}
                                    {% if form.start_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.start_date.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-calendar-times me-1 text-muted"></i>
                                        {{ form.end_date.label }}
                                        {% if form.end_date.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {{ form.end_date }}
                                    {% if form.end_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.end_date.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label for="{{ form.entry_deadline.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-calendar-minus me-1 text-muted"></i>
                                        {{ form.entry_deadline.label }}
                                        {% if form.entry_deadline.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {{ form.entry_deadline }}
                                    {% if form.entry_deadline.errors %}
                                        <div class="text-danger small mt-1">{{ form.entry_deadline.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="form-section mt-4 pt-4 border-top" id="submit-buttons-section">
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex gap-2 justify-content-end">
                                        <a href="{% url 'events:list' %}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times me-2"></i>Cancelar
                                        </a>
                                        <button type="submit" class="btn btn-primary" id="submit-event-btn">
                                            <i class="fas fa-save me-2"></i>{% if form.instance.pk %}Actualizar Evento{% else %}Guardar Evento{% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- Modal unificada para seleccionar y subir medios -->
<div class="modal fade" id="mediaSelectorModal" tabindex="-1" aria-labelledby="mediaSelectorModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content video-selector-modal-content">
            <div class="modal-header video-selector-header">
                <div class="d-flex align-items-center">
                    <div class="modal-icon-wrapper">
                        <i class="fas fa-folder-open" id="mediaModalIcon"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="modal-title mb-0" id="mediaSelectorModalLabel">
                            Seleccionar Medio
                        </h5>
                        <p class="modal-subtitle mb-0" id="mediaModalSubtitle">Elige un archivo de tu biblioteca multimedia</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body video-selector-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="video-search-wrapper flex-grow-1 me-3">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="mediaSearchInput" placeholder="Buscar por nombre, descripción o tags...">
                            <button class="btn btn-outline-secondary" type="button" id="clearMediaSearchBtn" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="mediaTypeFilter" style="width: auto;">
                            <option value="">Todos los tipos</option>
                            <option value="image">Imágenes</option>
                            <option value="video">Videos</option>
                            <option value="document">Documentos</option>
                            <option value="audio">Audio</option>
                        </select>
                        <div>
                            <input type="file" id="mediaUploadInput" multiple style="display: none;">
                            <button type="button" class="btn btn-primary" id="uploadMediaBtn">
                                <i class="fas fa-upload me-2"></i>Subir Archivo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Barra de progreso de subida -->
                <div id="mediaUploadProgress" style="display: none; margin-bottom: 1rem;"></div>

                <div id="mediaSelectorLoading" class="video-selector-loading" style="display: none;">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3 text-muted">Cargando archivos...</p>
                    </div>
                </div>

                <div id="mediaSelectorGrid" class="video-selector-grid">
                    <!-- Los archivos se cargarán aquí -->
                </div>

                <!-- Paginación -->
                <nav id="mediaSelectorPagination" aria-label="Page navigation" style="display: none; margin-top: 2rem;">
                    <ul class="pagination justify-content-center mb-0">
                        <!-- Los controles de paginación se cargarán aquí -->
                    </ul>
                </nav>

                <div id="mediaSelectorEmpty" class="video-selector-empty" style="display: none;">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <h6 class="empty-title">No se encontraron archivos</h6>
                        <p class="empty-text">Intenta con otros términos de búsqueda o sube nuevos archivos a la biblioteca.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer video-selector-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary btn-lg" id="confirmMediaSelection" disabled>
                    <i class="fas fa-check me-2"></i>Seleccionar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Botón flotante de actualizar (sticky) - Fuera del contenedor principal -->
<div class="floating-submit-container" id="floating-submit-container">
    <div class="floating-submit-content">
        <a href="{% url 'events:list' %}" class="btn btn-outline-light btn-sm me-2">
            <i class="fas fa-times me-1"></i>Cancelar
        </a>
        <button type="submit" class="btn btn-primary btn-lg" form="eventForm" id="floating-submit-btn">
            <i class="fas fa-save me-2"></i>{% if form.instance.pk %}Actualizar Evento{% else %}Guardar Evento{% endif %}
        </button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del formulario
    const countryInput = document.getElementById('country_search');
    const countryHidden = document.getElementById('id_country');
    const countrySuggestions = document.getElementById('country_suggestions');

    const stateInput = document.getElementById('state_search');
    const stateHidden = document.getElementById('id_state');
    const stateSuggestions = document.getElementById('state_suggestions');

    const cityInput = document.getElementById('city_search');
    const cityHidden = document.getElementById('id_city');
    const citySuggestions = document.getElementById('city_suggestions');

    // Validar que los elementos existan
    if (!countryInput || !countryHidden || !countrySuggestions) {
        console.error('Error: No se encontraron los elementos del campo país', {
            countryInput: !!countryInput,
            countryHidden: !!countryHidden,
            countrySuggestions: !!countrySuggestions
        });
    }

    if (!stateInput || !stateHidden || !stateSuggestions) {
        console.error('Error: No se encontraron los elementos del campo estado', {
            stateInput: !!stateInput,
            stateHidden: !!stateHidden,
            stateSuggestions: !!stateSuggestions
        });
    }

    if (!cityInput || !cityHidden || !citySuggestions) {
        console.error('Error: No se encontraron los elementos del campo ciudad', {
            cityInput: !!cityInput,
            cityHidden: !!cityHidden,
            citySuggestions: !!citySuggestions
        });
    }

    console.log('Autocomplete inicializado:', {
        country: !!countryInput,
        state: !!stateInput,
        city: !!cityInput
    });

    let selectedCountryId = null;
    let selectedStateId = null;
    let countrySearchTimeout = null;
    let stateSearchTimeout = null;
    let citySearchTimeout = null;

    function highlightMatch(text, query) {
        if (!query) return text;

        // Normalizar para comparar sin tildes
        const normalize = (str) => {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        };

        const normalizedText = normalize(text);
        const normalizedQuery = normalize(query);

        if (!normalizedText.includes(normalizedQuery)) {
            return text;
        }

        // Crear un mapeo de posiciones normalizadas a posiciones originales
        const positionMap = [];
        let normalizedPos = 0;
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const normalizedChar = normalize(char);
            for (let j = 0; j < normalizedChar.length; j++) {
                positionMap[normalizedPos] = i;
                normalizedPos++;
            }
        }

        // Encontrar la posición de coincidencia
        const startIndex = normalizedText.indexOf(normalizedQuery);
        if (startIndex === -1) {
            return text;
        }

        const endIndex = startIndex + normalizedQuery.length;
        const originalStart = positionMap[startIndex] || 0;
        const originalEnd = positionMap[endIndex - 1] !== undefined ? positionMap[endIndex - 1] + 1 : text.length;

        // Construir el resultado resaltando la parte que coincide
        const before = text.substring(0, originalStart);
        const match = text.substring(originalStart, originalEnd);
        const after = text.substring(originalEnd);

        return before + '<strong>' + match + '</strong>' + after;
    }

    function renderSuggestions(container, items, input, hidden, query, onSelect) {
        container.innerHTML = '';

        if (items.length === 0) {
            container.innerHTML = '<div class="autocomplete-suggestion"><span class="text-muted"><i class="fas fa-search me-2"></i>No se encontraron resultados</span></div>';
            container.classList.add('show');
            return;
        }

        // Agregar contador de resultados
        if (items.length > 5) {
            const countDiv = document.createElement('div');
            countDiv.className = 'autocomplete-suggestion text-center bg-light';
            countDiv.style.cssText = 'position: sticky; top: 0; z-index: 1; border-bottom: 2px solid #dee2e6;';
            countDiv.innerHTML = `<small class="text-primary fw-bold"><i class="fas fa-list me-1"></i>${items.length} resultados encontrados</small>`;
            container.appendChild(countDiv);
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-suggestion';

            // Resaltar coincidencias en el nombre
            const highlightedName = highlightMatch(item.name, query);

            div.innerHTML = `
                <div class="suggestion-name">${highlightedName}</div>
                ${item.code ? `<div class="suggestion-meta">Código: ${item.code}</div>` : ''}
            `;

            div.addEventListener('click', function() {
                input.value = item.name;
                hidden.value = item.id;
                container.classList.remove('show');

                if (onSelect) {
                    onSelect(item);
                }
            });

            // Resaltar al pasar el mouse
            div.addEventListener('mouseenter', function() {
                // Remover highlight de todos
                container.querySelectorAll('.autocomplete-suggestion').forEach(s => s.classList.remove('highlighted'));
                this.classList.add('highlighted');
            });

            div.addEventListener('mouseleave', function() {
                this.classList.remove('highlighted');
            });

            container.appendChild(div);
        });

        container.classList.add('show');

        // Scroll al inicio
        container.scrollTop = 0;
    }

    // Función mejorada para búsqueda con soporte de focus (mostrar todos al hacer click)
    function setupImprovedAutocomplete(input, hidden, suggestions, apiUrl, getFilterParam, onSelectCallback) {
        let searchTimeout = null;
        let currentIndex = -1;
        let allResults = [];

        // Función para realizar la búsqueda
        function performSearch(query = '') {
            clearTimeout(searchTimeout);

            // Mostrar indicador de carga
            suggestions.innerHTML = '<div class="autocomplete-suggestion"><span class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Buscando...</span></div>';
            suggestions.classList.add('show');

            searchTimeout = setTimeout(() => {
                let url = apiUrl;
                const filterParam = typeof getFilterParam === 'function' ? getFilterParam() : getFilterParam;

                if (query) {
                    url += `?q=${encodeURIComponent(query)}`;
                }
                if (filterParam) {
                    url += query ? '&' : '?';
                    url += filterParam;
                }

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        allResults = data;
                        currentIndex = -1;
                        renderSuggestions(suggestions, data, input, hidden, query, onSelectCallback);
                    })
                    .catch(error => {
                        console.error('Error en búsqueda:', error);
                        suggestions.innerHTML = '<div class="autocomplete-suggestion"><span class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al buscar. Intente nuevamente.</span></div>';
                        suggestions.classList.add('show');
                    });
            }, query ? 150 : 0); // Sin delay si es focus sin query
        }

        // Input: buscar mientras escribe
        input.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length === 0) {
                suggestions.classList.remove('show');
                currentIndex = -1;
                return;
            }
            performSearch(query);
        });

        // Focus: mostrar todos los resultados disponibles
        input.addEventListener('focus', function() {
            if (this.value.trim().length > 0) {
                // Si ya hay texto, buscar con ese texto
                performSearch(this.value.trim());
            } else if (!this.hasAttribute('disabled')) {
                // Si está vacío y no deshabilitado, mostrar todos
                performSearch('');
            }
        });

        // Click: igual que focus (para mejor UX móvil)
        input.addEventListener('click', function() {
            if (!this.hasAttribute('disabled') && suggestions.children.length === 0) {
                performSearch(this.value.trim());
            } else if (suggestions.children.length > 0) {
                suggestions.classList.add('show');
            }
        });

        // Navegación con teclado
        input.addEventListener('keydown', function(e) {
            const items = suggestions.querySelectorAll('.autocomplete-suggestion:not(.text-muted)');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentIndex = Math.min(currentIndex + 1, items.length - 1);
                updateHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentIndex = Math.max(currentIndex - 1, -1);
                updateHighlight(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentIndex >= 0 && items[currentIndex]) {
                    items[currentIndex].click();
                }
            } else if (e.key === 'Escape') {
                suggestions.classList.remove('show');
                currentIndex = -1;
            }
        });

        function updateHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === currentIndex);
            });

            // Scroll to highlighted item
            if (currentIndex >= 0 && items[currentIndex]) {
                items[currentIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }
    }

    // Autocomplete para país (mejorado)
    if (countryInput && countryHidden && countrySuggestions) {
        setupImprovedAutocomplete(
            countryInput,
            countryHidden,
            countrySuggestions,
            '/locations/countries/api/',
            null,
            function(country) {
                selectedCountryId = country.id;
                console.log('País seleccionado:', country.name, 'ID:', country.id);

                // Limpiar y deshabilitar estado y ciudad
                if (stateInput) {
                    stateInput.value = '';
                    stateInput.placeholder = 'Seleccione primero un estado...';
                    stateInput.removeAttribute('disabled');
                }
                if (stateHidden) {
                    stateHidden.value = '';
                }
                if (cityInput) {
                    cityInput.value = '';
                    cityInput.placeholder = 'Primero seleccione país y estado';
                    cityInput.setAttribute('disabled', 'disabled');
                }
                if (cityHidden) {
                    cityHidden.value = '';
                }

                // Limpiar sitios y hoteles
                if (typeof reloadSitesAndHotels === 'function') {
                    reloadSitesAndHotels(null);
                }

                // Dar focus al campo de estado
                setTimeout(() => {
                    if (stateInput) stateInput.focus();
                }, 100);
            }
        );
    }

    // Autocomplete para estado (mejorado, con filtro por país)
    if (stateInput && stateHidden && stateSuggestions) {
        // Agregar validación al intentar usar el campo
        stateInput.addEventListener('focus', function() {
            if (!selectedCountryId) {
                stateSuggestions.innerHTML = '<div class="autocomplete-suggestion"><span class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Por favor, seleccione primero un país</span></div>';
                stateSuggestions.classList.add('show');
                setTimeout(() => {
                    if (countryInput) countryInput.focus();
                }, 1500);
                return;
            }
        });

        setupImprovedAutocomplete(
            stateInput,
            stateHidden,
            stateSuggestions,
            '/locations/states/api/',
            () => selectedCountryId ? `country=${selectedCountryId}` : null,
            function(state) {
                selectedStateId = state.id;
                console.log('Estado seleccionado:', state.name, 'ID:', state.id);

                // Habilitar ciudad
                if (cityInput) {
                    cityInput.value = '';
                    cityInput.placeholder = 'Buscar ciudad...';
                    cityInput.removeAttribute('disabled');
                }
                if (cityHidden) {
                    cityHidden.value = '';
                }

                // Limpiar sitios y hoteles
                if (typeof reloadSitesAndHotels === 'function') {
                    reloadSitesAndHotels(null);
                }

                // Dar focus al campo de ciudad
                setTimeout(() => {
                    if (cityInput) cityInput.focus();
                }, 100);
            }
        );
    }

    // Autocomplete para ciudad (mejorado, con filtro por estado)
    if (cityInput && cityHidden && citySuggestions) {
        // Agregar validación al intentar usar el campo
        cityInput.addEventListener('focus', function() {
            if (!selectedStateId) {
                citySuggestions.innerHTML = '<div class="autocomplete-suggestion"><span class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Por favor, seleccione primero un país y un estado</span></div>';
                citySuggestions.classList.add('show');
                setTimeout(() => {
                    if (stateInput && selectedCountryId) {
                        stateInput.focus();
                    } else if (countryInput) {
                        countryInput.focus();
                    }
                }, 1500);
                return;
            }
        });

        setupImprovedAutocomplete(
            cityInput,
            cityHidden,
            citySuggestions,
            '/locations/cities/api/',
            () => selectedStateId ? `state=${selectedStateId}` : null,
            function(city) {
                console.log('Ciudad seleccionada:', city.name, 'ID:', city.id);

                // Cargar sitios y hoteles para esta ciudad
                if (typeof reloadSitesAndHotels === 'function') {
                    reloadSitesAndHotels(city.id);
                }
            }
        );
    }

    // Cerrar sugerencias al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (countryInput && countrySuggestions) {
            if (!countryInput.contains(e.target) && !countrySuggestions.contains(e.target)) {
                countrySuggestions.classList.remove('show');
            }
        }
        if (stateInput && stateSuggestions) {
            if (!stateInput.contains(e.target) && !stateSuggestions.contains(e.target)) {
                stateSuggestions.classList.remove('show');
            }
        }
        if (cityInput && citySuggestions) {
            if (!cityInput.contains(e.target) && !citySuggestions.contains(e.target)) {
                citySuggestions.classList.remove('show');
            }
        }
    });

    // Cargar valores iniciales si existen (para edición) - Carga secuencial
    {% if form.country.value %}
        const initialCountryId = {{ form.country.value }};
        const initialStateId = {% if form.state.value %}{{ form.state.value }}{% else %}null{% endif %};
        const initialCityId = {% if form.city.value %}{{ form.city.value }}{% else %}null{% endif %};

        // Cargar país primero usando ID específico
        fetch(`/locations/countries/api/?id=${initialCountryId}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const country = data[0];
                    if (countryInput) {
                        countryInput.value = country.name;
                    }
                    if (countryHidden) {
                        countryHidden.value = country.id;
                    }
                    selectedCountryId = country.id;
                    if (stateInput) {
                        stateInput.removeAttribute('disabled');
                    }

                    // Si hay estado, cargarlo después del país usando ID específico
                    if (initialStateId && stateInput && stateHidden) {
                        return fetch(`/locations/states/api/?id=${initialStateId}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.length > 0) {
                                    const state = data[0];
                                    stateInput.value = state.name;
                                    stateHidden.value = state.id;
                                    selectedStateId = state.id;
                                    if (cityInput) {
                                        cityInput.removeAttribute('disabled');
                                    }

                                    // Si hay ciudad, cargarla después del estado usando ID específico
                                    if (initialCityId && cityInput && cityHidden) {
                                        return fetch(`/locations/cities/api/?id=${initialCityId}`)
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data && data.length > 0) {
                                                    const city = data[0];
                                                    cityInput.value = city.name;
                                                    cityHidden.value = city.id;

                                                    // Cargar sitios y hoteles si existe la función
                                                    if (typeof reloadSitesAndHotels === 'function') {
                                                        reloadSitesAndHotels(city.id);
                                                    }
                                                }
                                            });
                                    }
                                }
                            });
                    }
                }
            })
            .catch(error => {
                console.error('Error al cargar valores iniciales:', error);
            });
    {% endif %}

    // Función para recargar sitios y hoteles cuando cambia la ciudad
    function reloadSitesAndHotels(cityId) {
        console.log('Recargando sitios y hoteles para ciudad:', cityId);

        if (!cityId) {
            // Si no hay ciudad, limpiar todos los datos
            allSites = [];
            allPrimarySites = [];
            allHotels = [];
            allPrimaryHotels = [];
            selectedSites = [];
            selectedHotels = [];

            // Limpiar selecciones
            if (typeof window.clearPrimarySite === 'function') {
                window.clearPrimarySite();
            }
            if (typeof window.clearHotel === 'function') {
                window.clearHotel();
            }

            // Renderizar listas vacías
            if (typeof renderSitesList === 'function') {
                renderSitesList();
            }
            if (typeof renderHotelsList === 'function') {
                renderHotelsList();
            }
            return;
        }

        // Recargar sitios adicionales
        if (typeof loadSites === 'function') {
            loadSites(cityId);
        }
        // Recargar sitio principal
        if (typeof loadPrimarySites === 'function') {
            loadPrimarySites(cityId);
            // Limpiar selección actual si el sitio no está en la nueva lista
            if (primarySiteIdInput && primarySiteIdInput.value) {
                // Se verificará después de cargar los sitios
                setTimeout(() => {
                    const currentSiteId = parseInt(primarySiteIdInput.value);
                    const siteExists = allPrimarySites.some(s => s.id === currentSiteId);
                    if (!siteExists && cityId) {
                        // Si hay una ciudad seleccionada pero el sitio no está en la lista, limpiar
                        window.clearPrimarySite();
                    }
                }, 500);
            }
        }
        // Recargar hoteles adicionales
        if (typeof loadHotels === 'function') {
            loadHotels(cityId);
        }
        // Recargar hotel principal
        if (typeof loadPrimaryHotels === 'function') {
            loadPrimaryHotels(cityId);
            // Limpiar selección actual si el hotel no está en la nueva lista
            if (hotelIdInput && hotelIdInput.value) {
                setTimeout(() => {
                    const currentHotelId = parseInt(hotelIdInput.value);
                    const hotelExists = allPrimaryHotels.some(h => h.id === currentHotelId);
                    if (!hotelExists && cityId) {
                        // Si hay una ciudad seleccionada pero el hotel no está en la lista, limpiar
                        window.clearHotel();
                    }
                }, 500);
            }
        }
    }

    // ========== SECCIÓN DE SITIOS Y HOTELES ==========
    // Esta sección se encarga de cargar y filtrar sitios y hoteles según la ciudad seleccionada
    // NOTA: Usa cityHidden (campo oculto del autocomplete) en lugar de citySelect

    // Sistema mejorado de selección de sitios adicionales con buscador
    const siteSearch = document.getElementById('site_search');
    const sitesList = document.getElementById('sites_list');
    const selectedSitesChips = document.getElementById('selected_sites_chips');
    const noSelectedMessage = document.getElementById('no_selected_message');
    const additionalSitesCheckboxes = document.querySelectorAll('#additional_sites_hidden input[type="checkbox"]');
    const noSitesFound = document.getElementById('no_sites_found');

    // Obtener todos los sitios desde la API
    let allSites = [];
    let selectedSites = [];

    // Cargar sitios desde la API
    function loadSites(cityId = null) {
        const url = cityId ? `/locations/sites/api/?city=${cityId}` : '/locations/sites/api/';
        console.log('Cargando sitios adicionales desde:', url, 'cityId:', cityId);

        // Función auxiliar para continuar cargando sitios de la ciudad
        function continueLoadingSites(cityId) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Sitios adicionales recibidos:', data.length, 'para ciudad:', cityId);
                    // Verificar que los sitios realmente pertenezcan a la ciudad solicitada
                    if (cityId) {
                        const filteredData = data.filter(site => site.city_id === parseInt(cityId));
                        console.log('Sitios adicionales filtrados por ciudad_id:', filteredData.length);
                        data = filteredData;
                    }

                    // Agregar sitios a allSites (evitando duplicados)
                    data.forEach(site => {
                        const existingSite = allSites.find(s => s.id === site.id);
                        if (!existingSite) {
                            const siteObj = {
                                id: site.id,
                                name: site.site_name || site.name || `Sitio ${site.id}`,
                                checkbox: null
                            };
                            allSites.push(siteObj);
                        }
                    });

                    // Encontrar los checkboxes correspondientes para los sitios nuevos
                    allSites.forEach(site => {
                        if (!site.checkbox) {
                            const checkbox = Array.from(additionalSitesCheckboxes).find(cb => cb.value === site.id.toString());
                            if (checkbox) {
                                site.checkbox = checkbox;
                            }
                        }
                    });

                    // Inicializar la interfaz
                    syncAdditionalSitesCheckboxes(); // Sincronizar checkboxes
                    renderSelectedChips();
                    renderSitesList();
                    console.log('✅ Sitios adicionales inicializados. Total allSites:', allSites.length, 'Total selectedSites:', selectedSites.length);
                })
                .catch(error => {
                    console.error('Error al cargar sitios:', error);
                    // Fallback: usar los checkboxes existentes
                    additionalSitesCheckboxes.forEach(checkbox => {
                        const label = checkbox.closest('label') || document.querySelector(`label[for="${checkbox.id}"]`);
                        let siteName = label ? label.textContent.trim() : `Sitio ${checkbox.value}`;
                        // Limpiar el nombre si contiene el checkbox
                        siteName = siteName.replace(checkbox.value, '').trim();

                        const existingSite = allSites.find(s => s.id.toString() === checkbox.value);
                        if (!existingSite) {
                            allSites.push({
                                id: checkbox.value,
                                name: siteName || `Sitio ${checkbox.value}`,
                                checkbox: checkbox
                            });
                        }

                        if (checkbox.checked) {
                            const site = allSites.find(s => s.id.toString() === checkbox.value);
                            if (site && !selectedSites.find(s => s.id.toString() === site.id.toString())) {
                                selectedSites.push(site);
                            }
                        }
                    });
                    renderSelectedChips();
                    renderSitesList();
                });
        }

        // PRIMERO: Verificar todos los checkboxes marcados y cargar esos sitios desde la API
        // Esto asegura que los sitios seleccionados se muestren incluso si no están en la ciudad actual
        const checkedCheckboxes = Array.from(additionalSitesCheckboxes).filter(cb => cb.checked);
        console.log('✅ Checkboxes marcados encontrados:', checkedCheckboxes.length);

        if (checkedCheckboxes.length > 0) {
            const checkedSiteIds = checkedCheckboxes.map(cb => parseInt(cb.value));
            console.log('✅ IDs de sitios marcados:', checkedSiteIds);

            // Cargar cada sitio marcado desde la API por ID
            const loadPromises = checkedSiteIds.map(siteId => {
                return fetch(`/locations/sites/api/?id=${siteId}`)
                    .then(response => response.json())
                    .then(siteData => {
                        if (siteData && siteData.length > 0) {
                            // Buscar el sitio con el ID correcto (no solo tomar el primero)
                            const site = siteData.find(s => s.id === siteId);
                            if (site) {
                                const checkbox = checkedCheckboxes.find(cb => parseInt(cb.value) === siteId);
                                const siteObj = {
                                    id: site.id,
                                    name: site.site_name || site.name || `Sitio ${site.id}`,
                                    checkbox: checkbox || null
                                };

                                // Agregar a allSites si no está
                                if (!allSites.find(s => s.id === siteObj.id)) {
                                    allSites.push(siteObj);
                                    console.log('✅ Sitio cargado desde API (marcado):', siteObj);
                                }

                                // Agregar a selectedSites si no está
                                if (!selectedSites.find(s => s.id === siteObj.id)) {
                                    selectedSites.push(siteObj);
                                    console.log('✅ Sitio agregado a selectedSites:', siteObj);
                                }

                                return siteObj;
                            }
                        }
                        return null;
                    })
                    .catch(error => {
                        console.error('❌ Error al cargar sitio marcado (ID:', siteId, '):', error);
                        return null;
                    });
            });

            // Esperar a que todos los sitios marcados se carguen antes de continuar
            Promise.all(loadPromises).then(() => {
                console.log('✅ Todos los sitios marcados cargados. Total selectedSites:', selectedSites.length);
                // Renderizar los chips inmediatamente después de cargar
                renderSelectedChips();
                // Continuar con la carga normal de sitios de la ciudad
                continueLoadingSites(cityId);
            });
        } else {
            // Si no hay checkboxes marcados, continuar normalmente
            continueLoadingSites(cityId);
        }
    }

    // Cargar sitios al iniciar
    // IMPORTANTE: Primero verificar los checkboxes marcados ANTES de cargar por ciudad
    console.log('🔍 Inicializando sitios adicionales...');
    console.log('Checkboxes encontrados:', additionalSitesCheckboxes.length);

    const checkedCheckboxesOnInit = Array.from(additionalSitesCheckboxes).filter(cb => cb.checked);
    console.log('✅ Checkboxes marcados al iniciar:', checkedCheckboxesOnInit.length);

    if (checkedCheckboxesOnInit.length > 0) {
        console.log('✅ IDs de sitios marcados al iniciar:', checkedCheckboxesOnInit.map(cb => cb.value));

        // Cargar todos los sitios marcados desde la API
        const initLoadPromises = checkedCheckboxesOnInit.map(checkbox => {
            const siteId = parseInt(checkbox.value);
            return fetch(`/locations/sites/api/?id=${siteId}`)
                .then(response => response.json())
                .then(siteData => {
                    if (siteData && siteData.length > 0) {
                        // Buscar el sitio con el ID correcto
                        const site = siteData.find(s => s.id === siteId);
                        if (site) {
                            const siteObj = {
                                id: site.id,
                                name: site.site_name || site.name || `Sitio ${site.id}`,
                                checkbox: checkbox
                            };

                            // Agregar a allSites si no está
                            if (!allSites.find(s => s.id === siteObj.id)) {
                                allSites.push(siteObj);
                                console.log('✅ Sitio cargado al iniciar:', siteObj);
                            }

                            // Agregar a selectedSites si no está
                            if (!selectedSites.find(s => s.id === siteObj.id)) {
                                selectedSites.push(siteObj);
                                console.log('✅ Sitio agregado a selectedSites al iniciar:', siteObj);
                            }

                            return siteObj;
                        }
                    }
                    return null;
                })
                .catch(error => {
                    console.error('❌ Error al cargar sitio al iniciar (ID:', siteId, '):', error);
                    return null;
                });
        });

        // Esperar a que todos los sitios se carguen, luego renderizar y continuar con la carga normal
        Promise.all(initLoadPromises).then(() => {
            console.log('✅ Todos los sitios marcados cargados al iniciar. Total selectedSites:', selectedSites.length);
            console.log('✅ selectedSites contenido:', selectedSites.map(s => ({id: s.id, name: s.name})));
            // Renderizar los chips inmediatamente
            renderSelectedChips();
            renderSitesList();
            console.log('✅ Chips renderizados después de cargar sitios al iniciar');

            // Luego cargar sitios de la ciudad si hay una ciudad seleccionada
            const initialCityIdForSites = (cityHidden && cityHidden.value) ? cityHidden.value : null;
            if (initialCityIdForSites) {
                console.log('Cargando sitios adicionales de la ciudad:', initialCityIdForSites);
                loadSites(initialCityIdForSites);
            }
        });
    } else {
        // Si no hay checkboxes marcados, cargar normalmente
        const initialCityIdForSites = (cityHidden && cityHidden.value) ? cityHidden.value : null;
        if (initialCityIdForSites) {
            loadSites(initialCityIdForSites);
        } else {
            // Si no hay ciudad ni sitios seleccionados, NO cargar sitios
            allSites = [];
            renderSitesList();
        }
    }

    // Autocomplete para Sitio Principal (Primary Site)
    const primarySiteInput = document.getElementById('primary_site_autocomplete');
    const primarySiteDropdown = document.getElementById('primary_site_dropdown');
    const primarySiteIdInput = document.getElementById('primary_site_id');
    const primarySiteSelected = document.getElementById('primary_site_selected');
    const primarySiteName = document.getElementById('primary_site_name');
    let primarySiteTimeout = null;
    let allPrimarySites = [];
    let userHasSelectedSite = false; // Bandera para rastrear si el usuario seleccionó un sitio manualmente

    // Cargar todos los sitios para el autocomplete
    function loadPrimarySites(cityId = null) {
        const url = cityId ? `/locations/sites/api/?city=${cityId}` : '/locations/sites/api/';
        console.log('Cargando sitios principales desde:', url, 'cityId:', cityId);
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                console.log('Sitios cargados:', data.length, 'para ciudad:', cityId);
                // Verificar que los sitios realmente pertenezcan a la ciudad solicitada
                if (cityId) {
                    const filteredData = data.filter(site => site.city_id === parseInt(cityId));
                    console.log('Sitios filtrados por ciudad_id:', filteredData.length);
                    data = filteredData;
                }
                allPrimarySites = data.map(site => ({
                    id: site.id,
                    name: site.site_name || site.name || `Sitio ${site.id}`,
                    location: [site.city_name, site.state_name, site.country_name].filter(Boolean).join(', ')
                }));

                // Si hay un sitio seleccionado inicialmente, verificar si todavía existe
                const initialSiteId = primarySiteIdInput ? primarySiteIdInput.value : null;
                if (initialSiteId) {
                    const initialSite = allPrimarySites.find(s => s.id === parseInt(initialSiteId));
                    if (initialSite) {
                        // El sitio ya está en la lista, mostrarlo (pero solo si no hay otro seleccionado)
                        const currentValue = primarySiteIdInput ? primarySiteIdInput.value : null;
                        if (!currentValue || currentValue === initialSiteId) {
                            showSelectedPrimarySite(initialSite, false);
                        } else {
                            console.log('No mostrar sitio inicial, hay otro seleccionado:', currentValue);
                        }
                    } else {
                        // Si el sitio no está en la lista filtrada, intentar cargarlo directamente
                        fetch(`/locations/sites/api/?id=${initialSiteId}`)
                            .then(response => response.json())
                            .then(siteData => {
                                if (siteData && siteData.length > 0) {
                                    // Buscar el sitio con el ID correcto (no solo tomar el primero)
                                    let site = siteData.find(s => s.id === parseInt(initialSiteId));

                                    if (!site) {
                                        console.warn('Sitio con ID', initialSiteId, 'no encontrado en loadPrimarySites. Sitios disponibles:', siteData.map(s => s.id));
                                        // Si no se encuentra, no hacer nada más
                                        return;
                                    }

                                    console.log('Sitio cargado desde API para loadPrimarySites:', {
                                        buscado: initialSiteId,
                                        encontrado: site.id,
                                        nombre: site.site_name || site.name,
                                        todosLosSitios: siteData.map(s => ({id: s.id, name: s.site_name || s.name}))
                                    });

                                    const siteObj = {
                                        id: site.id,
                                        name: site.site_name || site.name || `Sitio ${site.id}`,
                                        location: [site.city_name, site.state_name, site.country_name].filter(Boolean).join(', ')
                                    };
                                    // Agregar a la lista si no está
                                    if (!allPrimarySites.find(s => s.id === siteObj.id)) {
                                        allPrimarySites.push(siteObj);
                                    }
                                    // Solo mostrar si no hay otro sitio seleccionado Y el sitio tiene el ID correcto
                                    const currentValue = primarySiteIdInput ? primarySiteIdInput.value : null;
                                    if ((!currentValue || currentValue === initialSiteId) && siteObj.id.toString() === initialSiteId) {
                                        showSelectedPrimarySite(siteObj, false);
                                    } else {
                                        if (siteObj.id.toString() !== initialSiteId) {
                                            console.warn('No mostrar sitio cargado: ID no coincide', {
                                                buscado: initialSiteId,
                                                encontrado: siteObj.id
                                            });
                                        } else {
                                            console.log('No mostrar sitio cargado, hay otro seleccionado:', currentValue);
                                        }
                                    }
                                } else {
                                    // Si el sitio ya no existe, limpiar la selección solo si hay ciudad
                                    // (si no hay ciudad, mantener el sitio aunque no esté en la lista)
                                    if (cityId) {
                                        window.clearPrimarySite();
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error al cargar sitio inicial:', error);
                            });
                    }
                }
            })
            .catch(error => {
                console.error('Error al cargar sitios para autocomplete:', error);
                allPrimarySites = [];
            });
    }

    // Mostrar sitio seleccionado
    function showSelectedPrimarySite(site, isUserSelection = true) {
        if (!site || !site.id) {
            console.error('showSelectedPrimarySite: sitio inválido', site);
            return;
        }

        const previousValue = primarySiteIdInput ? primarySiteIdInput.value : null;
        const newValue = site.id.toString();

        // Si es una selección del usuario, marcar la bandera
        if (isUserSelection) {
            userHasSelectedSite = true;
            console.log('Selección del usuario detectada, marcando bandera');
        }

        // Si el usuario ya seleccionó un sitio y esta no es su selección, no sobrescribir
        if (userHasSelectedSite && !isUserSelection && previousValue && previousValue !== newValue) {
            console.log('Ignorando inicialización: usuario ya seleccionó un sitio diferente', {
                sitioIntentado: {id: site.id, name: site.name},
                sitioActual: previousValue
            });
            return;
        }

        console.log('showSelectedPrimarySite llamado:', {
            sitio: {id: site.id, name: site.name},
            valorAnterior: previousValue,
            valorNuevo: newValue,
            esSeleccionUsuario: isUserSelection,
            usuarioYaSelecciono: userHasSelectedSite
        });

        // Actualizar el valor
        primarySiteIdInput.value = newValue;
        primarySiteName.textContent = site.name;
        primarySiteInput.value = '';
        primarySiteInput.style.display = 'none';
        primarySiteSelected.style.display = 'block';
        primarySiteDropdown.style.display = 'none';

        console.log('Sitio mostrado correctamente. Input hidden actualizado a:', primarySiteIdInput.value);
    }

    // Limpiar sitio seleccionado
    window.clearPrimarySite = function() {
        primarySiteIdInput.value = '';
        primarySiteInput.value = '';
        primarySiteInput.style.display = 'block';
        primarySiteSelected.style.display = 'none';
        primarySiteDropdown.style.display = 'none';
    };

    // Filtrar y mostrar sugerencias
    function showPrimarySiteSuggestions(searchTerm) {
        if (!searchTerm || searchTerm.length < 2) {
            primarySiteDropdown.style.display = 'none';
            return;
        }

        if (allPrimarySites.length === 0) {
            const cityId = (cityHidden && cityHidden.value) ? cityHidden.value : null;
            let message = '';
            if (cityId && cityInput && cityInput.value) {
                const cityName = cityInput.value;
                message = `No hay sitios disponibles para ${cityName}. Por favor, seleccione otra ciudad o cree un sitio para esta ciudad.`;
            } else {
                message = 'Seleccione una ciudad para ver los sitios disponibles.';
            }
            primarySiteDropdown.innerHTML = `
                <div class="list-group-item text-muted text-center py-3">
                    <i class="fas fa-info-circle me-2"></i>${message}
                </div>
            `;
            primarySiteDropdown.style.display = 'block';
            return;
        }

        const filtered = allPrimarySites.filter(site => {
            const searchLower = searchTerm.toLowerCase();
            return site.name.toLowerCase().includes(searchLower) ||
                   (site.location && site.location.toLowerCase().includes(searchLower));
        }).slice(0, 10); // Limitar a 10 resultados

        if (filtered.length === 0) {
            primarySiteDropdown.innerHTML = `
                <div class="list-group-item text-muted text-center py-3">
                    <i class="fas fa-search me-2"></i>No se encontraron sitios
                </div>
            `;
        } else {
            primarySiteDropdown.innerHTML = filtered.map(site => {
                const safeName = site.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                const safeLocation = (site.location || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                    <button
                        type="button"
                        class="list-group-item list-group-item-action"
                        onclick="selectPrimarySite(${site.id})"
                        style="cursor: pointer;"
                    >
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                <strong>${safeName}</strong>
                                ${safeLocation ? `<br><small class="text-muted">${safeLocation}</small>` : ''}
                            </div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                    </button>
                `;
            }).join('');
        }

        primarySiteDropdown.style.display = 'block';
    }

    // Seleccionar sitio (llamado cuando el usuario hace clic)
    window.selectPrimarySite = function(siteId) {
        console.log('selectPrimarySite llamado con ID:', siteId, '(selección del usuario)');
        const site = allPrimarySites.find(s => s.id === parseInt(siteId));
        if (site) {
            console.log('Sitio encontrado en allPrimarySites:', site);
            // Marcar como selección del usuario para evitar que se sobrescriba
            showSelectedPrimarySite(site, true);
        } else {
            console.error('Sitio no encontrado en allPrimarySites con ID:', siteId);
            console.log('Sitios disponibles:', allPrimarySites.map(s => ({id: s.id, name: s.name})));
        }
    };

    // Event listeners para el autocomplete
    if (primarySiteInput) {
        primarySiteInput.addEventListener('input', function() {
            clearTimeout(primarySiteTimeout);
            primarySiteTimeout = setTimeout(() => {
                showPrimarySiteSuggestions(this.value);
            }, 300); // Debounce de 300ms
        });

        primarySiteInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                showPrimarySiteSuggestions(this.value);
            }
        });

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (primarySiteInput && primarySiteDropdown && primarySiteSelected) {
                if (!primarySiteInput.contains(e.target) &&
                    !primarySiteDropdown.contains(e.target) &&
                    !primarySiteSelected.contains(e.target)) {
                    primarySiteDropdown.style.display = 'none';
                }
            }
        });

        // Manejar teclas en el input
        primarySiteInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                primarySiteDropdown.style.display = 'none';
            }
        });

        // Función para inicializar el sitio principal (solo al cargar la página, no después de selecciones del usuario)
        function initializePrimarySite() {
            // Si el usuario ya seleccionó un sitio, no inicializar
            if (userHasSelectedSite) {
                console.log('Usuario ya seleccionó un sitio, saltando inicialización');
                return;
            }

            const currentSiteId = primarySiteIdInput ? primarySiteIdInput.value : null;

            // Solo inicializar si no hay sitio seleccionado o si es el mismo que el inicial
            if (currentSiteId && currentSiteId.trim() !== '') {
                console.log('Inicializando sitio principal desde valor guardado, ID:', currentSiteId);

                // Verificar si el sitio ya está en allPrimarySites
                const existingSite = allPrimarySites.find(s => s.id === parseInt(currentSiteId));
                if (existingSite) {
                    console.log('Sitio ya está en la lista, mostrándolo (inicialización):', existingSite);
                    // Solo mostrar si el usuario no ha seleccionado otro sitio
                    if (!userHasSelectedSite) {
                        showSelectedPrimarySite(existingSite, false);
                    } else {
                        console.log('No mostrar sitio inicial, usuario ya seleccionó otro');
                    }
                    return;
                }

                // Si no está en la lista, cargarlo desde la API
                fetch(`/locations/sites/api/?id=${currentSiteId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(siteData => {
                        console.log('Sitio inicial cargado desde API:', siteData, 'Buscando ID:', currentSiteId);
                        if (siteData && siteData.length > 0) {
                            // Buscar el sitio con el ID correcto (no solo tomar el primero)
                            let site = siteData.find(s => s.id === parseInt(currentSiteId));

                            if (!site) {
                                console.warn('Sitio con ID', currentSiteId, 'no encontrado en la respuesta. Sitios disponibles:', siteData.map(s => s.id));
                                // Si no se encuentra, no inicializar
                                return;
                            }

                            console.log('Sitio encontrado para inicialización:', {
                                buscado: currentSiteId,
                                encontrado: site.id,
                                nombre: site.site_name || site.name,
                                todosLosSitios: siteData.map(s => ({id: s.id, name: s.site_name || s.name}))
                            });

                            const siteObj = {
                                id: site.id,
                                name: site.site_name || site.name || `Sitio ${site.id}`,
                                location: [site.city_name, site.state_name, site.country_name].filter(Boolean).join(', ')
                            };
                            // Agregar a la lista si no está
                            if (!allPrimarySites.find(s => s.id === siteObj.id)) {
                                allPrimarySites.push(siteObj);
                            }
                            // Solo mostrar si el usuario no ha seleccionado otro sitio Y el sitio tiene el ID correcto
                            if (!userHasSelectedSite && siteObj.id.toString() === currentSiteId) {
                                showSelectedPrimarySite(siteObj, false);
                                console.log('Sitio principal inicializado correctamente:', siteObj);
                            } else {
                                if (siteObj.id.toString() !== currentSiteId) {
                                    console.warn('No inicializar: sitio encontrado no coincide con el ID buscado', {
                                        buscado: currentSiteId,
                                        encontrado: siteObj.id
                                    });
                                } else {
                                    console.log('No inicializar, usuario ya seleccionó otro sitio');
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar sitio inicial:', error);
                    });
            }

            // Cargar sitios al iniciar (con ciudad si está seleccionada)
            const initialCityIdForPrimarySites = (cityHidden && cityHidden.value) ? cityHidden.value : null;
            if (initialCityIdForPrimarySites) {
                // Cargar la lista completa de sitios de la ciudad
                loadPrimarySites(initialCityIdForPrimarySites);
            }
        }

        // Inicializar inmediatamente y también cuando el DOM esté listo
        // Esto asegura que se ejecute incluso si el script se carga después del DOM
        // IMPORTANTE: Solo inicializar una vez al cargar la página, no después de selecciones del usuario
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initializePrimarySite, 100); // Pequeño delay para asegurar que todos los elementos estén listos
            });
        } else {
            // DOM ya está listo, ejecutar después de un pequeño delay
            setTimeout(initializePrimarySite, 100);
        }
    }

    // Autocomplete para Hotel Sede (Primary Hotel)
    const hotelInput = document.getElementById('hotel_autocomplete');
    const hotelDropdown = document.getElementById('hotel_dropdown');
    const hotelIdInput = document.getElementById('hotel_id');
    const hotelSelected = document.getElementById('hotel_selected');
    const hotelName = document.getElementById('hotel_name');
    let hotelTimeout = null;
    let allPrimaryHotels = [];
    let userHasSelectedHotel = false; // Bandera para rastrear si el usuario seleccionó un hotel manualmente

    // Log inicial para debugging
    if (hotelIdInput) {
        const debugSource = hotelIdInput.getAttribute('data-debug') || 'unknown';
        console.log('=== HOTEL INPUT HIDDEN DEBUG ===');
        console.log('Hotel input hidden encontrado en el DOM:', {
            id: hotelIdInput.id,
            name: hotelIdInput.name,
            value: hotelIdInput.value,
            valueAttribute: hotelIdInput.getAttribute('value'),
            debugSource: debugSource,
            isEmpty: !hotelIdInput.value || hotelIdInput.value.trim() === '',
            outerHTML: hotelIdInput.outerHTML
        });
        console.log('================================');
    } else {
        console.error('❌ Hotel input hidden NO encontrado en el DOM');
    }

    if (hotelSelected) {
        console.log('Hotel selected chip estado:', {
            display: hotelSelected.style.display,
            isVisible: hotelSelected.style.display !== 'none',
            innerHTML: hotelSelected.innerHTML.substring(0, 200)
        });
    }

    // Cargar todos los hoteles para el autocomplete
    function loadPrimaryHotels(cityId = null) {
        const url = cityId ? `/locations/hotels/api/?city=${cityId}` : '/locations/hotels/api/';
        console.log('Cargando hoteles principales desde:', url);
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                console.log('Hoteles cargados:', data.length, 'para ciudad:', cityId);
                console.log('Datos recibidos:', data);
                // Verificar que los hoteles realmente pertenezcan a la ciudad solicitada
                if (cityId) {
                    const filteredData = data.filter(hotel => hotel.city_id === parseInt(cityId));
                    console.log('Hoteles filtrados por ciudad_id:', filteredData.length);
                    data = filteredData;
                }
                allPrimaryHotels = data.map(hotel => ({
                    id: hotel.id,
                    name: hotel.name || hotel.hotel_name || `Hotel ${hotel.id}`,
                    location: hotel.city_id ? `Ciudad ID: ${hotel.city_id}` : ''
                }));
                console.log('allPrimaryHotels después del mapeo:', allPrimaryHotels.length);
                console.log('allPrimaryHotels contenido:', allPrimaryHotels);

                // Si el usuario está escribiendo en el campo de búsqueda, actualizar las sugerencias
                if (hotelInput && hotelInput.value && hotelInput.value.length >= 2) {
                    console.log('Actualizando sugerencias porque hay texto en el input:', hotelInput.value);
                    showHotelSuggestions(hotelInput.value);
                }

                // Si hay un hotel seleccionado inicialmente, verificar si todavía existe
                // NOTA: Esta lógica se ejecuta DESPUÉS de que initializePrimaryHotel haya intentado cargar el hotel
                // Por lo tanto, solo verificamos si el hotel está en la lista y lo mostramos si no se ha mostrado ya
                let initialHotelId = hotelIdInput ? hotelIdInput.value : null;

                // Si está vacío, intentar leer del atributo value
                if (!initialHotelId || initialHotelId.trim() === '') {
                    initialHotelId = hotelIdInput ? hotelIdInput.getAttribute('value') : null;
                }

                // Si aún está vacío, intentar leer del select original de Django
                if (!initialHotelId || initialHotelId.trim() === '') {
                    const originalSelect = document.querySelector('select[id^="id_hotel"]');
                    if (originalSelect && originalSelect.value) {
                        initialHotelId = originalSelect.value;
                    }
                }

                if (initialHotelId && initialHotelId.trim() !== '' && !userHasSelectedHotel) {
                    const hotelId = initialHotelId.trim();
                    console.log('loadPrimaryHotels: Verificando hotel inicial después de cargar lista, ID:', hotelId);
                    const initialHotel = allPrimaryHotels.find(h => h.id === parseInt(hotelId));
                    if (initialHotel) {
                        // El hotel ya está en la lista, verificar si ya se mostró
                        const hotelSelectedDisplay = hotelSelected ? hotelSelected.style.display : 'none';
                        const hotelInputDisplay = hotelInput ? hotelInput.style.display : 'block';

                        // Solo mostrar si no se ha mostrado ya (el input está visible o el selected está oculto)
                        if (hotelInputDisplay !== 'none' || hotelSelectedDisplay === 'none') {
                            console.log('loadPrimaryHotels: Mostrando hotel inicial desde lista:', initialHotel);
                            showSelectedPrimaryHotel(initialHotel, false);
                        } else {
                            console.log('loadPrimaryHotels: Hotel ya está mostrado, no sobrescribir');
                        }
                    } else {
                        console.log('loadPrimaryHotels: Hotel inicial (ID:', hotelId, ') no está en la lista filtrada por ciudad. initializePrimaryHotel debería cargarlo por ID.');
                    }
                } else if (!initialHotelId || initialHotelId.trim() === '') {
                    console.log('loadPrimaryHotels: No hay hotel inicial para mostrar (input vacío)');
                }
            })
            .catch(error => {
                console.error('Error al cargar hoteles para autocomplete:', error);
                allPrimaryHotels = [];
            });
    }

    // Mostrar hotel seleccionado
    function showSelectedPrimaryHotel(hotel, isUserSelection = true) {
        if (!hotel || !hotel.id) {
            console.error('showSelectedPrimaryHotel: hotel inválido', hotel);
            return;
        }

        const previousValue = hotelIdInput ? hotelIdInput.value : null;
        const newValue = hotel.id.toString();

        // Si es una selección del usuario, marcar la bandera
        if (isUserSelection) {
            userHasSelectedHotel = true;
            console.log('Selección del usuario detectada (hotel), marcando bandera');
        }

        // Si el usuario ya seleccionó un hotel y esta no es su selección, no sobrescribir
        if (userHasSelectedHotel && !isUserSelection && previousValue && previousValue !== newValue) {
            console.log('Ignorando inicialización (hotel): usuario ya seleccionó un hotel diferente', {
                hotelIntentado: {id: hotel.id, name: hotel.name},
                hotelActual: previousValue
            });
            return;
        }

        console.log('showSelectedPrimaryHotel llamado:', {
            hotel: {id: hotel.id, name: hotel.name},
            valorAnterior: previousValue,
            valorNuevo: newValue,
            esSeleccionUsuario: isUserSelection,
            usuarioYaSelecciono: userHasSelectedHotel
        });

        // Actualizar el valor
        hotelIdInput.value = newValue;
        hotelName.textContent = hotel.name;
        hotelInput.value = '';
        hotelInput.style.display = 'none';
        hotelSelected.style.display = 'block';
        hotelDropdown.style.display = 'none';

        console.log('Hotel mostrado correctamente. Input hidden actualizado a:', hotelIdInput.value);
    }

    // Limpiar hotel seleccionado
    window.clearHotel = function() {
        hotelIdInput.value = '';
        hotelInput.value = '';
        hotelInput.style.display = 'block';
        hotelSelected.style.display = 'none';
        hotelDropdown.style.display = 'none';
    };

    // Filtrar y mostrar sugerencias
    function showHotelSuggestions(searchTerm) {
        if (!searchTerm || searchTerm.length < 2) {
            hotelDropdown.style.display = 'none';
            return;
        }

        console.log('showHotelSuggestions llamado. allPrimaryHotels:', allPrimaryHotels.length, 'searchTerm:', searchTerm);

        if (allPrimaryHotels.length === 0) {
            const cityId = (cityHidden && cityHidden.value) ? cityHidden.value : null;
            let message = '';
            if (cityId && cityInput && cityInput.value) {
                const cityName = cityInput.value;
                message = `No hay hoteles disponibles para ${cityName}. Por favor, seleccione otra ciudad o cree un hotel para esta ciudad.`;
                console.log('Mostrando mensaje: No hay hoteles para', cityName, 'pero allPrimaryHotels.length es', allPrimaryHotels.length);
            } else {
                message = 'Seleccione una ciudad para ver los hoteles disponibles.';
            }
            hotelDropdown.innerHTML = `
                <div class="list-group-item text-muted text-center py-3">
                    <i class="fas fa-info-circle me-2"></i>${message}
                </div>
            `;
            hotelDropdown.style.display = 'block';
            return;
        }

        const filtered = allPrimaryHotels.filter(hotel => {
            const searchLower = searchTerm.toLowerCase();
            return hotel.name.toLowerCase().includes(searchLower) ||
                   (hotel.location && hotel.location.toLowerCase().includes(searchLower));
        }).slice(0, 10); // Limitar a 10 resultados

        if (filtered.length === 0) {
            hotelDropdown.innerHTML = `
                <div class="list-group-item text-muted text-center py-3">
                    <i class="fas fa-search me-2"></i>No se encontraron hoteles
                </div>
            `;
        } else {
            hotelDropdown.innerHTML = filtered.map(hotel => {
                const safeName = hotel.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                const safeLocation = (hotel.location || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                    <button
                        type="button"
                        class="list-group-item list-group-item-action"
                        onclick="selectPrimaryHotel(${hotel.id})"
                        style="cursor: pointer;"
                    >
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-hotel me-2 text-primary"></i>
                                <strong>${safeName}</strong>
                                ${safeLocation ? `<br><small class="text-muted">${safeLocation}</small>` : ''}
                            </div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                    </button>
                `;
            }).join('');
        }

        hotelDropdown.style.display = 'block';
    }

    // Seleccionar hotel
    window.selectPrimaryHotel = function(hotelId) {
        console.log('selectPrimaryHotel llamado con ID:', hotelId, '(selección del usuario)');
        const hotel = allPrimaryHotels.find(h => h.id === parseInt(hotelId));
        if (hotel) {
            console.log('Hotel encontrado en allPrimaryHotels:', hotel);
            // Marcar como selección del usuario para evitar que se sobrescriba
            showSelectedPrimaryHotel(hotel, true);
        } else {
            console.error('Hotel no encontrado en allPrimaryHotels con ID:', hotelId);
            console.log('Hoteles disponibles:', allPrimaryHotels.map(h => ({id: h.id, name: h.name})));
        }
    };

    // Event listeners para el autocomplete
    if (hotelInput) {
        hotelInput.addEventListener('input', function() {
            clearTimeout(hotelTimeout);
            hotelTimeout = setTimeout(() => {
                showHotelSuggestions(this.value);
            }, 300); // Debounce de 300ms
        });

        hotelInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                showHotelSuggestions(this.value);
            }
        });

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (hotelInput && hotelDropdown && hotelSelected) {
                if (!hotelInput.contains(e.target) &&
                    !hotelDropdown.contains(e.target) &&
                    !hotelSelected.contains(e.target)) {
                    hotelDropdown.style.display = 'none';
                }
            }
        });

        // Manejar teclas en el input
        hotelInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hotelDropdown.style.display = 'none';
            }
        });

        // Cargar hoteles principales SOLO si hay ciudad seleccionada
        // Función para inicializar el hotel principal (solo al cargar la página, no después de selecciones del usuario)
        function initializePrimaryHotel() {
            console.log('initializePrimaryHotel llamado');

            // Verificar si el elemento existe
            if (!hotelIdInput) {
                console.error('hotelIdInput no existe en el DOM');
                return;
            }

            // Obtener el valor del input hidden de múltiples formas
            let rawValue = hotelIdInput.value;

            // Si está vacío, intentar leer del atributo value
            if (!rawValue || rawValue.trim() === '') {
                rawValue = hotelIdInput.getAttribute('value') || '';
            }

            // Si aún está vacío, intentar leer del select original de Django (por si acaso)
            if (!rawValue || rawValue.trim() === '') {
                const originalSelect = document.querySelector('select[id^="id_hotel"]');
                if (originalSelect && originalSelect.value) {
                    rawValue = originalSelect.value;
                    console.log('Valor obtenido del select original:', rawValue);
                }
            }

            console.log('Valor crudo del input hidden (hotel_id):', rawValue, 'tipo:', typeof rawValue);
            console.log('Estado inicial:', {
                userHasSelectedHotel: userHasSelectedHotel,
                hotelIdInputValue: rawValue,
                hotelIdInputExists: !!hotelIdInput,
                allPrimaryHotelsLength: allPrimaryHotels.length,
                hotelSelectedDisplay: hotelSelected ? hotelSelected.style.display : 'N/A',
                hotelInputDisplay: hotelInput ? hotelInput.style.display : 'N/A'
            });

            // Si el usuario ya seleccionó un hotel, no inicializar
            if (userHasSelectedHotel) {
                console.log('Usuario ya seleccionó un hotel, saltando inicialización');
                return;
            }

            // Si el hotel ya está visible, no inicializar
            if (hotelSelected && hotelSelected.style.display !== 'none') {
                console.log('Hotel ya está visible, no es necesario inicializar');
                return;
            }

            const currentHotelId = rawValue && rawValue.trim() !== '' ? rawValue.trim() : null;
            console.log('currentHotelId procesado:', currentHotelId);

            // Solo inicializar si hay un hotel guardado y el usuario no ha seleccionado uno nuevo
            if (currentHotelId && currentHotelId.trim() !== '') {
                console.log('✅ Inicializando hotel principal desde valor guardado, ID:', currentHotelId);
                console.log('Estado antes de inicializar:', {
                    allPrimaryHotelsLength: allPrimaryHotels.length,
                    hotelSelectedDisplay: hotelSelected ? hotelSelected.style.display : 'N/A',
                    hotelInputDisplay: hotelInput ? hotelInput.style.display : 'N/A'
                });

                // Verificar si el hotel ya está en allPrimaryHotels
                const existingHotel = allPrimaryHotels.find(h => h.id === parseInt(currentHotelId));
                if (existingHotel) {
                    console.log('✅ Hotel ya está en la lista, mostrándolo (inicialización):', existingHotel);
                    // Solo mostrar si el usuario no ha seleccionado otro hotel
                    if (!userHasSelectedHotel) {
                        console.log('Mostrando hotel desde allPrimaryHotels...');
                        showSelectedPrimaryHotel(existingHotel, false);
                        console.log('✅ Hotel inicial mostrado correctamente desde allPrimaryHotels');
                    } else {
                        console.log('⚠️ No mostrar hotel inicial, usuario ya seleccionó otro');
                    }
                    return;
                } else {
                    console.log('⚠️ Hotel NO está en allPrimaryHotels todavía. Intentando cargar desde API...');
                    console.log('allPrimaryHotels actual:', allPrimaryHotels.map(h => ({id: h.id, name: h.name})));
                }

                // Si no está en la lista, cargarlo desde la API
                fetch(`/locations/hotels/api/?id=${currentHotelId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(hotelData => {
                        console.log('📡 Hotel inicial cargado desde API:', hotelData, 'Buscando ID:', currentHotelId);
                        if (hotelData && hotelData.length > 0) {
                            // Buscar el hotel con el ID correcto (no solo tomar el primero)
                            let hotel = hotelData.find(h => h.id === parseInt(currentHotelId));

                            if (!hotel) {
                                console.error('❌ Hotel con ID', currentHotelId, 'no encontrado en la respuesta. Hoteles disponibles:', hotelData.map(h => h.id));
                                return;
                            }

                            console.log('✅ Hotel encontrado para inicialización:', {
                                buscado: currentHotelId,
                                encontrado: hotel.id,
                                nombre: hotel.name || hotel.hotel_name,
                                todosLosHoteles: hotelData.map(h => ({id: h.id, name: h.name || h.hotel_name}))
                            });

                            const hotelObj = {
                                id: hotel.id,
                                name: hotel.name || hotel.hotel_name || `Hotel ${hotel.id}`,
                                location: hotel.city_id ? `Ciudad ID: ${hotel.city_id}` : ''
                            };

                            // Agregar a la lista si no está
                            if (!allPrimaryHotels.find(h => h.id === hotelObj.id)) {
                                allPrimaryHotels.push(hotelObj);
                                console.log('✅ Hotel agregado a allPrimaryHotels:', hotelObj);
                            } else {
                                console.log('ℹ️ Hotel ya estaba en allPrimaryHotels');
                            }

                            // Solo mostrar si el usuario no ha seleccionado otro hotel Y el hotel tiene el ID correcto
                            if (!userHasSelectedHotel && hotelObj.id.toString() === currentHotelId) {
                                console.log('Mostrando hotel desde API...');
                                showSelectedPrimaryHotel(hotelObj, false);
                                console.log('✅ Hotel principal inicializado correctamente desde API:', hotelObj);
                            } else {
                                if (hotelObj.id.toString() !== currentHotelId) {
                                    console.error('❌ No inicializar: hotel encontrado no coincide con el ID buscado', {
                                        buscado: currentHotelId,
                                        encontrado: hotelObj.id
                                    });
                                } else {
                                    console.log('⚠️ No inicializar, usuario ya seleccionó otro hotel');
                                }
                            }
                        } else {
                            console.error('❌ No se recibieron datos del hotel desde la API');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error al cargar hotel inicial:', error);
                    });
            } else {
                console.log('No hay hotel guardado para inicializar (currentHotelId vacío o null)');
                console.log('Esto puede significar que:');
                console.log('  1. El evento no tiene un hotel asignado');
                console.log('  2. El valor no se está pasando correctamente desde Django al template');
                console.log('  3. El input hidden no se está renderizando con el valor correcto');

                // Verificar si el hotel está visible en el chip
                if (hotelSelected && hotelSelected.style.display !== 'none') {
                    console.log('Hotel ya está visible en el chip, no es necesario inicializar');
                }
            }

            // Cargar hoteles al iniciar (con ciudad si está seleccionada)
            const initialCityIdForPrimaryHotels = (cityHidden && cityHidden.value) ? cityHidden.value : null;
            if (initialCityIdForPrimaryHotels) {
                console.log('Cargando lista de hoteles de la ciudad:', initialCityIdForPrimaryHotels);
                // Cargar la lista completa de hoteles de la ciudad
                // IMPORTANTE: Esto se ejecuta después de intentar inicializar el hotel guardado
                loadPrimaryHotels(initialCityIdForPrimaryHotels);
            } else {
                console.log('No hay ciudad seleccionada, no se cargarán hoteles');
            }
        }

        // Inicializar inmediatamente y también cuando el DOM esté listo
        // IMPORTANTE: Esperar a que la ciudad se cargue primero, ya que el hotel depende de la ciudad
        console.log('Configurando inicialización de hotel principal. readyState:', document.readyState);

        function scheduleHotelInitialization() {
            // Esperar un poco más para asegurar que la ciudad y otros campos estén inicializados
            const delay = 300; // Aumentar el delay para dar tiempo a que todo se cargue
            console.log(`Programando inicialización de hotel en ${delay}ms`);

            setTimeout(function() {
                console.log('Ejecutando initializePrimaryHotel después del delay');
                initializePrimaryHotel();
            }, delay);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOMContentLoaded: programando initializePrimaryHotel');
                scheduleHotelInitialization();
            });
        } else {
            // DOM ya está listo, ejecutar después de un delay
            console.log('DOM ya listo: programando initializePrimaryHotel');
            scheduleHotelInitialization();
        }
    }

    // Renderizar lista de sitios disponibles
    function renderSitesList(searchTerm = '') {
        // Si no hay sitios disponibles en absoluto
        if (allSites.length === 0) {
            sitesList.style.display = 'block';
            noSitesFound.style.display = 'none';
            const cityId = (cityHidden && cityHidden.value) ? cityHidden.value : null;
            if (cityId && cityInput && cityInput.value) {
                const cityName = cityInput.value;
                sitesList.innerHTML = `<div class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>No hay sitios disponibles para ${cityName}. Por favor, seleccione otra ciudad o cree un sitio para esta ciudad.</div>`;
            } else {
                sitesList.innerHTML = `<div class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>Seleccione una ciudad para ver los sitios disponibles.</div>`;
            }
            return;
        }

        const filteredSites = allSites.filter(site => {
            const isSelected = selectedSites.some(s => s.id === site.id);
            const matchesSearch = !searchTerm ||
                site.name.toLowerCase().includes(searchTerm.toLowerCase());
            return !isSelected && matchesSearch;
        });

        if (filteredSites.length === 0) {
            if (searchTerm) {
                sitesList.style.display = 'none';
                noSitesFound.style.display = 'block';
            } else {
                sitesList.style.display = 'block';
                noSitesFound.style.display = 'none';
                sitesList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-check-circle me-2"></i>Todos los sitios han sido seleccionados</div>';
            }
        } else {
            sitesList.style.display = 'block';
            noSitesFound.style.display = 'none';

            sitesList.innerHTML = filteredSites.map(site => {
                // Escapar comillas para evitar problemas en onclick
                const safeName = site.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                <button
                    type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    data-site-id="${site.id}"
                    onclick="addSite(${site.id})"
                    style="cursor: pointer;"
                >
                    <span><i class="fas fa-map-marker-alt me-2 text-primary"></i>${safeName}</span>
                    <i class="fas fa-plus-circle text-success"></i>
                </button>
            `;
            }).join('');
        }
    }

    // Sincronizar checkboxes con selectedSites
    function syncAdditionalSitesCheckboxes() {
        if (!additionalSitesCheckboxes || additionalSitesCheckboxes.length === 0) return;

        const selectedSiteIds = selectedSites.map(s => s.id.toString());
        additionalSitesCheckboxes.forEach(checkbox => {
            checkbox.checked = selectedSiteIds.includes(checkbox.value);
        });
    }

    // Renderizar chips de sitios seleccionados
    function renderSelectedChips() {
        if (selectedSites.length === 0) {
            selectedSitesChips.innerHTML = '<span class="text-muted small" id="no_selected_message">Ningún sitio seleccionado</span>';
        } else {
            if (noSelectedMessage) {
                noSelectedMessage.style.display = 'none';
            }
            selectedSitesChips.innerHTML = selectedSites.map(site => {
                // Escapar comillas para evitar problemas
                const safeName = site.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                <span class="badge bg-primary d-flex align-items-center gap-2" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${safeName}</span>
                    <button
                        type="button"
                        class="btn-close btn-close-white"
                        style="font-size: 0.7rem;"
                        onclick="removeSite(${site.id})"
                        aria-label="Eliminar"
                    ></button>
                </span>
            `;
            }).join('');
        }

        // Actualizar checkboxes
        additionalSitesCheckboxes.forEach(checkbox => {
            checkbox.checked = selectedSites.some(s => s.id.toString() === checkbox.value);
        });
    }

    // Agregar sitio
    window.addSite = function(siteId) {
        const site = allSites.find(s => s.id === parseInt(siteId) || s.id.toString() === siteId.toString());
        if (site && !selectedSites.some(s => s.id === site.id)) {
            selectedSites.push(site);
            syncAdditionalSitesCheckboxes(); // Sincronizar checkboxes
            renderSelectedChips();
            renderSitesList(siteSearch ? siteSearch.value : '');
            // Limpiar el buscador después de agregar
            if (siteSearch) {
                siteSearch.value = '';
            }
        }
    };

    // Remover sitio
    window.removeSite = function(siteId) {
        selectedSites = selectedSites.filter(s => s.id !== parseInt(siteId) && s.id.toString() !== siteId.toString());
        syncAdditionalSitesCheckboxes(); // Sincronizar checkboxes
        renderSelectedChips();
        renderSitesList(siteSearch ? siteSearch.value : '');
    };

    // Buscar sitios
    if (siteSearch) {
        siteSearch.addEventListener('input', function() {
            renderSitesList(this.value);
        });
    }

    // Inicializar - NO renderizar aquí porque los sitios aún no se han cargado
    // El renderizado se hará después de que los sitios se carguen desde la API
    // Solo renderizar la lista vacía por ahora
    const currentSiteSearch = siteSearch ? siteSearch.value : '';
    renderSitesList(currentSiteSearch);

    // Sistema mejorado de selección de hoteles adicionales con buscador
    const hotelSearch = document.getElementById('hotel_search');
    const hotelsList = document.getElementById('hotels_list');
    const selectedHotelsChips = document.getElementById('selected_hotels_chips');
    const noSelectedHotelsMessage = document.getElementById('no_selected_hotels_message');
    const additionalHotelsCheckboxes = document.querySelectorAll('#additional_hotels_hidden input[type="checkbox"]');
    const noHotelsFound = document.getElementById('no_hotels_found');

    // Obtener todos los hoteles desde la API
    let allHotels = [];
    let selectedHotels = [];

    // Cargar hoteles desde la API
    function loadHotels(cityId = null) {
        const url = cityId ? `/locations/hotels/api/?city=${cityId}` : '/locations/hotels/api/';
        console.log('Cargando hoteles adicionales desde:', url);
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                console.log('Hoteles adicionales recibidos:', data.length, 'para ciudad:', cityId);
                console.log('Datos recibidos:', data);
                // Verificar que los hoteles realmente pertenezcan a la ciudad solicitada
                if (cityId) {
                    const filteredData = data.filter(hotel => hotel.city_id === parseInt(cityId));
                    console.log('Hoteles adicionales filtrados por ciudad_id:', filteredData.length);
                    data = filteredData;
                }
                allHotels = data.map(hotel => ({
                    id: hotel.id,
                    name: hotel.name || hotel.hotel_name || `Hotel ${hotel.id}`,
                    checkbox: null
                }));
                console.log('allHotels después del mapeo:', allHotels.length);

                // Limpiar hoteles seleccionados que ya no están en la lista
                selectedHotels = selectedHotels.filter(sh =>
                    allHotels.some(h => h.id === sh.id)
                );

                // Encontrar los checkboxes correspondientes
                allHotels.forEach(hotel => {
                    const checkbox = Array.from(additionalHotelsCheckboxes).find(cb => cb.value === hotel.id.toString());
                    if (checkbox) {
                        hotel.checkbox = checkbox;
                        // Si el checkbox está marcado, agregarlo a seleccionados (si no está ya)
                        if (checkbox.checked && !selectedHotels.some(sh => sh.id === hotel.id)) {
                            selectedHotels.push(hotel);
                        }
                    }
                });

                console.log('Hoteles cargados:', allHotels.length, 'Hoteles seleccionados:', selectedHotels.length);

                // Inicializar la interfaz
                renderSelectedHotelsChips();
                // Asegurar que la lista se muestre con el término de búsqueda actual
                const currentSearch = hotelSearch ? hotelSearch.value : '';
                renderHotelsList(currentSearch);
            })
            .catch(error => {
                console.error('Error al cargar hoteles:', error);
                allHotels = [];
                // Fallback: usar los checkboxes existentes
                additionalHotelsCheckboxes.forEach(checkbox => {
                    const label = checkbox.closest('label') || document.querySelector(`label[for="${checkbox.id}"]`);
                    let hotelName = label ? label.textContent.trim() : `Hotel ${checkbox.value}`;
                    // Limpiar el nombre si contiene el checkbox
                    hotelName = hotelName.replace(checkbox.value, '').trim();

                    allHotels.push({
                        id: checkbox.value,
                        name: hotelName || `Hotel ${checkbox.value}`,
                        checkbox: checkbox
                    });

                    if (checkbox.checked) {
                        selectedHotels.push(allHotels[allHotels.length - 1]);
                    }
                });
                renderSelectedHotelsChips();
                renderHotelsList();
            });
    }

    // Renderizar lista de hoteles disponibles
    function renderHotelsList(searchTerm = '') {
        if (!hotelsList) {
            console.error('hotelsList element not found');
            return;
        }

        console.log('renderHotelsList llamado. allHotels:', allHotels.length, 'selectedHotels:', selectedHotels.length, 'searchTerm:', searchTerm);

        // Si no hay hoteles cargados, mostrar mensaje
        if (allHotels.length === 0) {
            hotelsList.style.display = 'block';
            if (noHotelsFound) noHotelsFound.style.display = 'none';
            const cityId = (cityHidden && cityHidden.value) ? cityHidden.value : null;
            if (cityId && cityInput && cityInput.value) {
                const cityName = cityInput.value;
                hotelsList.innerHTML = `<div class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>No hay hoteles disponibles para ${cityName}. Por favor, seleccione otra ciudad o cree un hotel para esta ciudad.</div>`;
            } else {
                hotelsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>Seleccione una ciudad para ver los hoteles disponibles.</div>';
            }
            return;
        }

        const filteredHotels = allHotels.filter(hotel => {
            const isSelected = selectedHotels.some(h => h.id === hotel.id);
            const matchesSearch = !searchTerm ||
                hotel.name.toLowerCase().includes(searchTerm.toLowerCase());
            return !isSelected && matchesSearch;
        });

        console.log('Hoteles filtrados para mostrar:', filteredHotels.length);

        if (filteredHotels.length === 0) {
            if (searchTerm) {
                hotelsList.style.display = 'none';
                if (noHotelsFound) noHotelsFound.style.display = 'block';
            } else {
                hotelsList.style.display = 'block';
                if (noHotelsFound) noHotelsFound.style.display = 'none';
                hotelsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-check-circle me-2"></i>Todos los hoteles han sido seleccionados</div>';
            }
        } else {
            hotelsList.style.display = 'block';
            if (noHotelsFound) noHotelsFound.style.display = 'none';

            console.log('Renderizando', filteredHotels.length, 'hoteles en la lista');
            hotelsList.innerHTML = filteredHotels.map(hotel => {
                // Escapar comillas para evitar problemas en onclick
                const safeName = hotel.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                <button
                    type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    data-hotel-id="${hotel.id}"
                    onclick="addHotel(${hotel.id})"
                    style="cursor: pointer;"
                >
                    <span><i class="fas fa-hotel me-2 text-primary"></i>${safeName}</span>
                    <i class="fas fa-plus-circle text-success"></i>
                </button>
            `;
            }).join('');
        }
    }

    // Renderizar chips de hoteles seleccionados
    function renderSelectedHotelsChips() {
        if (selectedHotels.length === 0) {
            selectedHotelsChips.innerHTML = '<span class="text-muted small" id="no_selected_hotels_message">Ningún hotel seleccionado</span>';
        } else {
            if (noSelectedHotelsMessage) {
                noSelectedHotelsMessage.style.display = 'none';
            }
            selectedHotelsChips.innerHTML = selectedHotels.map(hotel => {
                // Escapar comillas para evitar problemas
                const safeName = hotel.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                <span class="badge bg-primary d-flex align-items-center gap-2" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                    <i class="fas fa-hotel"></i>
                    <span>${safeName}</span>
                    <button
                        type="button"
                        class="btn-close btn-close-white"
                        style="font-size: 0.7rem;"
                        onclick="removeHotel(${hotel.id})"
                        aria-label="Eliminar"
                    ></button>
                </span>
            `;
            }).join('');
        }

        // Actualizar checkboxes
        if (additionalHotelsCheckboxes && additionalHotelsCheckboxes.length > 0) {
            additionalHotelsCheckboxes.forEach(checkbox => {
                checkbox.checked = selectedHotels.some(h => h.id.toString() === checkbox.value);
            });
        }
    }

    // Agregar hotel
    window.addHotel = function(hotelId) {
        const hotel = allHotels.find(h => h.id === parseInt(hotelId) || h.id.toString() === hotelId.toString());
        if (hotel && !selectedHotels.some(h => h.id === hotel.id)) {
            selectedHotels.push(hotel);
            renderSelectedHotelsChips();
            renderHotelsList(hotelSearch ? hotelSearch.value : '');
            // Limpiar el buscador después de agregar
            if (hotelSearch) {
                hotelSearch.value = '';
            }
        }
    };

    // Remover hotel
    window.removeHotel = function(hotelId) {
        selectedHotels = selectedHotels.filter(h => h.id !== parseInt(hotelId) && h.id.toString() !== hotelId.toString());
        renderSelectedHotelsChips();
        renderHotelsList(hotelSearch ? hotelSearch.value : '');
    };

    // Buscar hoteles
    if (hotelSearch) {
        hotelSearch.addEventListener('input', function() {
            renderHotelsList(this.value);
        });
    }

    // Cargar hoteles al iniciar (con ciudad si está seleccionada)
    // Cargar hoteles adicionales SOLO si hay ciudad seleccionada
    const initialCityIdForHotels = (cityHidden && cityHidden.value) ? cityHidden.value : null;
    if (initialCityIdForHotels) {
        loadHotels(initialCityIdForHotels);
    } else {
        // Si no hay ciudad, NO cargar hoteles - esperar a que se seleccione una ciudad
        allHotels = [];
        renderHotelsList();
    }

    // ========== SISTEMA DE SELECCIÓN DE CONTACTOS ==========
    const contactSearch = document.getElementById('contact_search');
    const contactsList = document.getElementById('contacts_list');
    const selectedContactsChips = document.getElementById('selected_contacts_chips');
    const noSelectedContactsMessage = document.getElementById('no_selected_contacts_message');
    const contactsHidden = document.getElementById('contacts_hidden');

    let contactsCheckboxes = [];
    if (contactsHidden) {
        contactsCheckboxes = contactsHidden.querySelectorAll('input[type="checkbox"]');
        if (contactsCheckboxes.length === 0) {
            contactsCheckboxes = document.querySelectorAll('input[type="checkbox"][name="event_contact"]');
        }
        if (contactsCheckboxes.length === 0) {
            contactsCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="id_event_contact_"]');
        }
    }

    const noContactsFound = document.getElementById('no_contacts_found');
    let allContacts = [];
    let selectedContacts = [];

    // Cargar contactos desde los checkboxes
    function loadContacts() {
        allContacts = [];
        selectedContacts = [];

        if (contactsCheckboxes.length === 0) {
            console.warn('No se encontraron checkboxes de contactos');
            if (contactsList) {
                contactsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-exclamation-triangle me-2"></i>No hay contactos disponibles. Por favor, cree contactos primero.</div>';
            }
            return;
        }

        contactsCheckboxes.forEach(checkbox => {
            const label = checkbox.closest('label') || document.querySelector(`label[for="${checkbox.id}"]`);
            let contactFullText = '';
            let contactName = '';
            let contactPosition = '';
            let contactOrganization = '';

            if (label) {
                const labelText = label.textContent || label.innerText;
                contactFullText = labelText.replace(/\s+/g, ' ').trim();

                if (label.contains(checkbox)) {
                    const textAfter = Array.from(label.childNodes)
                        .filter(node => node.nodeType === 3 || (node.nodeType === 1 && node !== checkbox))
                        .map(node => node.textContent || '')
                        .join(' ')
                        .trim();
                    if (textAfter) {
                        contactFullText = textAfter;
                    }
                }

                // Parsear el formato: "Nombre - Cargo (Organización)" o "Nombre - Cargo" o "Nombre (Organización)"
                // Regex para capturar: Nombre - Cargo (Organización)
                let match = contactFullText.match(/^(.+?)\s*-\s*(.+?)\s*\((.+?)\)$/);
                if (match) {
                    contactName = match[1].trim();
                    contactPosition = match[2].trim();
                    contactOrganization = match[3].trim();
                } else {
                    // Regex para: Nombre - Cargo
                    match = contactFullText.match(/^(.+?)\s*-\s*(.+?)$/);
                    if (match) {
                        contactName = match[1].trim();
                        contactPosition = match[2].trim();
                    } else {
                        // Regex para: Nombre (Organización)
                        match = contactFullText.match(/^(.+?)\s*\((.+?)\)$/);
                        if (match) {
                            contactName = match[1].trim();
                            contactOrganization = match[2].trim();
                        } else {
                            // Solo el nombre
                            contactName = contactFullText;
                        }
                    }
                }
            }

            if (!contactName || contactName === '') {
                contactName = `Contacto ${checkbox.value}`;
            }

            allContacts.push({
                id: checkbox.value,
                name: contactName,
                position: contactPosition,
                organization: contactOrganization,
                fullText: contactFullText,
                checkbox: checkbox
            });

            if (checkbox.checked) {
                selectedContacts.push(allContacts[allContacts.length - 1]);
            }
        });

        console.log('Contactos cargados:', {
            total: allContacts.length,
            selected: selectedContacts.length
        });

        renderSelectedContactsChips();
        renderContactsList();
    }

    // Renderizar chips de contactos seleccionados
    function renderSelectedContactsChips() {
        if (!selectedContactsChips) return;

        selectedContactsChips.innerHTML = '';

        if (selectedContacts.length === 0) {
            if (noSelectedContactsMessage) {
                selectedContactsChips.appendChild(noSelectedContactsMessage.cloneNode(true));
            }
            return;
        }

        selectedContacts.forEach(contact => {
            const chip = document.createElement('span');
            chip.className = 'badge bg-primary d-inline-flex align-items-center gap-2 py-2 px-3';

            let chipContent = `<i class="fas fa-user me-1"></i><span><strong>${contact.name}</strong>`;
            if (contact.position) {
                chipContent += `<br><small style="font-size: 0.75rem; opacity: 0.9;">${contact.position}</small>`;
            }
            chipContent += `</span>`;

            chip.innerHTML = `
                ${chipContent}
                <button type="button" class="btn-close btn-close-white" style="font-size: 0.65rem;" onclick="removeContact('${contact.id}')"></button>
            `;
            selectedContactsChips.appendChild(chip);
        });
    }

    // Renderizar lista de contactos
    function renderContactsList(searchQuery = '') {
        if (!contactsList) return;

        contactsList.innerHTML = '';

        if (allContacts.length === 0) {
            contactsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>No hay contactos disponibles.</div>';
            return;
        }

        const query = searchQuery.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        const filteredContacts = searchQuery
            ? allContacts.filter(contact =>
                contact.name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes(query)
              )
            : allContacts;

        if (filteredContacts.length === 0) {
            if (noContactsFound) {
                noContactsFound.style.display = 'block';
            }
            contactsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-search me-2"></i>No se encontraron contactos con ese criterio</div>';
            return;
        }

        if (noContactsFound) {
            noContactsFound.style.display = 'none';
        }

        filteredContacts.forEach(contact => {
            const isSelected = selectedContacts.some(s => s.id === contact.id);
            const item = document.createElement('button');
            item.type = 'button';
            item.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${isSelected ? 'active' : ''}`;

            let contactInfo = `<div class="d-flex align-items-start">
                <i class="fas fa-user me-2 mt-1"></i>
                <div>
                    <div class="fw-semibold">${contact.name}</div>`;

            if (contact.position && contact.organization) {
                contactInfo += `<small class="${isSelected ? 'text-white-50' : 'text-muted'}">${contact.position} en ${contact.organization}</small>`;
            } else if (contact.position) {
                contactInfo += `<small class="${isSelected ? 'text-white-50' : 'text-muted'}">${contact.position}</small>`;
            } else if (contact.organization) {
                contactInfo += `<small class="${isSelected ? 'text-white-50' : 'text-muted'}">${contact.organization}</small>`;
            }

            contactInfo += `</div></div>`;

            item.innerHTML = `
                ${contactInfo}
                ${isSelected ? '<i class="fas fa-check text-white"></i>' : '<i class="fas fa-plus text-primary"></i>'}
            `;

            item.addEventListener('click', function() {
                if (isSelected) {
                    removeContact(contact.id);
                } else {
                    addContact(contact.id);
                }
            });

            contactsList.appendChild(item);
        });
    }

    // Agregar contacto
    window.addContact = function(contactId) {
        const contact = allContacts.find(c => c.id === contactId || c.id.toString() === contactId.toString());
        if (contact && !selectedContacts.some(s => s.id === contact.id)) {
            selectedContacts.push(contact);
            if (contact.checkbox) {
                contact.checkbox.checked = true;
            }
            renderSelectedContactsChips();
            renderContactsList(contactSearch ? contactSearch.value : '');
        }
    };

    // Remover contacto
    window.removeContact = function(contactId) {
        const contact = allContacts.find(c => c.id === contactId || c.id.toString() === contactId.toString());
        selectedContacts = selectedContacts.filter(c => c.id !== contactId && c.id.toString() !== contactId.toString());
        if (contact && contact.checkbox) {
            contact.checkbox.checked = false;
        }
        renderSelectedContactsChips();
        renderContactsList(contactSearch ? contactSearch.value : '');
    };

    // Buscar contactos
    if (contactSearch) {
        contactSearch.addEventListener('input', function() {
            renderContactsList(this.value);
        });
    }

    // Cargar contactos al iniciar
    if (contactsCheckboxes.length > 0) {
        loadContacts();
    } else {
        console.warn('No se encontraron checkboxes de contactos');
        if (contactsList) {
            contactsList.innerHTML = `
                <div class="alert alert-warning text-center py-3 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>No hay contactos disponibles.</strong><br>
                    <small>Por favor, cree contactos desde la sección "Gestión de Datos" → "Contactos de Eventos" en el menú lateral.</small>
                </div>
            `;
        }
        if (selectedContactsChips) {
            selectedContactsChips.innerHTML = `
                <div class="alert alert-info text-center py-2 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>No hay contactos disponibles para seleccionar.</small>
                </div>
            `;
        }
    }

    // ========== SISTEMA DE SELECCIÓN DE DIVISIONES ==========
    const divisionSearch = document.getElementById('division_search');
    const divisionsList = document.getElementById('divisions_list');
    const selectedDivisionsChips = document.getElementById('selected_divisions_chips');
    const noSelectedDivisionsMessage = document.getElementById('no_selected_divisions_message');
    const divisionsHidden = document.getElementById('divisions_hidden');

    // Buscar checkboxes de diferentes formas posibles (Django puede renderizarlos de varias maneras)
    let divisionsCheckboxes = [];
    if (divisionsHidden) {
        // Buscar dentro del contenedor
        divisionsCheckboxes = divisionsHidden.querySelectorAll('input[type="checkbox"]');

        // Si no se encuentran, buscar en todo el documento con el name correcto
        if (divisionsCheckboxes.length === 0) {
            divisionsCheckboxes = document.querySelectorAll('input[type="checkbox"][name="divisions"]');
        }

        // Si aún no se encuentran, buscar por ID que empiece con id_divisions
        if (divisionsCheckboxes.length === 0) {
            divisionsCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="id_divisions_"]');
        }

        // Si aún no se encuentran, buscar cualquier checkbox dentro de un ul o li que esté relacionado con divisions
        if (divisionsCheckboxes.length === 0) {
            const divisionsContainer = divisionsHidden.querySelector('ul');
            if (divisionsContainer) {
                divisionsCheckboxes = divisionsContainer.querySelectorAll('input[type="checkbox"]');
            }
        }
    }

    // Si aún no se encuentran, buscar en todo el documento cualquier checkbox relacionado con divisions
    if (divisionsCheckboxes.length === 0) {
        // Buscar por name que contenga "divisions"
        divisionsCheckboxes = document.querySelectorAll('input[type="checkbox"][name*="divisions"]');
    }

    const noDivisionsFound = document.getElementById('no_divisions_found');

    console.log('Divisiones - Elementos encontrados:', {
        divisionSearch: !!divisionSearch,
        divisionsList: !!divisionsList,
        selectedDivisionsChips: !!selectedDivisionsChips,
        divisionsHidden: !!divisionsHidden,
        checkboxesCount: divisionsCheckboxes.length,
        divisionsHiddenHTML: divisionsHidden ? (divisionsHidden.innerHTML.length > 0 ? divisionsHidden.innerHTML.substring(0, 500) : '(vacío)') : 'N/A',
        allCheckboxesInPage: document.querySelectorAll('input[type="checkbox"]').length
    });

    // Si encontramos checkboxes, mostrar información adicional
    if (divisionsCheckboxes.length > 0) {
        console.log('Checkboxes de divisiones encontrados:', Array.from(divisionsCheckboxes).map(cb => ({
            id: cb.id,
            name: cb.name,
            value: cb.value,
            checked: cb.checked,
            label: cb.closest('label') ? cb.closest('label').textContent.trim() : 'sin label'
        })));
    }

    // Obtener todas las divisiones desde los checkboxes
    let allDivisions = [];
    let selectedDivisions = [];

    // Cargar divisiones desde los checkboxes
    function loadDivisions() {
        allDivisions = []; // Resetear array
        selectedDivisions = []; // Resetear array

        // Si no hay checkboxes, mostrar mensaje
        if (divisionsCheckboxes.length === 0) {
            console.warn('No se encontraron checkboxes de divisiones');
            if (divisionsList) {
                divisionsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-exclamation-triangle me-2"></i>No hay divisiones disponibles. Por favor, cree divisiones primero.</div>';
            }
            return;
        }

        // Obtener todas las divisiones desde los checkboxes
        divisionsCheckboxes.forEach(checkbox => {
            const label = checkbox.closest('label') || document.querySelector(`label[for="${checkbox.id}"]`);
            let divisionName = '';

            if (label) {
                // Obtener el texto del label, removiendo el checkbox si está dentro
                const labelText = label.textContent || label.innerText;
                // Remover espacios en blanco y saltos de línea
                divisionName = labelText.replace(/\s+/g, ' ').trim();

                // Si el checkbox está dentro del label, intentar obtener solo el texto después del checkbox
                if (label.contains(checkbox)) {
                    // Crear un rango de texto desde después del checkbox
                    const textAfter = Array.from(label.childNodes)
                        .filter(node => node.nodeType === 3 || (node.nodeType === 1 && node !== checkbox))
                        .map(node => node.textContent || '')
                        .join(' ')
                        .trim();
                    if (textAfter) {
                        divisionName = textAfter;
                    }
                }
            }

            // Si aún no hay nombre, usar el value como fallback
            if (!divisionName || divisionName === '') {
                divisionName = `División ${checkbox.value}`;
            }

            allDivisions.push({
                id: checkbox.value,
                name: divisionName,
                checkbox: checkbox
            });

            if (checkbox.checked) {
                selectedDivisions.push(allDivisions[allDivisions.length - 1]);
            }
        });

        console.log('Divisiones cargadas:', {
            total: allDivisions.length,
            selected: selectedDivisions.length,
            divisions: allDivisions.map(d => ({ id: d.id, name: d.name }))
        });

        // Inicializar la interfaz
        renderSelectedDivisionsChips();
        renderDivisionsList();
    }

    // Renderizar lista de divisiones disponibles
    function renderDivisionsList(searchTerm = '') {
        if (!divisionsList) {
            console.error('divisionsList no encontrado');
            return;
        }

        // Si no hay divisiones cargadas, mostrar mensaje
        if (allDivisions.length === 0) {
            divisionsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-exclamation-triangle me-2"></i>No hay divisiones disponibles. Por favor, cree divisiones primero.</div>';
            if (noDivisionsFound) {
                noDivisionsFound.style.display = 'none';
            }
            return;
        }

        const filteredDivisions = allDivisions.filter(division => {
            const isSelected = selectedDivisions.some(d => d.id === division.id);
            const matchesSearch = !searchTerm ||
                division.name.toLowerCase().includes(searchTerm.toLowerCase());
            return !isSelected && matchesSearch;
        });

        if (filteredDivisions.length === 0) {
            if (searchTerm) {
                divisionsList.style.display = 'none';
                if (noDivisionsFound) {
                    noDivisionsFound.style.display = 'block';
                }
            } else {
                divisionsList.style.display = 'block';
                if (noDivisionsFound) {
                    noDivisionsFound.style.display = 'none';
                }
                divisionsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-check-circle me-2"></i>Todas las divisiones han sido seleccionadas</div>';
            }
        } else {
            divisionsList.style.display = 'block';
            if (noDivisionsFound) {
                noDivisionsFound.style.display = 'none';
            }

            divisionsList.innerHTML = filteredDivisions.map(division => {
                // Escapar comillas para evitar problemas en onclick
                const safeName = division.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                <button
                    type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    data-division-id="${division.id}"
                    onclick="addDivision(${division.id})"
                    style="cursor: pointer;"
                >
                    <span><i class="fas fa-layer-group me-2 text-primary"></i>${safeName}</span>
                    <i class="fas fa-plus-circle text-success"></i>
                </button>
            `;
            }).join('');
        }
    }

    // Renderizar chips de divisiones seleccionadas
    function renderSelectedDivisionsChips() {
        if (selectedDivisions.length === 0) {
            selectedDivisionsChips.innerHTML = '<span class="text-muted small" id="no_selected_divisions_message">Ninguna división seleccionada</span>';
        } else {
            if (noSelectedDivisionsMessage) {
                noSelectedDivisionsMessage.style.display = 'none';
            }
            selectedDivisionsChips.innerHTML = selectedDivisions.map(division => {
                // Escapar comillas para evitar problemas
                const safeName = division.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                <span class="badge bg-primary d-flex align-items-center gap-2" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                    <i class="fas fa-layer-group"></i>
                    <span>${safeName}</span>
                    <button
                        type="button"
                        class="btn-close btn-close-white"
                        style="font-size: 0.7rem;"
                        onclick="removeDivision(${division.id})"
                        aria-label="Eliminar"
                    ></button>
                </span>
            `;
            }).join('');
        }

        // Actualizar checkboxes
        if (divisionsCheckboxes && divisionsCheckboxes.length > 0) {
            divisionsCheckboxes.forEach(checkbox => {
                checkbox.checked = selectedDivisions.some(d => d.id.toString() === checkbox.value);
            });
        }
    }

    // Agregar división
    window.addDivision = function(divisionId) {
        const division = allDivisions.find(d => d.id === parseInt(divisionId) || d.id.toString() === divisionId.toString());
        if (division && !selectedDivisions.some(d => d.id === division.id)) {
            selectedDivisions.push(division);
            renderSelectedDivisionsChips();
            renderDivisionsList(divisionSearch ? divisionSearch.value : '');
            // Limpiar el buscador después de agregar
            if (divisionSearch) {
                divisionSearch.value = '';
            }
        }
    };

    // Remover división
    window.removeDivision = function(divisionId) {
        selectedDivisions = selectedDivisions.filter(d => d.id !== parseInt(divisionId) && d.id.toString() !== divisionId.toString());
        renderSelectedDivisionsChips();
        renderDivisionsList(divisionSearch ? divisionSearch.value : '');
    };

    // Buscar divisiones
    if (divisionSearch) {
        divisionSearch.addEventListener('input', function() {
            renderDivisionsList(this.value);
        });
    }

    // Función para cargar divisiones desde el contexto del template (alternativa a checkboxes)
    function loadDivisionsFromContext() {
        {% if available_divisions %}
        try {
            const divisionsFromContext = JSON.parse('{{ available_divisions|escapejs }}');
            console.log('Cargando divisiones desde contexto:', divisionsFromContext);

            if (divisionsFromContext && Array.isArray(divisionsFromContext) && divisionsFromContext.length > 0) {
                allDivisions = divisionsFromContext.map(div => ({
                    id: div.id,
                    name: div.name,
                    checkbox: null
                }));

                console.log('Divisiones cargadas desde contexto:', allDivisions.length);

                // Crear checkboxes ocultos para el formulario
                if (divisionsHidden) {
                    let ul = divisionsHidden.querySelector('ul#id_divisions');
                    if (!ul) {
                        ul = document.createElement('ul');
                        ul.id = 'id_divisions';
                        divisionsHidden.appendChild(ul);
                    }

                    ul.innerHTML = ''; // Limpiar

                    allDivisions.forEach(division => {
                        const li = document.createElement('li');
                        const label = document.createElement('label');
                        const checkbox = document.createElement('input');

                        checkbox.type = 'checkbox';
                        checkbox.name = 'divisions';
                        checkbox.value = division.id;
                        checkbox.id = `id_divisions_${division.id}`;
                        checkbox.className = 'form-check-input';

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(' ' + division.name));
                        li.appendChild(label);
                        ul.appendChild(li);

                        division.checkbox = checkbox;
                    });

                    console.log('Checkboxes creados:', allDivisions.length);
                }

                renderSelectedDivisionsChips();
                renderDivisionsList();
            } else {
                console.warn('Array de divisiones vacío en el contexto');
                if (divisionsList) {
                    divisionsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-exclamation-triangle me-2"></i>No hay divisiones disponibles. Por favor, cree divisiones primero.</div>';
                }
            }
        } catch (error) {
            console.error('Error al cargar divisiones desde contexto:', error);
            if (divisionsList) {
                divisionsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar divisiones.</div>';
            }
        }
        {% else %}
        console.warn('No hay divisiones en el contexto del template');
        if (divisionsList) {
            divisionsList.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-exclamation-triangle me-2"></i>No hay divisiones disponibles. Por favor, cree divisiones primero.</div>';
        }
        {% endif %}
    }

    // Cargar divisiones al iniciar
    if (divisionsCheckboxes.length > 0) {
        console.log('Cargando divisiones desde checkboxes HTML');
        loadDivisions();
    } else {
        console.warn('No se encontraron checkboxes. Intentando cargar desde contexto...');
        loadDivisionsFromContext();

        // Si aún no hay divisiones después de cargar del contexto
        if (allDivisions.length === 0) {
            console.error('No se pudieron cargar divisiones de ninguna fuente');
            if (divisionsList) {
                divisionsList.innerHTML = `
                    <div class="alert alert-warning text-center py-3 mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>No hay divisiones disponibles.</strong><br>
                        <small>Por favor, cree divisiones desde la sección "Configuración" → "Divisiones" en el menú lateral.</small>
                    </div>
                `;
            }
            if (selectedDivisionsChips) {
                selectedDivisionsChips.innerHTML = `
                    <div class="alert alert-info text-center py-2 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>No hay divisiones disponibles para seleccionar.</small>
                    </div>
                `;
            }
        }
    }
});
</script>

<!-- Quill HTML Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para crear botón de alternancia HTML/Visual
    function createHtmlToggleButton() {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'ql-html-toggle';
        button.setAttribute('type', 'button');
        button.style.cssText = 'display: inline-flex !important; flex-direction: row !important; align-items: center !important; white-space: nowrap !important;';
        button.innerHTML = '<i class="fas fa-code" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">HTML</span>';
        button.title = 'Alternar entre modo Visual y HTML';
        return button;
    }

    // Configuración de Quill con botón personalizado
    const quillConfig = {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['blockquote', 'code-block'],
                ['clean']
                ],
                handlers: {
                    'html-toggle': function() {
                        // Este handler se manejará externamente
                    }
                }
            }
        },
        placeholder: 'Escriba aquí...',
    };

    let descriptionEditor = null;
    let descriptionPlayerEditor = null;
    let emailBodyEditor = null;
    let descriptionHtmlMode = false;
    let descriptionPlayerHtmlMode = false;

    // Inicializar Quill para descripción general
    const descriptionField = document.getElementById('id_description');
    const descriptionEditorDiv = document.getElementById('description-editor');
    const descriptionHtmlEditor = document.getElementById('description-html-editor');

    // Inicializar Quill para descripción de Player
    const descriptionPlayerField = document.getElementById('id_description_player');
    const descriptionPlayerEditorDiv = document.getElementById('description-player-editor');
    const descriptionPlayerHtmlEditor = document.getElementById('description-player-html-editor');

    // Ocultar el textarea original del formulario
    if (descriptionField) {
        descriptionField.style.display = 'none';
        descriptionField.style.visibility = 'hidden';
        descriptionField.style.position = 'absolute';
        descriptionField.style.width = '0';
        descriptionField.style.height = '0';
        descriptionField.style.opacity = '0';
        descriptionField.style.pointerEvents = 'none';
    }

    // Ocultar el textarea original de description_player
    if (descriptionPlayerField) {
        descriptionPlayerField.style.display = 'none';
        descriptionPlayerField.style.visibility = 'hidden';
        descriptionPlayerField.style.position = 'absolute';
        descriptionPlayerField.style.width = '0';
        descriptionPlayerField.style.height = '0';
        descriptionPlayerField.style.opacity = '0';
        descriptionPlayerField.style.pointerEvents = 'none';
    }

    // Inicialización simple de editores
    if (descriptionField && descriptionEditorDiv) {
        try {
            if (typeof Quill !== 'undefined') {
                descriptionEditor = new Quill('#description-editor', quillConfig);
                console.log('✅ Editor Quill inicializado para descripción general');

                const toolbarElement = descriptionEditor.container ? descriptionEditor.container.previousElementSibling : null;
                if (toolbarElement) {
                    const buttonContainer = document.createElement('span');
                    buttonContainer.className = 'ql-formats';
                    const htmlToggleBtn = createHtmlToggleButton();
                    htmlToggleBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleHtmlMode('description');
                    });
                    buttonContainer.appendChild(htmlToggleBtn);
                    toolbarElement.appendChild(buttonContainer);
                }

                if (descriptionField.value) {
                    descriptionEditor.root.innerHTML = descriptionField.value;
                    if (descriptionHtmlEditor) {
                        descriptionHtmlEditor.value = descriptionField.value;
                    }
                }

                descriptionEditor.on('text-change', function() {
                    if (!descriptionHtmlMode) {
                        descriptionField.value = descriptionEditor.root.innerHTML;
                        if (descriptionHtmlEditor) {
                            descriptionHtmlEditor.value = descriptionEditor.root.innerHTML;
                        }
                    }
                });

                if (descriptionHtmlEditor) {
                    descriptionHtmlEditor.addEventListener('input', function() {
                        if (descriptionHtmlMode) {
                            descriptionField.value = descriptionHtmlEditor.value;
                            try {
                                descriptionEditor.root.innerHTML = descriptionHtmlEditor.value;
                            } catch (e) {
                                console.warn('Error al actualizar editor visual desde HTML:', e);
                            }
                        }
                    });
                }
            } else {
                console.warn('⚠️ Quill no disponible para descripción general');
                descriptionField.style.display = 'block';
                descriptionField.style.visibility = 'visible';
                descriptionField.style.position = 'relative';
                descriptionField.style.width = '100%';
                descriptionField.style.height = '300px';
                descriptionField.style.opacity = '1';
                descriptionField.style.pointerEvents = 'auto';
            }
        } catch (e) {
            console.error('Error inicializando editor general:', e);
            descriptionField.style.display = 'block';
            descriptionField.style.visibility = 'visible';
            descriptionField.style.position = 'relative';
            descriptionField.style.width = '100%';
            descriptionField.style.height = '300px';
            descriptionField.style.opacity = '1';
            descriptionField.style.pointerEvents = 'auto';
        }
    }

    if (descriptionPlayerField && descriptionPlayerEditorDiv) {
        if (typeof Quill === 'undefined') {
            console.warn('⚠️ Quill no disponible para Player');
            descriptionPlayerField.style.display = 'block';
            descriptionPlayerField.style.visibility = 'visible';
            descriptionPlayerField.style.position = 'relative';
            descriptionPlayerField.style.width = '100%';
            descriptionPlayerField.style.height = '300px';
            descriptionPlayerField.style.opacity = '1';
            descriptionPlayerField.style.pointerEvents = 'auto';
        }
    }

    // Función para alternar entre modo HTML y Visual
    function toggleHtmlMode(editorType) {
        if (editorType === 'description') {
            descriptionHtmlMode = !descriptionHtmlMode;
            const editorDiv = document.getElementById('description-editor');
            const htmlEditor = document.getElementById('description-html-editor');
            const toolbarElement = descriptionEditor ? descriptionEditor.container.previousElementSibling : null;
            const toggleBtn = toolbarElement ? toolbarElement.querySelector('.ql-html-toggle') : null;

            if (descriptionHtmlMode) {
                // Cambiar a modo HTML
                if (editorDiv) {
                    editorDiv.style.display = 'none';
                }
                if (htmlEditor) {
                    htmlEditor.style.display = 'block';
                    // Sincronizar contenido
                    if (descriptionEditor) {
                        htmlEditor.value = descriptionEditor.root.innerHTML;
                    }
                }
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i class="fas fa-eye" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">Visual</span>';
                    toggleBtn.classList.add('active');
                }
            } else {
                // Cambiar a modo Visual
                if (editorDiv) {
                    editorDiv.style.display = 'block';
                }
                if (htmlEditor) {
                    htmlEditor.style.display = 'none';
                    // Sincronizar contenido
                    if (descriptionEditor && htmlEditor) {
                        try {
                            descriptionEditor.root.innerHTML = htmlEditor.value;
                            if (descriptionField) {
                                descriptionField.value = htmlEditor.value;
                            }
                        } catch (e) {
                            console.warn('Error al actualizar editor visual:', e);
                        }
                    }
                }
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i class="fas fa-code" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">HTML</span>';
                    toggleBtn.classList.remove('active');
                }
            }
        } else if (editorType === 'description_player') {
            descriptionPlayerHtmlMode = !descriptionPlayerHtmlMode;
            const editorDiv = document.getElementById('description-player-editor');
            const htmlEditor = document.getElementById('description-player-html-editor');
            const toolbarElement = descriptionPlayerEditor ? descriptionPlayerEditor.container.previousElementSibling : null;
            const toggleBtn = toolbarElement ? toolbarElement.querySelector('.ql-html-toggle') : null;

            if (descriptionPlayerHtmlMode) {
                if (editorDiv) editorDiv.style.display = 'none';
                if (htmlEditor) {
                    htmlEditor.style.display = 'block';
                    if (descriptionPlayerEditor) {
                        htmlEditor.value = descriptionPlayerEditor.root.innerHTML;
                    }
                }
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i class="fas fa-eye" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">Visual</span>';
                    toggleBtn.classList.add('active');
                }
            } else {
                if (editorDiv) editorDiv.style.display = 'block';
                if (htmlEditor) {
                    htmlEditor.style.display = 'none';
                    if (descriptionPlayerEditor && htmlEditor) {
                        try {
                            descriptionPlayerEditor.root.innerHTML = htmlEditor.value;
                            if (descriptionPlayerField) {
                                descriptionPlayerField.value = htmlEditor.value;
                            }
                        } catch (e) {
                            console.warn('Error al actualizar editor visual:', e);
                        }
                    }
                }
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i class="fas fa-code" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">HTML</span>';
                    toggleBtn.classList.remove('active');
                }
            }
        }
    }

    // Hacer la función accesible globalmente para el botón
    window.toggleHtmlMode = toggleHtmlMode;

    // Inicializar editor para Player
    if (descriptionPlayerField && descriptionPlayerEditorDiv) {
        // Si ya existe Quill en el DOM (por doble ejecución del script), reutilizar instancia
        if (descriptionPlayerEditorDiv.querySelector('.ql-container') || descriptionPlayerEditorDiv.querySelector('.ql-editor')) {
            try {
                if (typeof Quill !== 'undefined' && Quill.find) {
                    descriptionPlayerEditor = Quill.find(descriptionPlayerEditorDiv);
                }
            } catch (e) {
                // ignore
            }
        }

        // Inicializar si aún no existe instancia
        if (!descriptionPlayerEditor && typeof Quill !== 'undefined') {
            descriptionPlayerEditor = new Quill('#description-player-editor', quillConfig);
        }

        // Agregar botón de alternancia HTML (una sola vez)
        const playerToolbarElement = descriptionPlayerEditor && descriptionPlayerEditor.container
            ? descriptionPlayerEditor.container.previousElementSibling
            : null;
        if (playerToolbarElement && !playerToolbarElement.querySelector('.ql-html-toggle')) {
            const playerButtonContainer = document.createElement('span');
            playerButtonContainer.className = 'ql-formats';

            const playerHtmlToggleBtn = createHtmlToggleButton();
            playerHtmlToggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleHtmlMode('description_player');
            });

            playerButtonContainer.appendChild(playerHtmlToggleBtn);
            playerToolbarElement.appendChild(playerButtonContainer);
        }

        // Cargar contenido inicial
        if (descriptionPlayerField.value) {
            descriptionPlayerEditor.root.innerHTML = descriptionPlayerField.value;
            if (descriptionPlayerHtmlEditor) {
                descriptionPlayerHtmlEditor.value = descriptionPlayerField.value;
            }
        }

        // Sincronizar contenido
        descriptionPlayerEditor.on('text-change', function() {
            if (!descriptionPlayerHtmlMode) {
                descriptionPlayerField.value = descriptionPlayerEditor.root.innerHTML;
                if (descriptionPlayerHtmlEditor) {
                    descriptionPlayerHtmlEditor.value = descriptionPlayerEditor.root.innerHTML;
                }
            }
        });

        // Sincronizar cuando se edita el HTML directamente
        if (descriptionPlayerHtmlEditor) {
            descriptionPlayerHtmlEditor.addEventListener('input', function() {
                if (descriptionPlayerHtmlMode) {
                    descriptionPlayerField.value = descriptionPlayerHtmlEditor.value;
                    try {
                        descriptionPlayerEditor.root.innerHTML = descriptionPlayerHtmlEditor.value;
                    } catch (e) {
                        console.warn('Error al actualizar editor visual desde HTML:', e);
                    }
                }
            });
        }
    }

    // Inicializar Quill para email_welcome_body
    const emailBodyField = document.getElementById('id_email_welcome_body');
    const emailBodyEditorDiv = document.getElementById('email-body-editor');
    const emailHtmlEditor = document.getElementById('email-body-html-editor');
    let emailBodyHtmlMode = false;

    // Ocultar el textarea original del formulario de email
    if (emailBodyField) {
        emailBodyField.style.display = 'none';
        emailBodyField.style.visibility = 'hidden';
        emailBodyField.style.position = 'absolute';
        emailBodyField.style.width = '0';
        emailBodyField.style.height = '0';
        emailBodyField.style.opacity = '0';
        emailBodyField.style.pointerEvents = 'none';
    }

    if (emailBodyField && emailBodyEditorDiv) {
        emailBodyEditor = new Quill('#email-body-editor', quillConfig);

        // Buscar el contenedor del editor de email
        const emailEditorContainer = document.getElementById('email-body-editor-container');

        // Agregar botón de alternancia HTML a la toolbar del email
        const emailToolbarElement = emailBodyEditor.container.previousElementSibling;
        if (emailToolbarElement) {
            // Crear un contenedor para el botón que se integre mejor con Quill
            const emailButtonContainer = document.createElement('span');
            emailButtonContainer.className = 'ql-formats';

            const emailHtmlToggleBtn = createHtmlToggleButton();
            emailHtmlToggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleEmailHtmlMode();
            });

            emailButtonContainer.appendChild(emailHtmlToggleBtn);
            emailToolbarElement.appendChild(emailButtonContainer);
        }

        // Cargar contenido inicial si existe
        if (emailBodyField.value) {
            emailBodyEditor.root.innerHTML = emailBodyField.value;
            if (emailHtmlEditor) {
                emailHtmlEditor.value = emailBodyField.value;
            }
        }

        // Sincronizar contenido con el textarea original
        emailBodyEditor.on('text-change', function() {
            if (!emailBodyHtmlMode) {
            emailBodyField.value = emailBodyEditor.root.innerHTML;
                if (emailHtmlEditor) {
                    emailHtmlEditor.value = emailBodyEditor.root.innerHTML;
                }
            }
        });

        // Sincronizar cuando se edita el HTML directamente
        if (emailHtmlEditor) {
            emailHtmlEditor.addEventListener('input', function() {
                if (emailBodyHtmlMode) {
                    emailBodyField.value = emailHtmlEditor.value;
                    try {
                        emailBodyEditor.root.innerHTML = emailHtmlEditor.value;
                    } catch (e) {
                        console.warn('Error al actualizar editor visual desde HTML:', e);
                    }
                }
            });
        }

        // Función para alternar modo HTML del email
        function toggleEmailHtmlMode() {
            emailBodyHtmlMode = !emailBodyHtmlMode;
            const emailEditorDiv = document.getElementById('email-body-editor');
            const emailHtmlEditor = document.getElementById('email-body-html-editor');
            const emailToolbarElement = emailBodyEditor ? emailBodyEditor.container.previousElementSibling : null;
            const emailToggleBtn = emailToolbarElement ? emailToolbarElement.querySelector('.ql-html-toggle') : null;

            if (emailBodyHtmlMode) {
                // Cambiar a modo HTML
                if (emailEditorDiv) {
                    emailEditorDiv.style.display = 'none';
                }
                if (emailHtmlEditor) {
                    emailHtmlEditor.style.display = 'block';
                    emailHtmlEditor.value = emailBodyEditor.root.innerHTML;
                }
                if (emailToggleBtn) {
                    emailToggleBtn.innerHTML = '<i class="fas fa-eye" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">Visual</span>';
                    emailToggleBtn.classList.add('active');
                }
            } else {
                // Cambiar a modo Visual
                if (emailEditorDiv) {
                    emailEditorDiv.style.display = 'block';
                }
                if (emailHtmlEditor) {
                    emailHtmlEditor.style.display = 'none';
                    try {
                        emailBodyEditor.root.innerHTML = emailHtmlEditor.value;
                        emailBodyField.value = emailHtmlEditor.value;
                    } catch (e) {
                        console.warn('Error al actualizar editor visual:', e);
                    }
                }
                if (emailToggleBtn) {
                    emailToggleBtn.innerHTML = '<i class="fas fa-code" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">HTML</span>';
                    emailToggleBtn.classList.remove('active');
                }
            }
        }

        window.toggleEmailHtmlMode = toggleEmailHtmlMode;
    }

    // Inicializar editores para Team Manager y Spectator
    let teamManagerEditor = null;
    let spectatorEditor = null;
    let teamManagerHtmlMode = false;
    let spectatorHtmlMode = false;
    let teamManagerEditorInitialized = false;
    let spectatorEditorInitialized = false;

    // Función para inicializar el editor de Team Manager
    function initializeTeamManagerEditor() {
        if (teamManagerEditorInitialized && teamManagerEditor) return;

        const teamManagerField = document.getElementById('id_description_team_manager');
        const teamManagerEditorDiv = document.getElementById('description-team-manager-editor');
        const teamManagerHtmlEditor = document.getElementById('description-team-manager-html-editor');

        if (!teamManagerField || !teamManagerEditorDiv) return;

        // Verificar si el contenedor ya tiene un editor Quill inicializado
        if (teamManagerEditorDiv.querySelector('.ql-container')) {
            // Ya hay un editor, no inicializar de nuevo
            teamManagerEditorInitialized = true;
            return;
        }

        // Ocultar el textarea original
        teamManagerField.style.display = 'none';
        teamManagerField.style.visibility = 'hidden';
        teamManagerField.style.position = 'absolute';
        teamManagerField.style.width = '0';
        teamManagerField.style.height = '0';
        teamManagerField.style.opacity = '0';
        teamManagerField.style.pointerEvents = 'none';

        // Asegurar que el contenedor sea visible
        const container = document.getElementById('description-team-manager-editor-container');
        if (container) {
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.width = '100%';
        }
        teamManagerEditorDiv.style.display = 'block';
        teamManagerEditorDiv.style.visibility = 'visible';
        teamManagerEditorDiv.style.minHeight = '300px';

        try {
            teamManagerEditor = new Quill('#description-team-manager-editor', quillConfig);
            teamManagerEditorInitialized = true;

            // Agregar botón de alternancia HTML
            const teamManagerToolbarElement = teamManagerEditor.container.previousElementSibling;
            if (teamManagerToolbarElement) {
                const teamManagerButtonContainer = document.createElement('span');
                teamManagerButtonContainer.className = 'ql-formats';

                const teamManagerHtmlToggleBtn = createHtmlToggleButton();
                teamManagerHtmlToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleTeamManagerHtmlMode();
                });

                teamManagerButtonContainer.appendChild(teamManagerHtmlToggleBtn);
                teamManagerToolbarElement.appendChild(teamManagerButtonContainer);
            }

            // Cargar contenido inicial
            if (teamManagerField.value) {
                teamManagerEditor.root.innerHTML = teamManagerField.value;
                if (teamManagerHtmlEditor) {
                    teamManagerHtmlEditor.value = teamManagerField.value;
                }
            }

            // Sincronizar contenido
            teamManagerEditor.on('text-change', function() {
                if (!teamManagerHtmlMode) {
                    teamManagerField.value = teamManagerEditor.root.innerHTML;
                    if (teamManagerHtmlEditor) {
                        teamManagerHtmlEditor.value = teamManagerEditor.root.innerHTML;
                    }
                }
            });

            // Sincronizar cuando se edita el HTML directamente
            if (teamManagerHtmlEditor) {
                teamManagerHtmlEditor.addEventListener('input', function() {
                    if (teamManagerHtmlMode) {
                        teamManagerField.value = teamManagerHtmlEditor.value;
                        try {
                            teamManagerEditor.root.innerHTML = teamManagerHtmlEditor.value;
                        } catch (e) {
                            console.warn('Error al actualizar editor visual desde HTML:', e);
                        }
                    }
                });
            }

            // Habilitar el editor para escritura
            teamManagerEditor.enable(true);
            teamManagerEditor.root.setAttribute('contenteditable', 'true');

        } catch (e) {
            console.error('Error inicializando editor de Team Manager:', e);
        }
    }

    // Función para alternar modo HTML del Team Manager
    function toggleTeamManagerHtmlMode() {
        teamManagerHtmlMode = !teamManagerHtmlMode;
        const editorDiv = document.getElementById('description-team-manager-editor');
        const htmlEditor = document.getElementById('description-team-manager-html-editor');
        const toolbarElement = teamManagerEditor ? teamManagerEditor.container.previousElementSibling : null;
        const toggleBtn = toolbarElement ? toolbarElement.querySelector('.ql-html-toggle') : null;

        if (teamManagerHtmlMode) {
            if (editorDiv) editorDiv.style.display = 'none';
            if (htmlEditor) {
                htmlEditor.style.display = 'block';
                htmlEditor.value = teamManagerEditor ? teamManagerEditor.root.innerHTML : '';
            }
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-eye" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">Visual</span>';
                toggleBtn.classList.add('active');
            }
        } else {
            if (editorDiv) editorDiv.style.display = 'block';
            if (htmlEditor) {
                htmlEditor.style.display = 'none';
                try {
                    if (teamManagerEditor) {
                        teamManagerEditor.root.innerHTML = htmlEditor.value;
                        const teamManagerField = document.getElementById('id_description_team_manager');
                        if (teamManagerField) {
                            teamManagerField.value = htmlEditor.value;
                        }
                    }
                } catch (e) {
                    console.warn('Error al actualizar editor visual:', e);
                }
            }
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-code" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">HTML</span>';
                toggleBtn.classList.remove('active');
            }
        }
    }

    window.toggleTeamManagerHtmlMode = toggleTeamManagerHtmlMode;

    // Inicializar el editor cuando el tab de Team Manager se muestre
    const teamManagerTabPane = document.getElementById('team-manager');
    if (teamManagerTabPane) {
        // Verificar si el tab ya está visible al cargar
        if (teamManagerTabPane.classList.contains('show') || teamManagerTabPane.classList.contains('active')) {
            setTimeout(function() {
                initializeTeamManagerEditor();
            }, 100);
        }

        // Agregar listener para cuando se muestre el tab
        const teamManagerTab = document.getElementById('team-manager-tab');
        if (teamManagerTab) {
            teamManagerTab.addEventListener('shown.bs.tab', function() {
                setTimeout(function() {
                    initializeTeamManagerEditor();
                }, 100);
            });
        }
    }

    // Función para inicializar el editor de Spectator
    function initializeSpectatorEditor() {
        if (spectatorEditorInitialized && spectatorEditor) return;

        const spectatorField = document.getElementById('id_description_spectator');
        const spectatorEditorDiv = document.getElementById('description-spectator-editor');
        const spectatorHtmlEditor = document.getElementById('description-spectator-html-editor');

        if (!spectatorField || !spectatorEditorDiv) return;

        // Verificar si el contenedor ya tiene un editor Quill inicializado
        if (spectatorEditorDiv.querySelector('.ql-container')) {
            // Ya hay un editor, no inicializar de nuevo
            spectatorEditorInitialized = true;
            return;
        }

        // Ocultar el textarea original
        spectatorField.style.display = 'none';
        spectatorField.style.visibility = 'hidden';
        spectatorField.style.position = 'absolute';
        spectatorField.style.width = '0';
        spectatorField.style.height = '0';
        spectatorField.style.opacity = '0';
        spectatorField.style.pointerEvents = 'none';

        // Asegurar que el contenedor sea visible
        const container = document.getElementById('description-spectator-editor-container');
        if (container) {
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.width = '100%';
        }
        spectatorEditorDiv.style.display = 'block';
        spectatorEditorDiv.style.visibility = 'visible';
        spectatorEditorDiv.style.minHeight = '300px';

        try {
            spectatorEditor = new Quill('#description-spectator-editor', quillConfig);
            spectatorEditorInitialized = true;

            // Agregar botón de alternancia HTML
            const spectatorToolbarElement = spectatorEditor.container.previousElementSibling;
            if (spectatorToolbarElement) {
                const spectatorButtonContainer = document.createElement('span');
                spectatorButtonContainer.className = 'ql-formats';

                const spectatorHtmlToggleBtn = createHtmlToggleButton();
                spectatorHtmlToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleSpectatorHtmlMode();
                });

                spectatorButtonContainer.appendChild(spectatorHtmlToggleBtn);
                spectatorToolbarElement.appendChild(spectatorButtonContainer);
            }

            // Cargar contenido inicial
            if (spectatorField.value) {
                spectatorEditor.root.innerHTML = spectatorField.value;
                if (spectatorHtmlEditor) {
                    spectatorHtmlEditor.value = spectatorField.value;
                }
            }

            // Sincronizar contenido
            spectatorEditor.on('text-change', function() {
                if (!spectatorHtmlMode) {
                    spectatorField.value = spectatorEditor.root.innerHTML;
                    if (spectatorHtmlEditor) {
                        spectatorHtmlEditor.value = spectatorEditor.root.innerHTML;
                    }
                }
            });

            // Sincronizar cuando se edita el HTML directamente
            if (spectatorHtmlEditor) {
                spectatorHtmlEditor.addEventListener('input', function() {
                    if (spectatorHtmlMode) {
                        spectatorField.value = spectatorHtmlEditor.value;
                        try {
                            spectatorEditor.root.innerHTML = spectatorHtmlEditor.value;
                        } catch (e) {
                            console.warn('Error al actualizar editor visual desde HTML:', e);
                        }
                    }
                });
            }

            // Habilitar el editor para escritura
            spectatorEditor.enable(true);
            spectatorEditor.root.setAttribute('contenteditable', 'true');

        } catch (e) {
            console.error('Error inicializando editor de Spectator:', e);
        }
    }

    // Función para alternar modo HTML del Spectator
    function toggleSpectatorHtmlMode() {
        spectatorHtmlMode = !spectatorHtmlMode;
        const editorDiv = document.getElementById('description-spectator-editor');
        const htmlEditor = document.getElementById('description-spectator-html-editor');
        const toolbarElement = spectatorEditor ? spectatorEditor.container.previousElementSibling : null;
        const toggleBtn = toolbarElement ? toolbarElement.querySelector('.ql-html-toggle') : null;

        if (spectatorHtmlMode) {
            if (editorDiv) editorDiv.style.display = 'none';
            if (htmlEditor) {
                htmlEditor.style.display = 'block';
                htmlEditor.value = spectatorEditor ? spectatorEditor.root.innerHTML : '';
            }
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-eye" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">Visual</span>';
                toggleBtn.classList.add('active');
            }
        } else {
            if (editorDiv) editorDiv.style.display = 'block';
            if (htmlEditor) {
                htmlEditor.style.display = 'none';
                try {
                    if (spectatorEditor) {
                        spectatorEditor.root.innerHTML = htmlEditor.value;
                        const spectatorField = document.getElementById('id_description_spectator');
                        if (spectatorField) {
                            spectatorField.value = htmlEditor.value;
                        }
                    }
                } catch (e) {
                    console.warn('Error al actualizar editor visual:', e);
                }
            }
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-code" style="display: inline-block !important; margin-right: 4px;"></i><span style="display: inline-block !important;">HTML</span>';
                toggleBtn.classList.remove('active');
            }
        }
    }

    window.toggleSpectatorHtmlMode = toggleSpectatorHtmlMode;

    // Inicializar el editor cuando el tab de Spectator se muestre
    const spectatorTabPane = document.getElementById('spectator');
    if (spectatorTabPane) {
        // Verificar si el tab ya está visible al cargar
        if (spectatorTabPane.classList.contains('show') || spectatorTabPane.classList.contains('active')) {
            setTimeout(function() {
                initializeSpectatorEditor();
            }, 100);
        }

        // Agregar listener para cuando se muestre el tab
        const spectatorTab = document.getElementById('spectator-tab');
        if (spectatorTab) {
            spectatorTab.addEventListener('shown.bs.tab', function() {
                setTimeout(function() {
                    initializeSpectatorEditor();
                }, 100);
            });
        }
    }

    // Asegurar que el contenido se envíe al formulario
    const form = document.getElementById('eventForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('Sincronizando formulario antes de enviar...');

            // Sincronizar antes de enviar
            if (descriptionEditor && descriptionField) {
                if (descriptionHtmlMode && descriptionHtmlEditor) {
                    descriptionField.value = descriptionHtmlEditor.value;
                } else {
                descriptionField.value = descriptionEditor.root.innerHTML;
                }
            }
            if (emailBodyEditor && emailBodyField) {
                const emailHtmlEditor = document.getElementById('email-body-html-editor');
                if (emailBodyHtmlMode && emailHtmlEditor) {
                    emailBodyField.value = emailHtmlEditor.value;
                } else {
                emailBodyField.value = emailBodyEditor.root.innerHTML;
                }
            }
            // Sincronizar editores de Team Manager y Spectator
            if (teamManagerEditor && teamManagerField) {
                const teamManagerHtmlEditor = document.getElementById('description-team-manager-html-editor');
                if (teamManagerHtmlMode && teamManagerHtmlEditor) {
                    teamManagerField.value = teamManagerHtmlEditor.value;
                } else {
                    teamManagerField.value = teamManagerEditor.root.innerHTML;
                }
            }
            if (spectatorEditor && spectatorField) {
                const spectatorHtmlEditor = document.getElementById('description-spectator-html-editor');
                if (spectatorHtmlMode && spectatorHtmlEditor) {
                    spectatorField.value = spectatorHtmlEditor.value;
                } else {
                    spectatorField.value = spectatorEditor.root.innerHTML;
                }
            }

            // Verificar que primary_site tenga el valor correcto
            const primarySiteIdInput = document.getElementById('primary_site_id');
            if (primarySiteIdInput) {
                const siteId = primarySiteIdInput.value;
                console.log('Primary site a enviar (desde input hidden):', siteId);

                // Asegurarnos de que el input hidden tenga el valor correcto
                // El input hidden ya tiene name="primary_site", así que se enviará directamente
                // No necesitamos sincronizar con otro campo

                // Verificar que no haya otro campo con name="primary_site" que pueda interferir
                const otherPrimarySiteFields = document.querySelectorAll('[name="primary_site"]');
                if (otherPrimarySiteFields.length > 1) {
                    console.warn('ADVERTENCIA: Hay múltiples campos con name="primary_site"', otherPrimarySiteFields);
                    // Remover el name de todos excepto el input hidden
                    otherPrimarySiteFields.forEach(field => {
                        if (field.id !== 'primary_site_id' && field.getAttribute('name') === 'primary_site') {
                            field.removeAttribute('name');
                            console.log('Removido name de campo duplicado:', field.id || field.tagName);
                        }
                    });
                }
            } else {
                console.error('No se encontró el input hidden primary_site_id');
            }

            // Verificar que hotel tenga el valor correcto
            const hotelIdInput = document.getElementById('hotel_id');
            if (hotelIdInput) {
                const hotelId = hotelIdInput.value;
                console.log('Hotel a enviar (desde input hidden):', hotelId);

                // El input hidden ya tiene name="hotel", así que se enviará directamente
                // Verificar que no haya otro campo con name="hotel" que pueda interferir
                const otherHotelFields = document.querySelectorAll('[name="hotel"]');
                if (otherHotelFields.length > 1) {
                    console.warn('ADVERTENCIA: Hay múltiples campos con name="hotel"', otherHotelFields);
                    // Remover el name de todos excepto el input hidden
                    otherHotelFields.forEach(field => {
                        if (field.id !== 'hotel_id' && field.getAttribute('name') === 'hotel') {
                            field.removeAttribute('name');
                            console.log('Removido name de campo duplicado (hotel):', field.id || field.tagName);
                        }
                    });
                }
            } else {
                console.error('No se encontró el input hidden hotel_id');
            }

            // Sincronizar additional_sites - asegurar que los checkboxes reflejen la selección
            // Los checkboxes ya deberían estar sincronizados por renderSelectedChips(),
            // pero verificamos una vez más antes de enviar
            const additionalSitesCheckboxes = document.querySelectorAll('#additional_sites_hidden input[type="checkbox"]');
            if (additionalSitesCheckboxes.length > 0) {
                // Obtener los IDs de los sitios seleccionados desde los chips visibles
                // Esto es más confiable que depender de la variable JavaScript
                const selectedChips = document.querySelectorAll('#selected_sites_chips .badge');
                const selectedSiteIdsFromChips = Array.from(selectedChips).map(chip => {
                    const removeBtn = chip.querySelector('button[onclick*="removeSite"]');
                    if (removeBtn) {
                        const onclick = removeBtn.getAttribute('onclick');
                        const match = onclick.match(/removeSite\((\d+)\)/);
                        if (match) return match[1];
                    }
                    return null;
                }).filter(Boolean);

                console.log('Sitios seleccionados desde chips:', selectedSiteIdsFromChips);

                // Sincronizar checkboxes con los chips visibles
                additionalSitesCheckboxes.forEach(checkbox => {
                    const shouldBeChecked = selectedSiteIdsFromChips.includes(checkbox.value);
                    checkbox.checked = shouldBeChecked;
                    if (shouldBeChecked) {
                        console.log('Checkbox sincronizado y marcado:', checkbox.value);
                    }
                });
                console.log('Additional sites sincronizados antes de enviar');
            } else {
                console.warn('No se encontraron checkboxes para additional_sites');
            }
        });
    }

    // Función helper para obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ========== SISTEMA UNIFICADO DE SELECCIÓN DE MEDIOS ==========
    function initUnifiedMediaSelector() {
        const mediaSelectorModal = document.getElementById('mediaSelectorModal');
        if (!mediaSelectorModal) {
            console.warn('Modal unificada no encontrada, reintentando...');
            setTimeout(initUnifiedMediaSelector, 200);
            return;
        }

        // Elementos de la modal unificada
        const mediaSearchInput = document.getElementById('mediaSearchInput');
        const mediaSelectorGrid = document.getElementById('mediaSelectorGrid');
        const mediaSelectorLoading = document.getElementById('mediaSelectorLoading');
        const mediaSelectorEmpty = document.getElementById('mediaSelectorEmpty');
        const confirmMediaSelection = document.getElementById('confirmMediaSelection');
        const mediaTypeFilter = document.getElementById('mediaTypeFilter');
        const uploadMediaBtn = document.getElementById('uploadMediaBtn');
        const mediaUploadInput = document.getElementById('mediaUploadInput');
        const mediaUploadProgress = document.getElementById('mediaUploadProgress');
        const clearMediaSearchBtn = document.getElementById('clearMediaSearchBtn');
        const mediaModalIcon = document.getElementById('mediaModalIcon');
        const mediaModalTitle = document.getElementById('mediaSelectorModalLabel');
        const mediaModalSubtitle = document.getElementById('mediaModalSubtitle');

        // Estado de la modal
        let currentMediaType = '';
        let currentTargetField = null;
        let selectedMedia = null;
        let searchTimeout = null;
        let isLoadingMedia = false;
        let currentPage = 1;
        let paginationInfo = null;

        // Función para cargar medios con paginación
        function loadMedia(search = '', type = '', page = 1) {
            if (!mediaSelectorGrid || !mediaSelectorLoading || !mediaSelectorEmpty) return;
            if (isLoadingMedia) return;

            isLoadingMedia = true;
            currentPage = page;
            mediaSelectorGrid.innerHTML = '';
            mediaSelectorLoading.style.display = 'block';
            mediaSelectorEmpty.style.display = 'none';

            const mediaSelectorPagination = document.getElementById('mediaSelectorPagination');
            if (mediaSelectorPagination) {
                mediaSelectorPagination.style.display = 'none';
            }

            // Construir URL con parámetros correctamente
            const baseUrl = '{% url "media:list_ajax" %}';
            const params = new URLSearchParams();
            if (type) {
                params.append('type', type);
            }
            if (search) {
                params.append('search', search);
            }
            params.append('page', page.toString());
            params.append('per_page', '24');  // Cambiar de limit a per_page
            const url = baseUrl + (params.toString() ? '?' + params.toString() : '');

            fetch(url, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                mediaSelectorLoading.style.display = 'none';
                isLoadingMedia = false;

                if (data.success && data.results && data.results.length > 0) {
                    mediaSelectorGrid.innerHTML = '';
                    const addedIds = new Set();
                    data.results.forEach(media => {
                        if (!addedIds.has(media.id)) {
                            addedIds.add(media.id);
                            const mediaItem = createMediaItem(media);
                            mediaSelectorGrid.appendChild(mediaItem);
                        }
                    });

                    // Renderizar paginación si existe
                    if (data.pagination && data.pagination.total_pages > 1) {
                        paginationInfo = data.pagination;
                        renderPagination(data.pagination, search, type);
                        if (mediaSelectorPagination) {
                            mediaSelectorPagination.style.display = 'block';
                        }
                    } else {
                        if (mediaSelectorPagination) {
                            mediaSelectorPagination.style.display = 'none';
                        }
                    }
                } else {
                    mediaSelectorEmpty.style.display = 'block';
                    if (mediaSelectorPagination) {
                        mediaSelectorPagination.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error al cargar medios:', error);
                mediaSelectorLoading.style.display = 'none';
                mediaSelectorEmpty.style.display = 'block';
                isLoadingMedia = false;
                const mediaSelectorPagination = document.getElementById('mediaSelectorPagination');
                if (mediaSelectorPagination) {
                    mediaSelectorPagination.style.display = 'none';
                }
            });
        }

        // Función para renderizar controles de paginación
        function renderPagination(pagination, search = '', type = '') {
            const paginationContainer = document.querySelector('#mediaSelectorPagination ul');
            if (!paginationContainer) return;

            paginationContainer.innerHTML = '';

            // Botón Anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${!pagination.has_previous ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" data-page="${pagination.previous_page || 1}" ${!pagination.has_previous ? 'tabindex="-1" aria-disabled="true"' : ''}>
                    <i class="fas fa-chevron-left me-1"></i>Anterior
                </a>
            `;
            if (pagination.has_previous) {
                prevLi.querySelector('a').addEventListener('click', function(e) {
                    e.preventDefault();
                    loadMedia(search, type, pagination.previous_page);
                });
            }
            paginationContainer.appendChild(prevLi);

            // Números de página
            const totalPages = pagination.total_pages;
            const currentPageNum = pagination.current_page;
            const startPage = Math.max(1, currentPageNum - 2);
            const endPage = Math.min(totalPages, currentPageNum + 2);

            // Primera página si no está visible
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
                firstLi.querySelector('a').addEventListener('click', function(e) {
                    e.preventDefault();
                    loadMedia(search, type, 1);
                });
                paginationContainer.appendChild(firstLi);
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    paginationContainer.appendChild(ellipsisLi);
                }
            }

            // Páginas visibles
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPageNum ? 'active' : ''}`;
                if (i === currentPageNum) {
                    pageLi.innerHTML = `<span class="page-link">${i}</span>`;
                } else {
                    pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    pageLi.querySelector('a').addEventListener('click', function(e) {
                        e.preventDefault();
                        loadMedia(search, type, i);
                    });
                }
                paginationContainer.appendChild(pageLi);
            }

            // Última página si no está visible
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    paginationContainer.appendChild(ellipsisLi);
                }
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
                lastLi.querySelector('a').addEventListener('click', function(e) {
                    e.preventDefault();
                    loadMedia(search, type, totalPages);
                });
                paginationContainer.appendChild(lastLi);
            }

            // Botón Siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${!pagination.has_next ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" data-page="${pagination.next_page || 1}" ${!pagination.has_next ? 'tabindex="-1" aria-disabled="true"' : ''}>
                    Siguiente<i class="fas fa-chevron-right ms-1"></i>
                </a>
            `;
            if (pagination.has_next) {
                nextLi.querySelector('a').addEventListener('click', function(e) {
                    e.preventDefault();
                    loadMedia(search, type, pagination.next_page);
                });
            }
            paginationContainer.appendChild(nextLi);
        }

        // Función para crear item de medio
        function createMediaItem(media) {
            const item = document.createElement('div');
            item.className = 'video-selector-item';
            item.dataset.mediaId = media.id;
            item.dataset.mediaUrl = media.url;
            // Almacenar thumbnail para vista previa
            item.dataset.mediaThumbnail = media.thumbnail || media.url || '';
            item.dataset.mediaType = media.file_type || '';

            let thumbnail = '';
            if (media.file_type === 'video') {
                thumbnail = media.thumbnail
                    ? `<img src="${media.thumbnail}" alt="${media.title || 'Video'}">`
                    : `<div class="placeholder"><i class="fas fa-video"></i></div>`;
            } else if (media.file_type === 'image') {
                thumbnail = media.thumbnail || media.url
                    ? `<img src="${media.thumbnail || media.url}" alt="${media.title || 'Imagen'}">`
                    : `<div class="placeholder"><i class="fas fa-image"></i></div>`;
            } else {
                thumbnail = `<div class="placeholder"><i class="fas fa-file"></i></div>`;
            }

            const fileSize = formatFileSize(media.file_size || 0);
            const mediaTitle = media.title || 'Sin título';
            const playOverlay = media.file_type === 'video'
                ? '<div class="video-play-overlay"><i class="fas fa-play-circle"></i></div>'
                : '';

            item.innerHTML = `
                <div class="video-thumbnail">
                    ${thumbnail}
                    ${playOverlay}
                </div>
                <div class="video-info">
                    <div class="video-title" title="${mediaTitle}">${mediaTitle}</div>
                    <div class="video-meta">
                        <span><i class="fas fa-hdd"></i> ${fileSize}</span>
                    </div>
                </div>
            `;

            item.addEventListener('click', function() {
                document.querySelectorAll('#mediaSelectorGrid .video-selector-item').forEach(el => {
                    el.classList.remove('selected');
                });
                item.classList.add('selected');
                selectedMedia = {
                    id: media.id,
                    url: media.url,
                    title: mediaTitle,
                    thumbnail: media.thumbnail || media.url || '',
                    file_type: media.file_type || ''
                };
                confirmMediaSelection.disabled = false;
            });

            return item;
        }

        // Función helper para formatear tamaño de archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Configurar botones "Elegir de Media"
        function setupMediaButtons() {
            const buttons = document.querySelectorAll('button[data-media-type]');
            console.log('Buscando botones con data-media-type, encontrados:', buttons.length);

            if (buttons.length === 0) {
                console.warn('No se encontraron botones con data-media-type, reintentando...');
                setTimeout(setupMediaButtons, 500);
                return;
            }

            buttons.forEach(btn => {
                // Remover listener anterior si existe
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Click en botón de media detectado');

                    const mediaType = this.getAttribute('data-media-type');
                    const targetField = this.getAttribute('data-target-field');
                    const modalTitle = this.getAttribute('data-modal-title') || 'Seleccionar Medio';
                    const modalSubtitle = this.getAttribute('data-modal-subtitle') || 'Elige un archivo de tu biblioteca multimedia';

                    console.log('Tipo de medio:', mediaType, 'Campo destino:', targetField);

                    // Configurar modal
                    currentMediaType = mediaType;
                    currentTargetField = document.getElementById(targetField);

                    if (!currentTargetField) {
                        console.error('No se encontró el campo destino:', targetField);
                        alert('Error: No se encontró el campo de destino');
                        return;
                    }

                    if (!mediaSelectorModal) {
                        console.error('No se encontró la modal');
                        alert('Error: La modal de selección de medios no está disponible');
                        return;
                    }

                    if (mediaModalTitle) mediaModalTitle.textContent = modalTitle;
                    if (mediaModalSubtitle) mediaModalSubtitle.textContent = modalSubtitle;

                    // Cambiar icono según tipo
                    if (mediaModalIcon) {
                        if (mediaType === 'video') {
                            mediaModalIcon.className = 'fas fa-video';
                        } else if (mediaType === 'image') {
                            mediaModalIcon.className = 'fas fa-image';
                        } else {
                            mediaModalIcon.className = 'fas fa-folder-open';
                        }
                    }

                    // Configurar filtro de tipo
                    if (mediaTypeFilter) {
                        mediaTypeFilter.value = mediaType;
                    }

                    // Configurar input de subida según tipo
                    if (mediaUploadInput) {
                        if (mediaType === 'video') {
                            mediaUploadInput.setAttribute('accept', 'video/*');
                        } else if (mediaType === 'image') {
                            mediaUploadInput.setAttribute('accept', 'image/*');
                        } else {
                            mediaUploadInput.removeAttribute('accept');
                        }
                    }

                    // Resetear selección
                    selectedMedia = null;
                    if (confirmMediaSelection) {
                        confirmMediaSelection.disabled = true;
                    }
                    if (mediaSearchInput) {
                        mediaSearchInput.value = '';
                    }
                    if (clearMediaSearchBtn) {
                        clearMediaSearchBtn.style.display = 'none';
                    }

                    // Abrir modal
                    console.log('Intentando abrir modal...');
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        try {
                            let modalInstance = bootstrap.Modal.getInstance(mediaSelectorModal);
                            if (!modalInstance) {
                                console.log('Creando nueva instancia de modal');
                                modalInstance = new bootstrap.Modal(mediaSelectorModal);
                            }
                            console.log('Mostrando modal...');
                            modalInstance.show();
                        } catch (error) {
                            console.error('Error al abrir modal:', error);
                            alert('Error al abrir la modal: ' + error.message);
                        }
                    } else {
                        console.error('Bootstrap no está disponible');
                        // Fallback manual
                        mediaSelectorModal.style.display = 'block';
                        mediaSelectorModal.classList.add('show');
                        document.body.classList.add('modal-open');
                        const backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        document.body.appendChild(backdrop);
                    }
                });
            });
            console.log('Botones configurados correctamente');
        }

        // Configurar botones después de un breve delay para asegurar que el DOM esté listo
        setupMediaButtons();
        setTimeout(setupMediaButtons, 300);

        // Cargar medios cuando se abre el modal
        mediaSelectorModal.addEventListener('show.bs.modal', function() {
            currentPage = 1;
            loadMedia('', currentMediaType, 1);
        });

        // Actualizar vista previa cuando se escribe manualmente una URL
        const videoUrlField = document.getElementById('id_video_url');
        const bannerField = document.getElementById('id_banner');
        const logoField = document.getElementById('id_logo');

        if (videoUrlField) {
            videoUrlField.addEventListener('input', function() {
                const url = this.value.trim();
                const videoPreview = document.getElementById('video_preview');
                const videoPreviewImg = document.getElementById('video_preview_img');
                if (url && videoPreview && videoPreviewImg) {
                    // Para videos, intentar obtener thumbnail si es YouTube/Vimeo
                    let previewUrl = url;
                    if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        // YouTube thumbnail
                        const videoId = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
                        if (videoId) {
                            previewUrl = `https://img.youtube.com/vi/${videoId[1]}/maxresdefault.jpg`;
                        }
                    } else if (url.includes('vimeo.com')) {
                        // Vimeo - usar un placeholder o intentar obtener thumbnail
                        previewUrl = url;
                    }
                    videoPreviewImg.src = previewUrl;
                    videoPreviewImg.alt = 'Vista previa del video';
                    videoPreview.style.display = 'block';
                } else if (!url && videoPreview) {
                    videoPreview.style.display = 'none';
                }
            });
        }

        if (bannerField) {
            bannerField.addEventListener('input', function() {
                const url = this.value.trim();
                const bannerPreview = document.getElementById('banner_preview');
                const bannerPreviewImg = document.getElementById('banner_preview_img');
                const bannerExistingPreview = document.getElementById('banner_existing_preview');
                if (url && bannerPreview && bannerPreviewImg) {
                    bannerPreviewImg.src = url;
                    bannerPreviewImg.alt = 'Vista previa del banner';
                    bannerPreview.style.display = 'block';
                    if (bannerExistingPreview) {
                        bannerExistingPreview.style.display = 'none';
                    }
                } else if (!url && bannerPreview) {
                    bannerPreview.style.display = 'none';
                    if (bannerExistingPreview) {
                        bannerExistingPreview.style.display = 'block';
                    }
                }
            });
        }

        const bannerMobileField = document.getElementById('id_banner_mobile');
        if (bannerMobileField) {
            bannerMobileField.addEventListener('input', function() {
                const url = this.value.trim();
                const bannerMobilePreview = document.getElementById('banner_mobile_preview');
                const bannerMobilePreviewImg = document.getElementById('banner_mobile_preview_img');
                const bannerMobileExistingPreview = document.getElementById('banner_mobile_existing_preview');
                if (url && bannerMobilePreview && bannerMobilePreviewImg) {
                    bannerMobilePreviewImg.src = url;
                    bannerMobilePreviewImg.alt = 'Vista previa del banner móvil';
                    bannerMobilePreview.style.display = 'block';
                    if (bannerMobileExistingPreview) {
                        bannerMobileExistingPreview.style.display = 'none';
                    }
                } else if (!url && bannerMobilePreview) {
                    bannerMobilePreview.style.display = 'none';
                    if (bannerMobileExistingPreview) {
                        bannerMobileExistingPreview.style.display = 'block';
                    }
                }
            });
        }

        if (logoField) {
            logoField.addEventListener('input', function() {
                const url = this.value.trim();
                const logoPreview = document.getElementById('logo_preview');
                const logoPreviewImg = document.getElementById('logo_preview_img');
                const logoExistingPreview = document.getElementById('logo_existing_preview');
                if (url && logoPreview && logoPreviewImg) {
                    logoPreviewImg.src = url;
                    logoPreviewImg.alt = 'Vista previa del logo';
                    logoPreview.style.display = 'block';
                    if (logoExistingPreview) {
                        logoExistingPreview.style.display = 'none';
                    }
                } else if (!url && logoPreview) {
                    logoPreview.style.display = 'none';
                    if (logoExistingPreview) {
                        logoExistingPreview.style.display = 'block';
                    }
                }
            });
        }

        // Confirmar selección
        if (confirmMediaSelection) {
            confirmMediaSelection.addEventListener('click', function() {
                if (selectedMedia && currentTargetField) {
                    currentTargetField.value = selectedMedia.url;

                    // Actualizar vista previa según el campo
                    const fieldId = currentTargetField.id;
                    updateMediaPreview(fieldId, selectedMedia);

                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modalInstance = bootstrap.Modal.getInstance(mediaSelectorModal);
                        if (modalInstance) modalInstance.hide();
                    }
                }
            });
        }

        // Función para actualizar vista previa
        function updateMediaPreview(fieldId, media) {
            if (fieldId === 'id_video_url') {
                // Vista previa de video (usar thumbnail)
                const videoPreview = document.getElementById('video_preview');
                const videoPreviewImg = document.getElementById('video_preview_img');
                if (videoPreview && videoPreviewImg) {
                    const previewUrl = media.thumbnail || media.url || '';
                    if (previewUrl) {
                        videoPreviewImg.src = previewUrl;
                        videoPreviewImg.alt = media.title || 'Vista previa del video';
                        videoPreview.style.display = 'block';
                    }
                }
            } else if (fieldId === 'id_banner') {
                // Vista previa de banner (usar URL de la imagen)
                const bannerPreview = document.getElementById('banner_preview');
                const bannerPreviewImg = document.getElementById('banner_preview_img');
                const bannerExistingPreview = document.getElementById('banner_existing_preview');
                if (bannerPreview && bannerPreviewImg) {
                    const previewUrl = media.url || '';
                    if (previewUrl) {
                        bannerPreviewImg.src = previewUrl;
                        bannerPreviewImg.alt = media.title || 'Vista previa del banner';
                        bannerPreview.style.display = 'block';
                        // Ocultar vista previa existente si hay una nueva
                        if (bannerExistingPreview) {
                            bannerExistingPreview.style.display = 'none';
                        }
                    }
                }
            } else if (fieldId === 'id_banner_mobile') {
                // Vista previa de banner móvil (usar URL de la imagen)
                const bannerMobilePreview = document.getElementById('banner_mobile_preview');
                const bannerMobilePreviewImg = document.getElementById('banner_mobile_preview_img');
                const bannerMobileExistingPreview = document.getElementById('banner_mobile_existing_preview');
                if (bannerMobilePreview && bannerMobilePreviewImg) {
                    const previewUrl = media.url || '';
                    if (previewUrl) {
                        bannerMobilePreviewImg.src = previewUrl;
                        bannerMobilePreviewImg.alt = media.title || 'Vista previa del banner móvil';
                        bannerMobilePreview.style.display = 'block';
                        // Ocultar vista previa existente si hay una nueva
                        if (bannerMobileExistingPreview) {
                            bannerMobileExistingPreview.style.display = 'none';
                        }
                    }
                }
            } else if (fieldId === 'id_logo') {
                // Vista previa de logo (usar URL de la imagen)
                const logoPreview = document.getElementById('logo_preview');
                const logoPreviewImg = document.getElementById('logo_preview_img');
                const logoExistingPreview = document.getElementById('logo_existing_preview');
                if (logoPreview && logoPreviewImg) {
                    const previewUrl = media.url || '';
                    if (previewUrl) {
                        logoPreviewImg.src = previewUrl;
                        logoPreviewImg.alt = media.title || 'Vista previa del logo';
                        logoPreview.style.display = 'block';
                        // Ocultar vista previa existente si hay una nueva
                        if (logoExistingPreview) {
                            logoExistingPreview.style.display = 'none';
                        }
                    }
                }
            }
        }

        // Búsqueda
        if (mediaSearchInput) {
            mediaSearchInput.addEventListener('input', function() {
                if (clearMediaSearchBtn) {
                    clearMediaSearchBtn.style.display = this.value ? 'block' : 'none';
                }
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const type = mediaTypeFilter ? mediaTypeFilter.value : currentMediaType;
                    currentPage = 1;  // Reiniciar a página 1 cuando se busca
                    loadMedia(this.value, type, 1);
                }, 500);
            });
        }

        // Limpiar búsqueda
        if (clearMediaSearchBtn) {
            clearMediaSearchBtn.addEventListener('click', function() {
                if (mediaSearchInput) {
                    mediaSearchInput.value = '';
                    clearMediaSearchBtn.style.display = 'none';
                    const type = mediaTypeFilter ? mediaTypeFilter.value : currentMediaType;
                    currentPage = 1;  // Reiniciar a página 1 cuando se limpia la búsqueda
                    loadMedia('', type, 1);
                }
            });
        }

        // Filtro de tipo
        if (mediaTypeFilter) {
            mediaTypeFilter.addEventListener('change', function() {
                const search = mediaSearchInput ? mediaSearchInput.value : '';
                currentPage = 1;  // Reiniciar a página 1 cuando se cambia el filtro
                loadMedia(search, this.value, 1);
            });
        }

        // Funcionalidad de subida
        if (uploadMediaBtn && mediaUploadInput) {
            uploadMediaBtn.addEventListener('click', function() {
                mediaUploadInput.click();
            });

            mediaUploadInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    handleMediaUpload(e.target.files);
                }
            });
        }

        function handleMediaUpload(files) {
            if (!files || files.length === 0) return;

            mediaUploadProgress.style.display = 'block';
            mediaUploadProgress.innerHTML = `
                <div class="mb-2"><small class="text-muted">Subiendo ${files.length} archivo(s)...</small></div>
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="mediaUploadProgressBar" style="width: 0%">0%</div>
                </div>
                <div id="mediaUploadStatus" class="small text-muted"></div>
            `;

            const progressBar = document.getElementById('mediaUploadProgressBar');
            const uploadStatus = document.getElementById('mediaUploadStatus');
            const filesArray = Array.from(files);
            let completed = 0;
            const total = filesArray.length;

            filesArray.forEach((file) => {
                const formData = new FormData();
                formData.append('original_file', file);
                formData.append('title', file.name.replace(/\.[^/.]+$/, ""));

                const xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const fileProgress = (e.loaded / e.total) * 100;
                        const overallProgress = ((completed + (fileProgress / 100)) / total) * 100;
                        progressBar.style.width = overallProgress + '%';
                        progressBar.textContent = Math.round(overallProgress) + '%';
                        uploadStatus.textContent = `Subiendo: ${file.name} (${Math.round(fileProgress)}%)`;
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if (data.success) {
                                completed++;
                                if (completed === total) {
                                    progressBar.classList.remove('progress-bar-animated');
                                    progressBar.classList.add('bg-success');
                                    uploadStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Todos los archivos subidos exitosamente. Recargando lista...</span>';
                                    setTimeout(() => {
                                        const type = mediaTypeFilter ? mediaTypeFilter.value : currentMediaType;
                                        const search = mediaSearchInput ? mediaSearchInput.value : '';
                                        currentPage = 1;  // Reiniciar a página 1 después de subir archivos
                                        loadMedia(search, type, 1);
                                        mediaUploadProgress.style.display = 'none';
                                        mediaUploadInput.value = '';
                                    }, 1000);
                                }
                            }
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    }
                });

                xhr.open('POST', '{% url "media:upload_ajax" %}');
                xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken') || '{{ csrf_token }}');
                xhr.send(formData);
            });
        }
    }

    // Inicializar sistema unificado
    console.log('Inicializando sistema unificado de medios...');
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando...');
            initUnifiedMediaSelector();
            initItineraryManager();
            initAllIncludesManagers();
        });
    } else {
        console.log('DOM ya está listo, inicializando...');
        // Pequeño delay para asegurar que todos los elementos estén en el DOM
        setTimeout(function() {
        initUnifiedMediaSelector();
        initItineraryManager();
            initAllIncludesManagers();
        }, 100);
    }
});

// Sistema de gestión de itinerario
function initItineraryManager() {
    const startDateInput = document.getElementById('id_start_date');
    const endDateInput = document.getElementById('id_end_date');
    const itineraryContainer = document.getElementById('itinerary-container');
    const generateBtn = document.getElementById('generate-itinerary-btn');
    const addDayBtn = document.getElementById('add-day-btn');
    let dayCounter = 0;
    let itineraryDays = [];

    // Cargar itinerario existente si está editando
    {% if form.instance.pk %}
        {% for item in form.instance.itinerary_items.all|dictsort:"day" %}
            itineraryDays.push({
                id: {{ item.id }},
                day: '{{ item.day|date:"Y-m-d" }}',
                dayNumber: {{ item.day_number }},
                title: '{{ item.title|default:""|escapejs }}',
                description: '{{ item.description|default:""|escapejs }}',
                scheduleItems: {% if item.schedule_items %}{{ item.schedule_items|safe }}{% else %}[]{% endif %}
            });
        {% endfor %}
        if (itineraryDays.length > 0) {
            dayCounter = itineraryDays.reduce((max, d) => Math.max(max, d.dayNumber), 0);
            renderItinerary();
        }
    {% endif %}

    // Función para generar días automáticamente
    function generateDaysFromDates() {
        if (!startDateInput || !endDateInput) return;

        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);

        if (!startDateInput.value || !endDateInput.value || startDate >= endDate) {
            alert('Por favor, selecciona fechas válidas de inicio y fin del evento.');
            return;
        }

        itineraryDays = [];
        let currentDate = new Date(startDate);
        let dayNumber = 1;

        while (currentDate <= endDate) {
            const dayStr = currentDate.toISOString().split('T')[0];
            const dayName = currentDate.toLocaleDateString('es-ES', { weekday: 'long' });
            const dayMonth = currentDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });

            itineraryDays.push({
                id: null,
                day: dayStr,
                dayNumber: dayNumber,
                title: `Día ${dayNumber} - ${dayMonth.charAt(0).toUpperCase() + dayMonth.slice(1)}`,
                description: '',
                scheduleItems: []
            });

            currentDate.setDate(currentDate.getDate() + 1);
            dayNumber++;
        }

        dayCounter = itineraryDays.length;
        renderItinerary();
    }

    // Función para renderizar el itinerario
    function renderItinerary() {
        if (!itineraryContainer) return;

        itineraryContainer.innerHTML = '';

        // Ordenar por día
        itineraryDays.sort((a, b) => new Date(a.day) - new Date(b.day));

        itineraryDays.forEach((day, index) => {
            const dayCard = createDayCard(day, index);
            itineraryContainer.appendChild(dayCard);
        });

        updateGenerateButton();
    }

    // Función para crear tarjeta de día
    function createDayCard(dayData, index) {
        const card = document.createElement('div');
        card.className = 'itinerary-day-card';
        card.dataset.dayIndex = index;

        const dayDate = new Date(dayData.day);
        const dayName = dayDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        card.innerHTML = `
            <div class="itinerary-day-header">
                <div class="itinerary-day-title">
                    <span class="itinerary-day-number">${dayData.dayNumber}</span>
                    <input type="text"
                           class="form-control form-control-sm d-inline-block"
                           style="width: auto; min-width: 300px; margin-left: 0.5rem;"
                           value="${escapeHtml(dayData.title)}"
                           placeholder="Título del día"
                           data-field="title"
                           data-day-index="${index}">
                    <span class="text-muted ms-2">(${dayName})</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDay(${index})">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>

            <input type="hidden" name="itinerary_days" value='${JSON.stringify(dayData).replace(/'/g, "&#39;")}' data-day-index="${index}">

            <div class="mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-calendar-day me-1 text-muted"></i>Fecha del Día
                </label>
                <input type="date"
                       class="form-control"
                       value="${dayData.day}"
                       data-field="day"
                       data-day-index="${index}"
                       required>
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-align-left me-1 text-muted"></i>Descripción del Día
                </label>
                <textarea class="form-control"
                          rows="3"
                          placeholder="Descripción detallada de las actividades del día..."
                          data-field="description"
                          data-day-index="${index}">${escapeHtml(dayData.description)}</textarea>
            </div>

            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label fw-semibold mb-0">
                        <i class="fas fa-clock me-1 text-muted"></i>Horario de Actividades
                    </label>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addScheduleItem(${index})">
                        <i class="fas fa-plus me-1"></i>Agregar Actividad
                    </button>
                </div>
                <div class="schedule-items-container" data-day-index="${index}">
                    ${renderScheduleItems(dayData.scheduleItems, index)}
                </div>
            </div>
        `;

        // Agregar listeners a los campos
        card.querySelectorAll('[data-field]').forEach(input => {
            input.addEventListener('change', function() {
                updateDayData(index, this.dataset.field, this.value);
            });
            input.addEventListener('input', function() {
                if (this.dataset.field === 'title' || this.dataset.field === 'description') {
                    updateDayData(index, this.dataset.field, this.value);
                }
            });
        });

        return card;
    }

    // Función para renderizar actividades del horario
    function renderScheduleItems(scheduleItems, dayIndex) {
        if (!scheduleItems || scheduleItems.length === 0) {
            return '<p class="text-muted small mb-0">No hay actividades programadas. Haz clic en "Agregar Actividad" para comenzar.</p>';
        }

        return scheduleItems.map((item, itemIndex) => `
            <div class="itinerary-schedule-item" data-item-index="${itemIndex}">
                <div class="itinerary-time-input">
                    <input type="time"
                           class="form-control"
                           value="${item.time || ''}"
                           data-field="time"
                           data-day-index="${dayIndex}"
                           data-item-index="${itemIndex}"
                           required>
                </div>
                <div class="itinerary-activity-input">
                    <input type="text"
                           class="form-control"
                           value="${escapeHtml(item.activity || '')}"
                           placeholder="Descripción de la actividad..."
                           data-field="activity"
                           data-day-index="${dayIndex}"
                           data-item-index="${itemIndex}"
                           required>
                </div>
                <div class="itinerary-schedule-remove">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeScheduleItem(${dayIndex}, ${itemIndex})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Función para actualizar datos del día
    function updateDayData(dayIndex, field, value) {
        if (itineraryDays[dayIndex]) {
            if (field === 'day') {
                itineraryDays[dayIndex].day = value;
            } else if (field === 'title') {
                itineraryDays[dayIndex].title = value;
            } else if (field === 'description') {
                itineraryDays[dayIndex].description = value;
            }

            // Actualizar el input hidden
            const hiddenInput = document.querySelector(`input[name="itinerary_days"][data-day-index="${dayIndex}"]`);
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(itineraryDays[dayIndex]).replace(/'/g, "&#39;");
            }
        }
    }

    // Función para agregar día manualmente
    window.addDayManually = function() {
        const today = new Date().toISOString().split('T')[0];
        itineraryDays.push({
            id: null,
            day: today,
            dayNumber: ++dayCounter,
            title: `Día ${dayCounter}`,
            description: '',
            scheduleItems: []
        });
        renderItinerary();
    };

    // Función para eliminar día
    window.removeDay = function(dayIndex) {
        if (confirm('¿Estás seguro de que deseas eliminar este día del itinerario?')) {
            itineraryDays.splice(dayIndex, 1);
            // Renumerar días
            itineraryDays.forEach((day, index) => {
                day.dayNumber = index + 1;
            });
            renderItinerary();
        }
    };

    // Función para agregar actividad al horario
    window.addScheduleItem = function(dayIndex) {
        if (itineraryDays[dayIndex]) {
            if (!itineraryDays[dayIndex].scheduleItems) {
                itineraryDays[dayIndex].scheduleItems = [];
            }
            itineraryDays[dayIndex].scheduleItems.push({
                time: '',
                activity: ''
            });
            renderItinerary();

            // Focus en el campo de tiempo del nuevo item
            setTimeout(() => {
                const newItem = document.querySelector(`.schedule-items-container[data-day-index="${dayIndex}"] .itinerary-schedule-item:last-child input[data-field="time"]`);
                if (newItem) newItem.focus();
            }, 100);
        }
    };

    // Función para eliminar actividad del horario
    window.removeScheduleItem = function(dayIndex, itemIndex) {
        if (itineraryDays[dayIndex] && itineraryDays[dayIndex].scheduleItems) {
            itineraryDays[dayIndex].scheduleItems.splice(itemIndex, 1);
            renderItinerary();
        }
    };

    // Función para actualizar botón de generar
    function updateGenerateButton() {
        if (generateBtn) {
            generateBtn.style.display = (itineraryDays.length === 0 && startDateInput && endDateInput && startDateInput.value && endDateInput.value) ? 'block' : 'none';
        }
    }

    // Función helper para escapar HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Event listeners
    if (generateBtn) {
        generateBtn.addEventListener('click', generateDaysFromDates);
    }

    if (addDayBtn) {
        addDayBtn.addEventListener('click', addDayManually);
    }

    if (startDateInput && endDateInput) {
        startDateInput.addEventListener('change', updateGenerateButton);
        endDateInput.addEventListener('change', updateGenerateButton);
    }

    // Actualizar actividades cuando cambian
    document.addEventListener('change', function(e) {
        if (e.target.matches('.schedule-items-container input[data-field="time"], .schedule-items-container input[data-field="activity"]')) {
            const dayIndex = parseInt(e.target.dataset.dayIndex);
            const itemIndex = parseInt(e.target.dataset.itemIndex);
            const field = e.target.dataset.field;

            if (itineraryDays[dayIndex] && itineraryDays[dayIndex].scheduleItems && itineraryDays[dayIndex].scheduleItems[itemIndex]) {
                itineraryDays[dayIndex].scheduleItems[itemIndex][field] = e.target.value;

                // Actualizar el input hidden
                const hiddenInput = document.querySelector(`input[name="itinerary_days"][data-day-index="${dayIndex}"]`);
                if (hiddenInput) {
                    hiddenInput.value = JSON.stringify(itineraryDays[dayIndex]).replace(/'/g, "&#39;");
                }
            }
        }
    });

    // Inicializar
    updateGenerateButton();
}

// Inicializar múltiples managers de includes (uno por cada tipo de usuario)
function initAllIncludesManagers() {
    initIncludesManager('player');
    initIncludesManager('team_manager');
    initIncludesManager('spectator');
}

// Sistema de gestión de "Incluye" (por tipo de usuario)
function initIncludesManager(userType) {
    const includesContainer = document.getElementById(`includes-container-${userType}`);
    const addIncludeBtn = document.querySelector(`.add-include-btn[data-user-type="${userType}"]`);

    if (!includesContainer) {
        console.warn(`Contenedor de includes no encontrado para ${userType}`);
        return;
    }

    let includesItems = [];
    let itemCounter = 0;

    // Cargar includes existentes si está editando (filtrar por user_type)
    {% if form.instance.pk %}
        {% for item in form.instance.includes_items.all %}
            if (userType === '{{ item.user_type }}') {
                includesItems.push({
                    id: {% if item.id %}{{ item.id }}{% else %}null{% endif %},
                    userType: '{{ item.user_type }}',
                    title: '{{ item.title|escapejs|default:"" }}',
                    description: '{{ item.description|escapejs|default:"" }}',
                    order: {{ item.order|default:0 }},
                    isActive: {% if item.is_active %}true{% else %}false{% endif %}
                });
                itemCounter = Math.max(itemCounter, {{ item.order|default:0 }});
            }
        {% endfor %}
        if (includesItems.length > 0) {
            renderIncludes();
        }
    {% endif %}

    // Función para renderizar includes
    function renderIncludes() {
        if (!includesContainer) return;

        // Limpiar contenedor
        includesContainer.innerHTML = '';

        // Limpiar todos los inputs hidden existentes para este userType
        document.querySelectorAll(`input[name="includes_items_${userType}"]`).forEach(input => {
            input.remove();
        });

        // Ordenar por order
        includesItems.sort((a, b) => a.order - b.order);

        // Renderizar cada item
        includesItems.forEach((item, index) => {
            const card = createIncludeCard(item, index);
            includesContainer.appendChild(card);

            // Crear input hidden para este item
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = `includes_items_${userType}`;
            hiddenInput.setAttribute('data-item-index', index);
            hiddenInput.value = JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, '&quot;');
            includesContainer.appendChild(hiddenInput);
        });
    }

    // Función para crear card de include
    function createIncludeCard(item, index) {
        const card = document.createElement('div');
        card.className = 'includes-item-card';
        card.innerHTML = `
            <div class="includes-item-header">
                <div class="includes-item-title-input">
                    <input type="text" class="form-control" placeholder="Título del item" value="${(item.title || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" data-item-index="${index}" data-field="title">
                </div>
                <div class="includes-item-order-badge">${item.order || index + 1}</div>
            </div>
            <div class="includes-item-description-textarea">
                <textarea class="form-control" placeholder="Descripción (opcional)" rows="3" data-item-index="${index}" data-field="description">${(item.description || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}</textarea>
            </div>
            <div class="includes-item-actions">
                <div class="includes-item-active-toggle">
                    <input type="checkbox" class="form-check-input" id="include-active-${userType}-${index}" ${item.isActive !== false ? 'checked' : ''} data-item-index="${index}" data-field="isActive">
                    <label class="form-check-label" for="include-active-${userType}-${index}">Activo</label>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInclude_${userType}(${index})">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        `;

        // Event listeners para actualizar datos
        card.querySelector('input[data-field="title"]').addEventListener('input', function(e) {
            updateIncludeData(index, 'title', e.target.value);
        });

        card.querySelector('textarea[data-field="description"]').addEventListener('input', function(e) {
            updateIncludeData(index, 'description', e.target.value);
        });

        card.querySelector('input[data-field="isActive"]').addEventListener('change', function(e) {
            updateIncludeData(index, 'isActive', e.target.checked);
        });

        return card;
    }

    // Función para actualizar datos del item
    function updateIncludeData(itemIndex, field, value) {
        if (itemIndex >= 0 && itemIndex < includesItems.length) {
            const item = includesItems[itemIndex];

            if (field === 'order') {
                item.order = parseInt(value) || 0;
            } else if (field === 'title') {
                item.title = value || '';
            } else if (field === 'description') {
                item.description = value || '';
            } else if (field === 'isActive') {
                item.isActive = value;
            }

            // Actualizar el input hidden correspondiente
            const hiddenInput = document.querySelector(`input[name="includes_items_${userType}"][data-item-index="${itemIndex}"]`);
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, '&quot;');
            } else {
                // Si no existe el input hidden, regenerar todo
                console.warn(`Input hidden no encontrado para índice ${itemIndex}, regenerando...`);
                renderIncludes();
            }
        }
    }

    // Función para agregar item manualmente
    window[`addIncludeManually_${userType}`] = function() {
        itemCounter++;
        includesItems.push({
            id: null,
            userType: userType,
            title: '',
            description: '',
            order: itemCounter,
            isActive: true
        });
        renderIncludes();
    };

    // Función para eliminar item
    window[`removeInclude_${userType}`] = function(itemIndex) {
        if (confirm('¿Estás seguro de que deseas eliminar este item?')) {
            includesItems.splice(itemIndex, 1);
            // Renumerar items
            includesItems.forEach((item, idx) => {
                item.order = idx + 1;
            });
            renderIncludes();
        }
    };

    // Event listeners para addIncludeBtn
    if (addIncludeBtn) {
        addIncludeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log(`Botón "Agregar Item" clickeado para ${userType}`);
            if (window[`addIncludeManually_${userType}`]) {
                window[`addIncludeManually_${userType}`]();
            } else {
                console.error(`Función addIncludeManually_${userType} no encontrada`);
            }
        });
        console.log(`✅ Listener agregado al botón "Agregar Item" para ${userType}`);
    } else {
        console.warn(`⚠️ Botón "Agregar Item" no encontrado para ${userType}. Buscando de nuevo...`);
        // Intentar buscar de nuevo después de un pequeño delay
        setTimeout(() => {
            const retryBtn = document.querySelector(`.add-include-btn[data-user-type="${userType}"]`);
            if (retryBtn) {
                retryBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(`Botón "Agregar Item" clickeado para ${userType} (retry)`);
                    if (window[`addIncludeManually_${userType}`]) {
                        window[`addIncludeManually_${userType}`]();
                    }
                });
                console.log(`✅ Listener agregado al botón "Agregar Item" para ${userType} (retry exitoso)`);
            } else {
                console.error(`❌ Botón "Agregar Item" NO encontrado para ${userType} después del retry.`);
            }
        }, 500);
    }

    // Inicializar
    renderIncludes();
}

// Botón flotante de submit - mostrar/ocultar según scroll
(function() {
    function initFloatingSubmitButton() {
        const floatingContainer = document.getElementById('floating-submit-container');
        const submitButtonsSection = document.getElementById('submit-buttons-section');

        if (!floatingContainer || !submitButtonsSection) {
            console.warn('Botón flotante: contenedores no encontrados. Reintentando...');
            setTimeout(initFloatingSubmitButton, 500);
            return;
        }

        console.log('✅ Botón flotante inicializado correctamente');

        function toggleFloatingButton() {
            try {
                const rect = submitButtonsSection.getBoundingClientRect();
                const windowHeight = window.innerHeight || document.documentElement.clientHeight;

                // Mostrar el botón flotante cuando la sección de botones original está fuera de la vista (más abajo)
                if (rect.bottom < windowHeight - 20) {
                    floatingContainer.classList.add('show');
                } else {
                    floatingContainer.classList.remove('show');
                }
            } catch (e) {
                console.error('Error en toggleFloatingButton:', e);
            }
        }

        // Verificar posición al hacer scroll
        window.addEventListener('scroll', function() {
            toggleFloatingButton();
        }, { passive: true });

        // Verificar posición al cargar la página y al cambiar el tamaño de la ventana
        window.addEventListener('resize', toggleFloatingButton);
        window.addEventListener('load', function() {
            setTimeout(toggleFloatingButton, 100);
        });

        // Verificar inicialmente con un pequeño delay
        setTimeout(toggleFloatingButton, 300);

        // Verificar periódicamente durante los primeros segundos por si hay carga dinámica
        let checkCount = 0;
        const checkInterval = setInterval(function() {
            toggleFloatingButton();
            checkCount++;
            if (checkCount >= 6) {
                clearInterval(checkInterval);
            }
        }, 500);
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initFloatingSubmitButton, 200);
        });
    } else {
        setTimeout(initFloatingSubmitButton, 300);
    }
})();



</script>
{% endblock extra_js %}







