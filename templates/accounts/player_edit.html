{% extends is_ajax|yesno:"accounts/base_ajax.html,base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Edit Player" %} - NCS International{% endblock %}

{% block breadcrumb %}
    <span>{% trans "Players" %}</span>
    <span>{% trans "Edit" %}</span>
{% endblock %}

{% block content %}
<!-- Messages (hidden, converted to toasts) -->
<div class="messages-container" style="display: none;">
    {% for message in messages %}
        <div class="django-message" data-tag="{{ message.tags }}" data-message="{{ message|escapejs }}" data-extra-tags="{{ message.extra_tags|default:'' }}">
        </div>
    {% endfor %}
</div>

<div class="tab-content-header mb-4">
    <h4 style="color: var(--mlb-blue); font-weight: 800; font-size: 1.5rem; margin-bottom: 10px;">
        <i class="fas fa-user-edit me-2" style="color: var(--mlb-red);"></i>{% trans "Edit Player" %}
    </h4>
    <p class="text-muted">{% trans "Modify player information" %}: {{ object.user.get_full_name|default:object.user.username }}</p>
</div>

<div class="form-container">
    <form method="post" action="{% url 'accounts:player_edit' object.pk %}" enctype="multipart/form-data" id="playerEditForm" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger mb-4 alert-persistent">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- Informaci√≥n Personal -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-user me-2" style="color: var(--mlb-red);"></i>{% trans "Personal Information" %}
            </h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label required-field">
                        {% trans "First Name" %} *
                    </label>
                    {{ form.first_name }}
                    {% if form.first_name.errors %}
                        <div class="error-message mt-1">{{ form.first_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.last_name.id_for_label }}" class="form-label required-field">
                        {% trans "Last Name" %} *
                    </label>
                    {{ form.last_name }}
                    {% if form.last_name.errors %}
                        <div class="error-message mt-1">{{ form.last_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.last_name2.id_for_label }}" class="form-label">
                        {% trans "Second Last Name" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    {{ form.last_name2 }}
                    {% if form.last_name2.errors %}
                        <div class="error-message mt-1">{{ form.last_name2.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                {% if form.email %}
                <div class="col-md-6 mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label required-field">
                        {% trans "Email" %} *
                    </label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div class="error-message mt-1">{{ form.email.errors }}</div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="col-md-6 mb-3">
                    <label for="{{ form.phone.id_for_label }}" class="form-label">
                        {% trans "Phone" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    {{ form.phone }}
                    {% if form.phone.errors %}
                        <div class="error-message mt-1">{{ form.phone.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">{% trans "Format: (123) 456-7890" %}</small>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.birth_date.id_for_label }}" class="form-label">
                        {% trans "Birth Date" %}
                    </label>
                    {{ form.birth_date }}
                    {% if form.birth_date.help_text %}
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>{{ form.birth_date.help_text }}
                        </small>
                    {% endif %}
                    {% if form.birth_date.errors %}
                        <div class="error-message mt-1">{{ form.birth_date.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Foto de Perfil -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="{{ form.profile_picture.id_for_label }}" class="form-label">
                        <i class="fas fa-camera me-2"></i>{% trans "Profile Picture" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    <div class="profile-picture-upload-area" id="profilePictureUploadArea" style="border: 2px dashed #0d2c54; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        {% if object.user.profile.profile_picture %}
                            <div style="position: relative;">
                                <img src="{{ object.user.profile.profile_picture.url }}" alt="Profile Picture" style="max-width: 200px; max-height: 200px; border-radius: 12px; object-fit: cover; margin-bottom: 15px;">
                                <div>
                                    <i class="fas fa-check-circle fa-2x mb-2" style="color: #28a745;"></i>
                                    <p class="mb-1" style="font-weight: 600; color: var(--mlb-blue);">
                                        {% trans "Photo Uploaded" %}
                                    </p>
                                    <small class="text-muted">{% trans "Click to change photo" %}</small>
                                </div>
                            </div>
                        {% else %}
                            <div>
                                <i class="fas fa-camera fa-3x mb-3" style="color: #0d2c54; opacity: 0.5;"></i>
                                <p class="mb-2" style="font-weight: 600; color: var(--mlb-blue); font-size: 1.05rem;">
                                    {% trans "Upload Profile Picture" %}
                                </p>
                                <small class="text-muted">{% trans "Click here to select an image" %}</small>
                            </div>
                        {% endif %}
                    </div>
                    {{ form.profile_picture }}
                    {% if form.profile_picture.errors %}
                        <div class="error-message mt-2">{{ form.profile_picture.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>{% trans "Accepted formats: JPG, PNG, GIF. Max size: 5MB" %}
                    </small>
                </div>
            </div>

            <!-- Ubicaci√≥n -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.country.id_for_label }}" class="form-label required-field">
                        <i class="fas fa-globe me-1"></i>{% trans "Country" %} *
                    </label>
                    {{ form.country }}
                    {% if form.country.errors %}
                        <div class="error-message mt-1">{{ form.country.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.state.id_for_label }}" class="form-label required-field">
                        <i class="fas fa-map-marker-alt me-1"></i>{% trans "State" %} *
                    </label>
                    <div class="position-relative">
                        {{ form.state }}
                        <div id="stateLoader" class="position-absolute" style="display: none; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                            <i class="fas fa-spinner fa-spin" style="color: var(--mlb-blue);"></i>
                        </div>
                    </div>
                    {% if form.state.errors %}
                        <div class="error-message mt-1">{{ form.state.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.city.id_for_label }}" class="form-label required-field">
                        <i class="fas fa-city me-1"></i>{% trans "City" %} *
                    </label>
                    <div class="position-relative">
                        {{ form.city }}
                        <div id="cityLoader" class="position-absolute" style="display: none; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                            <i class="fas fa-spinner fa-spin" style="color: var(--mlb-blue);"></i>
                        </div>
                    </div>
                    {% if form.city.errors %}
                        <div class="error-message mt-1">{{ form.city.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Informaci√≥n Deportiva -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-baseball-ball me-2" style="color: var(--mlb-red);"></i>{% trans "Sports Information" %}
            </h5>

            <!-- Campos ocultos para mantener valores cuando padre edita -->
            {% if form.team_hidden %}
                {{ form.team_hidden }}
            {% endif %}

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.team.id_for_label }}" class="form-label required-field">
                        {% trans "Team" %} *
                    </label>
                    {{ form.team }}
                    {% if form.team.errors %}
                        <div class="error-message mt-1">{{ form.team.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.jersey_number.id_for_label }}" class="form-label">
                        {% trans "Jersey Number" %}
                    </label>
                    {{ form.jersey_number }}
                    {% if form.jersey_number.errors %}
                        <div class="error-message mt-1">{{ form.jersey_number.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.position.id_for_label }}" class="form-label">
                        {% trans "Primary Position" %}
                    </label>
                    {{ form.position }}
                    {% if form.position.errors %}
                        <div class="error-message mt-1">{{ form.position.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.secondary_position.id_for_label }}" class="form-label">
                        {% trans "Secondary Position" %}
                    </label>
                    {{ form.secondary_position }}
                    {% if form.secondary_position.errors %}
                        <div class="error-message mt-1">{{ form.secondary_position.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label d-block">
                        {% trans "Are you a pitcher?" %}
                    </label>
                    <div class="form-check">
                        {{ form.is_pitcher }}
                        <label class="form-check-label" for="{{ form.is_pitcher.id_for_label }}">
                            {% trans "Yes, I am a pitcher" %}
                        </label>
                    </div>
                    {% if form.is_pitcher.errors %}
                        <div class="error-message mt-1">{{ form.is_pitcher.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.height.id_for_label }}" class="form-label">
                        {% trans "Height" %}
                    </label>
                    {{ form.height }}
                    {% if form.height.errors %}
                        <div class="error-message mt-1">{{ form.height.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">{% trans "Ex: 5'10\"" %}</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.weight.id_for_label }}" class="form-label">
                        {% trans "Weight (lbs)" %}
                    </label>
                    {{ form.weight }}
                    {% if form.weight.errors %}
                        <div class="error-message mt-1">{{ form.weight.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.batting_hand.id_for_label }}" class="form-label required-field">
                        {% trans "Batting Hand" %} *
                    </label>
                    {{ form.batting_hand }}
                    {% if form.batting_hand.errors %}
                        <div class="error-message mt-1">{{ form.batting_hand.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.throwing_hand.id_for_label }}" class="form-label required-field">
                        {% trans "Throwing Hand" %} *
                    </label>
                    {{ form.throwing_hand }}
                    {% if form.throwing_hand.errors %}
                        <div class="error-message mt-1">{{ form.throwing_hand.errors }}</div>
                    {% endif %}
                </div>
            </div>

            {% if form.is_active %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            {% trans "Active Player" %}
                        </label>
                    </div>
                    {% if form.is_active.errors %}
                        <div class="error-message mt-1">{{ form.is_active.errors }}</div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Elegibilidad y Divisi√≥n -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-check-circle me-2" style="color: var(--mlb-red);"></i>{% trans "Eligibility and Division" %}
            </h5>

            {% if object %}
                {% with age=object.calculate_age_as_of_april_30 age_division=object.get_age_based_division grade_division=object.get_grade_based_division eligible=object.get_eligible_divisions %}
                    {% if age %}
                        <div class="alert alert-info border mb-3 alert-persistent" style="background: #e7f3ff; border-color: #0dcaf0 !important;">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>{% trans "Eligibility Information" %}:</strong><br>
                                <strong>{% trans "Age as of April 30" %}:</strong> {{ age }} {% trans "years" %}<br>
                                {% if age_division %}
                                    <strong>{% trans "Age-based division" %}:</strong> {{ age_division }}<br>
                                {% endif %}
                                {% if grade_division %}
                                    <strong>{% trans "Grade-based division" %}:</strong> {{ grade_division }}<br>
                                {% endif %}
                                {% if eligible %}
                                    <strong>{% trans "Eligible divisions" %}:</strong> {{ eligible|join:", " }}
                                {% endif %}
                            </small>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endif %}

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.grade.id_for_label }}" class="form-label required-field">
                        {% trans "Current Grade" %} *
                    </label>
                    {{ form.grade }}
                    {% if form.grade.help_text %}
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>{{ form.grade.help_text }}
                        </small>
                    {% endif %}
                    {% if form.grade.errors %}
                        <div class="error-message mt-1">{{ form.grade.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.division.id_for_label }}" class="form-label required-field">
                        {% trans "Assigned Division" %} *
                    </label>
                    {{ form.division }}
                    {% if form.division.help_text %}
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>{{ form.division.help_text }}
                        </small>
                    {% endif %}
                    {% if form.division.errors %}
                        <div class="error-message mt-1">{{ form.division.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.age_verification_document.id_for_label }}" class="form-label" style="font-weight: 700; color: var(--mlb-blue); font-size: 1.05rem; margin-bottom: 12px;">
                    <i class="fas fa-file-upload me-2" style="color: var(--mlb-red);"></i>{% trans "Age Verification Document" %}
                </label>
                <div class="file-upload-area" id="ageVerificationUploadArea" style="border: 3px dashed var(--mlb-blue); border-radius: 12px; padding: 30px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e7f3ff 100%); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                    <div style="position: relative; z-index: 2;">
                        {% if object.age_verification_document %}
                            <i class="fas fa-check-circle fa-3x mb-3" style="color: #28a745; animation: none;"></i>
                            <p class="mb-2" style="font-weight: 700; color: #28a745; font-size: 1.1rem;">
                                <i class="fas fa-file-check me-2"></i>{% trans "Current Document" %}
                            </p>
                            <a href="{% url 'accounts:serve_age_verification_document' object.pk %}" target="_blank" class="btn btn-sm btn-outline-info mb-2">
                                <i class="fas fa-file me-1"></i>{% trans "View current document" %}
                            </a>
                            <p class="mb-1" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.95rem;">{% trans "Click to upload new document" %}</p>
                        {% else %}
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: var(--mlb-blue); animation: pulse 2s ease-in-out infinite;"></i>
                            <p class="mb-2" style="font-weight: 700; color: var(--mlb-blue); font-size: 1.1rem;">{% trans "Click to upload document" %}</p>
                        {% endif %}
                        <small class="text-muted d-block mt-2" style="font-size: 0.9rem;">{% trans "PDF, JPG, PNG (max. 10MB)" %}</small>
                        <small class="text-muted d-block mt-1" style="font-size: 0.85rem;">{% trans "Birth certificate, passport or ID (original or digital)" %}</small>
                    </div>
                    {{ form.age_verification_document }}
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, rgba(13, 44, 84, 0.05) 0%, rgba(213, 0, 50, 0.05) 100%); z-index: 1; pointer-events: none;"></div>
                </div>
                {% if form.age_verification_document.help_text %}
                    <div class="alert alert-info mt-3 mb-0" style="background: #e7f3ff; border-left: 4px solid var(--mlb-blue); border-radius: 6px; padding: 12px;">
                        <small style="display: flex; align-items: center;">
                            <i class="fas fa-info-circle me-2" style="color: var(--mlb-blue);"></i>
                            <span>{{ form.age_verification_document.help_text }}</span>
                        </small>
                    </div>
                {% endif %}
                {% if form.age_verification_document.errors %}
                    <div class="alert alert-danger mt-3 mb-0" style="border-left: 4px solid var(--mlb-red); border-radius: 6px; padding: 12px;">
                        <small style="display: flex; align-items: center;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span>{{ form.age_verification_document.errors }}</span>
                        </small>
                    </div>
                {% endif %}
            </div>

            {% if not is_parent_editing %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.age_verification_status.id_for_label }}" class="form-label">
                        {% trans "Verification Status" %}
                    </label>
                    {{ form.age_verification_status }}
                    {% if form.age_verification_status.errors %}
                        <div class="error-message mt-1">{{ form.age_verification_status.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">
                        <i class="fas fa-info-circle me-1"></i>
                        {% trans "Select the verification status for the age verification document" %}
                    </small>
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.age_verification_notes.id_for_label }}" class="form-label">
                    {% trans "Verification Notes" %}
                </label>
                {{ form.age_verification_notes }}
                {% if form.age_verification_notes.errors %}
                    <div class="error-message mt-1">{{ form.age_verification_notes.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Add any notes about the age verification process" %}
                </small>
            </div>
            {% endif %}
        </div>

        <!-- Tallas de Uniformes -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-tshirt me-2" style="color: var(--mlb-red);"></i>{% trans "Uniform Sizes" %}
            </h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.jersey_size.id_for_label }}" class="form-label required-field">
                        {% trans "Jersey Size" %} *
                    </label>
                    {{ form.jersey_size }}
                    {% if form.jersey_size.errors %}
                        <div class="error-message mt-1">{{ form.jersey_size.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.hat_size.id_for_label }}" class="form-label required-field">
                        {% trans "Hat Size" %} *
                    </label>
                    {{ form.hat_size }}
                    {% if form.hat_size.errors %}
                        <div class="error-message mt-1">{{ form.hat_size.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.batting_glove_size.id_for_label }}" class="form-label required-field">
                        {% trans "Batting Glove Size" %} *
                    </label>
                    {{ form.batting_glove_size }}
                    {% if form.batting_glove_size.errors %}
                        <div class="error-message mt-1">{{ form.batting_glove_size.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.batting_helmet_size.id_for_label }}" class="form-label required-field">
                        {% trans "Batting Helmet Size" %} *
                    </label>
                    {{ form.batting_helmet_size }}
                    {% if form.batting_helmet_size.errors %}
                        <div class="error-message mt-1">{{ form.batting_helmet_size.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.shorts_size.id_for_label }}" class="form-label required-field">
                        {% trans "Pants Size" %} *
                    </label>
                    {{ form.shorts_size }}
                    {% if form.shorts_size.errors %}
                        <div class="error-message mt-1">{{ form.shorts_size.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Contacto de Emergencia -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-phone-alt me-2" style="color: var(--mlb-red);"></i>{% trans "Emergency Contact" %}
            </h5>
            <div class="alert alert-light border mb-3 alert-persistent" style="background: #f8f9fa; border-color: #dee2e6 !important;">
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Information used only in case of medical emergency." %}
                </small>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label required-field">
                        {% trans "Contact Name" %} *
                    </label>
                    {{ form.emergency_contact_name }}
                    {% if form.emergency_contact_name.errors %}
                        <div class="error-message mt-1">{{ form.emergency_contact_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.emergency_contact_phone.id_for_label }}" class="form-label required-field">
                        {% trans "Emergency Phone" %} *
                    </label>
                    {{ form.emergency_contact_phone }}
                    {% if form.emergency_contact_phone.errors %}
                        <div class="error-message mt-1">{{ form.emergency_contact_phone.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">{% trans "24/7 available number" %}</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.emergency_contact_relation.id_for_label }}" class="form-label required-field">
                        {% trans "Relationship with Player" %} *
                    </label>
                    {{ form.emergency_contact_relation }}
                    {% if form.emergency_contact_relation.errors %}
                        <div class="error-message mt-1">{{ form.emergency_contact_relation.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.medical_conditions.id_for_label }}" class="form-label required-field">
                    {% trans "Medical Conditions" %} *
                </label>
                {{ form.medical_conditions }}
                {% if form.medical_conditions.errors %}
                    <div class="error-message mt-1">{{ form.medical_conditions.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Allergies, asthma, medications, etc. If there are no conditions, write \"None\"." %}
                </small>
            </div>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="form-actions mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'accounts:player_detail' object.pk %}" class="btn btn-form-cancel">
                    <i class="fas fa-times me-2"></i>{% trans "Cancel" %}
                </a>
                <button type="submit" class="btn btn-form-submit" id="btnSavePlayer">
                    <span class="button-text">
                        <i class="fas fa-save me-2"></i>{% trans "Save Changes" %}
                    </span>
                    <span class="button-spinner" style="display: none;">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        {% trans "Saving..." %}
                    </span>
                </button>
            </div>
        </div>
    </form>
</div>

<style>
@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.file-upload-area input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 3;
}

.profile-picture-upload-area:hover {
    border-color: var(--mlb-red) !important;
    transform: scale(1.02);
    box-shadow: 0 8px 20px rgba(13, 44, 84, 0.1) !important;
}
</style>

<script>
(function() {
    // Funci√≥n para inicializar el formulario de edici√≥n
    function initPlayerEditForm() {
        console.log('üîÑ Inicializando formulario de edici√≥n de jugador...');
        const playerEditForm = document.getElementById('playerEditForm');
        if (!playerEditForm) return;

        // 1. Manejo de is_pitcher y secondary_position
        const isPitcherCheckbox = document.getElementById('{{ form.is_pitcher.id_for_label }}');
        const secondaryPositionSelect = document.getElementById('{{ form.secondary_position.id_for_label }}');

        function prepareFormFields() {
            console.log('üõ†Ô∏è Preparando campos del formulario antes de enviar...');

            // Asegurar is_pitcher
            if (isPitcherCheckbox) {
                const existingHidden = playerEditForm.querySelector('input[name="is_pitcher"][type="hidden"]');
                if (existingHidden) existingHidden.remove();

                if (!isPitcherCheckbox.checked) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'is_pitcher';
                    hiddenInput.value = '0';
                    playerEditForm.appendChild(hiddenInput);
                    console.log('‚úÖ Added hidden is_pitcher=0');
                }
            }

            // Asegurar secondary_position
            if (secondaryPositionSelect) {
                const val = secondaryPositionSelect.value;
                if (!val) {
                    const existingHidden = playerEditForm.querySelector('input[name="secondary_position"][type="hidden"]');
                    if (existingHidden) existingHidden.remove();

                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'secondary_position';
                    hiddenInput.value = '';
                    playerEditForm.appendChild(hiddenInput);
                    console.log('‚úÖ Added hidden secondary_position=""');
                }
            }
        }

        // Exponer globalmente para el panel
        window.preparePlayerEditFormFields = prepareFormFields;

        // Agregar listener si no estamos en el panel
        const isInPanel = playerEditForm.hasAttribute('data-submit-listener-added') ||
                          document.getElementById('tab-content-editar-jugador') !== null;

        if (!isInPanel) {
            playerEditForm.addEventListener('submit', function(e) {
                prepareFormFields();

                // Mostrar spinner
                const btn = document.getElementById('btnSavePlayer');
                if (btn) {
                    const text = btn.querySelector('.button-text');
                    const spinner = btn.querySelector('.button-spinner');
                    if (text && spinner) {
                        text.style.display = 'none';
                        spinner.style.display = 'inline-block';
                        btn.disabled = true;
                    }
                }
            });
        }

        // 2. Inicializar Foto de Perfil
        const profilePictureInput = document.getElementById('id_profile_picture');
        const profilePictureUploadArea = document.getElementById('profilePictureUploadArea');

        if (profilePictureInput && profilePictureUploadArea) {
            // Click triggers input
            profilePictureUploadArea.addEventListener('click', function(e) {
                if (e.target !== profilePictureInput) {
                    profilePictureInput.click();
                }
            });

            // Preview
            profilePictureInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validaciones
                    if (file.size > 5 * 1024 * 1024) {
                        alert('{% filter escapejs %}{% trans "The file is too large. Maximum size is 5MB." %}{% endfilter %}');
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePictureUploadArea.innerHTML = `
                            <div style="position: relative;">
                                <img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 12px; object-fit: cover; margin-bottom: 15px;">
                                <div>
                                    <i class="fas fa-check-circle fa-2x mb-2" style="color: #28a745;"></i>
                                    <p class="mb-1" style="font-weight: 600; color: var(--mlb-blue);">{% filter escapejs %}{% trans "Photo Selected" %}{% endfilter %}</p>
                                    <small class="text-success">${file.name}</small>
                                </div>
                            </div>
                        `;
                        profilePictureUploadArea.style.borderColor = '#28a745';
                        profilePictureUploadArea.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // 3. Inicializar Verificaci√≥n de Edad (File Area)
        const ageVerifInput = document.querySelector('#playerEditForm input[type="file"][name*="age_verification"]');
        const ageVerifArea = document.getElementById('ageVerificationUploadArea');

        if (ageVerifInput && ageVerifArea) {
            ageVerifArea.addEventListener('click', function(e) {
                if (e.target !== ageVerifInput) {
                    ageVerifInput.click();
                }
            });

            ageVerifInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 10 * 1024 * 1024) {
                        alert('{% filter escapejs %}{% trans "The file is too large. Maximum allowed size is 10MB." %}{% endfilter %}');
                        this.value = '';
                        return;
                    }

                    const contentDiv = ageVerifArea.querySelector('div[style*="position: relative"]');
                    if (contentDiv) {
                        contentDiv.innerHTML = `
                            <i class="fas fa-check-circle fa-3x mb-3" style="color: #28a745;"></i>
                            <p class="mb-2" style="font-weight: 700; color: #28a745; font-size: 1.1rem;">{% filter escapejs %}{% trans "Document Uploaded" %}{% endfilter %}</p>
                            <p class="mb-1" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.95rem;">${file.name}</small>
                        `;
                    }
                    ageVerifArea.style.borderColor = '#28a745';
                    ageVerifArea.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                }
            });
        }

        // 4. Filtros Din√°micos de Ubicaci√≥n
        const countrySelect = playerEditForm.querySelector('[name="country"]');
        const stateSelect = playerEditForm.querySelector('[name="state"]');
        const citySelect = playerEditForm.querySelector('[name="city"]');
        const stateLoader = playerEditForm.querySelector('#stateLoader');
        const cityLoader = playerEditForm.querySelector('#cityLoader');

        if (countrySelect && stateSelect && citySelect) {
            const initialCountry = countrySelect.value;

            function updateStates(showLoader = true) {
                const countryId = countrySelect.value;
                const currentStateValue = stateSelect.value;

                stateSelect.innerHTML = '<option value="">{% filter escapejs %}{% trans "Select a state" %}{% endfilter %}</option>';
                citySelect.innerHTML = '<option value="">{% filter escapejs %}{% trans "Select a city" %}{% endfilter %}</option>';

                if (countryId) {
                    if (showLoader && stateLoader) stateLoader.style.display = 'block';
                    if (showLoader) {
                        stateSelect.disabled = true;
                        citySelect.disabled = true;
                    }

                    fetch(`/locations/ajax/states/${countryId}/`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(state => {
                                const opt = document.createElement('option');
                                opt.value = state.id;
                                opt.textContent = state.name;
                                if (currentStateValue == state.id) opt.selected = true;
                                stateSelect.appendChild(opt);
                            });
                            if (stateSelect.value) updateCities(showLoader);
                        })
                        .finally(() => {
                            if (stateLoader) stateLoader.style.display = 'none';
                            stateSelect.disabled = false;
                            citySelect.disabled = false;
                        });
                }
            }

            function updateCities(showLoader = true) {
                const stateId = stateSelect.value;
                const currentCityValue = citySelect.value;

                citySelect.innerHTML = '<option value="">{% filter escapejs %}{% trans "Select a city" %}{% endfilter %}</option>';

                if (stateId) {
                    if (showLoader && cityLoader) cityLoader.style.display = 'block';
                    if (showLoader) citySelect.disabled = true;

                    fetch(`/locations/ajax/cities/${stateId}/`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(city => {
                                const opt = document.createElement('option');
                                opt.value = city.id;
                                opt.textContent = city.name;
                                if (currentCityValue == city.id) opt.selected = true;
                                citySelect.appendChild(opt);
                            });
                        })
                        .finally(() => {
                            if (cityLoader) cityLoader.style.display = 'none';
                            citySelect.disabled = false;
                        });
                }
            }

            countrySelect.addEventListener('change', () => updateStates(true));
            stateSelect.addEventListener('change', () => updateCities(true));

            if (initialCountry && stateSelect.options.length <= 1) updateStates(false);
        }
    }

    // Ejecutar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPlayerEditForm);
    } else {
        initPlayerEditForm();
    }

    // Convert Django messages to toasts
    setTimeout(function() {
        if (window.adminDashboard) {
            window.adminDashboard.convertDjangoMessagesToToasts();
        }
    }, 100);
})();
</script>
{% endblock %}
