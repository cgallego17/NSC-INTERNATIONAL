{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Emails" %} - NCS International{% endblock %}

{% block breadcrumb %}
    <span>{% trans "Emails" %}</span>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'admin/css/vendor/select2/select2.css' %}">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .html-editor-wrapper {
            position: relative;
        }
        .html-editor-wrapper .ql-container {
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            border: 1px solid #dee2e6;
            border-top: none;
        }
        .html-editor-wrapper .ql-toolbar {
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
            border: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .html-editor-wrapper .ql-editor {
            min-height: 320px;
            font-size: 14px;
        }
        #email-html-body-html-editor {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            min-height: 320px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            display: none;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
            <h1 class="h4 mb-1">{% trans "Send Email" %}</h1>
            <div class="text-muted" style="font-size: 0.9rem;">{% trans "Send HTML emails to users" %}</div>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'accounts:admin_email_broadcast_list' %}">
                <i class="bi bi-arrow-left me-1"></i>{% trans "Back" %}
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">{% trans "Subject" %}</label>
                        {{ form.subject }}
                        {% if form.subject.errors %}<div class="text-danger" style="font-size: 0.85rem;">{{ form.subject.errors }}</div>{% endif %}
                    </div>

                    <div class="col-12">
                        <label class="form-label">{% trans "HTML Body" %}</label>
                        <div class="html-editor-wrapper">
                            {{ form.html_body }}
                            <div id="email-html-body-editor-container">
                                <div id="email-html-body-editor" style="min-height: 320px;"></div>
                                <textarea id="email-html-body-html-editor" class="form-control" placeholder="Edite el HTML directamente aquí..."></textarea>
                            </div>
                        </div>
                        {% if form.html_body.errors %}<div class="text-danger" style="font-size: 0.85rem;">{{ form.html_body.errors }}</div>{% endif %}
                        <div class="text-muted mt-1" style="font-size: 0.85rem;">{% trans "Tip: you can paste full HTML here. A text version will be generated automatically." %}</div>
                    </div>

                    <div class="col-12">
                        <div class="fw-semibold mb-2">{% trans "Recipients" %}</div>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                {{ form.send_to_parents }}
                                <label class="form-check-label" for="{{ form.send_to_parents.id_for_label }}">{% trans "Parents" %}</label>
                            </div>
                            <div class="form-check">
                                {{ form.send_to_managers }}
                                <label class="form-check-label" for="{{ form.send_to_managers.id_for_label }}">{% trans "Coaches / Managers" %}</label>
                            </div>
                            <div class="form-check">
                                {{ form.send_to_spectators }}
                                <label class="form-check-label" for="{{ form.send_to_spectators.id_for_label }}">{% trans "Spectators" %}</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="fw-semibold mb-2">{% trans "Filters" %}</div>
                        <div class="row g-2">
                            <div class="col-12 col-md-3">
                                <label class="form-label">{% trans "Country" %}</label>
                                {{ form.country }}
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">{% trans "State" %}</label>
                                {{ form.state }}
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">{% trans "City" %}</label>
                                {{ form.city }}
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">{% trans "Division" %}</label>
                                {{ form.division }}
                                <div class="text-muted mt-1" style="font-size: 0.8rem;">{% trans "Spectators are filtered only by location." %}</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send me-1"></i>{% trans "Send" %}
                        </button>
                        <a href="{% url 'accounts:admin_email_send' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>{% trans "Clear" %}
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
<script src="{% static 'admin/js/vendor/select2/select2.full.js' %}"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    (function () {
        const countrySelect = document.getElementById('id_country');
        const stateSelect = document.getElementById('id_state');
        const citySelect = document.getElementById('id_city');
        const divisionSelect = document.getElementById('id_division');

        if (!countrySelect || !stateSelect || !citySelect) return;

        const stateEmptyLabel = stateSelect.querySelector('option[value=""]')?.textContent || '';
        const cityEmptyLabel = citySelect.querySelector('option[value=""]')?.textContent || '';

        const resetSelect = (selectEl, emptyLabel) => {
            selectEl.innerHTML = '';
            if (emptyLabel) {
                const emptyOpt = document.createElement('option');
                emptyOpt.value = '';
                emptyOpt.textContent = emptyLabel;
                selectEl.appendChild(emptyOpt);
            }
        };

        const fillSelect = (selectEl, items, selectedValue) => {
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = String(item.id);
                opt.textContent = item.name;
                if (selectedValue && String(item.id) === String(selectedValue)) {
                    opt.selected = true;
                }
                selectEl.appendChild(opt);
            });
        };

        const getSelectedValues = (selectEl) => {
            return Array.from(selectEl.selectedOptions || []).map(o => o.value).filter(Boolean);
        };

        const fetchJsonOrLog = async (url, meta) => {
            try {
                const res = await fetch(url, {
                    credentials: 'same-origin',
                    headers: { 'Accept': 'application/json' },
                });

                if (!res.ok) {
                    const bodyText = await res.text();
                    console.error('Failed to load dependent options', {
                        ...meta,
                        url,
                        status: res.status,
                        contentType: res.headers.get('content-type'),
                        body: bodyText.slice(0, 300),
                    });
                    return [];
                }

                const contentType = (res.headers.get('content-type') || '').toLowerCase();
                if (!contentType.includes('application/json')) {
                    const bodyText = await res.text();
                    console.error('Expected JSON but got non-JSON response', {
                        ...meta,
                        url,
                        status: res.status,
                        contentType,
                        body: bodyText.slice(0, 300),
                    });
                    return [];
                }

                return await res.json();
            } catch (err) {
                console.error('Error fetching dependent options', { ...meta, url, err });
                return [];
            }
        };

        const loadStates = async (countryIds, selectedStateIds) => {
            resetSelect(stateSelect, stateEmptyLabel);
            resetSelect(citySelect, cityEmptyLabel);

            if (!countryIds || !countryIds.length) return;

            const results = await Promise.all(countryIds.map(async (countryId) => {
                return await fetchJsonOrLog(
                    `/locations/ajax/states/${encodeURIComponent(countryId)}/`,
                    { kind: 'states', countryId }
                );
            }));

            const merged = new Map();
            results.flat().forEach(item => {
                merged.set(String(item.id), item);
            });

            fillSelect(stateSelect, Array.from(merged.values()), null);

            if (selectedStateIds && selectedStateIds.length) {
                Array.from(stateSelect.options).forEach(opt => {
                    if (selectedStateIds.includes(String(opt.value))) {
                        opt.selected = true;
                    }
                });
            }

            if (window.jQuery && window.jQuery.fn && window.jQuery.fn.select2) {
                window.jQuery(stateSelect).trigger('change.select2');
                window.jQuery(citySelect).trigger('change.select2');
            }
        };

        const loadCities = async (stateIds, selectedCityIds) => {
            resetSelect(citySelect, cityEmptyLabel);

            if (!stateIds || !stateIds.length) return;

            const results = await Promise.all(stateIds.map(async (stateId) => {
                return await fetchJsonOrLog(
                    `/locations/ajax/cities/${encodeURIComponent(stateId)}/`,
                    { kind: 'cities', stateId }
                );
            }));

            const merged = new Map();
            results.flat().forEach(item => {
                merged.set(String(item.id), item);
            });

            fillSelect(citySelect, Array.from(merged.values()), null);

            if (selectedCityIds && selectedCityIds.length) {
                Array.from(citySelect.options).forEach(opt => {
                    if (selectedCityIds.includes(String(opt.value))) {
                        opt.selected = true;
                    }
                });
            }

            if (window.jQuery && window.jQuery.fn && window.jQuery.fn.select2) {
                window.jQuery(citySelect).trigger('change.select2');
            }
        };

        countrySelect.addEventListener('change', async function () {
            await loadStates(getSelectedValues(countrySelect), []);
        });

        stateSelect.addEventListener('change', async function () {
            await loadCities(getSelectedValues(stateSelect), []);
        });

        (async function init() {
            const initialCountryIds = getSelectedValues(countrySelect);
            const initialStateIds = getSelectedValues(stateSelect);
            const initialCityIds = getSelectedValues(citySelect);

            if (initialCountryIds.length) {
                await loadStates(initialCountryIds, initialStateIds);
            }
            if (initialStateIds.length) {
                await loadCities(initialStateIds, initialCityIds);
            }
        })();
    })();
</script>
<script>
    (function () {
        if (!window.jQuery || !window.jQuery.fn || !window.jQuery.fn.select2) return;

        const $ = window.jQuery;
        const selects = ['#id_country', '#id_state', '#id_city', '#id_division'];

        const initSelect2 = function () {
            selects.forEach(sel => {
                const el = document.querySelector(sel);
                if (!el) return;
                $(el).select2({
                    width: '100%',
                    closeOnSelect: false,
                });
            });
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSelect2);
        } else {
            initSelect2();
        }
    })();
</script>

<script>
    (function () {
        const initQuillEmailBody = function () {
            const field = document.getElementById('id_html_body');
            const editorDiv = document.getElementById('email-html-body-editor');
            const htmlEditor = document.getElementById('email-html-body-html-editor');
            if (!field || !editorDiv || !window.Quill) return;

            field.style.display = 'none';
            field.style.visibility = 'hidden';
            field.style.position = 'absolute';
            field.style.width = '0';
            field.style.height = '0';
            field.style.opacity = '0';
            field.style.pointerEvents = 'none';

            const createHtmlToggleButton = function () {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'ql-html-toggle';
                button.style.cssText = 'display: inline-flex; flex-direction: row; align-items: center; white-space: nowrap;';
                button.innerHTML = '<i class="fas fa-code" style="display:inline-block;margin-right:4px;"></i><span style="display:inline-block;">HTML</span>';
                button.title = 'Alternar entre modo Visual y HTML';
                return button;
            };

            const quillConfig = {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                            [{ 'align': [] }],
                            ['link', 'image'],
                            ['blockquote', 'code-block'],
                            ['clean']
                        ],
                    },
                },
                placeholder: 'Escriba aquí...',
            };

            let htmlMode = false;
            const quill = new Quill('#email-html-body-editor', quillConfig);

            const toolbarElement = quill.container ? quill.container.previousElementSibling : null;
            if (toolbarElement && !toolbarElement.querySelector('.ql-html-toggle')) {
                const buttonContainer = document.createElement('span');
                buttonContainer.className = 'ql-formats';
                const toggleBtn = createHtmlToggleButton();
                toggleBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    htmlMode = !htmlMode;
                    if (htmlMode) {
                        editorDiv.style.display = 'none';
                        htmlEditor.style.display = 'block';
                        htmlEditor.value = quill.root.innerHTML;
                        toggleBtn.innerHTML = '<i class="fas fa-eye" style="display:inline-block;margin-right:4px;"></i><span style="display:inline-block;">Visual</span>';
                        toggleBtn.classList.add('active');
                    } else {
                        editorDiv.style.display = 'block';
                        htmlEditor.style.display = 'none';
                        quill.root.innerHTML = htmlEditor.value;
                        field.value = htmlEditor.value;
                        toggleBtn.innerHTML = '<i class="fas fa-code" style="display:inline-block;margin-right:4px;"></i><span style="display:inline-block;">HTML</span>';
                        toggleBtn.classList.remove('active');
                    }
                });
                buttonContainer.appendChild(toggleBtn);
                toolbarElement.appendChild(buttonContainer);
            }

            if (field.value) {
                quill.root.innerHTML = field.value;
                if (htmlEditor) {
                    htmlEditor.value = field.value;
                }
            }

            quill.on('text-change', function () {
                if (!htmlMode) {
                    field.value = quill.root.innerHTML;
                    if (htmlEditor) {
                        htmlEditor.value = quill.root.innerHTML;
                    }
                }
            });

            if (htmlEditor) {
                htmlEditor.addEventListener('input', function () {
                    if (htmlMode) {
                        field.value = htmlEditor.value;
                        try {
                            quill.root.innerHTML = htmlEditor.value;
                        } catch (e) {
                            // ignore
                        }
                    }
                });
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initQuillEmailBody);
        } else {
            initQuillEmailBody();
        }
    })();
</script>
{% endblock %}
