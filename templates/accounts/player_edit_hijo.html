{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Editar Hijo/Jugador - NCS International{% endblock %}

{% block breadcrumb %}
    <span>Jugadores</span>
    <span>Editar</span>
{% endblock %}

{% block content %}
<!-- Messages (hidden, converted to toasts) -->
<div class="messages-container" style="display: none;">
    {% for message in messages %}
        <div class="django-message" data-tag="{{ message.tags }}" data-message="{{ message|escapejs }}" data-extra-tags="{{ message.extra_tags|default:'' }}">
        </div>
    {% endfor %}
</div>

<div class="tab-content-header mb-4">
    <h4 style="color: var(--mlb-blue); font-weight: 800; font-size: 1.5rem; margin-bottom: 10px;">
        <i class="fas fa-user-edit me-2" style="color: var(--mlb-red);"></i>{% trans "Edit Child/Player" %}
    </h4>
    <p class="text-muted">{% trans "Modify your child's information" %}: {% if object.user %}{{ object.user.get_full_name|default:object.user.username }}{% else %}{{ object.first_name }} {{ object.last_name }}{% endif %}</p>
</div>

<div class="form-container">
    <form method="post" action="{% url 'accounts:player_edit' object.pk %}" enctype="multipart/form-data" id="playerEditForm" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger mb-4 alert-persistent">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- Campos ocultos para age_verification (solo para padres) -->
        <div style="display: none;">
            {{ form.age_verification_status }}
            {{ form.age_verification_notes }}
        </div>

        <!-- InformaciÃ³n del Jugador -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-user me-2" style="color: var(--mlb-red);"></i>{% trans "Personal Information" %}
            </h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label required-field">
                        {% trans "First Name" %} *
                    </label>
                    {{ form.first_name }}
                    {% if form.first_name.errors %}
                        <div class="error-message mt-1">{{ form.first_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.last_name.id_for_label }}" class="form-label required-field">
                        {% trans "Last Name" %} *
                    </label>
                    {{ form.last_name }}
                    {% if form.last_name.errors %}
                        <div class="error-message mt-1">{{ form.last_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.last_name2.id_for_label }}" class="form-label">
                        {% trans "Second Last Name" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    {{ form.last_name2 }}
                    {% if form.last_name2.errors %}
                        <div class="error-message mt-1">{{ form.last_name2.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                {% if form.email %}
                <div class="col-md-6 mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label required-field">
                        {% trans "Email" %} *
                    </label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div class="error-message mt-1">{{ form.email.errors }}</div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="col-md-6 mb-3">
                    <label for="{{ form.phone.id_for_label }}" class="form-label">
                        {% trans "Phone" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    {{ form.phone }}
                    {% if form.phone.errors %}
                        <div class="error-message mt-1">{{ form.phone.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">{% trans "Format: (123) 456-7890" %}</small>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.birth_date.id_for_label }}" class="form-label">
                        {% trans "Birth Date" %}
                    </label>
                    {{ form.birth_date }}
                    {% if form.birth_date.help_text %}
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>{{ form.birth_date.help_text }}
                        </small>
                    {% endif %}
                    {% if form.birth_date.errors %}
                        <div class="error-message mt-1">{{ form.birth_date.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Foto de Perfil -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="{{ form.profile_picture.id_for_label }}" class="form-label">
                        <i class="fas fa-camera me-2"></i>{% trans "Profile Picture" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    <div class="profile-picture-upload-area" id="profilePictureUploadArea" style="border: 2px dashed #0d2c54; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        {% if object.user.profile.profile_picture %}
                            <div style="position: relative;">
                                <img src="{{ object.user.profile.profile_picture.url }}" alt="Profile Picture" style="max-width: 200px; max-height: 200px; border-radius: 12px; object-fit: cover; margin-bottom: 15px;">
                                <div>
                                    <i class="fas fa-check-circle fa-2x mb-2" style="color: #28a745;"></i>
                                    <p class="mb-1" style="font-weight: 600; color: var(--mlb-blue);">
                                        {% trans "Photo Uploaded" %}
                                    </p>
                                    <small class="text-muted">{% trans "Click to change photo" %}</small>
                                </div>
                            </div>
                        {% else %}
                            <div>
                                <i class="fas fa-camera fa-3x mb-3" style="color: #0d2c54; opacity: 0.5;"></i>
                                <p class="mb-2" style="font-weight: 600; color: var(--mlb-blue); font-size: 1.05rem;">
                                    {% trans "Upload Profile Picture" %}
                                </p>
                                <small class="text-muted">{% trans "Click here to select an image" %}</small>
                            </div>
                        {% endif %}
                    </div>
                    {{ form.profile_picture }}
                    {% if form.profile_picture.errors %}
                        <div class="error-message mt-2">{{ form.profile_picture.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>{% trans "Accepted formats: JPG, PNG, GIF. Max size: 5MB" %}
                    </small>
                </div>
            </div>

            <!-- UbicaciÃ³n -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.country.id_for_label }}" class="form-label">
                        <i class="fas fa-globe me-1"></i>{% trans "Country" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    {{ form.country }}
                    {% if form.country.errors %}
                        <div class="error-message mt-1">{{ form.country.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.state.id_for_label }}" class="form-label">
                        <i class="fas fa-map-marker-alt me-1"></i>{% trans "State" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    {{ form.state }}
                    {% if form.state.errors %}
                        <div class="error-message mt-1">{{ form.state.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.city.id_for_label }}" class="form-label">
                        <i class="fas fa-city me-1"></i>{% trans "City" %}
                        <span class="text-muted small">({% trans "optional" %})</span>
                    </label>
                    {{ form.city }}
                    {% if form.city.errors %}
                        <div class="error-message mt-1">{{ form.city.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- InformaciÃ³n Deportiva -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-baseball-ball me-2" style="color: var(--mlb-red);"></i>{% trans "Sports Information" %}
            </h5>
            <div class="alert alert-light border mb-3 alert-persistent" style="background: #f8f9fa; border-color: #dee2e6 !important;">
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Team and jersey number will be assigned by an administrator or manager." %}
                </small>
            </div>

            <!-- Campos ocultos para mantener valores cuando padre edita -->
            <div style="display: none;">
                {% if form.team_hidden %}
                    {{ form.team_hidden }}
                {% endif %}
                {{ form.team.as_hidden }}
                {{ form.jersey_number.as_hidden }}
                {{ form.is_active.as_hidden }}
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.position.id_for_label }}" class="form-label">
                        {% trans "Primary Position" %}
                    </label>
                    {{ form.position }}
                    {% if form.position.errors %}
                        <div class="error-message mt-1">{{ form.position.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.secondary_position.id_for_label }}" class="form-label">
                        {% trans "Secondary Position" %}
                    </label>
                    {{ form.secondary_position }}
                    {% if form.secondary_position.errors %}
                        <div class="error-message mt-1">{{ form.secondary_position.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label d-block">
                        {% trans "Are you a pitcher?" %}
                    </label>
                    <div class="form-check">
                        {{ form.is_pitcher }}
                        <label class="form-check-label" for="{{ form.is_pitcher.id_for_label }}">
                            {% trans "Yes, I am a pitcher" %}
                        </label>
                    </div>
                    {% if form.is_pitcher.errors %}
                        <div class="error-message mt-1">{{ form.is_pitcher.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.height.id_for_label }}" class="form-label">
                        {% trans "Height" %}
                    </label>
                    {{ form.height }}
                    {% if form.height.errors %}
                        <div class="error-message mt-1">{{ form.height.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">{% trans "Ex: 5'10\"" %}</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.weight.id_for_label }}" class="form-label">
                        {% trans "Weight (lbs)" %}
                    </label>
                    {{ form.weight }}
                    {% if form.weight.errors %}
                        <div class="error-message mt-1">{{ form.weight.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.batting_hand.id_for_label }}" class="form-label required-field">
                        {% trans "Batting Hand" %} *
                    </label>
                    {{ form.batting_hand }}
                    {% if form.batting_hand.errors %}
                        <div class="error-message mt-1">{{ form.batting_hand.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.throwing_hand.id_for_label }}" class="form-label required-field">
                        {% trans "Throwing Hand" %} *
                    </label>
                    {{ form.throwing_hand }}
                    {% if form.throwing_hand.errors %}
                        <div class="error-message mt-1">{{ form.throwing_hand.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Elegibilidad y DivisiÃ³n -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-check-circle me-2" style="color: var(--mlb-red);"></i>{% trans "Eligibility and Division" %}
            </h5>

            {% if object %}
                {% with age=object.calculate_age_as_of_april_30 age_division=object.get_age_based_division grade_division=object.get_grade_based_division eligible=object.get_eligible_divisions %}
                    {% if age %}
                        <div class="alert alert-info border mb-3 alert-persistent" style="background: #e7f3ff; border-color: #0dcaf0 !important;">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>{% trans "Eligibility Information" %}:</strong><br>
                                <strong>{% trans "Age as of April 30" %}:</strong> {{ age }} {% trans "years" %}<br>
                                {% if age_division %}
                                    <strong>{% trans "Age-based division" %}:</strong> {{ age_division }}<br>
                                {% endif %}
                                {% if grade_division %}
                                    <strong>{% trans "Grade-based division" %}:</strong> {{ grade_division }}<br>
                                {% endif %}
                                {% if eligible %}
                                    <strong>{% trans "Eligible divisions" %}:</strong> {{ eligible|join:", " }}
                                {% endif %}
                            </small>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endif %}

            <div class="alert alert-warning border mb-3 alert-persistent" style="background: #fff3cd; border-color: #ffc107 !important;">
                <small>
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <strong>{% trans "Required:" %}</strong> {% trans "Grade and Division are required fields. They will be calculated automatically based on birth date, but you can modify them if needed." %}
                </small>
            </div>
            <div class="alert alert-info border mb-3 alert-persistent" style="background: #e7f3ff; border-color: #0dcaf0 !important;">
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Players without approved age verification are not eligible until documentation is approved." %}
                </small>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.grade.id_for_label }}" class="form-label required-field">
                        {% trans "Current Grade" %} *
                    </label>
                    {{ form.grade }}
                    {% if form.grade.help_text %}
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>{{ form.grade.help_text }}
                        </small>
                    {% endif %}
                    {% if form.grade.errors %}
                        <div class="error-message mt-1">{{ form.grade.errors }}</div>
                    {% endif %}
                    <small class="text-success d-block mt-1">
                        <i class="fas fa-magic me-1"></i>{% trans "Will be calculated automatically" %}
                    </small>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.division.id_for_label }}" class="form-label required-field">
                        {% trans "Assigned Division" %} *
                    </label>
                    {{ form.division }}
                    {% if form.division.help_text %}
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>{{ form.division.help_text }}
                        </small>
                    {% endif %}
                    {% if form.division.errors %}
                        <div class="error-message mt-1">{{ form.division.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">{% trans "Assigned automatically or by administrator" %}</small>
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.age_verification_document.id_for_label }}" class="form-label" style="font-weight: 700; color: var(--mlb-blue); font-size: 1.05rem; margin-bottom: 12px;">
                    <i class="fas fa-file-upload me-2" style="color: var(--mlb-red);"></i>{% trans "Age Verification Document" %}
                </label>
                <div class="file-upload-area" id="ageVerificationUploadArea" style="border: 3px dashed var(--mlb-blue); border-radius: 12px; padding: 30px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e7f3ff 100%); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='var(--mlb-red)'; this.style.background='linear-gradient(135deg, #e7f3ff 0%, #fff5f5 100%)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(13, 44, 84, 0.15)';" onmouseout="this.style.borderColor='var(--mlb-blue)'; this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e7f3ff 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="position: relative; z-index: 2;">
                        {% if object.age_verification_document %}
                            <i class="fas fa-check-circle fa-3x mb-3" style="color: #28a745; animation: none;"></i>
                            <p class="mb-2" style="font-weight: 700; color: #28a745; font-size: 1.1rem;">
                                <i class="fas fa-file-check me-2"></i>{% trans "Current Document" %}
                            </p>
                            <a href="{{ object.age_verification_document.url }}" target="_blank" class="btn btn-sm btn-outline-info mb-2">
                                <i class="fas fa-file me-1"></i>{% trans "View current document" %}
                            </a>
                            <p class="mb-1" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.95rem;">{% trans "Click to upload new document" %}</p>
                        {% else %}
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: var(--mlb-blue); animation: pulse 2s ease-in-out infinite;"></i>
                            <p class="mb-2" style="font-weight: 700; color: var(--mlb-blue); font-size: 1.1rem;">{% trans "Click to upload document" %}</p>
                        {% endif %}
                        <small class="text-muted d-block mt-2" style="font-size: 0.9rem;">{% trans "PDF, JPG, PNG (max. 10MB)" %}</small>
                        <small class="text-muted d-block mt-1" style="font-size: 0.85rem;">{% trans "Birth certificate, passport or ID (original or digital)" %}</small>
                    </div>
                    {{ form.age_verification_document }}
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, rgba(13, 44, 84, 0.05) 0%, rgba(213, 0, 50, 0.05) 100%); z-index: 1; pointer-events: none;"></div>
                </div>
                {% if form.age_verification_document.help_text %}
                    <div class="alert alert-info mt-3 mb-0" style="background: #e7f3ff; border-left: 4px solid var(--mlb-blue); border-radius: 6px; padding: 12px;">
                        <small style="display: flex; align-items: center;">
                            <i class="fas fa-info-circle me-2" style="color: var(--mlb-blue);"></i>
                            <span>{{ form.age_verification_document.help_text }}</span>
                        </small>
                    </div>
                {% endif %}
                {% if form.age_verification_document.errors %}
                    <div class="alert alert-danger mt-3 mb-0" style="border-left: 4px solid var(--mlb-red); border-radius: 6px; padding: 12px;">
                        <small style="display: flex; align-items: center;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span>{{ form.age_verification_document.errors }}</span>
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Tallas de Uniformes -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-tshirt me-2" style="color: var(--mlb-red);"></i>{% trans "Uniform Sizes" %}
            </h5>
            <div class="alert alert-warning border mb-3 alert-persistent" style="background: #fff3cd; border-color: #ffc107 !important;">
                <small>
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <strong>{% trans "Required:" %}</strong> {% trans "All uniform sizes are required. Please select the appropriate sizes for each item." %}
                </small>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.jersey_size.id_for_label }}" class="form-label required-field">
                        {% trans "Jersey Size" %} *
                    </label>
                    {{ form.jersey_size }}
                    {% if form.jersey_size.errors %}
                        <div class="error-message mt-1">{{ form.jersey_size.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.hat_size.id_for_label }}" class="form-label required-field">
                        {% trans "Hat Size" %} *
                    </label>
                    {{ form.hat_size }}
                    {% if form.hat_size.errors %}
                        <div class="error-message mt-1">{{ form.hat_size.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.batting_glove_size.id_for_label }}" class="form-label required-field">
                        {% trans "Batting Glove Size" %} *
                    </label>
                    {{ form.batting_glove_size }}
                    {% if form.batting_glove_size.errors %}
                        <div class="error-message mt-1">{{ form.batting_glove_size.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.batting_helmet_size.id_for_label }}" class="form-label required-field">
                        {% trans "Batting Helmet Size" %} *
                    </label>
                    {{ form.batting_helmet_size }}
                    {% if form.batting_helmet_size.errors %}
                        <div class="error-message mt-1">{{ form.batting_helmet_size.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.shorts_size.id_for_label }}" class="form-label required-field">
                        {% trans "Pants Size" %} *
                    </label>
                    {{ form.shorts_size }}
                    {% if form.shorts_size.errors %}
                        <div class="error-message mt-1">{{ form.shorts_size.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Contacto de Emergencia -->
        <div class="form-section mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <h5 class="mb-3" style="color: var(--mlb-blue); font-weight: 600; font-size: 1.1rem;">
                <i class="fas fa-phone-alt me-2" style="color: var(--mlb-red);"></i>{% trans "Emergency Contact" %}
            </h5>
            <div class="alert alert-light border mb-3 alert-persistent" style="background: #f8f9fa; border-color: #dee2e6 !important;">
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Information used only in case of medical emergency." %}
                </small>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label required-field">
                        {% trans "Contact Name" %} *
                    </label>
                    {{ form.emergency_contact_name }}
                    {% if form.emergency_contact_name.errors %}
                        <div class="error-message mt-1">{{ form.emergency_contact_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.emergency_contact_phone.id_for_label }}" class="form-label required-field">
                        {% trans "Emergency Phone" %} *
                    </label>
                    {{ form.emergency_contact_phone }}
                    {% if form.emergency_contact_phone.errors %}
                        <div class="error-message mt-1">{{ form.emergency_contact_phone.errors }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">{% trans "24/7 available number" %}</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.emergency_contact_relation.id_for_label }}" class="form-label required-field">
                        {% trans "Relationship with Player" %} *
                    </label>
                    {{ form.emergency_contact_relation }}
                    {% if form.emergency_contact_relation.errors %}
                        <div class="error-message mt-1">{{ form.emergency_contact_relation.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.medical_conditions.id_for_label }}" class="form-label required-field">
                    {% trans "Medical Conditions" %} *
                </label>
                {{ form.medical_conditions }}
                {% if form.medical_conditions.errors %}
                    <div class="error-message mt-1">{{ form.medical_conditions.errors }}</div>
                {% endif %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Allergies, asthma, medications, etc. If there are no conditions, write \"None\"." %}
                </small>
            </div>
        </div>

        <!-- Botones de AcciÃ³n -->
        <div class="form-actions mb-4" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #e9ecef;">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'accounts:panel' %}" class="btn btn-form-cancel">
                    <i class="fas fa-times me-2"></i>{% trans "Cancel" %}
                </a>
                <button type="submit" class="btn btn-form-submit" id="btnSubmitPlayerEdit">
                    <span class="button-text">
                        <i class="fas fa-save me-2"></i>{% trans "Save Changes" %}
                    </span>
                    <span class="button-spinner" style="display: none;">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        {% trans "Saving..." %}
                    </span>
                </button>
            </div>
        </div>
    </form>
</div>

<style>
@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.file-upload-area input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 3;
}
</style>

<script>
console.log('ðŸ”„ PLAYER EDIT HIJO SCRIPT v3.0 - CARGADO');
(function() {
    // FunciÃ³n que se ejecuta inmediatamente, sin esperar DOMContentLoaded
    // Esto asegura que funcione tanto cuando se carga la pÃ¡gina completa como cuando se carga vÃ­a AJAX
    function initPlayerEditForm() {
        console.log('âœ… Inicializando formulario de ediciÃ³n de hijo v3.0');

        // Asegurar que is_pitcher siempre se envÃ­e en el formulario
        // Si el checkbox no estÃ¡ marcado, agregar un hidden antes de enviar
        const isPitcherCheckbox = document.getElementById('{{ form.is_pitcher.id_for_label }}');
        const playerEditForm = document.getElementById('playerEditForm');

        if (isPitcherCheckbox && playerEditForm) {
            // Verificar si ya tiene un listener (usando una marca)
            if (playerEditForm.dataset.pitcherListenerAdded === 'true') {
                console.log('Listener de is_pitcher ya agregado, omitiendo...');
                return;
            }

            // FunciÃ³n para preparar los campos antes del submit
            function prepareFormFields() {
                console.log('ðŸŸ¢ === PREPARANDO CAMPOS DEL FORMULARIO ===');
                console.log('ðŸŸ¢ Formulario:', playerEditForm);
                console.log('ðŸŸ¢ isPitcherCheckbox:', isPitcherCheckbox);
                console.log('ðŸŸ¢ is_pitcher checkbox checked:', isPitcherCheckbox ? isPitcherCheckbox.checked : 'N/A');

                // Verificar que secondary_position estÃ© presente
                const secondaryPositionField = playerEditForm.querySelector('[name="secondary_position"]');
                if (secondaryPositionField) {
                    console.log('âœ… secondary_position encontrado:', secondaryPositionField.value);
                } else {
                    console.warn('âš ï¸ secondary_position NO encontrado en el formulario');
                }

                // Asegurar que is_pitcher siempre se envÃ­e correctamente
                // Remover cualquier hidden anterior
                const existingHidden = playerEditForm.querySelector('input[name="is_pitcher"][type="hidden"]');
                if (existingHidden) {
                    existingHidden.remove();
                }

                // Si el checkbox no estÃ¡ marcado, agregar un campo hidden para asegurar que se envÃ­e False
                // Django necesita recibir explÃ­citamente el valor, incluso si es False
                if (!isPitcherCheckbox.checked) {
                    // Crear un nuevo hidden con valor 'False' (Django lo interpretarÃ¡ como False)
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'is_pitcher';
                    hiddenInput.value = 'False'; // Valor explÃ­cito para que Django lo interprete como False
                    playerEditForm.appendChild(hiddenInput);
                    console.log('âœ… is_pitcher checkbox no marcado - agregado hidden con valor False');
                } else {
                    console.log('âœ… is_pitcher checkbox marcado - valor serÃ¡ True');
                }

                // Asegurar que secondary_position siempre tenga un valor (incluso si estÃ¡ vacÃ­o)
                if (secondaryPositionField) {
                    // El campo siempre se enviarÃ¡, incluso si estÃ¡ vacÃ­o (Django lo manejarÃ¡ correctamente)
                    if (secondaryPositionField.value) {
                        console.log('âœ… secondary_position tiene valor:', secondaryPositionField.value);
                    } else {
                        console.log('âœ… secondary_position vacÃ­o - se enviarÃ¡ como cadena vacÃ­a');
                    }
                } else {
                    console.warn('âš ï¸ secondary_position NO encontrado en el formulario');
                }

                // Verificar todos los campos antes de enviar
                const formData = new FormData(playerEditForm);
                console.log('=== CAMPOS DEL FORMULARIO ===');
                for (let [key, value] of formData.entries()) {
                    if (key === 'secondary_position' || key === 'is_pitcher' || key === 'email' || key === 'team') {
                        console.log(`âœ… ${key}:`, value);
                    }
                }
            }

            // SIEMPRE exponer la funciÃ³n globalmente para que el panel pueda usarla
            window.preparePlayerEditFormFields = prepareFormFields;
            console.log('âœ… FunciÃ³n prepareFormFields expuesta globalmente v3.0');
            console.log('âœ… window.preparePlayerEditFormFields:', typeof window.preparePlayerEditFormFields);
            console.log('âœ… TEST - Ejecutando prepareFormFields ahora...');
            // Ejecutar una vez para verificar
            if (typeof window.preparePlayerEditFormFields === 'function') {
                console.log('âœ…âœ…âœ… preparePlayerEditFormFields ES UNA FUNCIÃ“N Y ESTÃ DISPONIBLE');
            }

            // Verificar si estamos en el panel (cuando se carga vÃ­a AJAX)
            // Si el formulario tiene el atributo data-submit-listener-added, significa que el panel ya maneja el submit
            const isInPanel = playerEditForm.hasAttribute('data-submit-listener-added') ||
                                document.getElementById('tab-content-editar-jugador') !== null;

            console.log('âœ… isInPanel:', isInPanel);
            console.log('âœ… tab-content-editar-jugador:', document.getElementById('tab-content-editar-jugador'));

            if (!isInPanel) {
                // Si NO estÃ¡ en el panel, agregar listener normal
                // Marcar que el listener fue agregado
                playerEditForm.dataset.pitcherListenerAdded = 'true';

                playerEditForm.addEventListener('submit', function(e) {
                    prepareFormFields();
                    // No prevenir el submit aquÃ­, dejar que se envÃ­e normalmente
                });
                console.log('âœ… Listener de submit agregado al formulario (NO estÃ¡ en panel)');
            } else {
                console.log('âœ… Formulario en panel detectado - el panel manejarÃ¡ el submit');
            }
        }
    }

    // Ejecutar inmediatamente
    initPlayerEditForm();

    // TambiÃ©n ejecutar cuando el DOM estÃ© listo (por si se carga la pÃ¡gina completa)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPlayerEditForm);
    }

    // TambiÃ©n ejecutar despuÃ©s de un pequeÃ±o delay para asegurar que funcione con AJAX
    setTimeout(initPlayerEditForm, 100);
    setTimeout(initPlayerEditForm, 500);
})();

// FunciÃ³n global para inicializar el campo de foto de perfil
window.initProfilePictureUpload = function() {
    console.log('ðŸ”„ Inicializando campo de foto de perfil...');

    const profilePictureInput = document.getElementById('id_profile_picture');
    const profilePictureUploadArea = document.getElementById('profilePictureUploadArea');

    console.log('ðŸŽ¨ Profile Picture Input:', profilePictureInput);
    console.log('ðŸŽ¨ Profile Picture Upload Area:', profilePictureUploadArea);

    if (profilePictureInput && profilePictureUploadArea) {
        console.log('âœ… Ambos elementos encontrados, configurando event listeners');

        // Limpiar listeners previos si existen
        const newUploadArea = profilePictureUploadArea.cloneNode(true);
        profilePictureUploadArea.parentNode.replaceChild(newUploadArea, profilePictureUploadArea);
        const uploadArea = document.getElementById('profilePictureUploadArea');

        // Hacer clic en el Ã¡rea activa el input de archivo
        // Usar capturing phase para capturar el evento antes que los hijos
        uploadArea.addEventListener('click', function(e) {
            console.log('ðŸ–±ï¸ Upload area clicked!');
            e.preventDefault();
            e.stopPropagation();

            // Verificar que el input estÃ© habilitado
            if (profilePictureInput.disabled) {
                console.warn('âš ï¸ Input estÃ¡ deshabilitado');
                return;
            }

            console.log('ðŸš€ Triggering file input click');
            profilePictureInput.click();
        }, true); // true = usar capturing phase

        console.log('âœ… Event listener agregado');

            // Preview de la imagen seleccionada
            profilePictureInput.addEventListener('change', function(e) {
                console.log('ðŸ“¸ Archivo seleccionado');
                const file = e.target.files[0];
                if (file) {
                    console.log('ðŸ“„ Archivo:', file.name, file.type, file.size);

                    // Validar tamaÃ±o (5MB mÃ¡ximo)
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxSize) {
                        alert('{% trans "The file is too large. Maximum size is 5MB." %}');
                        profilePictureInput.value = '';
                        return;
                    }

                    // Validar tipo de archivo
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                    if (!allowedTypes.includes(file.type)) {
                        alert('{% trans "Invalid file type. Only JPG, PNG and GIF are allowed." %}');
                        profilePictureInput.value = '';
                        return;
                    }

                    // Mostrar preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePictureUploadArea.innerHTML = `
                            <div style="position: relative;">
                                <img src="${e.target.result}" alt="Profile Picture Preview" style="max-width: 200px; max-height: 200px; border-radius: 12px; object-fit: cover; margin-bottom: 15px;">
                                <div>
                                    <i class="fas fa-check-circle fa-2x mb-2" style="color: #28a745;"></i>
                                    <p class="mb-1" style="font-weight: 600; color: var(--mlb-blue);">
                                        {% trans "Photo Selected" %}
                                    </p>
                                    <small class="text-success">${file.name} (${(file.size / 1024).toFixed(2)} KB)</small>
                                    <br>
                                    <small class="text-muted">{% trans "Click to change photo" %}</small>
                                </div>
                            </div>
                        `;
                        profilePictureUploadArea.style.borderColor = '#28a745';
                        profilePictureUploadArea.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                    };
                    reader.readAsDataURL(file);
                }
            });

        // Hover effect
        uploadArea.addEventListener('mouseenter', function() {
            this.style.borderColor = 'var(--mlb-red)';
            this.style.transform = 'scale(1.02)';
        });

        uploadArea.addEventListener('mouseleave', function() {
            if (!profilePictureInput.files.length) {
                this.style.borderColor = '#0d2c54';
            }
            this.style.transform = 'scale(1)';
        });
    } else {
        console.error('âŒ No se encontraron los elementos:', {
            input: profilePictureInput,
            area: profilePictureUploadArea
        });
    }
};

// Ejecutar cuando el DOM estÃ© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Formulario de ediciÃ³n de hijo cargado');
    // Intentar inicializar inmediatamente
    setTimeout(window.initProfilePictureUpload, 100);
});

    // Traducciones para evitar problemas con tags de traducciÃ³n dentro de template literals
    const fileUploadTranslations = {
        documentUploaded: "{% trans 'Document Uploaded' %}",
        clickToChangeFile: "{% trans 'Click to change file' %}",
        fileTooLarge: "{% trans 'The file is too large. Maximum allowed size is 10MB.' %}",
        fileTypeNotAllowed: "{% trans 'File type not allowed. Only PDF, JPG or PNG are accepted.' %}"
    };

    // Mejorar el Ã¡rea de carga de archivos
    const fileInput = document.querySelector('#playerEditForm input[type="file"][name*="age_verification"]');
    const fileUploadArea = document.getElementById('ageVerificationUploadArea');

    if (fileInput && fileUploadArea) {
        // Asegurar que el campo no sea requerido
        fileInput.removeAttribute('required');
        fileInput.required = false;

        fileUploadArea.addEventListener('click', function(e) {
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileName = file.name;
                const fileSize = (file.size / 1024 / 1024).toFixed(2);

                // Validar tamaÃ±o (mÃ¡x 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(fileUploadTranslations.fileTooLarge);
                    fileInput.value = '';
                    return;
                }

                // Validar tipo de archivo
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    alert(fileUploadTranslations.fileTypeNotAllowed);
                    fileInput.value = '';
                    return;
                }

                // Actualizar el Ã¡rea con el archivo cargado
                const contentDiv = fileUploadArea.querySelector('div[style*="position: relative"]');
                if (contentDiv) {
                    contentDiv.innerHTML = `
                        <i class="fas fa-check-circle fa-3x mb-3" style="color: #28a745; animation: none;"></i>
                        <p class="mb-2" style="font-weight: 700; color: #28a745; font-size: 1.1rem;">
                            <i class="fas fa-file-check me-2"></i>${fileUploadTranslations.documentUploaded}
                        </p>
                        <p class="mb-1" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.95rem; word-break: break-word;">${fileName}</p>
                        <small class="text-muted d-block mt-2" style="font-size: 0.9rem;">${fileSize} MB</small>
                        <small class="text-success d-block mt-1" style="font-size: 0.85rem;">
                            <i class="fas fa-check me-1"></i>${fileUploadTranslations.clickToChangeFile}
                        </small>
                    `;
                }

                fileUploadArea.style.borderColor = '#28a745';
                fileUploadArea.style.borderWidth = '3px';
                fileUploadArea.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                fileUploadArea.style.boxShadow = '0 4px 12px rgba(40, 167, 69, 0.2)';
            }
        });
    }

    // Convert Django messages to toasts
    setTimeout(function() {
        if (window.adminDashboard) {
            window.adminDashboard.convertDjangoMessagesToToasts();
        }
    }, 100);

    // Filtros dinÃ¡micos de ubicaciÃ³n (Country -> State -> City)
    const countrySelect = document.getElementById('id_country');
    const stateSelect = document.getElementById('id_state');
    const citySelect = document.getElementById('id_city');

    if (countrySelect && stateSelect && citySelect) {
        // Guardar valores iniciales
        const initialCountry = countrySelect.value;
        const initialState = stateSelect.value;
        const initialCity = citySelect.value;

        function updateStates() {
            const countryId = countrySelect.value;
            const currentStateValue = stateSelect.value;

            // Limpiar estados y ciudades
            stateSelect.innerHTML = '<option value="">{% trans "Select a state" %}</option>';
            citySelect.innerHTML = '<option value="">{% trans "Select a city" %}</option>';

            if (countryId) {
                fetch(`/locations/ajax/states/${countryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state.id;
                            option.textContent = state.name;
                            if (currentStateValue == state.id) {
                                option.selected = true;
                            }
                            stateSelect.appendChild(option);
                        });
                        // Si habÃ­a un estado seleccionado, actualizar ciudades
                        if (currentStateValue) {
                            updateCities();
                        }
                    })
                    .catch(error => console.error('Error loading states:', error));
            }
        }

        function updateCities() {
            const stateId = stateSelect.value;
            const currentCityValue = citySelect.value;

            citySelect.innerHTML = '<option value="">{% trans "Select a city" %}</option>';

            if (stateId) {
                fetch(`/locations/ajax/cities/${stateId}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.id;
                            option.textContent = city.name;
                            if (currentCityValue == city.id) {
                                option.selected = true;
                            }
                            citySelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading cities:', error));
            }
        }

        // Event listeners
        countrySelect.addEventListener('change', updateStates);
        stateSelect.addEventListener('change', updateCities);

        // Cargar datos iniciales si hay un paÃ­s seleccionado
        if (initialCountry) {
            updateStates();
        }
    }
});
</script>
{% endblock %}

