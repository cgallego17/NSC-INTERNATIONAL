{% load i18n %}
{% load static %}

<div class="profile-container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    <div class="row g-4">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="profile-sidebar" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 20px;">
                <div class="profile-sidebar-header mb-4">
                    <h5 class="mb-0" style="color: var(--mlb-blue); font-weight: 700;">
                        <i class="fas fa-user-circle me-2" style="color: var(--mlb-red);"></i>{% trans "Profile" %}
                    </h5>
                </div>
                <nav class="profile-sidebar-nav">
                    <button type="button"
                       class="profile-sidebar-item js-profile-section-btn active"
                       data-profile-section="profile"
                       style="display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; text-decoration: none; color: #495057; transition: all 0.3s; background: #f8f9fa; color: var(--mlb-blue); font-weight: 600; width: 100%; border: none; text-align: left;">
                        <i class="fas fa-user me-3" style="width: 20px; text-align: center;"></i>
                        <span>{% trans "Profile Information" %}</span>
                    </button>
                    <button type="button"
                       class="profile-sidebar-item js-profile-section-btn"
                       data-profile-section="billing"
                       style="display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; text-decoration: none; color: #495057; transition: all 0.3s; width: 100%; border: none; text-align: left; background: transparent;">
                        <i class="fas fa-credit-card me-3" style="width: 20px; text-align: center;"></i>
                        <span>{% trans "Billing" %}</span>
                    </button>
                    <button type="button"
                       class="profile-sidebar-item js-profile-section-btn"
                       data-profile-section="security"
                       style="display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; text-decoration: none; color: #495057; transition: all 0.3s; width: 100%; border: none; text-align: left; background: transparent;">
                        <i class="fas fa-shield-alt me-3" style="width: 20px; text-align: center;"></i>
                        <span>{% trans "Security" %}</span>
                    </button>
                    <button type="button"
                       class="profile-sidebar-item js-profile-section-btn"
                       data-profile-section="notifications"
                       style="display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; text-decoration: none; color: #495057; transition: all 0.3s; width: 100%; border: none; text-align: left; background: transparent;">
                        <i class="fas fa-bell me-3" style="width: 20px; text-align: center;"></i>
                        <span>{% trans "Notifications" %}</span>
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="profile-content" style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <div class="js-profile-section" data-profile-section="profile" style="display: block;">
                    {% include 'accounts/profile_sections/profile_info.html' %}
                </div>
                <div class="js-profile-section" data-profile-section="billing" style="display: none;">
                    {% include 'accounts/profile_sections/billing.html' %}
                </div>
                <div class="js-profile-section" data-profile-section="security" style="display: none;">
                    {% include 'accounts/profile_sections/security.html' %}
                </div>
                <div class="js-profile-section" data-profile-section="notifications" style="display: none;">
                    {% include 'accounts/profile_sections/notifications.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .profile-sidebar-item:hover {
        background: #f8f9fa !important;
        color: var(--mlb-blue) !important;
        transform: translateX(4px);
    }

    .profile-sidebar-item.active {
        border-left: 3px solid var(--mlb-red);
    }
</style>

<script>
    (function initProfileTabSidebar() {
        function activateProfileSection(sectionId) {
            const buttons = document.querySelectorAll('.js-profile-section-btn');
            const sections = document.querySelectorAll('.js-profile-section');

            buttons.forEach(btn => {
                const isActive = btn.getAttribute('data-profile-section') === sectionId;
                btn.classList.toggle('active', isActive);
                if (isActive) {
                    btn.style.background = '#f8f9fa';
                    btn.style.color = 'var(--mlb-blue)';
                    btn.style.fontWeight = '600';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = '#495057';
                    btn.style.fontWeight = '400';
                }
            });

            sections.forEach(sec => {
                sec.style.display = (sec.getAttribute('data-profile-section') === sectionId) ? 'block' : 'none';
            });
        }

        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.js-profile-section-btn');
            if (!btn) return;
            e.preventDefault();
            const sectionId = btn.getAttribute('data-profile-section') || 'profile';
            activateProfileSection(sectionId);
        });

        // Initialize from URL param or default
        const urlParams = new URLSearchParams(window.location.search);
        const sectionParam = urlParams.get('profile_section');
        if (sectionParam) {
            activateProfileSection(sectionParam);
        } else {
            activateProfileSection('profile');
        }

        // Location Selectors Logic (Reusable for Profile & Billing)
        function initLocationSelectors(prefix = '') {
            const countryId = `id_${prefix}country`;
            const stateId = `id_${prefix}state`;
            const cityId = `id_${prefix}city`;

            const countrySelect = document.getElementById(countryId);
            const stateSelect = document.getElementById(stateId);
            const citySelect = document.getElementById(cityId);

            if (!countrySelect || !stateSelect || !citySelect) return;

            function updateStates() {
                const cId = countrySelect.value;
                stateSelect.innerHTML = '<option value="">Select a state</option>';
                citySelect.innerHTML = '<option value="">Select a city</option>';

                if (!cId) return;

                stateSelect.disabled = true;
                citySelect.disabled = true;

                fetch(`/locations/ajax/states/${cId}/`)
                    .then(r => r.json())
                    .then(data => {
                        data.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state.id;
                            option.textContent = state.name;
                            stateSelect.appendChild(option);
                        });
                        // Restore previous selection if present (for edit forms)
                        if (stateSelect.dataset.value) {
                            stateSelect.value = stateSelect.dataset.value;
                            updateCities();
                        }
                    })
                    .catch(() => {})
                    .finally(() => {
                        stateSelect.disabled = false;
                        citySelect.disabled = false;
                    });
            }

            function updateCities() {
                const sId = stateSelect.value;
                citySelect.innerHTML = '<option value="">Select a city</option>';
                if (!sId) return;

                citySelect.disabled = true;
                fetch(`/locations/ajax/cities/${sId}/`)
                    .then(r => r.json())
                    .then(data => {
                        data.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.id;
                            option.textContent = city.name;
                            citySelect.appendChild(option);
                        });
                         if (citySelect.dataset.value) {
                            citySelect.value = citySelect.dataset.value;
                        }
                    })
                    .catch(() => {})
                    .finally(() => {
                        citySelect.disabled = false;
                    });
            }

            countrySelect.addEventListener('change', updateStates);
            stateSelect.addEventListener('change', updateCities);
        }

        // Initialize for both forms when DOM is ready
        initLocationSelectors('profile-');          // Profile Info (id_profile-country)
        initLocationSelectors('billing-');  // Billing (id_billing-country)

        // Profile Picture Preview
        const profilePicInput = document.getElementById('id_profile-profile_picture');
        if (profilePicInput) {
            profilePicInput.addEventListener('change', function(e) {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const container = document.querySelector('.current-profile-pic');
                        if (container) {
                            container.innerHTML = `<img src="${event.target.result}" alt="Profile Picture" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #e9ecef;">`;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

    })();
</script>

