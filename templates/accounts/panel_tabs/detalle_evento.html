{% load i18n %}
{% load static %}
{% load url_filters %}

<!-- Estilos responsive para móvil -->
<style>
    /* Estilos específicos para móvil - Detalle de Evento */
    @media (max-width: 768px) {
        /* Eliminar padding/margin del body y html en móvil */
        html, body {
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
        }

        /* Contenedor iframe-inner sin padding */
        .iframe-inner {
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Contenedor principal sin padding lateral */
        #event-details-section {
            padding-left: 0 !important;
            padding-right: 0 !important;
            width: 100% !important;
        }

        /* Header del evento - Más compacto */
        .tab-content-header {
            padding: 0 0 12px 0 !important;
            margin-bottom: 0 !important;
        }

        .tab-content-header h4 {
            font-size: 1.15rem !important;
            margin-bottom: 4px !important;
        }

        .tab-content-header p {
            font-size: 0.8rem !important;
            margin-bottom: 0 !important;
        }

        /* Row principal - Stack vertical con menos gap */
        .row.g-4 {
            flex-direction: column !important;
            gap: 12px !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Card de información del evento - Más compacta y más ancha */
        .col-lg-7 {
            width: 100% !important;
            padding: 0 !important;
            max-width: 100% !important;
        }

        .event-info-card {
            padding: 16px 8px !important;
            border-radius: 12px !important;
            margin-bottom: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Banner/Logo del evento - Más bajo */
        .event-info-card > div:first-child {
            height: 180px !important;
            margin-bottom: 16px !important;
            border-radius: 10px !important;
        }

        /* Título del evento - Más compacto */
        .event-info-card > .mb-4 {
            margin-bottom: 16px !important;
        }

        .event-info-card h2 {
            font-size: 1.35rem !important;
            margin-top: 6px !important;
            margin-bottom: 10px !important;
            line-height: 1.3 !important;
        }

        /* Línea separadora - Más delgada */
        .event-info-card [style*="height: 2px"][style*="background: linear-gradient"] {
            height: 1.5px !important;
            margin-bottom: 16px !important;
        }

        /* Sección de detalles - Más compacta */
        .event-details {
            margin-bottom: 16px !important;
        }

        .event-details h5 {
            font-size: 0.95rem !important;
            margin-bottom: 12px !important;
        }

        /* Grid de información - Stack vertical sin gaps grandes */
        .event-details .row.g-3 {
            flex-direction: column !important;
            gap: 0 !important;
            margin: 0 !important;
        }

        .event-details .col-md-6 {
            width: 100% !important;
            margin-bottom: 10px !important;
            padding: 0 !important;
        }

        /* Cards de información - Más compactas */
        .event-details [style*="display: flex"][style*="align-items: center"],
        .event-details [style*="display: flex"][style*="align-items: flex-start"] {
            padding: 10px 8px !important;
            gap: 10px !important;
            margin-bottom: 0 !important;
        }

        /* Divisions card - Optimizada para móvil */
        .event-details [style*="width: 44px"][style*="height: 44px"] {
            width: 36px !important;
            height: 36px !important;
        }

        .event-details [style*="width: 44px"][style*="height: 44px"] i {
            font-size: 0.95rem !important;
        }

        /* Acordeón de divisiones - Estilos base */
        .divisions-title-desktop {
            display: block !important;
        }

        .divisions-toggle-btn {
            display: none !important;
        }

        .divisions-card .divisions-content {
            display: flex !important;
        }

        /* Divisiones extra: se muestra/oculta con <details> (sin JS) */
        .divisions-extra {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 6px !important;
            align-items: center !important;
            width: 100% !important;
            margin-top: 6px !important;
        }

        /* Botón Show more */
        .divisions-show-more-btn {
            transition: all 0.2s !important;
            display: inline-flex !important;
            visibility: visible !important;
            pointer-events: auto !important;
            z-index: 10 !important;
            position: relative !important;
            opacity: 1 !important;
        }

        .divisions-show-more-btn:hover {
            background: var(--mlb-red) !important;
            color: white !important;
            transform: translateY(-1px) !important;
        }

        /* details toggle */
        .divisions-more {
            width: 100% !important;
        }

        .divisions-more > summary.divisions-show-more-btn {
            list-style: none;
        }

        .divisions-more > summary.divisions-show-more-btn::-webkit-details-marker {
            display: none;
        }

        .divisions-more[open] .divisions-show-more-chevron {
            transform: rotate(180deg) !important;
        }

        .divisions-show-more-text--less { display: none; }
        .divisions-more[open] .divisions-show-more-text--more { display: none; }
        .divisions-more[open] .divisions-show-more-text--less { display: inline; }

        /* Asegurar que el contenedor de divisiones permita clics en PC */
        @media (min-width: 769px) {
            .divisions-card .divisions-content {
                pointer-events: auto !important;
                opacity: 1 !important;
            }
        }

        /* En móvil: mostrar acordeón */
        @media (max-width: 768px) {
            .divisions-title-desktop {
                display: none !important;
            }

            .divisions-toggle-btn {
                display: block !important;
            }

            .divisions-card .divisions-content {
                max-height: 0 !important;
                overflow: hidden !important;
                opacity: 0 !important;
                transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding-top 0.3s ease-out !important;
                padding-top: 0 !important;
                display: flex !important;
                flex-wrap: wrap !important;
            }

            .divisions-card.active .divisions-content {
                max-height: 500px !important;
                opacity: 1 !important;
                padding-top: 8px !important;
            }

            /* En móvil, cuando el acordeón está activo, mostrar todas las divisiones */
            /* En móvil el acordeón controla el alto; mostramos extra pero ocultamos el summary */
            .divisions-more > summary.divisions-show-more-btn { display: none !important; }
            .divisions-extra { margin-top: 6px !important; }

            /* Ocultar botón "Show more" en móvil */
            .divisions-show-more-btn {
                display: none !important;
            }

            .divisions-card.active .divisions-chevron {
                transform: rotate(180deg) !important;
            }

            .divisions-count {
                color: var(--mlb-red) !important;
                font-weight: 800 !important;
            }

            .divisions-toggle-btn:hover {
                opacity: 0.8 !important;
            }

            .divisions-toggle-btn:active {
                opacity: 0.6 !important;
            }
        }

        /* Badges de divisiones - Más compactos en móvil */
        .event-details [style*="display: inline-flex"][style*="align-items: center"] {
            padding: 5px 10px !important;
            font-size: 0.7rem !important;
            border-radius: 16px !important;
        }

        .event-details [style*="display: inline-flex"] i {
            font-size: 0.6rem !important;
            margin-right: 4px !important;
        }

        .event-details [style*="width: 40px"][style*="height: 40px"] {
            width: 32px !important;
            height: 32px !important;
        }

        .event-details [style*="width: 60px"][style*="height: 60px"] {
            width: 45px !important;
            height: 45px !important;
        }

        .event-details [style*="width: 40px"][style*="height: 40px"] i,
        .event-details [style*="width: 60px"][style*="height: 60px"] i {
            font-size: 0.85rem !important;
        }

        /* Texto en cards - Más pequeño */
        .event-details [style*="font-size: 0.75rem"] {
            font-size: 0.65rem !important;
        }

        .event-details [style*="font-weight: 600"][style*="color: var(--mlb-blue)"] {
            font-size: 0.85rem !important;
        }

        /* Video del evento - Más compacto */
        .event-info-card .mb-4[style*="margin-top: 30px"] {
            margin-top: 16px !important;
            margin-bottom: 16px !important;
        }

        #event-video-container {
            padding-bottom: 56.25% !important;
            border-radius: 10px !important;
            margin-bottom: 0 !important;
        }

        .event-info-card .mb-4 h5 {
            font-size: 0.95rem !important;
            margin-bottom: 12px !important;
        }

        /* Columna derecha - Stack vertical */
        .col-lg-5 {
            width: 100% !important;
            padding: 0 !important;
        }

        /* Cards de acción - Más compactas */
        [style*="background: white"][style*="border-radius: 16px"][style*="padding: 30px"] {
            padding: 16px 12px !important;
            border-radius: 12px !important;
        }

        /* Botones - Full width en móvil */
        .btn-lg,
        .btn {
            width: 100% !important;
            padding: 12px 18px !important;
            font-size: 0.9rem !important;
            margin-bottom: 8px !important;
        }

        /* Formularios */
        .form-control,
        .form-select {
            font-size: 16px !important; /* Evita zoom en iOS */
            padding: 10px 12px !important;
        }

        /* Alerts - Más compactos */
        .alert {
            padding: 10px 12px !important;
            font-size: 0.8rem !important;
            border-radius: 8px !important;
            margin-bottom: 12px !important;
        }

        /* Listas y elementos */
        ul, ol {
            padding-left: 18px !important;
            margin-bottom: 12px !important;
        }

        /* Espaciado general - Reducido */
        .mb-4 {
            margin-bottom: 16px !important;
        }

        .mb-3 {
            margin-bottom: 12px !important;
        }

        .mb-2 {
            margin-bottom: 8px !important;
        }

        /* Checkout Card - Más compacta */
        .checkout-card {
            position: relative !important;
            top: 0 !important;
            padding: 16px 12px !important;
            border-radius: 12px !important;
        }

        .checkout-card h4 {
            font-size: 1rem !important;
            margin-bottom: 12px !important;
            padding-bottom: 8px !important;
        }

        /* Pasos del checkout - Más compactos */
        .checkout-step {
            margin-bottom: 16px !important;
        }

        .checkout-step h5 {
            font-size: 0.85rem !important;
            margin-bottom: 8px !important;
        }

        .checkout-step h5 span {
            width: 20px !important;
            height: 20px !important;
            font-size: 0.65rem !important;
        }

        /* Items de niños/jugadores - Más compactos */
        .children-list {
            margin-top: 8px !important;
        }

        .child-item {
            padding: 10px !important;
            margin-bottom: 8px !important;
        }

        .child-item [style*="width: 40px"][style*="height: 40px"] {
            width: 32px !important;
            height: 32px !important;
        }

        .child-item [style*="font-weight: 700"][style*="color: var(--mlb-blue)"] {
            font-size: 0.8rem !important;
        }

        .child-item [style*="font-size: 0.75rem"] {
            font-size: 0.7rem !important;
        }

        .child-price {
            font-size: 0.85rem !important;
        }

        /* Botón Add Hotel Stay - Más compacto */
        #add-hotel-stay-btn {
            padding: 10px 14px !important;
            font-size: 0.85rem !important;
            min-height: 44px !important;
        }

        [style*="background: linear-gradient"][style*="border: 2px solid"][style*="padding: 12px"] {
            padding: 10px !important;
        }

        [style*="font-size: 0.8rem"][style*="color: #6c757d"][style*="font-weight: 600"] {
            font-size: 0.75rem !important;
            margin-bottom: 8px !important;
        }

        /* Resumen del checkout - Más compacto */
        .checkout-summary {
            padding-top: 12px !important;
            margin-top: 12px !important;
        }

        .checkout-summary h5 {
            font-size: 0.9rem !important;
            margin-bottom: 10px !important;
        }

        /* Items del resumen - Más compactos */
        #checkout-players-summary,
        #checkout-hotel-summary {
            margin-bottom: 10px !important;
        }

        #checkout-players-summary [style*="padding: 15px"],
        #checkout-hotel-summary [style*="padding: 12px"] {
            padding: 10px !important;
        }

        #checkout-players-summary [style*="font-size: 1rem"],
        #checkout-hotel-summary [style*="font-size: 0.95rem"] {
            font-size: 0.85rem !important;
        }

        #checkout-players-summary [style*="font-size: 0.75rem"],
        #checkout-hotel-summary [style*="font-size: 0.75rem"] {
            font-size: 0.7rem !important;
        }

        /* Total del checkout */
        #checkout-total {
            font-size: 1.2rem !important;
        }

        /* Botón de checkout */
        #checkout-button {
            width: 100% !important;
            padding: 12px 18px !important;
            font-size: 0.95rem !important;
            min-height: 48px !important;
            margin-top: 12px !important;
        }

        /* Descripción del evento */
        [style*="color: #6c757d"][style*="line-height: 1.6"] {
            font-size: 0.85rem !important;
            line-height: 1.4 !important;
        }

        /* Tablas - Scroll horizontal si es necesario */
        .table-responsive {
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch !important;
        }

        /* Badges y tags - Más pequeños */
        [style*="background: var(--mlb-red)"][style*="color: white"][style*="padding: 2px 8px"] {
            font-size: 0.6rem !important;
            padding: 2px 5px !important;
            margin-right: 3px !important;
            margin-top: 2px !important;
        }

        /* Reducir todos los márgenes superiores grandes */
        [style*="margin-top: 30px"],
        [style*="margin-top: 25px"] {
            margin-top: 12px !important;
        }

        /* Reducir padding en secciones */
        [style*="padding: 20px"] {
            padding: 16px 12px !important;
        }

        /* Eliminar márgenes inferiores excesivos al final */
        .row.g-4:last-child,
        .event-info-card:last-child,
        .checkout-card:last-child {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Contenedor principal - Usar toda la altura */
        #event-details-section {
            margin-bottom: 12px !important;
        }

        .row.g-4 {
            min-height: auto !important;
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }

        /* Eliminar altura mínima del row principal */
        .row.g-4[style*="min-height: 400px"] {
            min-height: auto !important;
        }

        /* Eliminar padding/margin del último elemento */
        .event-info-card > *:last-child,
        .checkout-card > *:last-child {
            margin-bottom: 0 !important;
        }

        /* Línea separadora - Más delgada y menos espacio */
        [style*="height: 2px"][style*="background: linear-gradient"] {
            margin-top: 12px !important;
            margin-bottom: 12px !important;
        }

        /* Eliminar espacios en secciones vacías */
        .mb-4:empty,
        .mb-3:empty {
            display: none !important;
        }

        /* Optimizar el contenedor del video */
        #event-video-container {
            margin-bottom: 0 !important;
        }

        /* Reducir espacio después del video */
        .event-info-card .mb-4:has(#event-video-container) {
            margin-bottom: 12px !important;
        }

        /* Footer/última sección sin margen */
        .event-info-card > div:last-child,
        .col-lg-5 > div:last-child {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Asegurar que no haya padding extra al final */
        body .tab-content-detalle-eventos,
        .tab-content-detalle-eventos > *:last-child {
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }

        /* Reducir espacio entre columnas cuando están apiladas */
        .col-lg-7,
        .col-lg-5 {
            margin-bottom: 0 !important;
        }

        /* Optimizar cards de información - Sin márgenes finales */
        .event-details .col-md-6:last-child {
            margin-bottom: 0 !important;
        }

        /* Reducir espacio en el checkout summary */
        .checkout-summary {
            padding-bottom: 0 !important;
        }

        /* Botón final sin margen inferior */
        #checkout-button {
            margin-bottom: 0 !important;
        }

        /* Eliminar padding del contenedor principal */
        #event-details-section + * {
            margin-top: 0 !important;
        }

        /* Optimizar último elemento de cada sección */
        .event-info-card > *:last-child,
        .checkout-card > *:last-child,
        .row.g-4 > *:last-child {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Eliminar espacios en elementos vacíos o con solo espacios */
        .mb-4:empty,
        .mb-3:empty,
        .mb-2:empty {
            display: none !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Reducir altura mínima del row principal */
        .row.g-4[style*="min-height"] {
            min-height: auto !important;
        }

        /* Asegurar que no haya padding extra en el último elemento del documento */
        body > *:last-child,
        .iframe-inner > *:last-child {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Optimizar sección de checkout - Sin espacios finales */
        .checkout-card .checkout-summary:last-child {
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }

        /* Reducir espacio después de la última línea separadora */
        .event-info-card [style*="height: 2px"]:last-of-type {
            margin-bottom: 12px !important;
        }

        /* Eliminar espacio después del video si es el último elemento */
        #event-video-container:last-child,
        .event-info-card > #event-video-container {
            margin-bottom: 0 !important;
        }

        /* Optimizar botones de pago - Más compactos */
        #pay-plan-btn,
        #pay-now-btn {
            padding: 10px 12px !important;
            margin-bottom: 8px !important;
        }

        #pay-plan-btn > div:first-child,
        #pay-now-btn > div:first-child {
            margin-bottom: 4px !important;
        }

        #pay-now-subtext,
        #plan-subtext {
            margin-top: 2px !important;
            font-size: 0.75rem !important;
            line-height: 1.2 !important;
        }

        #pay-now-btn > div:last-child,
        #pay-plan-btn > div:last-child {
            margin-top: 2px !important;
            font-size: 0.7rem !important;
        }

        /* Reducir espacio en el checkout summary */
        .checkout-summary {
            padding-top: 16px !important;
            margin-top: 16px !important;
        }

        .checkout-summary h5 {
            margin-bottom: 12px !important;
        }

        /* Reducir espacio en items del checkout */
        #checkout-items-list {
            margin-bottom: 12px !important;
            min-height: auto !important;
        }

        #checkout-players-summary,
        #checkout-hotel-summary {
            margin-bottom: 10px !important;
        }

        /* Reducir espacio en el total */
        [style*="border-top: 2px solid"][style*="padding-top: 15px"] {
            padding-top: 12px !important;
            margin-top: 12px !important;
        }

        /* Reducir espacio en el formulario de checkout */
        #eventRegistrationForm {
            margin-top: 12px !important;
        }

        /* Eliminar espacio después del último elemento del checkout */
        .checkout-card > *:last-child {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Alert al final sin margen */
        .alert-persistent {
            margin-top: 12px !important;
            margin-bottom: 0 !important;
            padding: 16px 12px !important;
        }

        .alert-persistent .fa-2x {
            font-size: 1.5rem !important;
            margin-bottom: 10px !important;
        }

        .alert-persistent p {
            margin-bottom: 8px !important;
        }

        .alert-persistent .btn {
            margin-top: 10px !important;
            padding: 8px 16px !important;
        }

        /* Asegurar que el checkout card no tenga padding inferior extra */
        .checkout-card {
            padding-bottom: 12px !important;
        }
    }
</style>

<!-- DEBUG: Verificar que la plantilla se está cargando -->
<!-- Event object: {{ event|default:"NO EVENT" }} -->
<!-- Active tab: {{ active_tab|default:"NO ACTIVE TAB" }} -->

<div class="tab-content-header mb-4" id="event-details-section" style="display: block !important; visibility: visible !important; opacity: 1 !important; width: 100% !important; position: relative !important; z-index: 1 !important;">
    <h4 style="color: var(--mlb-blue); font-weight: 800; font-size: 1.5rem; margin-bottom: 10px;">
        <i class="fas fa-calendar-check me-2" style="color: var(--mlb-red);"></i>{% trans "Event Details" %}
    </h4>
    <p class="text-muted">{% trans "Event information and registration" %}</p>
</div>

{% if event %}
<!-- DEBUG: Event encontrado, renderizando contenido del evento -->
<!-- Event ID: {{ event.pk }}, Title: {{ event.title }} -->
    <div class="row g-4" style="width: 100% !important; display: flex !important; flex-wrap: wrap !important; min-height: 400px !important; position: relative !important; z-index: 1 !important;">
        <!-- Lado Izquierdo - Información del Evento -->
        <div class="col-lg-7">
            <div class="event-info-card" style="background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <!-- Banner del Evento -->
                {% if event.banner %}
                    <div style="width: 100%; height: 300px; border-radius: 12px; overflow: hidden; margin-bottom: 25px;">
                        <img src="{{ event.banner|clean_localhost_url }}" alt="{{ event.title }}" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
                    </div>
                {% elif event.logo %}
                    <div style="width: 100%; height: 300px; border-radius: 12px; overflow: hidden; margin-bottom: 25px;">
                        <img src="{{ event.logo|clean_localhost_url }}" alt="{{ event.title }}" style="width: 100%; height: 100%; object-fit: contain; object-position: center; background: #f8f9fa;">
                    </div>
                {% endif %}

                <!-- Título y Categoría -->
                <div class="mb-4">
                    {% if event.category %}
                        <span style="color: var(--mlb-red); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            {{ event.category.name }}
                        </span>
                    {% endif %}
                    <h2 style="color: var(--mlb-blue); font-weight: 800; font-size: 2rem; margin-top: 10px; margin-bottom: 15px;">
                        {{ event.title }}
                    </h2>
                    {% if event.event_type %}
                        <p style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0;">
                            <i class="fas fa-tag me-2" style="color: var(--mlb-red);"></i>{{ event.event_type.name }}
                        </p>
                    {% endif %}
                </div>

                <!-- Línea separadora -->
                <div style="width: 100%; height: 2px; background: linear-gradient(90deg, var(--mlb-red) 0%, #b30029 100%); margin-bottom: 25px; border-radius: 2px;"></div>

                <!-- Información del Evento -->
                <div class="event-details mb-4">
                    <h5 style="color: var(--mlb-blue); font-weight: 700; margin-bottom: 20px;">
                        <i class="fas fa-calendar-alt me-2" style="color: var(--mlb-red);"></i>{% trans "Event Information" %}
                    </h5>
                    <div class="row g-3">
                        <!-- Columna Izquierda -->
                        <div class="col-md-6">
                            <div class="d-flex flex-column" style="gap: 12px;">
                        <!-- Fecha -->
                        {% if event.start_date %}
                                    <div>
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="fas fa-calendar" style="color: white; font-size: 1rem;"></i>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">{% trans "Start Date" %}</div>
                                        <div style="font-weight: 600; color: var(--mlb-blue);">{{ event.start_date|date:"F d, Y" }}</div>
                                        {% if event.end_date and event.end_date != event.start_date %}
                                            <div style="font-size: 0.75rem; color: #6c757d; margin-top: 2px;">{% trans "End Date" %}: {{ event.end_date|date:"F d, Y" }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                                <!-- Divisiones -->
                                {% if event.divisions.exists %}
                                    <div>
                                        <div class="divisions-card" style="display: flex; align-items: flex-start; gap: 12px; padding: 14px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 2px solid #e9ecef; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                            <div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 8px rgba(213, 0, 50, 0.2);">
                                                <i class="fas fa-users" style="color: white; font-size: 1.1rem;"></i>
                                        </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <button type="button" class="divisions-toggle-btn" style="display: none; width: 100%; background: transparent; border: none; padding: 0; text-align: left; cursor: pointer; margin-bottom: 8px;">
                                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                                        <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">
                                                            {% trans "Divisions" %} <span class="divisions-count">({{ event.divisions.count }})</span>
                                    </div>
                                                        <i class="fas fa-chevron-down divisions-chevron" style="color: var(--mlb-red); font-size: 0.7rem; transition: transform 0.3s;"></i>
                                </div>
                                                </button>
                                                <div class="divisions-title-desktop" style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-bottom: 8px;">{% trans "Divisions" %} <span class="divisions-count">({{ event.divisions.count }})</span></div>
                                                <div class="divisions-content" style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                                    {% for division in event.divisions.all|slice:":3" %}
                                                        <span class="division-badge" style="display: inline-flex; align-items: center; background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; box-shadow: 0 2px 6px rgba(213, 0, 50, 0.25); white-space: nowrap; transition: all 0.2s;">
                                                            <i class="fas fa-tag" style="font-size: 0.65rem; margin-right: 5px; opacity: 0.9;"></i>
                                                            {{ division.name }}
                                                        </span>
                                                    {% endfor %}
                                                    {% if event.divisions.count > 3 %}
                                                        <details class="divisions-more">
                                                            <summary class="divisions-show-more-btn" style="display: inline-flex; align-items: center; gap: 5px; background: transparent; border: 1px solid var(--mlb-red); color: var(--mlb-red); padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 4px; pointer-events: auto !important; z-index: 100 !important; position: relative !important;">
                                                                <span class="divisions-show-more-text divisions-show-more-text--more">{% trans "Show more" %}</span>
                                                                <span class="divisions-show-more-text divisions-show-more-text--less">{% trans "Show less" %}</span>
                                                                <i class="fas fa-chevron-down divisions-show-more-chevron" style="font-size: 0.6rem; transition: transform 0.3s; transform: rotate(0deg);"></i>
                                                            </summary>
                                                            <div class="divisions-extra" style="display: flex; width: 100%; flex-wrap: wrap; gap: 6px; align-items: center; flex-direction: row;">
                                                                {% for division in event.divisions.all|slice:"3:" %}
                                                                    <span class="division-badge" style="display: inline-flex; align-items: center; background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; box-shadow: 0 2px 6px rgba(213, 0, 50, 0.25); white-space: nowrap; transition: all 0.2s;">
                                                                        <i class="fas fa-tag" style="font-size: 0.65rem; margin-right: 5px; opacity: 0.9;"></i>
                                                                        {{ division.name }}
                                                                    </span>
                                                                {% endfor %}
                            </div>
                                                        </details>
                        {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Columna Derecha -->
                            <div class="col-md-6">
                            <div class="d-flex flex-column" style="gap: 12px;">
                                <!-- Ubicación -->
                                {% if event.city or event.state or event.country or event.location %}
                                    <div>
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--mlb-blue) 0%, var(--mlb-light-blue) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                <i class="fas fa-map-marker-alt" style="color: white; font-size: 1rem;"></i>
                                    </div>
                                    <div>
                                                <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">{% trans "Location" %}</div>
                                        <div style="font-weight: 600; color: var(--mlb-blue);">
                                                    {% if event.city %}{{ event.city.name }}{% endif %}{% if event.state %}{% if event.city %}, {% endif %}{{ event.state.name }}{% endif %}{% if event.country %}{% if event.state or event.city %}, {% endif %}{{ event.country.name }}{% endif %}
                                                    {% if not event.city and not event.state and not event.country and event.location %}{{ event.location }}{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Estado -->
                                <div>
                            <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-check-circle" style="color: white; font-size: 1rem;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">{% trans "Status" %}</div>
                                    <div style="font-weight: 600; color: var(--mlb-blue); text-transform: capitalize;">{{ event.get_status_display }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Hotel Sede -->
                        {% if event.hotel %}
                                    <div>
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                    {% if event.hotel.photo %}
                                        <div style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                                            <img src="{{ event.hotel.photo.url }}" alt="{{ event.hotel.hotel_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                    {% else %}
                                                <div style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-hotel" style="color: white; font-size: 1.5rem;"></i>
                                        </div>
                                    {% endif %}
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">{% trans "Headquarters Hotel" %}</div>
                                        <div style="font-weight: 600; color: var(--mlb-blue);">{{ event.hotel.hotel_name }}</div>
                                        {% if event.hotel.address %}
                                            <div style="font-size: 0.75rem; color: #6c757d; margin-top: 2px;">{{ event.hotel.address }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Sitio Primario del Evento -->
                        {% if event.primary_site %}
                                    <div>
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                    {% if event.primary_site.image %}
                                        <div style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                                            <img src="{{ event.primary_site.image.url }}" alt="{{ event.primary_site.site_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                    {% else %}
                                                <div style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-map-marked-alt" style="color: white; font-size: 1.5rem;"></i>
                                        </div>
                                    {% endif %}
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">{% trans "Primary Site" %}</div>
                                        <div style="font-weight: 600; color: var(--mlb-blue);">{{ event.primary_site.site_name }}</div>
                                        {% if event.primary_site.address_1 %}
                                            <div style="font-size: 0.75rem; color: #6c757d; margin-top: 2px;">{{ event.primary_site.address_1 }}{% if event.primary_site.address_2 %}, {{ event.primary_site.address_2 }}{% endif %}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Video del Evento -->
                {% if event.video_url %}
                    <div class="mb-4" style="margin-top: 30px;">
                        <h5 style="color: var(--mlb-blue); font-weight: 700; margin-bottom: 20px;">
                            <i class="fas fa-video me-2" style="color: var(--mlb-red);"></i>{% trans "Event Video" %}
                        </h5>
                        <div id="event-video-container" style="position: relative; width: 100%; padding-bottom: 56.25%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15); background: #000;">
    <script>
        // Definir funciones globales ANTES de la IIFE para que estén disponibles
        (function() {
            // Estas funciones se definirán dentro de la IIFE pero estarán disponibles globalmente
            window._hotelModalInit{{ event.hotel.pk }} = function() {
                // Esta función se llamará cuando el DOM esté listo
                const script = document.currentScript || document.querySelector('script[data-hotel-pk="{{ event.hotel.pk }}"]');
                if (script) {
                    script.dispatchEvent(new CustomEvent('init-hotel-modal'));
                }
            };
        })();

        (function() {
                                    const videoUrl = '{{ event.video_url|escapejs }}';
                                    const container = document.getElementById('event-video-container');

                                    function extractYouTubeId(url) {
                                        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                                        const match = url.match(regExp);
                                        return (match && match[2].length === 11) ? match[2] : null;
                                    }

                                    function extractVimeoId(url) {
                                        const regExp = /(?:vimeo\.com\/)(?:.*\/)?(\d+)/;
                                        const match = url.match(regExp);
                                        return match ? match[1] : null;
                                    }

                                    let iframe = null;

                                    if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                                        const videoId = extractYouTubeId(videoUrl);
                                        if (videoId) {
                                            iframe = document.createElement('iframe');
                                            // Autoplay usually requires muted + playsinline
                                            iframe.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1&mute=1&playsinline=1&rel=0&modestbranding=1';
                                            iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;';
                                            iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                                            iframe.setAttribute('allowfullscreen', '');
                                        }
                                    } else if (videoUrl.includes('vimeo.com')) {
                                        const videoId = extractVimeoId(videoUrl);
                                        if (videoId) {
                                            iframe = document.createElement('iframe');
                                            // Autoplay usually requires muted + playsinline
                                            iframe.src = 'https://player.vimeo.com/video/' + videoId + '?autoplay=1&muted=1&playsinline=1';
                                            iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;';
                                            iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
                                            iframe.setAttribute('allowfullscreen', '');
                                        }
                                    } else {
                                        const video = document.createElement('video');
                                        // Autoplay: most browsers require muted + playsinline
                                        video.controls = true;
                                        video.autoplay = true;
                                        video.muted = true;
                                        video.playsInline = true;
                                        video.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: #000;';
                                        const source = document.createElement('source');
                                        source.src = videoUrl;
                                        source.type = 'video/mp4';
                                        video.appendChild(source);
                                        video.appendChild(document.createTextNode('{% trans "Your browser does not support the video tag." %}'));
                                        iframe = video;
                                    }

                                    if (iframe) {
                                        container.appendChild(iframe);
                                        // Attempt to start playback (safe no-op for iframes / blocked autoplay)
                                        try {
                                            if (iframe.tagName && iframe.tagName.toLowerCase() === 'video') {
                                                const p = iframe.play();
                                                if (p && typeof p.catch === 'function') p.catch(() => {});
                                            }
                                        } catch (e) {}
                                    } else {
                                        container.innerHTML = '<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white;"><i class="fas fa-exclamation-triangle me-2"></i>{% trans "Invalid video URL" %}</div>';
                                    }
                                })();
                            </script>
                        </div>
                    </div>
                {% endif %}

                <!-- Línea separadora -->
                <div style="width: 100%; height: 2px; background: linear-gradient(90deg, var(--mlb-red) 0%, #b30029 100%); margin-bottom: 25px; margin-top: 25px; border-radius: 2px;"></div>

                <!-- Descripción -->
                {% if event.description %}
                    <div class="mb-4">
                        <h5 style="color: var(--mlb-blue); font-weight: 700; margin-bottom: 15px;">
                            <i class="fas fa-info-circle me-2" style="color: var(--mlb-red);"></i>{% trans "Description" %}
                        </h5>
                        <div style="color: #333; line-height: 1.8; font-size: 0.95rem; font-weight: normal;" class="event-description">{{ event.description|safe }}</div>
                    </div>
                {% endif %}

                <!-- Enlace externo si existe -->
                {% if event.external_link %}
                    <div class="mt-4">
                        <a href="{{ event.external_link }}" target="_blank" class="btn" style="background: var(--mlb-blue); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="fas fa-external-link-alt"></i>{% trans "More Information" %}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Lado Derecho - Checkout -->
        <div class="col-lg-5">
            <div class="checkout-card" style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: sticky; top: 20px;">
                <h4 style="color: var(--mlb-blue); font-weight: 800; margin-bottom: 18px; border-bottom: 3px solid var(--mlb-red); padding-bottom: 12px; font-size: 1.2rem;">
                    <i class="fas fa-shopping-cart me-2" style="color: var(--mlb-red);"></i>{% trans "Checkout" %}
                </h4>

                <!-- Paso 1: Seleccionar Jugadores -->
                {% if has_ineligible_children %}
                    <div class="alert alert-warning mb-4" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 15px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <i class="fas fa-exclamation-triangle" style="color: #856404; font-size: 1.2rem; margin-top: 2px; flex-shrink: 0;"></i>
                            <div style="flex: 1;">
                                <p style="color: #856404; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem;">
                                    {% trans "Some of your players are not eligible for this event" %}
                                </p>
                                <p style="color: #856404; font-size: 0.85rem; margin-bottom: 10px;">
                                    {% trans "The following players do not match any of the event divisions" %}:
                                </p>
                                <ul style="margin: 0; padding-left: 20px; color: #856404; font-size: 0.85rem;">
                                    {% for child in ineligible_children %}
                                        <li>
                                            <strong>{% if child.user.get_full_name %}{{ child.user.get_full_name }}{% else %}{{ child.user.username }}{% endif %}</strong>
                                            {% if child.division %}
                                                - {% trans "Division" %}: <strong>{{ child.division }}</strong>
                                            {% else %}
                                                - {% trans "No division assigned" %}
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                                <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px;">
                                    <p style="font-size: 0.8rem; color: #6c757d; margin-bottom: 6px; font-weight: 600;">
                                        {% trans "Event Divisions" %}:
                                    </p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        {% for division in event.divisions.all %}
                                            <span style="background: var(--mlb-red); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                                {{ division.name }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if children %}
                    <div class="checkout-step mb-4" id="step-players">
                        <h5 style="color: var(--mlb-blue); font-weight: 700; margin-bottom: 12px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                            <span style="background: var(--mlb-red); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;">1</span>
                            <i class="fas fa-users me-1" style="color: var(--mlb-red);"></i>{% trans "Select Players" %}
                            </h5>
                        <div class="children-list">
                            {% for child in children %}
                                <div class="child-item mb-2" style="border: 2px solid {% if child.pk in registered_players %}#28a745{% else %}#e9ecef{% endif %}; border-radius: 8px; padding: 10px; transition: all 0.3s; cursor: {% if child.pk in registered_players %}not-allowed{% else %}pointer{% endif %}; background: {% if child.pk in registered_players %}#f8fff9{% else %}transparent{% endif %};"
                                     data-child-id="{{ child.pk }}"
                                     data-child-price="{{ event.default_entry_fee|default:'0.00' }}"
                                     data-birth-date="{% if child.user.profile.birth_date %}{{ child.user.profile.birth_date|date:'Y-m-d' }}{% endif %}"
                                     data-child-email="{% if child.user.email %}{{ child.user.email|escapejs }}{% endif %}"
                                     data-child-name="{% if child.user.get_full_name %}{{ child.user.get_full_name|escapejs }}{% else %}{{ child.user.username|escapejs }}{% endif %}"
                                     {% if child.pk in registered_players %}data-registered="true"{% endif %}>
                                    <div class="form-check" style="display: flex; align-items: center; gap: 10px;">
                                        {% if child.pk in registered_players %}
                                        <input class="form-check-input child-checkbox" type="checkbox" name="players" value="{{ child.pk }}" id="child_{{ child.pk }}"
                                               disabled style="width: 18px; height: 18px; cursor: not-allowed; margin: 0; flex-shrink: 0; opacity: 0.5;">
                                        <label class="form-check-label" for="child_{{ child.pk }}" style="cursor: not-allowed; width: 100%; margin: 0; opacity: 0.7;">
                                        {% else %}
                                        <input class="form-check-input child-checkbox" type="checkbox" name="players" value="{{ child.pk }}" id="child_{{ child.pk }}"
                                               style="width: 18px; height: 18px; cursor: pointer; margin: 0; flex-shrink: 0;">
                                        <label class="form-check-label" for="child_{{ child.pk }}" style="cursor: pointer; width: 100%; margin: 0;">
                                        {% endif %}
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <!-- Foto o Iniciales -->
                                                <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%);">
                                                    {% if child.user.profile.profile_picture %}
                                                        <img src="{{ child.user.profile.profile_picture.url }}" alt="{% if child.user.get_full_name %}{{ child.user.get_full_name }}{% else %}{{ child.user.username }}{% endif %}" style="width: 100%; height: 100%; object-fit: cover;">
                                                    {% else %}
                                                        {% with first_name=child.user.first_name|default:"" last_name=child.user.last_name|default:"" %}
                                                            {% if first_name or last_name %}
                                                                <span style="color: white; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                                                    {% if first_name %}{{ first_name|slice:":1" }}{% endif %}{% if last_name %}{{ last_name|slice:":1" }}{% endif %}
                                                                </span>
                                                            {% else %}
                                                                <i class="fas fa-user" style="color: white; font-size: 1rem;"></i>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                </div>
                                                <!-- Información del jugador -->
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 700; color: var(--mlb-blue); font-size: 0.9rem; line-height: 1.2; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                                        <span>{% if child.user.get_full_name %}{{ child.user.get_full_name }}{% else %}{{ child.user.username }}{% endif %}</span>
                                                        {% if child.pk in registered_players %}
                                                        <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                                            <i class="fas fa-check-circle" style="font-size: 0.65rem;"></i>{% trans "Registered" %}
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                    {% if child.division %}
                                                        <div style="font-size: 0.75rem; color: #6c757d; margin-top: 2px;">
                                                            <i class="fas fa-tag me-1" style="color: var(--mlb-red); font-size: 0.65rem;"></i>{{ child.division }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <!-- Precio -->
                                                {% if child.pk not in registered_players %}
                                                <div class="child-price" style="font-weight: 700; color: var(--mlb-red); font-size: 0.95rem; flex-shrink: 0;">
                                                    ${{ event.default_entry_fee|default:"0.00" }}
                                                </div>
                                                {% else %}
                                                <div style="font-weight: 600; color: #6c757d; font-size: 0.85rem; flex-shrink: 0; font-style: italic;">
                                                    {% trans "Already registered" %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Paso 2: Add Hotel Stay -->
                        {% if event.hotel %}
                    <div class="checkout-step mb-4" id="step-hotel">
                        <h5 style="color: var(--mlb-blue); font-weight: 700; margin-bottom: 12px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                            <span style="background: var(--mlb-red); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;">2</span>
                            <i class="fas fa-hotel me-1" style="color: var(--mlb-red);"></i>{% trans "Add Hotel Stay" %}
                        </h5>

                        <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 2px solid #e9ecef; border-radius: 12px; padding: 12px;">
                            <div style="font-size: 0.8rem; color: #6c757d; font-weight: 600; line-height: 1.25; margin-bottom: 10px;">
                                {% trans "If you don't add a hotel stay, a Hotel buy out fee will apply." %}
                                                </div>
                        </div>
                        {% endif %}

                        {% if event.hotel %}
                            <button type="button"
                                    class="btn btn-sm w-100"
                                    id="add-hotel-stay-btn"
                                    data-hotel-pk="{{ event.hotel.pk }}"
                                    onclick="openHotelRoomSelector()"
                                    style="background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); color: white; padding: 10px; border-radius: 10px; font-weight: 800; font-size: 0.9rem; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 24px rgba(213, 0, 50, 0.25)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <i class="fas fa-hotel"></i>
                                <span>{% trans "Add Hotel Stay" %}</span>
                            </button>
                            <div id="add-hotel-stay-hint" style="margin-top: 8px; font-size: 0.78rem; color: #6c757d; font-weight: 700; line-height: 1.2;"></div>
                                            </div>
                                        </div>
                {% endif %}

                <!-- Botón para agregar hotel (oculto, se muestra en Order Summary cuando se añade) -->
                        {% if event.hotel %}
                    <div class="hotel-stay-section" id="hotel-stay-section{{ event.hotel.pk }}" data-hotel-pk="{{ event.hotel.pk }}" style="display: none;">
                        <!-- Esta sección está oculta, el hotel solo aparece en Order Summary cuando se añade -->
                                                            </div>
                                                        {% endif %}

                <!-- Resumen del Checkout -->
                <div class="checkout-summary" style="border-top: 3px solid var(--mlb-red); padding-top: 20px; margin-top: 20px;">
                    <h5 style="color: var(--mlb-blue); font-weight: 700; margin-bottom: 15px; font-size: 1rem;">
                        <i class="fas fa-receipt me-2" style="color: var(--mlb-red);"></i>{% trans "Order Summary" %}
                    </h5>

                    <!-- Items del Checkout -->
                    <div id="checkout-items-list" style="margin-bottom: 15px; min-height: 50px;">
                        <div id="checkout-players-summary" style="display: none; margin-bottom: 15px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border: 2px solid #e9ecef; border-radius: 12px; padding: 15px; border-left: 4px solid var(--mlb-blue);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <i class="fas fa-users" style="color: var(--mlb-blue); font-size: 1rem;"></i>
                                            <span style="font-weight: 700; color: var(--mlb-blue); font-size: 1rem;">
                                                <span id="checkout-players-count">0</span> {% trans "Player(s)" %}
                                            </span>
                                                            </div>
                                                            <div style="font-size: 0.75rem; color: #6c757d;">
                                            {% trans "Event registration" %}
                                                            </div>
                                    </div>
                                    <div style="text-align: right; flex-shrink: 0; margin-left: 15px;">
                                        <div style="font-weight: 800; color: var(--mlb-blue); font-size: 1.2rem;" id="checkout-players-total">$0.00</div>
                                    </div>
                                                    </div>
                                                </div>
                                            </div>

                        <div id="checkout-hotel-summary" style="display: none;">
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border: 2px solid #e9ecef; border-radius: 12px; padding: 12px; border-left: 4px solid var(--mlb-red);">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            <i class="fas fa-hotel" style="color: var(--mlb-red); font-size: 0.9rem;"></i>
                                            <span style="font-weight: 700; color: var(--mlb-blue); font-size: 0.95rem;" id="checkout-hotel-name">{% trans "Hotel Stay" %}</span>
                                            <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
                                                <button type="button"
                                                        onclick="openHotelRoomSelector()"
                                                        style="background: transparent; border: none; padding: 0; color: var(--mlb-blue); font-weight: 800; font-size: 0.78rem; text-decoration: underline;">
                                                    {% trans "Change" %}
                                                </button>
                                                <button type="button"
                                                        onclick="window.removeCheckoutHotel && window.removeCheckoutHotel()"
                                                        style="background: transparent; border: none; padding: 0; color: #b91c1c; font-weight: 900; font-size: 0.78rem; text-decoration: underline;">
                                                    {% trans "Remove" %}
                                                </button>
                                            </div>
                                        </div>
                                        <div id="checkout-hotel-room-info" style="font-size: 0.8rem; color: #6c757d; font-weight: 600; display: inline;">
                                            <!-- Se llenará con información de la habitación -->
                                    </div>
                                        <div id="checkout-hotel-details" style="font-size: 0.75rem; color: #6c757d; line-height: 1.4; display: inline;">
                                            <!-- Se llenará con fechas, huéspedes, noches -->
                                </div>
                            </div>
                                    <div style="text-align: right; flex-shrink: 0;">
                                        <div style="font-weight: 800; color: var(--mlb-red); font-size: 1.1rem; margin-bottom: 2px;" id="checkout-hotel-total">$0.00</div>
                                        <div style="font-size: 0.7rem; color: #6c757d;" id="checkout-hotel-nights">0 {% trans "nights" %}</div>
                                        <div style="font-size: 0.65rem; color: #9ca3af; margin-top: 1px;" id="checkout-hotel-price-per-night"></div>
                            </div>
                                </div>
                            </div>
                        </div>

                        <div id="checkout-no-show-summary" style="display: none; margin-bottom: 15px;">
                            <div style="background: linear-gradient(135deg, #fff7ed 0%, #ffffff 100%); border: 2px solid #ffedd5; border-radius: 12px; padding: 12px; border-left: 4px solid #f97316;">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <i class="fas fa-exclamation-triangle" style="color: #f97316; font-size: 1rem;"></i>
                                            <span style="font-weight: 800; color: var(--mlb-blue); font-size: 0.95rem;">
                                                {% trans "Hotel buy out fee" %}
                                            </span>
                            </div>
                                        <div style="font-size: 0.78rem; color: #6c757d; font-weight: 600; line-height: 1.25;">
                                            {% trans "Applies when you don't add a hotel stay to this checkout." %}
                            </div>
                                    </div>
                                    <div style="text-align: right; flex-shrink: 0;">
                                        <div id="checkout-no-show-fee" style="font-weight: 900; color: #f97316; font-size: 1.1rem;">$0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="checkout-empty-message" style="text-align: center; padding: 20px; color: #6c757d; font-size: 0.85rem;">
                            <i class="fas fa-shopping-cart" style="font-size: 1.5rem; margin-bottom: 8px; opacity: 0.3;"></i>
                            <div style="margin-bottom: 15px;">{% trans "Select players to see your order summary" %}</div>
                                            </div>
                                        </div>

                    <!-- Total -->
                    <div style="border-top: 2px solid var(--mlb-red); padding-top: 15px; margin-top: 15px;">
                        <!-- Desglose de impuestos del hotel (si aplica) -->
                        <div id="checkout-taxes-breakdown" style="display: none; margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.8rem;">
                            <div style="font-weight: 700; color: var(--mlb-blue); margin-bottom: 6px; font-size: 0.85rem;">{% trans "Hotel Taxes" %}:</div>
                            <div id="checkout-taxes-details" style="color: #6c757d;">
                                <!-- Se llenará con el desglose de impuestos -->
                                    </div>
                                </div>

                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 800; color: var(--mlb-blue); font-size: 1.1rem;">{% trans "Total" %}:</span>
                            <span id="checkout-total-amount" style="font-weight: 800; color: var(--mlb-red); font-size: 1.4rem;">$0.00</span>
                            </div>
                        </div>

                    <!-- Botón de Finalizar -->
                    <form method="post" action="{% url 'accounts:register_children_to_event' event.pk %}" id="eventRegistrationForm" style="margin-top: 20px;">
                        {% csrf_token %}
                        <div id="selected-players-inputs"></div>
                        <input type="hidden" name="payment_mode" id="payment-mode" value="plan">
                        <input type="hidden" name="discount_percent" id="discount-percent" value="0">
                        <input type="hidden" name="no_show_fee" id="no-show-fee-input" value="0">
                        <div class="d-flex flex-column flex-sm-row gap-2">
                            <button type="button" class="btn" id="pay-plan-btn" disabled
                                    style="flex: 1; background: #e9ecef; color: var(--mlb-blue); border: 2px solid #e9ecef; border-radius: 10px; padding: 12px; font-weight: 800; transition: all 0.2s; opacity: 0.5; cursor: not-allowed; text-align: left;">
                                <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px;">
                                    <span><i class="fas fa-calendar-alt me-2"></i>{% trans "Payment plan" %}</span>
                                    <span id="plan-monthly-amount" style="font-weight: 900; color: var(--mlb-blue);">$0.00</span>
                            </div>
                                <div id="plan-subtext" style="margin-top: 4px; font-size: 0.8rem; font-weight: 700; color: #6c757d; line-height: 1.25;"></div>
                                <div style="margin-top: 2px; font-size: 0.74rem; font-weight: 600; color: #6c757d; line-height: 1.25;">
                                    {% trans "Good if you prefer to spread the total over time." %}
                        </div>
                        </button>

                            <button type="button" class="btn" id="pay-now-btn" disabled
                                    style="flex: 1; background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); color: white; border: none; border-radius: 10px; padding: 12px; font-weight: 800; transition: all 0.2s; opacity: 0.5; cursor: not-allowed; text-align: left;">
                                <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px;">
                                    <span id="pay-now-title"><i class="fas fa-bolt me-2"></i>{% trans "Pay now" %} <span id="pay-now-discount-badge" style="opacity:0.9;">{% trans "- 5% OFF" %}</span></span>
                                    <span id="pay-now-total" style="font-weight: 900; color: white;">$0.00</span>
                                </div>
                                <div id="pay-now-subtext" style="margin-top: 4px; font-size: 0.8rem; font-weight: 700; color: rgba(255,255,255,0.9); line-height: 1.25;"></div>
                                <div style="margin-top: 2px; font-size: 0.74rem; font-weight: 600; color: rgba(255,255,255,0.85); line-height: 1.25;">
                                    {% trans "Best value if you can pay today." %}
                                </div>
                        </button>
                        </div>
                    </form>

                    <!-- Loader mientras se crea la sesión de Stripe / redirección -->
                    <div id="stripe-checkout-loader" style="display:none;" role="status" aria-live="polite" aria-label="{% trans 'Redirecting to Stripe checkout' %}">
                        <div class="stripe-checkout-loader__backdrop"></div>
                        <div class="stripe-checkout-loader__card">
                            <div class="stripe-checkout-loader__spinner" aria-hidden="true"></div>
                            <div class="stripe-checkout-loader__title">{% trans "Redirecting to Stripe..." %}</div>
                            <div class="stripe-checkout-loader__subtitle">{% trans "Please don't close this window." %}</div>
                        </div>
                    </div>
                </div>

                {% if not children %}
                    <div class="alert alert-warning alert-persistent" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 20px; text-align: center; margin-top: 20px;">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3" style="color: #856404;"></i>
                        <p style="color: #856404; font-weight: 600; margin-bottom: 10px;">
                            {% if has_ineligible_children %}
                                {% trans "None of your players are eligible for this event based on their divisions." %}
                            {% else %}
                            {% trans "You don't have any children/players registered. Please register a child/player first." %}
                            {% endif %}
                        </p>
                        {% if has_ineligible_children %}
                            <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; text-align: left;">
                                <p style="font-size: 0.9rem; color: #856404; margin-bottom: 10px; font-weight: 600;">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "Event Divisions" %}:
                                </p>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
                                    {% for division in event.divisions.all %}
                                        <span style="background: var(--mlb-red); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
                                            {{ division.name }}
                                        </span>
                                    {% endfor %}
                                </div>
                                <p style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0;">
                                    {% trans "Your players' divisions must match one of the event divisions to register." %}
                                </p>
                            </div>
                        {% endif %}
                        <a
                            href="{% if user.profile.is_parent %}{% url 'panel' %}?tab=registrar-hijo{% elif user.profile.is_team_manager %}{% url 'panel' %}?tab=registrar-jugador{% else %}{% url 'panel' %}{% endif %}"
                            onclick="return (function(el){
                                    const tabId = '{% if user.profile.is_parent %}registrar-hijo{% elif user.profile.is_team_manager %}registrar-jugador{% else %}{% endif %}';
                                    // Si estamos dentro del panel (iframe), pedir al parent que active el tab (evita sub-frame-error)
                                    try {
                                        if (tabId && window.parent && window.parent !== window) {
                                            window.parent.postMessage({ type: 'nsc-activate-tab', tabId: tabId }, window.location.origin);
                                            return false;
                                        }
                                    } catch (e) {}
                                    // Fallback: navegación normal al panel
                                    try { window.top.location.href = el.href; return false; } catch(e) {}
                                    return true;
                                })(this);"
                            target="_top"
                            class="btn mt-3"
                            style="background: var(--mlb-blue); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none;"
                        >
                            <i class="fas fa-user-plus me-2"></i>{% trans "Register Child/Player" %}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

    </div>
{% else %}
    <!-- DEBUG: NO EVENT - Event no está en el contexto -->
    <div class="alert alert-warning" style="background: white; border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <i class="fas fa-exclamation-triangle fa-3x mb-3" style="color: #ffc107;"></i>
        <h5 style="color: var(--mlb-blue); font-weight: 700;">{% trans "Event not found" %}</h5>
        <p class="text-muted">{% trans "The event you are looking for does not exist or is not available." %}</p>
        <!-- DEBUG: Verificar contexto - event: {{ event|default:"NO EVENT OBJECT" }} -->
    </div>
{% endif %}

<style>
.child-item:hover {
    border-color: var(--mlb-red) !important;
    box-shadow: 0 2px 8px rgba(213, 0, 50, 0.2);
    transform: translateY(-2px);
}

.child-checkbox:checked + label .child-item {
    border-color: var(--mlb-red) !important;
    background: #fff5f7;
}

#register-btn:not(:disabled) {
    opacity: 1 !important;
    cursor: pointer !important;
}

#register-btn:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(213, 0, 50, 0.4);
}

/* Hover/focus para botones de pago */
#pay-plan-btn:not(:disabled):hover {
    transform: translateY(-1px);
    border-color: var(--mlb-blue);
    box-shadow: 0 10px 24px rgba(13, 44, 84, 0.18);
}

#pay-now-btn:not(:disabled):hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 24px rgba(213, 0, 50, 0.25);
    filter: brightness(1.02);
}

#add-hotel-stay-btn:disabled {
    opacity: 0.55;
    cursor: not-allowed;
    filter: grayscale(0.1);
}

#pay-plan-btn:focus-visible,
#pay-now-btn:focus-visible {
    outline: 3px solid rgba(13, 44, 84, 0.25);
    outline-offset: 2px;
}

/* Loader Stripe */
#stripe-checkout-loader {
    position: fixed;
    inset: 0;
    z-index: 99999;
    display: none; /* set to flex via JS */
    align-items: center;
    justify-content: center;
    padding: 16px;
}

#stripe-checkout-loader .stripe-checkout-loader__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(17, 24, 39, 0.55);
    backdrop-filter: blur(4px);
}

#stripe-checkout-loader .stripe-checkout-loader__card {
    position: relative;
    z-index: 1;
    width: min(440px, 92vw);
    background: white;
    border-radius: 14px;
    padding: 18px 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.28);
    text-align: center;
    border: 1px solid rgba(229, 231, 235, 0.9);
}

#stripe-checkout-loader .stripe-checkout-loader__spinner {
    width: 40px;
    height: 40px;
    margin: 4px auto 10px;
    border-radius: 999px;
    border: 4px solid #e5e7eb;
    border-top-color: var(--mlb-red);
    animation: stripeLoaderSpin 0.9s linear infinite;
}

#stripe-checkout-loader .stripe-checkout-loader__title {
    font-weight: 900;
    color: var(--mlb-blue);
    font-size: 1.05rem;
    margin-bottom: 4px;
}

#stripe-checkout-loader .stripe-checkout-loader__subtitle {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.85rem;
    line-height: 1.25;
}

@keyframes stripeLoaderSpin {
    to { transform: rotate(360deg); }
}

/* Estilos para el HTML de la descripción del evento */
.event-description {
    word-wrap: break-word;
    overflow-wrap: break-word;
    font-weight: normal !important;
    /* Colapsar espacios en blanco múltiples a uno solo */
    white-space: normal;
    text-rendering: optimizeLegibility;
}

/* Asegurar que todos los elementos colapsen espacios múltiples */
.event-description * {
    white-space: normal;
}

.event-description * {
    font-weight: inherit;
}

/* No agregar márgenes automáticos - dejar que el HTML del evento controle el espaciado */
.event-description p {
    font-weight: normal;
}

.event-description span {
    font-weight: normal;
}

.event-description div {
    font-weight: normal;
}

.event-description ul,
.event-description ol {
    /* Dejar que el HTML controle el margin-left */
}

.event-description li {
    font-weight: normal;
}

.event-description h1,
.event-description h2,
.event-description h3,
.event-description h4,
.event-description h5,
.event-description h6 {
    color: var(--mlb-blue);
    font-weight: 700;
}

.event-description strong,
.event-description b {
    font-weight: 700;
}

.event-description em,
.event-description i {
    font-style: italic;
    font-weight: normal;
}

.event-description a {
    color: var(--mlb-red);
    text-decoration: none;
    transition: color 0.3s;
    font-weight: normal;
}

.event-description a:hover {
    color: #b30029;
    text-decoration: underline;
}

.event-description img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
}

.event-description blockquote {
    border-left: 4px solid var(--mlb-red);
    padding-left: 1rem;
    font-style: italic;
    color: #6c757d;
}

.event-description code {
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

.event-description pre {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
}

.event-description table {
    width: 100%;
    border-collapse: collapse;
}

.event-description table th,
.event-description table td {
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    text-align: left;
}

.event-description table th {
    background: var(--mlb-blue);
    color: white;
    font-weight: 700;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Limpiar espacios duplicados en la descripción del evento
    const eventDescription = document.querySelector('.event-description');
    if (eventDescription) {
        // Normalizar espacios en blanco: colapsar múltiples espacios a uno solo
        const walker = document.createTreeWalker(
            eventDescription,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );

        let node;
        while (node = walker.nextNode()) {
            // Reemplazar múltiples espacios en blanco con uno solo
            node.textContent = node.textContent.replace(/\s+/g, ' ');
        }
    }

    const checkboxes = document.querySelectorAll('.child-checkbox');
    const pricePerPlayer = parseFloat('{{ event.default_entry_fee|default:"0" }}') || 0;
    const registrationForm = document.getElementById('eventRegistrationForm');
    const eventId = '{{ event.pk }}';
    const checkoutPlayersStorageKey = 'checkout_selected_players_' + eventId;
    const checkoutHotelStorageKey = 'checkout_selected_hotel_' + eventId;
    const hasHotelCart = {% if request.session.hotel_cart %}true{% else %}false{% endif %};

    // Excluir jugadores ya registrados de la selección
    document.querySelectorAll('.child-item[data-registered="true"]').forEach(function(item) {
        const checkbox = item.querySelector('.child-checkbox');
        if (checkbox) {
            checkbox.disabled = true;
            checkbox.checked = false;
            // Asegurar que no se pueda seleccionar
            item.style.pointerEvents = 'none';
        }
    });

    // Excluir jugadores ya registrados de la selección
    document.querySelectorAll('.child-item[data-registered="true"]').forEach(function(item) {
        const checkbox = item.querySelector('.child-checkbox');
        if (checkbox) {
            checkbox.disabled = true;
            checkbox.checked = false;
            // Asegurar que no se pueda seleccionar
            item.style.pointerEvents = 'none';
        }
    });

    // Almacenar items del checkout
    window.checkoutItems = {
        players: [],
        hotel: null
    };

    // Persist / restore checkout selections when the user returns from Stripe (cancel/back)
    function persistSelectedPlayers() {
        try {
            const selected = Array.from(document.querySelectorAll('.child-checkbox:checked:not(:disabled)')).map(cb => cb.value);
            localStorage.setItem(checkoutPlayersStorageKey, JSON.stringify(selected));
        } catch (e) {
            console.warn('Could not persist selected players', e);
        }
    }

    function restoreSelectedPlayers() {
        try {
            const raw = localStorage.getItem(checkoutPlayersStorageKey);
            if (!raw) return;
            const selected = JSON.parse(raw) || [];
            if (!Array.isArray(selected)) return;
            document.querySelectorAll('.child-checkbox').forEach((cb) => {
                cb.checked = selected.includes(cb.value);
            });
        } catch (e) {
            console.warn('Could not restore selected players', e);
        }
    }

    function persistSelectedHotel(hotelData) {
        try {
            if (!hotelData) {
                localStorage.removeItem(checkoutHotelStorageKey);
                return;
            }
            localStorage.setItem(checkoutHotelStorageKey, JSON.stringify(hotelData));
        } catch (e) {
            console.warn('Could not persist selected hotel', e);
        }
    }

    async function clearHotelCartInSession() {
        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            const resp = await fetch(hotelCartJsonUrl, { method: 'GET' });
            const data = await resp.json();
            const items = (data && data.items) ? data.items : [];
            if (!Array.isArray(items) || items.length === 0) return;

            await Promise.all(items.map((item) => {
                if (!item || !item.id) return Promise.resolve();
                return fetch(hotelCartRemoveUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({ item_id: item.id })
                }).catch(() => null);
            }));
        } catch (e) {
            console.warn('Could not clear hotel cart in session', e);
        }
    }

    function restoreSelectedHotel() {
        try {
            // If session cart is empty, do not restore stale hotel info
            if (!hasHotelCart) {
                localStorage.removeItem(checkoutHotelStorageKey);
                return;
            }
            const raw = localStorage.getItem(checkoutHotelStorageKey);
            if (!raw) return;
            const hotelData = JSON.parse(raw);
            if (!hotelData || typeof hotelData !== 'object') return;
            window.checkoutItems.hotel = hotelData;
        } catch (e) {
            console.warn('Could not restore selected hotel', e);
        }
    }

    // Función para formatear números con separadores de miles (puntos)
    function formatPrice(amount) {
        const num = parseFloat(amount);
        if (isNaN(num)) return '0.00';
        // Separar parte entera y decimal
        const parts = num.toFixed(2).split('.');
        // Agregar puntos de miles a la parte entera
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        // Unir con punto decimal
        return parts.join('.');
    }

    const paymentDeadlineStr = '{% if event.payment_deadline %}{{ event.payment_deadline|date:"Y-m-d" }}{% endif %}';
    function formatDateShort(dateObj) {
        try {
            return dateObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        } catch (e) {
            return '';
        }
    }

    // Shared handler: open hotel room selector from checkout buttons
    window.openHotelRoomSelector = function openHotelRoomSelector() {
        const selectedPlayersCount = document.querySelectorAll('.child-checkbox:checked:not(:disabled)').length;
        if (selectedPlayersCount <= 0) {
            alert('{% trans "Please select at least 1 player before adding a hotel stay." %}');
            return;
        }
        if (!window.NSC_HotelReservation) {
            console.error('NSC_HotelReservation not found');
            return;
        }
        const userData = {
            name: '{% if user.get_full_name %}{{ user.get_full_name|escapejs }}{% else %}{{ user.username|escapejs }}{% endif %}',
            email: '{{ user.email|escapejs }}',
            phone: '{% if user.profile.phone %}{{ user.profile.phone|escapejs }}{% endif %}',
            birthDate: '{% if user.profile.birth_date %}{{ user.profile.birth_date|date:"Y-m-d"|escapejs }}{% endif %}'
        };
        window.NSC_HotelReservation.showRoomsDirect('{{ event.hotel.pk }}', userData);
    };

    // Función para actualizar el resumen del checkout
    function updateCheckoutSummary() {
        // Verificar que estamos en el contexto correcto (página de detalles de evento)
        // Si no hay elementos del checkout, salir temprano para evitar errores
        const checkoutContainer = document.getElementById('checkout-players-summary') ||
                                  document.getElementById('checkout-hotel-summary') ||
                                  document.querySelector('.child-checkbox');

        if (!checkoutContainer) {
            // No estamos en la página de checkout, salir silenciosamente
            return;
        }

        const playersCount = document.querySelectorAll('.child-checkbox:checked:not(:disabled)').length;
        const playersTotal = playersCount * pricePerPlayer;
        const addHotelBtn = document.getElementById('add-hotel-stay-btn');
        const addHotelHint = document.getElementById('add-hotel-stay-hint');

        // Formatear precios individuales en la lista de jugadores (checkout)
        document.querySelectorAll('.child-item').forEach((item) => {
            const priceEl = item.querySelector('.child-price');
            if (!priceEl) return;
            const raw = item.getAttribute('data-child-price');
            if (raw !== null && raw !== undefined && raw !== '') {
                priceEl.textContent = '$' + formatPrice(raw);
            }
        });

        // Actualizar resumen de jugadores
        const playersSummary = document.getElementById('checkout-players-summary');
        const playersCountSpan = document.getElementById('checkout-players-count');
        const playersTotalSpan = document.getElementById('checkout-players-total');
        const emptyMessage = document.getElementById('checkout-empty-message');

        if (playersSummary) {
            if (playersCount > 0) {
                playersSummary.style.display = 'block';
                if (playersCountSpan) {
                    playersCountSpan.textContent = playersCount;
                }
                if (playersTotalSpan) {
                    playersTotalSpan.textContent = '$' + formatPrice(playersTotal);
                }
            } else {
                playersSummary.style.display = 'none';
            }
        }

        // Step 2: require players before allowing hotel selection
        if (addHotelBtn) {
            addHotelBtn.disabled = playersCount <= 0;
        }
        if (addHotelHint) {
            addHotelHint.textContent = (playersCount <= 0)
                ? '{% trans "Select player(s) first to continue." %}'
                : '';
        }

        // Actualizar resumen de hotel con información detallada e impuestos
        const hotelSummary = document.getElementById('checkout-hotel-summary');

        // Calcular total del hotel con impuestos
        let hotelBasePrice = 0;
        let hotelIVA = 0;
        let hotelISH = 0;
        let hotelTotal = 0;

        if (window.checkoutItems.hotel && hotelSummary) {
            const hotel = window.checkoutItems.hotel;

            // Si ya viene el total con impuestos incluidos, calcular el desglose
            if (hotel.total) {
                hotelTotal = parseFloat(hotel.total);
                // Si viene el precio base, usarlo; si no, calcularlo desde el total
                if (hotel.base_price) {
                    hotelBasePrice = parseFloat(hotel.base_price);
                } else {
                    // Calcular precio base desde el total (total / 1.21 para IVA 16% + ISH 5%)
                    // Total = Base * (1 + 0.16 + 0.05) = Base * 1.21
                    hotelBasePrice = hotelTotal / 1.21;
                }
                hotelIVA = hotelBasePrice * 0.16;
                hotelISH = hotelBasePrice * 0.05;
            } else if (hotel.base_price) {
                // Si viene el precio base, calcular impuestos
                hotelBasePrice = parseFloat(hotel.base_price);
                hotelIVA = hotelBasePrice * 0.16;
                hotelISH = hotelBasePrice * 0.05;
                hotelTotal = hotelBasePrice + hotelIVA + hotelISH;
            }

            if (hotelSummary) {
                hotelSummary.style.display = 'block';
            }

            // Nombre del hotel
            const hotelNameEl = document.getElementById('checkout-hotel-name');
            if (hotelNameEl) {
                hotelNameEl.textContent = hotel.hotel_name || '{% trans "Hotel Stay" %}';
            }

            // Información de la habitación y detalles en formato horizontal completo
            const roomInfoEl = document.getElementById('checkout-hotel-room-info');
            const hotelDetailsEl = document.getElementById('checkout-hotel-details');

            if (roomInfoEl && hotelDetailsEl) {
                let allInfoHTML = '';

                // Agregar nombre de habitación
                if (hotel.room_name) {
                    allInfoHTML += '<i class="fas fa-bed" style="color: var(--mlb-red); font-size: 0.75rem; margin-right: 4px;"></i>' + hotel.room_name;
                }

                // Agregar separador si hay habitación y fechas
                if (hotel.room_name && hotel.check_in && hotel.check_out) {
                    allInfoHTML += ' <span style="color: #d1d5db; margin: 0 8px;">•</span> ';
                }

                // Agregar fechas
                if (hotel.check_in && hotel.check_out) {
                    // Formatear fechas para mejor legibilidad
                    const formatDate = (dateStr) => {
                        try {
                            const date = new Date(dateStr);
                            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                        } catch (e) {
                            return dateStr;
                        }
                    };
                    allInfoHTML += '<span style="display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-calendar-alt" style="color: var(--mlb-red); font-size: 0.7rem;"></i><span style="font-weight: 500;">' + formatDate(hotel.check_in) + ' - ' + formatDate(hotel.check_out) + '</span></span>';
                }

                // Agregar separador si hay fechas y huéspedes
                if ((hotel.room_name || (hotel.check_in && hotel.check_out)) && hotel.guests) {
                    allInfoHTML += ' <span style="color: #d1d5db; margin: 0 8px;">•</span> ';
                }

                // Agregar número de huéspedes
                if (hotel.guests) {
                    allInfoHTML += '<span style="display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-users" style="color: var(--mlb-red); font-size: 0.7rem;"></i><span style="font-weight: 500;">' + hotel.guests + ' {% trans "guest(s)" %}</span></span>';
                }

                // Mostrar todo en una sola línea
                roomInfoEl.innerHTML = allInfoHTML;

                // Especificar el cobro por persona adicional (si aplica)
                const includesGuests = parseInt(hotel.includes_guests || 1);
                const additionalGuestPrice = parseFloat(hotel.additional_guest_price || 0);
                const guestsCount = parseInt(hotel.guests || 0);
                const nightsCount = parseInt(hotel.nights || 0);
                const extraGuests = Math.max(0, guestsCount - includesGuests);
                const extraGuestTotal = (extraGuests * additionalGuestPrice) * nightsCount;

                if (extraGuests > 0 && additionalGuestPrice > 0 && nightsCount > 0) {
                    hotelDetailsEl.innerHTML =
                        '<div style="margin-top: 6px; font-size: 0.78rem; color: #6c757d; font-weight: 600; line-height: 1.25;">' +
                        '<i class="fas fa-user-plus" style="color: var(--mlb-red); margin-right: 6px;"></i>' +
                        '{% trans "Additional guest(s)" %}: <span style="font-weight: 800; color: var(--mlb-blue);">' + extraGuests + '</span>' +
                        ' × <span style="font-weight: 800; color: var(--mlb-blue);">$' + formatPrice(additionalGuestPrice) + '</span>/{% trans "night" %}' +
                        ' × <span style="font-weight: 800; color: var(--mlb-blue);">' + nightsCount + '</span> = ' +
                        '<span style="font-weight: 900; color: var(--mlb-red);">$' + formatPrice(extraGuestTotal) + '</span>' +
                        '</div>';
                } else if (includesGuests > 0) {
                    hotelDetailsEl.innerHTML =
                        '<div style="margin-top: 6px; font-size: 0.78rem; color: #6c757d; font-weight: 600; line-height: 1.25;">' +
                        '<i class="fas fa-info-circle" style="color: #9ca3af; margin-right: 6px;"></i>' +
                        '{% trans "Includes" %} <span style="font-weight: 800; color: var(--mlb-blue);">' + includesGuests + '</span> {% trans "guest(s)" %}' +
                        '</div>';
                } else {
                    hotelDetailsEl.innerHTML = '';
                }
            } else {
                // Fallback al método anterior si los elementos no existen
                if (roomInfoEl) {
                    if (hotel.room_name) {
                        roomInfoEl.innerHTML = '<i class="fas fa-bed" style="color: var(--mlb-red); font-size: 0.75rem; margin-right: 4px;"></i>' + hotel.room_name;
                    } else {
                        roomInfoEl.innerHTML = '';
                    }
                }

                if (hotelDetailsEl) {
                    let detailsHTML = '<div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">';

                    if (hotel.check_in && hotel.check_out) {
                        const formatDate = (dateStr) => {
                            try {
                                const date = new Date(dateStr);
                                return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                            } catch (e) {
                                return dateStr;
                            }
                        };
                        detailsHTML += '<span style="display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-calendar-alt" style="color: var(--mlb-red); font-size: 0.7rem;"></i><span style="font-weight: 500;">' + formatDate(hotel.check_in) + ' - ' + formatDate(hotel.check_out) + '</span></span>';
                    }

                    if (hotel.guests) {
                        detailsHTML += '<span style="display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-users" style="color: var(--mlb-red); font-size: 0.7rem;"></i><span style="font-weight: 500;">' + hotel.guests + ' {% trans "guest(s)" %}</span></span>';
                    }

                    detailsHTML += '</div>';
                    hotelDetailsEl.innerHTML = detailsHTML;
                }
            }

            // Total, noches y precio por noche
            const hotelTotalEl = document.getElementById('checkout-hotel-total');
            if (hotelTotalEl) {
                hotelTotalEl.textContent = '$' + formatPrice(hotelTotal);
            }
            const nightsEl = document.getElementById('checkout-hotel-nights');
            if (nightsEl) {
                if (hotel.nights) {
                    nightsEl.textContent = hotel.nights + ' {% trans "night(s)" %}';
                } else {
                    nightsEl.textContent = '';
                }
            }
            // Mostrar precio por noche
            const pricePerNightEl = document.getElementById('checkout-hotel-price-per-night');
            if (pricePerNightEl && hotel.nights && hotelBasePrice > 0) {
                const pricePerNight = hotelBasePrice / hotel.nights;
                pricePerNightEl.textContent = '$' + formatPrice(pricePerNight) + '/{% trans "night" %}';
            } else if (pricePerNightEl) {
                pricePerNightEl.textContent = '';
            }
        } else if (hotelSummary) {
            hotelSummary.style.display = 'none';
        }

        // Mostrar/ocultar mensaje vacío
        if (emptyMessage) {
            if (playersCount === 0 && !window.checkoutItems.hotel) {
                emptyMessage.style.display = 'block';
            } else if (playersCount > 0 && !window.checkoutItems.hotel) {
                // Si hay jugadores pero no hotel, el Paso 2 maneja "Add Hotel Stay"
                emptyMessage.style.display = 'none';
            } else {
                emptyMessage.style.display = 'none';
            }
        }

        // Hotel buy out fee: solo aplica si el evento tiene hotel, hay jugadores seleccionados y NO se añadió hotel
        const NO_SHOW_FEE = 1000;
        const hasEventHotel = {% if event.hotel %}true{% else %}false{% endif %};
        const applyNoShowFee = hasEventHotel && (playersCount > 0) && !window.checkoutItems.hotel;
        const noShowFee = applyNoShowFee ? NO_SHOW_FEE : 0;

        // Mostrar/ocultar paso 2 (hotel) según si ya se añadió hotel
        const stepHotel = document.getElementById('step-hotel');
        if (stepHotel) {
            stepHotel.style.display = window.checkoutItems.hotel ? 'none' : 'block';
        }

        const noShowSummary = document.getElementById('checkout-no-show-summary');
        const noShowFeeEl = document.getElementById('checkout-no-show-fee');
        if (noShowSummary && noShowFeeEl) {
            if (applyNoShowFee) {
                noShowSummary.style.display = 'block';
                noShowFeeEl.textContent = '$' + formatPrice(noShowFee);
            } else {
                noShowSummary.style.display = 'none';
                noShowFeeEl.textContent = '$0.00';
            }
        }

        const noShowFeeInput = document.getElementById('no-show-fee-input');
        if (noShowFeeInput) {
            noShowFeeInput.value = String(noShowFee);
        }

        // Total del checkout (incluye Hotel buy out fee si aplica)
        const checkoutTotal = playersTotal + hotelTotal + noShowFee;
        window.__checkoutTotal = checkoutTotal;
        // Pay now -5% OFF only applies if a hotel stay is added
        const hasHotelForDiscount = (hotelTotal > 0) && !!window.checkoutItems.hotel;
        window.__checkoutTotalPayNow = hasHotelForDiscount ? (checkoutTotal * 0.95) : checkoutTotal;

        // Update Pay now button label (hide/show "- 5% OFF")
        const payNowDiscountBadge = document.getElementById('pay-now-discount-badge');
        if (payNowDiscountBadge) {
            payNowDiscountBadge.style.display = hasHotelForDiscount ? 'inline' : 'none';
        }

        const checkoutTotalEl = document.getElementById('checkout-total-amount');
        if (checkoutTotalEl) {
            checkoutTotalEl.textContent = '$' + formatPrice(checkoutTotal);
        }

        // Actualizar textos de botones de pago (plan / pay now)
        const planMonthlyEl = document.getElementById('plan-monthly-amount');
        const planSubtextEl = document.getElementById('plan-subtext');
        const payNowTotalEl = document.getElementById('pay-now-total');
        const payNowSubtextEl = document.getElementById('pay-now-subtext');

        // Pay now info
        if (payNowTotalEl) {
            payNowTotalEl.textContent = '$' + formatPrice(window.__checkoutTotalPayNow || 0);
        }
        if (payNowSubtextEl) {
            const savings = (window.__checkoutTotal || 0) - (window.__checkoutTotalPayNow || 0);
            if ((window.__checkoutTotal || 0) > 0) {
                if (hasHotelForDiscount) {
                    payNowSubtextEl.textContent = '{% trans "You pay today and save" %} $' + formatPrice(savings);
                } else {
                    payNowSubtextEl.textContent = '{% trans "5% OFF applies when you add a hotel stay." %}';
                }
            } else {
                payNowSubtextEl.textContent = '';
            }
        }

        // Plan info (months until payment_deadline)
        if (paymentDeadlineStr) {
            const now = new Date();
            const deadline = new Date(paymentDeadlineStr + 'T00:00:00');
            // Inclusive months: current month..deadline month
            let months = (deadline.getFullYear() - now.getFullYear()) * 12 + (deadline.getMonth() - now.getMonth()) + 1;
            if (!isFinite(months) || months < 1) months = 1;

            const monthly = (window.__checkoutTotal || 0) / months;
            if (planMonthlyEl) {
                planMonthlyEl.textContent = '$' + formatPrice(monthly) + '/mo';
            }
            if (planSubtextEl) {
                planSubtextEl.textContent =
                    months + ' {% trans "monthly payments (approx.) until" %} ' + formatDateShort(deadline);
            }
        } else {
            if (planMonthlyEl) planMonthlyEl.textContent = '';
            if (planSubtextEl) planSubtextEl.textContent = '';
        }

        // Mostrar/ocultar impuestos del hotel (independiente del breakdown)
        const taxesBreakdown = document.getElementById('checkout-taxes-breakdown');
        const taxesDetails = document.getElementById('checkout-taxes-details');

        if (hotelTotal > 0 && window.checkoutItems.hotel && taxesBreakdown && taxesDetails) {
            const hotel = window.checkoutItems.hotel;
            let hotelBasePrice = 0;
            let hotelIVA = 0;
            let hotelISH = 0;

            // Calcular impuestos
            if (hotel.base_price) {
                hotelBasePrice = parseFloat(hotel.base_price);
                hotelIVA = hotelBasePrice * 0.16;
                hotelISH = hotelBasePrice * 0.05;
            } else {
                // Calcular desde el total
                hotelBasePrice = hotelTotal / 1.21;
                hotelIVA = hotelBasePrice * 0.16;
                hotelISH = hotelBasePrice * 0.05;
            }

            // Mostrar impuestos
            taxesBreakdown.style.display = 'block';
            let taxesHTML = '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>{% trans "Base" %}:</span><span style="font-weight: 600;">$' + formatPrice(hotelBasePrice) + '</span></div>';
            taxesHTML += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>IVA (16%):</span><span style="font-weight: 600;">$' + formatPrice(hotelIVA) + '</span></div>';
            taxesHTML += '<div style="display: flex; justify-content: space-between;"><span>ISH (5%):</span><span style="font-weight: 600;">$' + formatPrice(hotelISH) + '</span></div>';
            taxesDetails.innerHTML = taxesHTML;
        } else if (taxesBreakdown) {
            // Ocultar impuestos si no hay hotel
            taxesBreakdown.style.display = 'none';
        }

        // Actualizar desglose del total
        const breakdownDiv = document.getElementById('checkout-breakdown');
        const breakdownPlayers = document.getElementById('checkout-breakdown-players');
        const breakdownHotel = document.getElementById('checkout-breakdown-hotel');
        const breakdownPlayersText = document.getElementById('breakdown-players-text');
        const breakdownHotelText = document.getElementById('breakdown-hotel-text');

        if (breakdownDiv) {
            if (playersCount > 0 || hotelTotal > 0) {
                breakdownDiv.style.display = 'block';

                // Desglose de jugadores
                if (breakdownPlayers && breakdownPlayersText) {
                    if (playersCount > 0) {
                        breakdownPlayers.style.display = 'block';
                        breakdownPlayersText.textContent = playersCount + ' × $' + formatPrice(pricePerPlayer) + ' = $' + formatPrice(playersTotal);
                    } else {
                        breakdownPlayers.style.display = 'none';
                    }
                }

                // Desglose de hotel con impuestos
                if (breakdownHotel && breakdownHotelText && hotelTotal > 0 && window.checkoutItems.hotel) {
                    breakdownHotel.style.display = 'block';
                    const hotel = window.checkoutItems.hotel;
                    const nights = hotel.nights || 1;

                    // Calcular desglose con impuestos
                    let hotelBasePrice = 0;
                    let hotelIVA = 0;
                    let hotelISH = 0;

                    if (hotel.base_price) {
                        hotelBasePrice = parseFloat(hotel.base_price);
                        hotelIVA = hotelBasePrice * 0.16;
                        hotelISH = hotelBasePrice * 0.05;
                    } else {
                        // Calcular desde el total
                        hotelBasePrice = hotelTotal / 1.21;
                        hotelIVA = hotelBasePrice * 0.16;
                        hotelISH = hotelBasePrice * 0.05;
                    }

                    const basePricePerNight = hotelBasePrice / nights;
                    let breakdownHTML = nights + ' {% trans "night(s)" %} × $' + formatPrice(basePricePerNight) + ' = $' + formatPrice(hotelBasePrice);
                    breakdownHTML += '<br><strong style="color: var(--mlb-red);">' + '{% trans "Total Hotel (with taxes)" %}: $' + formatPrice(hotelTotal) + '</strong>';
                    breakdownHotelText.innerHTML = breakdownHTML;

                } else if (breakdownHotel) {
                    breakdownHotel.style.display = 'none';
                }

                // Desglose Hotel buy out fee (si no hay hotel)
                const noShowFeeRowId = 'checkout-breakdown-no-show';
                let noShowRow = document.getElementById(noShowFeeRowId);
                if (!noShowRow && breakdownDiv) {
                    noShowRow = document.createElement('div');
                    noShowRow.id = noShowFeeRowId;
                    noShowRow.style.cssText = 'display:none; margin-top: 6px; color: #6c757d;';
                    breakdownDiv.appendChild(noShowRow);
                }
                if (noShowRow) {
                    const hasEventHotel = {% if event.hotel %}true{% else %}false{% endif %};
                    const applyNoShowFee = hasEventHotel && (playersCount > 0) && !window.checkoutItems.hotel;
                    const noShowFee = applyNoShowFee ? 1000 : 0;
                    if (applyNoShowFee) {
                        noShowRow.style.display = 'block';
                        noShowRow.innerHTML =
                            '<div style="display:flex; justify-content: space-between; align-items:center;">' +
                                '<span style="font-weight:600;">{% trans "Hotel buy out fee" %}</span>' +
                                '<span style="font-weight:800; color:#f97316;">$' + formatPrice(noShowFee) + '</span>' +
                            '</div>';
                    } else {
                        noShowRow.style.display = 'none';
                        noShowRow.innerHTML = '';
                    }
                }
            } else {
                breakdownDiv.style.display = 'none';
            }
        }

        // Habilitar/deshabilitar botones de pago
        const payPlanBtn = document.getElementById('pay-plan-btn');
        const payNowBtn = document.getElementById('pay-now-btn');
        if (payPlanBtn && payNowBtn) {
            if (playersCount > 0) {
                [payPlanBtn, payNowBtn].forEach((btn) => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
            } else {
                [payPlanBtn, payNowBtn].forEach((btn) => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                });
            }
        }

        // Actualizar inputs hidden con jugadores seleccionados (múltiples inputs con name="players")
        // Excluir jugadores deshabilitados (ya registrados)
        const selectedPlayers = Array.from(document.querySelectorAll('.child-checkbox:checked:not(:disabled)')).map(cb => cb.value);
        const playersInputsContainer = document.getElementById('selected-players-inputs');
        playersInputsContainer.innerHTML = ''; // Limpiar inputs anteriores
        selectedPlayers.forEach(playerId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'players';
            input.value = playerId;
            playersInputsContainer.appendChild(input);
        });
    }

    // Event listeners para checkboxes de jugadores (solo los habilitados)
    checkboxes.forEach(checkbox => {
        if (!checkbox.disabled) {
        checkbox.addEventListener('change', function() {
            persistSelectedPlayers();
            updateCheckoutSummary();
        });
        }
    });

    // Restore selections before initial summary render
    restoreSelectedPlayers();
    restoreSelectedHotel();

    // Actualizar al cargar la página
    updateCheckoutSummary();

    // Botones de pago (directos en el checkout)
    const payPlanBtn = document.getElementById('pay-plan-btn');
    const payNowBtn = document.getElementById('pay-now-btn');
    const paymentModeInput = document.getElementById('payment-mode');
    const discountPercentInput = document.getElementById('discount-percent');
    const stripeCheckoutLoader = document.getElementById('stripe-checkout-loader');
    const hotelCartJsonUrl = '{% url "locations:get_cart_json" %}';
    const hotelCartRemoveUrl = '{% url "locations:remove_from_cart" %}';

    // Stripe create-session URL (guarded for pages that render this template without an event, e.g. /panel/)
    const stripeCreateSessionUrl = {% if event and event.pk %}'{% url "accounts:create_stripe_event_checkout_session" event.pk %}'{% else %}null{% endif %};

    function showStripeCheckoutLoader() {
        if (stripeCheckoutLoader) stripeCheckoutLoader.style.display = 'flex';
        if (document && document.body) document.body.style.overflow = 'hidden';
    }

    function hideStripeCheckoutLoader() {
        if (stripeCheckoutLoader) stripeCheckoutLoader.style.display = 'none';
        if (document && document.body) document.body.style.overflow = '';
    }

    async function startStripeCheckout(mode) {
        console.log('startStripeCheckout called with mode:', mode);

        if (!registrationForm) {
            console.error('registrationForm not found');
            return;
        }

        if (!stripeCreateSessionUrl) {
            console.warn('Stripe checkout URL not available (missing event in template context).');
            alert('{% trans "Could not start payment: missing event information." %}');
            return;
        }

        // Verificar que hay jugadores seleccionados y calcular valores
        const playersCount = document.querySelectorAll('.child-checkbox:checked:not(:disabled)').length;
        if (playersCount === 0) {
            alert('{% trans "Please select at least one player to register." %}');
            return;
        }

        let didRedirect = false;
        showStripeCheckoutLoader();

        // Set hidden fields (kept for backend parity / logging)
        if (paymentModeInput) paymentModeInput.value = mode;
        // Pay now discount only if hotel is present
        const discountAllowed = (mode === 'now') && !!window.checkoutItems.hotel;
        if (discountPercentInput) discountPercentInput.value = discountAllowed ? '5' : '0';

        // Compute current no-show fee like the UI (reutilizar playersCount ya declarado arriba)
        const hasEventHotel = {% if event.hotel %}true{% else %}false{% endif %};
        const applyNoShowFee = hasEventHotel && (playersCount > 0) && !window.checkoutItems.hotel;
        const noShowFee = applyNoShowFee ? 1000 : 0;
        const noShowFeeInput = document.getElementById('no-show-fee-input');
        if (noShowFeeInput) noShowFeeInput.value = String(noShowFee);

        const csrf = registrationForm.querySelector('input[name="csrfmiddlewaretoken"]');
        const csrfToken = csrf ? csrf.value : '';

        // UI lock
        [payPlanBtn, payNowBtn].forEach((btn) => {
            if (!btn) return;
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.cursor = 'wait';
        });

        try {
            const formData = new FormData(registrationForm);

            // Debug: Log para verificar que se está enviando la petición
            console.log('Iniciando checkout de Stripe, modo:', mode);
            console.log('URL:', stripeCreateSessionUrl);

            const resp = await fetch(stripeCreateSessionUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            });

            // Verificar si la respuesta es JSON
            let data;
            const contentType = resp.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await resp.json();
            } else {
                const text = await resp.text();
                console.error('Respuesta no es JSON:', text);
                alert('{% trans "Error: Invalid response from server." %}');
                return;
            }

            console.log('Respuesta del servidor:', data);

            if (!resp.ok || !data || !data.success) {
                const msg = (data && (data.error || data.message)) ? (data.error || data.message) : '{% trans "Could not start payment." %}';
                console.error('Error en la respuesta:', msg, data);
                alert(msg);
                return;
            }

            if (data.checkout_url) {
                console.log('Redirigiendo a Stripe:', data.checkout_url);
                didRedirect = true;

                // Stripe no puede abrirse en un iframe, redirigir la ventana principal
                try {
                    // Intentar redirigir la ventana principal (top level)
                    if (window.top && window.top !== window) {
                        window.top.location.href = data.checkout_url;
                    } else {
                        // Si no estamos en un iframe, redirigir normalmente
                window.location.href = data.checkout_url;
                    }
                } catch (e) {
                    // Si hay error de seguridad (cross-origin), intentar con parent
                    try {
                        if (window.parent && window.parent !== window) {
                            window.parent.location.href = data.checkout_url;
            } else {
                            window.location.href = data.checkout_url;
                        }
                    } catch (e2) {
                        // Último recurso: abrir en nueva ventana
                        console.warn('No se pudo redirigir la ventana principal, abriendo en nueva ventana');
                        window.open(data.checkout_url, '_blank');
                    }
                }
            } else {
                console.error('No se recibió checkout_url en la respuesta:', data);
                alert('{% trans "Stripe did not return a checkout link." %}');
            }
        } catch (e) {
            console.error('Error al iniciar checkout:', e);
            alert('{% trans "Error starting payment. Please try again." %}');
        } finally {
            if (!didRedirect) {
                hideStripeCheckoutLoader();
            // Re-enable based on current state
            updateCheckoutSummary();
        }
        }
    }

    if (payPlanBtn) {
        payPlanBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Pay plan button clicked');
            startStripeCheckout('plan');
        });
    }
    if (payNowBtn) {
        payNowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Pay now button clicked');
            startStripeCheckout('now');
        });
    }

    // Función global para actualizar el hotel en el checkout (llamada desde el modal)
    window.updateCheckoutHotel = function(hotelData) {
        window.checkoutItems.hotel = hotelData;
        persistSelectedHotel(hotelData);
        updateCheckoutSummary();
    };

    // Función global para eliminar el hotel del checkout (UI + sesión + localStorage)
    window.removeCheckoutHotel = async function() {
        try {
            await clearHotelCartInSession();
        } finally {
            window.checkoutItems.hotel = null;
            persistSelectedHotel(null);
            updateCheckoutSummary();
            if (typeof window.updateCartCount === 'function') {
                window.updateCartCount();
            }
        }
    };

    // Eliminar artefactos legacy que algunos scripts viejos pueden inyectar en el checkout
    function removeLegacyCheckoutArtifacts() {
        // Elemento viejo del flujo de hotel
        document.querySelectorAll('.hotel-reservation-item').forEach((item) => item.remove());
        document.querySelectorAll('.checkout-grand-total').forEach((item) => item.remove());
    }

    // Ejecutar al cargar y periódicamente para asegurar que se eliminen
    removeLegacyCheckoutArtifacts();
    setInterval(removeLegacyCheckoutArtifacts, 1000);

    // También eliminar cuando se actualiza el checkout
    const originalUpdateCheckoutSummary = updateCheckoutSummary;
    updateCheckoutSummary = function() {
        originalUpdateCheckoutSummary();
        removeLegacyCheckoutArtifacts();
    };
});

// Mostrar sección "Add Hotel Stay" - NO ocultar basándose solo en localStorage
// Solo se ocultará cuando realmente se añada exitosamente al checkout
(function() {
    const hotelPk = '{{ event.hotel.pk }}';
    if (hotelPk) {
        // LIMPIAR localStorage incorrecto - el valor está guardado incorrectamente
        localStorage.removeItem('hotel_stay_added_' + hotelPk);
        console.log('localStorage limpiado para hotel:', hotelPk);

        // Asegurar que la sección esté visible
        const ensureHotelSectionVisible = function() {
            const hotelSection = document.getElementById('hotel-stay-section' + hotelPk);

            if (hotelSection) {
                // Asegurar que la sección esté visible sin log repetitivo
                hotelSection.style.setProperty('display', 'block', 'important');
                hotelSection.style.setProperty('visibility', 'visible', 'important');
                hotelSection.style.setProperty('opacity', '1', 'important');
            } else {
                console.warn('No se encontró la sección hotel-stay-section' + hotelPk);
            }
        };

        // Ejecutar después de que el DOM esté completamente cargado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(ensureHotelSectionVisible, 100);
            });
        } else {
            setTimeout(ensureHotelSectionVisible, 100);
        }

        // También ejecutar después de un delay adicional
        setTimeout(ensureHotelSectionVisible, 500);
    }
})();
</script>

<script>
    // Acordeón de divisiones para móvil y PC
    (function() {
        function initDivisionsAccordion() {
            const divisionsCard = document.querySelector('.divisions-card');
            const divisionsToggleBtn = document.querySelector('.divisions-toggle-btn');
            const divisionsShowMoreBtn = document.querySelector('.divisions-show-more-btn');

            // Acordeón para móvil
            if (divisionsToggleBtn && divisionsCard) {
                divisionsToggleBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    divisionsCard.classList.toggle('active');
                    // En móvil, cuando se expande, también mostrar las divisiones extra
                    if (divisionsCard.classList.contains('active')) {
                        const extra = divisionsCard.querySelector('.divisions-extra');
                        if (extra) extra.style.setProperty('display', 'flex', 'important');
                        divisionsCard.classList.add('show-all');
                    } else {
                        const extra = divisionsCard.querySelector('.divisions-extra');
                        if (extra) extra.style.setProperty('display', 'none', 'important');
                        divisionsCard.classList.remove('show-all');
                    }
                };
            }

            // En desktop el "show more" lo maneja <details>/<summary> (sin JS)
        }

        // Ejecutar cuando el DOM esté listo
        function runInit() {
            initDivisionsAccordion();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runInit);
        } else {
            runInit();
        }

        // También intentar después de delays adicionales para asegurar que funcione
        setTimeout(runInit, 100);
        setTimeout(runInit, 300);
        setTimeout(runInit, 500);

        // Nota: removimos event-delegation/capture aquí porque estaba bloqueando `onclick` del botón en algunos navegadores.
    })();
</script>

<!-- Modales de hotel: deben existir también en modo iframe (embed), por eso se incluyen aquí -->
{% if event and event.hotel %}
    {% include 'accounts/panel_tabs/detalle_evento_modals.html' %}
{% endif %}

{# Legacy/Debug script (mantenido comentado). Si ya no se usa, se puede borrar. #}
{% comment %}<script>
        // Definir funciones globales INMEDIATAMENTE (fuera de IIFE)
        window.addAdultForm{{ event.hotel.pk }} = function() {
            console.log('addAdultForm{{ event.hotel.pk }} called (global)');
            // Esta función será reemplazada por la versión completa cuando se ejecute la IIFE
            // Por ahora, intentar obtener referencias y llamar a funciones auxiliares
            const container = document.getElementById('adults-forms-container{{ event.hotel.pk }}');
            if (!container) {
                console.error('Container not found');
                return;
            }
            const existingForms = container.querySelectorAll('.adult-form-item');
            const newIndex = existingForms.length + 1;

            if (window._createAdultForm{{ event.hotel.pk }}) {
                const newForm = window._createAdultForm{{ event.hotel.pk }}(newIndex);
                if (newForm) {
                    container.appendChild(newForm);
                    if (window._updatePeopleCount{{ event.hotel.pk }}) {
                        window._updatePeopleCount{{ event.hotel.pk }}();
                    }
                }
            } else {
                console.error('_createAdultForm{{ event.hotel.pk }} not available yet');
                // Esperar un momento y reintentar
                setTimeout(function() {
                    if (window._createAdultForm{{ event.hotel.pk }}) {
                        window.addAdultForm{{ event.hotel.pk }}();
                    } else {
                        alert('{% trans "Please wait a moment and try again." %}');
                    }
                }, 100);
            }
        };

        (function() {
            const modalId = 'hotelReservationModal{{ event.hotel.pk }}';
            const modal = document.getElementById(modalId);
            const adultsFormsContainer = document.getElementById('adults-forms-container{{ event.hotel.pk }}');
            const adultsCountHidden = document.getElementById('number_of_adults{{ event.hotel.pk }}');
            const childrenInfo = document.getElementById('selected-children-info{{ event.hotel.pk }}');
            const childrenList = document.getElementById('children-list{{ event.hotel.pk }}');
            const totalPeopleCount = document.getElementById('total-people-count{{ event.hotel.pk }}');
            const adultsCount = document.getElementById('adults-count{{ event.hotel.pk }}');
            const childrenCount = document.getElementById('children-count{{ event.hotel.pk }}');
            const additionalChildrenContainer = document.getElementById('additional-children-forms-container{{ event.hotel.pk }}');
            const showRoomsBtn = document.getElementById('show-rooms-btn{{ event.hotel.pk }}');

            let adultFormCount = 1;
            let additionalChildFormCount = 0;

            // Función para calcular edad desde fecha de nacimiento
            function calculateAge(birthDate) {
                if (!birthDate) return '';
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age > 0 ? age : '';
            }

            // Función para actualizar la edad mostrada cuando cambia la fecha de nacimiento
            window.updateAdultAge{{ event.hotel.pk }} = function(dateInput, index) {
                const ageDisplay = document.querySelector('.adult-age-display-' + index);
                if (ageDisplay && dateInput.value) {
                    const age = calculateAge(dateInput.value);
                    if (age) {
                        ageDisplay.textContent = age + ' {% trans "years old" %}';
                        ageDisplay.style.color = 'var(--mlb-blue)';
                    } else {
                        ageDisplay.textContent = '';
                    }
                }
            };

            // Función para crear un formulario de adulto - EXPONER GLOBALMENTE
            function createAdultForm(index) {
                return _createAdultFormInternal(index);
            }

            // Función interna para crear formulario
            function _createAdultFormInternal(index) {
                const formDiv = document.createElement('div');
                formDiv.className = 'adult-form-item';
                formDiv.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: all 0.3s;';
                formDiv.onmouseover = function() {
                    this.style.borderColor = 'var(--mlb-blue)';
                    this.style.boxShadow = '0 2px 8px rgba(13, 44, 84, 0.1)';
                };
                formDiv.onmouseout = function() {
                    this.style.borderColor = '#e9ecef';
                    this.style.boxShadow = 'none';
                };

                const isFirst = index === 1;
                const canRemove = !isFirst;

                // Obtener datos del usuario para el primer adulto
                let userBirthDate = '';
                let userBirthDateValue = '';
                let initialAgeDisplay = '';
                if (isFirst) {
                    {% if user.profile.birth_date %}
                        userBirthDate = '{{ user.profile.birth_date|date:"Y-m-d" }}';
                        userBirthDateValue = ' value="' + userBirthDate + '"';
                        const calculatedAge = calculateAge(userBirthDate);
                    {% endif %}
                    {% if user.get_full_name %}
                        window.currentUserName = '{{ user.get_full_name|escapejs }}';
                    {% else %}
                        window.currentUserName = '{{ user.username|escapejs }}';
                    {% endif %}
                        if (calculatedAge) {
                            initialAgeDisplay = calculatedAge + ' {% trans "years old" %}';
                        }
                    {% endif %}
                }

                formDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--mlb-blue) 0%, var(--mlb-light-blue) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-user" style="color: white;"></i>
                            </div>
                            <div style="font-weight: 700; color: var(--mlb-blue);">
                                ${isFirst ? '{% trans "Primary Guest" %}' : '{% trans "Adult" %} ' + index}
                            </div>
                        </div>
                        ${canRemove ? '<button type="button" class="btn btn-sm btn-danger" onclick="removeAdultForm{{ event.hotel.pk }}(' + index + ')" style="padding: 4px 10px; border-radius: 6px; border: none;"><i class="fas fa-times"></i></button>' : ''}
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.85rem;">
                                <i class="fas fa-user me-1" style="color: var(--mlb-red);"></i>{% trans "Full Name" %} <span style="color: var(--mlb-red);">*</span>
                            </label>
                            <input type="text"
                                   class="form-control adult-name-input"
                                   name="adult_name_${index}"
                                   data-index="${index}"
                                   ${isFirst ? 'value="{{ user.get_full_name|default:user.username }}"' : ''}
                                   required
                                   style="border: 2px solid #e9ecef; border-radius: 8px; padding: 10px;"
                                   onfocus="this.style.borderColor='var(--mlb-blue)';"
                                   onblur="this.style.borderColor='#e9ecef';">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.85rem;">
                                <i class="fas fa-envelope me-1" style="color: var(--mlb-red);"></i>{% trans "Email" %} <span style="color: var(--mlb-red);">*</span>
                            </label>
                            <input type="email"
                                   class="form-control adult-email-input"
                                   name="adult_email_${index}"
                                   data-index="${index}"
                                   ${isFirst ? 'value="{{ user.email }}"' : ''}
                                   required
                                   style="border: 2px solid #e9ecef; border-radius: 8px; padding: 10px;"
                                   onfocus="this.style.borderColor='var(--mlb-blue)';"
                                   onblur="this.style.borderColor='#e9ecef';">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.85rem;">
                                <i class="fas fa-phone me-1" style="color: var(--mlb-red);"></i>{% trans "Phone" %} <span style="color: var(--mlb-red);">*</span>
                            </label>
                            <input type="tel"
                                   class="form-control adult-phone-input"
                                   name="adult_phone_${index}"
                                   data-index="${index}"
                                   ${isFirst && user.profile.phone ? 'value="{{ user.profile.phone }}"' : ''}
                                   required
                                   style="border: 2px solid #e9ecef; border-radius: 8px; padding: 10px;"
                                   onfocus="this.style.borderColor='var(--mlb-blue)';"
                                   onblur="this.style.borderColor='#e9ecef';">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.85rem;">
                                <i class="fas fa-birthday-cake me-1" style="color: var(--mlb-red);"></i>{% trans "Date of Birth" %} <span style="color: var(--mlb-red);">*</span>
                            </label>
                            <input type="date"
                                   class="form-control adult-birthdate-input"
                                   name="adult_birthdate_${index}"
                                   data-index="${index}"
                                   max="${new Date().toISOString().split('T')[0]}"
                                   ${userBirthDateValue}
                                   required
                                   style="border: 2px solid #e9ecef; border-radius: 8px; padding: 10px;"
                                   onchange="updateAdultAge{{ event.hotel.pk }}(this, ${index})"
                                   onfocus="this.style.borderColor='var(--mlb-blue)';"
                                   onblur="this.style.borderColor='#e9ecef';">
                            <small class="text-muted" style="font-size: 0.75rem; display: block; margin-top: 4px;">
                                <span class="adult-age-display-${index}" style="color: var(--mlb-blue); font-weight: 600;">
                                    ${initialAgeDisplay}
                                </span>
                            </small>
                        </div>
                    </div>
                `;

                formDiv.setAttribute('data-adult-index', index);
                return formDiv;
            }

            // Exponer funciones globalmente
            window._createAdultForm{{ event.hotel.pk }} = _createAdultFormInternal;
            window._updatePeopleCount{{ event.hotel.pk }} = updatePeopleCount;

            // Reemplazar la función global con la versión completa que tiene acceso a las variables locales
            window.addAdultForm{{ event.hotel.pk }} = function() {
                try {
                    console.log('addAdultForm{{ event.hotel.pk }} called (full version)');

                    // Obtener el contenedor
                    let container = adultsFormsContainer;
                    if (!container) {
                        container = document.getElementById('adults-forms-container{{ event.hotel.pk }}');
                        if (!container) {
                            console.error('adultsFormsContainer not found');
                            alert('{% trans "Error: could not find the forms container." %}');
                            return;
                        }
                    }

                    adultFormCount++;
                    console.log('Creating adult form', adultFormCount);
                    const newForm = createAdultForm(adultFormCount);

                    if (newForm && container) {
                        container.appendChild(newForm);
                        console.log('Adult form added successfully');
                        updatePeopleCount();
                    } else {
                        console.error('Failed to create or append adult form');
                        alert('{% trans "Error: could not add the adult form." %}');
                    }
                } catch (error) {
                    console.error('Error in addAdultForm:', error);
                    alert('{% trans "Error adding adult:" %} ' + error.message);
                }
            };

            // Función para remover un formulario de adulto
            window.removeAdultForm{{ event.hotel.pk }} = function(index) {
                const formToRemove = adultsFormsContainer.querySelector(`[data-adult-index="${index}"]`);
                if (formToRemove && index !== 1) {
                    formToRemove.remove();
                    // Renumerar los formularios restantes
                    renumberAdultForms();
                    updatePeopleCount();
                }
            };

            // Función para renumerar los formularios
            function renumberAdultForms() {
                const forms = adultsFormsContainer.querySelectorAll('.adult-form-item');
                adultFormCount = forms.length;
                forms.forEach((form, idx) => {
                    const newIndex = idx + 1;
                    form.setAttribute('data-adult-index', newIndex);
                    const inputs = form.querySelectorAll('input[data-index]');
                    inputs.forEach(input => {
                        const oldIndex = input.getAttribute('data-index');
                        input.setAttribute('name', input.getAttribute('name').replace(`_${oldIndex}`, `_${newIndex}`));
                        input.setAttribute('data-index', newIndex);
                    });
                    const titleDiv = form.querySelector('div[style*="font-weight: 700"]');
                    if (titleDiv && newIndex !== 1) {
                        titleDiv.textContent = '{% trans "Adult" %} ' + newIndex;
                    }
                });
            }

            // Función para crear un formulario de niño adicional
            function createChildForm(index) {
                const formDiv = document.createElement('div');
                formDiv.className = 'additional-child-form-item';
                formDiv.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: all 0.3s;';
                formDiv.setAttribute('data-child-index', index);

                formDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-baby" style="color: white;"></i>
                            </div>
                            <div style="font-weight: 700; color: var(--mlb-blue);">
                                {% trans "Child" %} ${index}
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeChildForm{{ event.hotel.pk }}(${index})" style="padding: 4px 10px; border-radius: 6px; border: none;">
                            <i class="fas fa-times"></i> {% trans "Remove" %}
                        </button>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.85rem;">
                                <i class="fas fa-user me-1" style="color: var(--mlb-red);"></i>{% trans "Full Name" %} <span style="color: var(--mlb-red);">*</span>
                            </label>
                            <input type="text"
                                   class="form-control child-name-input"
                                   name="additional_child_name_${index}"
                                   data-index="${index}"
                                   required
                                   style="border: 2px solid #e9ecef; border-radius: 8px; padding: 10px;"
                                   onfocus="this.style.borderColor='var(--mlb-blue)';"
                                   onblur="this.style.borderColor='#e9ecef';">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="font-weight: 600; color: var(--mlb-blue); font-size: 0.85rem;">
                                <i class="fas fa-birthday-cake me-1" style="color: var(--mlb-red);"></i>{% trans "Date of Birth" %} <span style="color: var(--mlb-red);">*</span>
                            </label>
                            <input type="date"
                                   class="form-control child-birthdate-input"
                                   name="additional_child_birthdate_${index}"
                                   data-index="${index}"
                                   max="${new Date().toISOString().split('T')[0]}"
                                   required
                                   style="border: 2px solid #e9ecef; border-radius: 8px; padding: 10px;"
                                   onchange="updateChildAge{{ event.hotel.pk }}(this, ${index})"
                                   onfocus="this.style.borderColor='var(--mlb-blue)';"
                                   onblur="this.style.borderColor='#e9ecef';">
                            <small class="text-muted" style="font-size: 0.75rem; display: block; margin-top: 4px;">
                                <span class="child-age-display-${index}" style="color: var(--mlb-blue); font-weight: 600;"></span>
                            </small>
                        </div>
                    </div>
                `;

                return formDiv;
            }

            // Función para actualizar la edad mostrada cuando cambia la fecha de nacimiento del niño
            window.updateChildAge{{ event.hotel.pk }} = function(dateInput, index) {
                const ageDisplay = document.querySelector('.child-age-display-' + index);
                if (ageDisplay && dateInput.value) {
                    const age = calculateAge(dateInput.value);
                    if (age) {
                        ageDisplay.textContent = age + ' {% trans "years old" %}';
                        ageDisplay.style.color = 'var(--mlb-blue)';
                    } else {
                        ageDisplay.textContent = '';
                    }
                }
            };

            // Función para agregar un formulario de niño adicional
            window.addChildForm{{ event.hotel.pk }} = function() {
                additionalChildFormCount++;
                const newForm = createChildForm(additionalChildFormCount);
                additionalChildrenContainer.appendChild(newForm);
                updatePeopleCount();
            };

            // Función para remover un formulario de niño adicional
            window.removeChildForm{{ event.hotel.pk }} = function(index) {
                const formToRemove = additionalChildrenContainer.querySelector(`[data-child-index="${index}"]`);
                if (formToRemove) {
                    formToRemove.remove();
                    renumberChildForms();
                    updatePeopleCount();
                }
            };

            // Función para renumerar los formularios de niños adicionales
            function renumberChildForms() {
                const forms = additionalChildrenContainer.querySelectorAll('.additional-child-form-item');
                additionalChildFormCount = forms.length;
                forms.forEach((form, idx) => {
                    const newIndex = idx + 1;
                    form.setAttribute('data-child-index', newIndex);
                    const inputs = form.querySelectorAll('input[data-index]');
                    inputs.forEach(input => {
                        const oldIndex = input.getAttribute('data-index');
                        input.setAttribute('name', input.getAttribute('name').replace(`_${oldIndex}`, `_${newIndex}`));
                        input.setAttribute('data-index', newIndex);
                    });
                    const titleDiv = form.querySelector('div[style*="font-weight: 700"]');
                    if (titleDiv) {
                        titleDiv.textContent = '{% trans "Child" %} ' + newIndex;
                    }
                });
            }

            function updatePeopleCount() {
                const adults = adultsFormsContainer.querySelectorAll('.adult-form-item').length;
                const checkboxes = document.querySelectorAll('.child-checkbox:checked:not(:disabled)');
                const selectedPlayers = checkboxes.length;
                const additionalChildren = additionalChildrenContainer.querySelectorAll('.additional-child-form-item').length;
                const totalPeople = adults + selectedPlayers + additionalChildren;

                // Actualizar campo hidden
                if (adultsCountHidden) {
                    adultsCountHidden.value = adults;
                }

                // Actualizar contador de adultos
                if (adultsCount) {
                    adultsCount.textContent = adults;
                }

                // Mostrar/ocultar sección de jugadores seleccionados
                const playersSection = document.getElementById('selected-children-section{{ event.hotel.pk }}');
                const playersBreakdown = document.getElementById('players-breakdown{{ event.hotel.pk }}');
                const playersCountBreakdown = document.getElementById('players-count-breakdown{{ event.hotel.pk }}');
                const playersCountDisplay = document.getElementById('children-count{{ event.hotel.pk }}');

                if (selectedPlayers > 0) {
                    if (playersSection) {
                        playersSection.style.display = 'block';
                    }
                    if (playersBreakdown) {
                        playersBreakdown.style.display = 'block';
                    }
                    if (playersCountBreakdown) {
                        playersCountBreakdown.textContent = selectedPlayers;
                    }
                    if (playersCountDisplay) {
                        playersCountDisplay.textContent = selectedPlayers;
                    }
                } else {
                    if (playersSection) {
                        playersSection.style.display = 'none';
                    }
                    if (playersBreakdown) {
                        playersBreakdown.style.display = 'none';
                    }
                }

                // Mostrar/ocultar sección de niños adicionales
                const additionalChildrenSection = document.getElementById('additional-children-section{{ event.hotel.pk }}');
                const additionalChildrenBreakdown = document.getElementById('additional-children-breakdown{{ event.hotel.pk }}');
                const additionalChildrenCountBreakdown = document.getElementById('additional-children-count-breakdown{{ event.hotel.pk }}');

                if (additionalChildren > 0) {
                    if (additionalChildrenSection) {
                        additionalChildrenSection.style.display = 'block';
                    }
                    if (additionalChildrenBreakdown) {
                        additionalChildrenBreakdown.style.display = 'block';
                    }
                    if (additionalChildrenCountBreakdown) {
                        additionalChildrenCountBreakdown.textContent = additionalChildren;
                    }
                } else {
                    if (additionalChildrenSection) {
                        additionalChildrenSection.style.display = 'none';
                    }
                    if (additionalChildrenBreakdown) {
                        additionalChildrenBreakdown.style.display = 'none';
                    }
                }

                    // Crear cards para cada jugador seleccionado con foto y nombre
                    if (childrenList) {
                        childrenList.innerHTML = '';
                        checkboxes.forEach(function(checkbox) {
                            const childItem = checkbox.closest('.child-item');
                            if (!childItem) return;

                            // Buscar el nombre del niño
                            const nameDiv = childItem.querySelector('div[style*="font-weight: 700"][style*="color: var(--mlb-blue)"]');
                            let childName = '';
                            if (nameDiv) {
                                childName = nameDiv.textContent.trim();
                            } else {
                                // Fallback: buscar cualquier div con font-weight: 700
                                const nameFallback = childItem.querySelector('div[style*="font-weight: 700"]');
                                if (nameFallback) {
                                    childName = nameFallback.textContent.trim();
                                }
                            }

                            // Buscar la foto del niño
                            const photoDiv = childItem.querySelector('div[style*="border-radius: 50%"][style*="overflow: hidden"]');
                            let photoHTML = '';

                            if (photoDiv) {
                                const img = photoDiv.querySelector('img');
                                if (img && img.src) {
                                    // Hay foto
                                    photoHTML = '<div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; flex-shrink: 0; border: 3px solid var(--mlb-red); box-shadow: 0 2px 8px rgba(213, 0, 50, 0.2);"><img src="' + img.src + '" alt="' + childName + '" style="width: 100%; height: 100%; object-fit: cover;"></div>';
                                } else {
                                    // No hay foto, usar el contenido del div (iniciales o icono)
                                    const photoContent = photoDiv.innerHTML;
                                    photoHTML = '<div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; flex-shrink: 0; border: 3px solid var(--mlb-red); background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(213, 0, 50, 0.2);">' + photoContent + '</div>';
                                }
                            } else {
                                // Fallback si no se encuentra el div de foto
                                photoHTML = '<div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; flex-shrink: 0; border: 3px solid var(--mlb-red); background: linear-gradient(135deg, var(--mlb-red) 0%, #b30029 100%); display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 2px 8px rgba(213, 0, 50, 0.2);"><i class="fas fa-child" style="font-size: 1.5rem;"></i></div>';
                            }

                            // Buscar la división si existe
                            const divisionDiv = childItem.querySelector('div[style*="font-size: 0.75rem"][style*="color: #6c757d"]');
                            let divisionText = '';
                            if (divisionDiv) {
                                divisionText = divisionDiv.textContent.trim();
                            }

                            // Crear la tarjeta
                            const card = document.createElement('div');
                            card.style.cssText = 'display: flex; align-items: center; gap: 15px; background: white; padding: 15px; border-radius: 12px; border: 2px solid var(--mlb-red); margin-bottom: 12px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);';
                            card.onmouseover = function() {
                                this.style.boxShadow = '0 4px 16px rgba(213, 0, 50, 0.25)';
                                this.style.transform = 'translateY(-2px)';
                                this.style.borderColor = 'var(--mlb-red)';
                            };
                            card.onmouseout = function() {
                                this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                                this.style.transform = 'translateY(0)';
                                this.style.borderColor = 'var(--mlb-red)';
                            };

                                // Calcular la edad del niño desde birth_date si está disponible
                                let childAgeDisplay = '';
                                let childBirthDateDisplay = '';
                                const birthDateAttr = childItem.getAttribute('data-birth-date');
                                if (birthDateAttr && birthDateAttr !== '') {
                                    const calculatedAge = calculateAge(birthDateAttr);
                                    if (calculatedAge) {
                                        childAgeDisplay = calculatedAge;
                                    }
                                    // Formatear fecha para mostrar
                                    const dateObj = new Date(birthDateAttr);
                                    if (!isNaN(dateObj.getTime())) {
                                        childBirthDateDisplay = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                                    }
                                }

                                // Nombre del niño
                                let nameHTML = '<div style="flex: 1;"><div style="font-weight: 800; color: var(--mlb-blue); font-size: 1rem; margin-bottom: 4px;">' + (childName || '{% trans "Player" %}') + '</div>';
                                if (divisionText) {
                                    nameHTML += '<div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 8px;"><i class="fas fa-tag me-1" style="color: var(--mlb-red); font-size: 0.7rem;"></i>' + divisionText + '</div>';
                                }
                                if (childBirthDateDisplay) {
                                    nameHTML += '<div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;"><span style="font-size: 0.8rem; color: var(--mlb-blue); font-weight: 600; display: flex; align-items: center; gap: 4px;"><i class="fas fa-birthday-cake" style="color: var(--mlb-red); font-size: 0.75rem;"></i>{% trans "Date of Birth" %}:</span><span style="font-size: 0.85rem; color: var(--mlb-blue); font-weight: 600; background: #f8f9fa; padding: 4px 10px; border-radius: 6px; border: 1px solid #e9ecef;">' + childBirthDateDisplay + '</span></div>';
                                    if (childAgeDisplay) {
                                        nameHTML += '<div style="font-size: 0.75rem; color: #6c757d; margin-top: 4px;"><i class="fas fa-calendar-alt me-1" style="color: var(--mlb-red); font-size: 0.7rem;"></i><strong>' + childAgeDisplay + '</strong> {% trans "years old" %}</div>';
                                    }
                                } else {
                                    nameHTML += '<div style="font-size: 0.75rem; color: #6c757d; margin-top: 8px; font-style: italic;"><i class="fas fa-info-circle me-1" style="color: var(--mlb-red);"></i>{% trans "Date of birth not available" %}</div>';
                                }
                                nameHTML += '</div>';

                            card.innerHTML = photoHTML + nameHTML;
                            childrenList.appendChild(card);
                        });
                    }
                } else {
                    if (childrenSection) {
                        childrenSection.style.display = 'none';
                    }
                    if (childrenBreakdown) {
                        childrenBreakdown.style.display = 'none';
                    }
                }

                if (totalPeopleCount) {
                    totalPeopleCount.textContent = totalPeople;
                }

                // Validar que el primer adulto tenga todos los campos llenos
                const firstAdultForm = adultsFormsContainer.querySelector('[data-adult-index="1"]');
                let isFirstAdultValid = true;
                if (firstAdultForm) {
                    const nameInput = firstAdultForm.querySelector('.adult-name-input');
                    const emailInput = firstAdultForm.querySelector('.adult-email-input');
                    const phoneInput = firstAdultForm.querySelector('.adult-phone-input');
                    const birthdateInput = firstAdultForm.querySelector('.adult-birthdate-input');

                    if (!nameInput || !nameInput.value.trim() ||
                        !emailInput || !emailInput.value.trim() ||
                        !phoneInput || !phoneInput.value.trim() ||
                        !birthdateInput || !birthdateInput.value) {
                        isFirstAdultValid = false;
                    } else {
                        // Validar que tenga al menos 18 años
                        const age = calculateAge(birthdateInput.value);
                        if (!age || age < 18) {
                            isFirstAdultValid = false;
                        }
                    }
                } else {
                    isFirstAdultValid = false; // No hay formulario de adulto principal
                }

                // Validar que haya al menos un jugador o hijo seleccionado
                const hasPlayerOrChild = selectedPlayers > 0 || additionalChildren > 0;

                // Mostrar/ocultar mensaje de advertencia
                const noChildrenWarning = document.getElementById('no-children-warning{{ event.hotel.pk }}');
                if (noChildrenWarning) {
                    if (!hasPlayerOrChild && adults >= 1 && isFirstAdultValid) {
                        noChildrenWarning.style.display = 'block';
                    } else {
                        noChildrenWarning.style.display = 'none';
                    }
                }

                // Habilitar/deshabilitar botón de mostrar habitaciones
                if (showRoomsBtn) {
                    if (totalPeople > 0 && isFirstAdultValid && adults >= 1 && hasPlayerOrChild) {
                        showRoomsBtn.disabled = false;
                        showRoomsBtn.style.opacity = '1';
                        showRoomsBtn.style.cursor = 'pointer';
                    } else {
                        showRoomsBtn.disabled = true;
                        showRoomsBtn.style.opacity = '0.5';
                        showRoomsBtn.style.cursor = 'not-allowed';
                    }
                }
            }

            // Función para mostrar habitaciones del hotel filtradas por capacidad
            window.showHotelRooms{{ event.hotel.pk }} = function() {
                const adults = adultsFormsContainer.querySelectorAll('.adult-form-item').length;
                const checkboxes = document.querySelectorAll('.child-checkbox:checked:not(:disabled)');
                const selectedPlayers = checkboxes.length;
                const additionalChildren = additionalChildrenContainer.querySelectorAll('.additional-child-form-item').length;
                const totalPeople = adults + selectedPlayers + additionalChildren;

                // Validar que haya al menos un adulto
                if (adults < 1) {
                    alert('{% trans "At least one adult is required" %}');
                    return;
                }

                // Validar que haya al menos un jugador o hijo seleccionado
                if (selectedPlayers === 0 && additionalChildren === 0) {
                    alert('{% trans "You must select at least one player or add at least one child" %}');
                    return;
                }

                // Cerrar la modal de reserva
                const reservationModal = bootstrap.Modal.getInstance(modal);
                if (reservationModal) {
                    // Mover el foco fuera del modal antes de cerrarlo
                    const activeElement = document.activeElement;
                    if (activeElement && modal.contains(activeElement)) {
                        const triggerButton = document.querySelector('[data-bs-target="#hotelReservationModal{{ event.hotel.pk }}"]');
                        if (triggerButton) {
                            triggerButton.focus();
                        }
                    }
                    reservationModal.hide();
                }

                // Abrir la modal del hotel
                const hotelModalElement = document.getElementById('hotelModal{{ event.hotel.pk }}');
                if (hotelModalElement) {
                    const hotelModal = new bootstrap.Modal(hotelModalElement);
                    hotelModal.show();

                    // Filtrar habitaciones por capacidad cuando se abra la modal
                    hotelModalElement.addEventListener('shown.bs.modal', function filterRooms() {
                        const roomListings = hotelModalElement.querySelectorAll('.room-listing');
                        roomListings.forEach(function(roomListing) {
                            const capacityText = roomListing.querySelector('.room-features');
                            if (capacityText) {
                                const capacityMatch = capacityText.textContent.match(/(\d+)\s+guests?/i);
                                if (capacityMatch) {
                                    const roomCapacity = parseInt(capacityMatch[1]);
                                    if (roomCapacity < totalPeople) {
                                        roomListing.style.display = 'none';
                                    } else {
                                        roomListing.style.display = 'flex';
                                        // Resaltar habitaciones que cumplen con la capacidad
                                        roomListing.style.border = '3px solid var(--mlb-red)';
                                        roomListing.style.boxShadow = '0 4px 20px rgba(213, 0, 50, 0.3)';
                                    }
                                }
                            }
                        });

                        // Mostrar mensaje si no hay habitaciones disponibles
                        const visibleRooms = Array.from(roomListings).filter(r => r.style.display !== 'none');
                        const roomsSection = hotelModalElement.querySelector('.rooms-section');
                        if (visibleRooms.length === 0 && roomsSection) {
                            const noRoomsMsg = document.createElement('div');
                            noRoomsMsg.className = 'alert alert-warning';
                            noRoomsMsg.style.cssText = 'text-align: center; padding: 30px; margin: 20px 0;';
                            noRoomsMsg.innerHTML = `
                                <i class="fas fa-exclamation-triangle fa-2x mb-3" style="color: #ffc107;"></i>
                                <h5>{% trans "No rooms available" %}</h5>
                                <p>{% trans "There are no rooms available for" %} ${totalPeople} {% trans "people" %}.</p>
                            `;
                            const roomsTitle = roomsSection.querySelector('.rooms-title');
                            if (roomsTitle && !roomsSection.querySelector('.alert-warning')) {
                                roomsTitle.insertAdjacentElement('afterend', noRoomsMsg);
                            }
                        }

                        // Remover el listener después de ejecutarse una vez
                        hotelModalElement.removeEventListener('shown.bs.modal', filterRooms);
                    }, { once: true });
                }
            };

            if (modal) {
                // Manejar el foco antes de que el modal se oculte
                // Manejar el foco antes de que el modal se oculte
                modal.addEventListener('hide.bs.modal', function(event) {
                    // Quitar el foco del elemento activo dentro del modal
                    const activeElement = document.activeElement;
                    if (activeElement && modal.contains(activeElement)) {
                        // Blur el elemento activo inmediatamente
                        if (typeof activeElement.blur === 'function') {
                            activeElement.blur();
                        }
                    }
                });

                // Manejar el foco después de que el modal se haya ocultado
                modal.addEventListener('hidden.bs.modal', function(event) {
                    // Mover el foco al botón que abrió el modal
                    const triggerButton = document.querySelector('[data-bs-target="#hotelReservationModal{{ event.hotel.pk }}"]');
                    if (triggerButton) {
                        triggerButton.focus();
                    }
                });

                // Agregar event listener al botón de cancelar para manejar el foco
                const cancelBtn = modal.querySelector('.cancel-modal-btn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function(e) {
                        // Quitar el foco inmediatamente
                        if (document.activeElement && modal.contains(document.activeElement)) {
                            document.activeElement.blur();
                        }
                    });
                }

                modal.addEventListener('show.bs.modal', function() {
                    // Inicializar con el primer adulto
                    if (adultsFormsContainer && adultsFormsContainer.children.length === 0) {
                        const firstForm = createAdultForm(1);
                        adultsFormsContainer.appendChild(firstForm);
                    }
                    updatePeopleCount();
                    // Agregar listeners a los botones cuando el modal se abre
                    attachButtonListeners();
                });

                // Escuchar cambios en los checkboxes de niños
                const checkboxes = document.querySelectorAll('.child-checkbox');
                checkboxes.forEach(function(checkbox) {
                    checkbox.addEventListener('change', updatePeopleCount);
                });

                // Escuchar cambios en los inputs de adultos
                adultsFormsContainer.addEventListener('input', function(event) {
                    if (event.target.classList.contains('adult-name-input') ||
                        event.target.classList.contains('adult-email-input') ||
                        event.target.classList.contains('adult-phone-input') ||
                        event.target.classList.contains('adult-birthdate-input')) {
                        updatePeopleCount();
                    }
                });

                // Escuchar cambios en los campos de fecha de nacimiento
                adultsFormsContainer.addEventListener('change', function(event) {
                    if (event.target.classList.contains('adult-birthdate-input')) {
                        const index = event.target.getAttribute('data-index');
                        updateAdultAge{{ event.hotel.pk }}(event.target, index);
                        updatePeopleCount();
                    }
                });

                // Escuchar cambios en los inputs de niños adicionales
                if (additionalChildrenContainer) {
                    additionalChildrenContainer.addEventListener('input', function(event) {
                        if (event.target.classList.contains('child-name-input') ||
                            event.target.classList.contains('child-birthdate-input')) {
                            updatePeopleCount();
                        }
                    });

                    additionalChildrenContainer.addEventListener('change', function(event) {
                        if (event.target.classList.contains('child-birthdate-input')) {
                            const index = event.target.getAttribute('data-index');
                            updateChildAge{{ event.hotel.pk }}(event.target, index);
                            updatePeopleCount();
                        }
                    });
                }
            }

            // Interceptar el submit del formulario para procesar los datos de adultos
            const form = document.getElementById('hotelReservationForm{{ event.hotel.pk }}');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const adults = adultsFormsContainer.querySelectorAll('.adult-form-item').length;
                    if (adults < 1) {
                        e.preventDefault();
                        alert('{% trans "At least one adult is required" %}');
                        return false;
                    }

                    // Validar todos los adultos
                    const adultForms = adultsFormsContainer.querySelectorAll('.adult-form-item');
                    for (let i = 0; i < adultForms.length; i++) {
                        const adultForm = adultForms[i];
                        const nameInput = adultForm.querySelector('input[name^="adult_name_"]');
                        const emailInput = adultForm.querySelector('input[name^="adult_email_"]');
                        const phoneInput = adultForm.querySelector('input[name^="adult_phone_"]');
                        const birthdateInput = adultForm.querySelector('input[name^="adult_birthdate_"]');

                        if (!nameInput || !nameInput.value.trim()) {
                            e.preventDefault();
                            alert('{% trans "Please fill in the name of all adults" %}');
                            nameInput.focus();
                            return false;
                        }
                        if (!emailInput || !emailInput.value.trim()) {
                            e.preventDefault();
                            alert('{% trans "Please fill in the email of all adults" %}');
                            emailInput.focus();
                            return false;
                        }
                        if (!phoneInput || !phoneInput.value.trim()) {
                            e.preventDefault();
                            alert('{% trans "Please fill in the phone of all adults" %}');
                            phoneInput.focus();
                            return false;
                        }
                        if (!birthdateInput || !birthdateInput.value) {
                            e.preventDefault();
                            alert('{% trans "Please fill in the date of birth of all adults" %}');
                            birthdateInput.focus();
                            return false;
                        }

                        // Validar que el adulto tenga al menos 18 años
                        const age = calculateAge(birthdateInput.value);
                        if (!age || age < 18) {
                            e.preventDefault();
                            alert('{% trans "All adults must be at least 18 years old" %}');
                            birthdateInput.focus();
                            return false;
                        }
                    }

                    // Obtener datos del primer adulto (huésped principal)
                    const firstAdultForm = adultsFormsContainer.querySelector('[data-adult-index="1"]');
                    if (firstAdultForm) {
                        const nameInput = firstAdultForm.querySelector('input[name^="adult_name_"]');
                        const emailInput = firstAdultForm.querySelector('input[name^="adult_email_"]');
                        const phoneInput = firstAdultForm.querySelector('input[name^="adult_phone_"]');

                        // Agregar campos hidden con los datos del huésped principal
                        const nameParam = document.createElement('input');
                        nameParam.type = 'hidden';
                        nameParam.name = 'guest_name';
                        nameParam.value = nameInput.value.trim();
                        form.appendChild(nameParam);

                        const emailParam = document.createElement('input');
                        emailParam.type = 'hidden';
                        emailParam.name = 'guest_email';
                        emailParam.value = emailInput.value.trim();
                        form.appendChild(emailParam);

                        const phoneParam = document.createElement('input');
                        phoneParam.type = 'hidden';
                        phoneParam.name = 'guest_phone';
                        phoneParam.value = phoneInput.value.trim();
                        form.appendChild(phoneParam);

                        // Calcular número total de huéspedes (adultos + niños)
                        const checkboxes = document.querySelectorAll('.child-checkbox:checked:not(:disabled)');
                        const children = checkboxes.length;
                        const totalGuests = adults + children;

                        const guestsParam = document.createElement('input');
                        guestsParam.type = 'hidden';
                        guestsParam.name = 'number_of_guests';
                        guestsParam.value = totalGuests;
                        form.appendChild(guestsParam);
                    }
                });
            }

            // Usar event delegation para los botones (funciona incluso si se agregan dinámicamente)
            if (modal) {
                // Event delegation en el modal para el botón de agregar adulto
                modal.addEventListener('click', function(e) {
                    if (e.target && (e.target.id === 'add-adult-btn{{ event.hotel.pk }}' || e.target.closest('#add-adult-btn{{ event.hotel.pk }}'))) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.addAdultForm{{ event.hotel.pk }} === 'function') {
                            window.addAdultForm{{ event.hotel.pk }}();
                        } else {
                            console.error('addAdultForm{{ event.hotel.pk }} is not defined');
                        }
                    }

                    if (e.target && (e.target.id === 'add-child-btn{{ event.hotel.pk }}' || e.target.closest('#add-child-btn{{ event.hotel.pk }}'))) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.addChildForm{{ event.hotel.pk }} === 'function') {
                            window.addChildForm{{ event.hotel.pk }}();
                        } else {
                            console.error('addChildForm{{ event.hotel.pk }} is not defined');
                        }
                    }
                });
            }
        })();
    </script>{% endcomment %}
