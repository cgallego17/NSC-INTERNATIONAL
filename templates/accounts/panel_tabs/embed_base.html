{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% trans "Panel Content" %}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Panel CSS (reutiliza estilos del panel para que el contenido se vea igual en el iframe) -->
    <link id="panel-usuario-css" href="{% static 'css/panel_usuario.css' %}" rel="stylesheet">
    <script>
        // Agregar parámetro de versión dinámico para evitar caché
        (function() {
            const link = document.getElementById('panel-usuario-css');
            if (link) {
                const now = new Date();
                const version = now.getFullYear().toString() +
                               String(now.getMonth() + 1).padStart(2, '0') +
                               String(now.getDate()).padStart(2, '0') +
                               String(now.getHours()).padStart(2, '0') +
                               String(now.getMinutes()).padStart(2, '0');
                link.href = link.href.split('?')[0] + '?v=' + version;
            }
        })();
    </script>

    <style>
        /* Evitar scroll doble dentro del iframe */
        html, body { height: auto; }
        body { margin: 0; background: transparent; overflow-x: hidden; }
        /* Si algún estilo externo aplica transform, puede romper position:fixed de Bootstrap dentro de iframe */
        html, body, .iframe-inner { transform: none !important; }
        /* Ajuste de padding dentro del iframe */
        .iframe-inner { padding: 0; }

        /* Modales dentro de iframe: reglas mínimas (Bootstrap maneja el layout) */
        .modal-backdrop {
            position: fixed !important;
            inset: 0 !important;
            z-index: 1040 !important;
            background-color: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(6px);
        }
        .modal {
            z-index: 1050 !important;
            /* Restaurar fixed ahora que el iframe es pantalla completa al abrir modal */
            position: fixed !important;
            inset: 0 !important;
            overflow-y: auto !important;
            display: none;
            /* Forzar que el flex de Bootstrap alinee arriba y no al centro */
            align-items: flex-start !important;
            padding-top: 20px !important;
        }
        .modal.show {
            display: flex !important; /* Bootstrap usa flex para centrar, lo usamos para alinear arriba */
        }

        /* Quitar el centrado vertical de Bootstrap para que carguen arriba */
        .modal-dialog {
            display: flex !important;
            align-items: flex-start !important;
            margin-top: 20px !important;
            margin-bottom: 20px !important;
            min-height: auto !important;
        }

        .modal-dialog::before {
            display: none !important; /* Quitar el spacer que usa Bootstrap para centrar */
        }

        /* Solo modales: asegurar que el contenido se vea completo y permita scroll */
        .modal .modal-content {
            max-height: none !important;
            overflow: visible !important;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5) !important;
            margin-bottom: 30px !important; /* Espacio al final para scroll */
        }
        .modal .modal-body {
            max-height: none !important;
            overflow: visible !important;
        }
    </style>
</head>
<body>
    <div class="iframe-inner">
        {% if inner_template %}
            {% include inner_template %}
        {% else %}
            <div class="p-4">
                <div class="alert alert-warning mb-0">{% trans "No content template provided." %}</div>
            </div>
        {% endif %}
    </div>

    <!-- Bootstrap 5 JS (solo para componentes dentro del tab embed) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Django JS i18n (gettext / ngettext) requerido por admin.js -->
    <script src="{% url 'javascript-catalog' %}"></script>
    <!-- Reutilizar el mismo JS del panel para funcionalidades (hotel reservation, etc.) dentro del iframe -->
    <script src="{% static 'js/admin.js' %}"></script>

    <script>
        (function () {
            // Si estamos dentro de un iframe del panel, enviar eventos al padre (por ejemplo: abrir detalle de evento)
            document.addEventListener('click', function (e) {
                var btn = e.target && e.target.closest ? e.target.closest('.detail-event-btn') : null;
                if (!btn) return;
                try {
                    var embedUrl = btn.getAttribute('data-embed-url');
                    var panelUrl = btn.getAttribute('href') || btn.getAttribute('data-event-url');
                    if (window.parent) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.parent.postMessage(
                            { type: 'nsc-open-event-detail', embedUrl: embedUrl, panelUrl: panelUrl },
                            window.location.origin
                        );
                    }
                } catch (err) {
                    // ignore
                }
            }, true);

            function postHeight() {
                try {
                    var tabId = window.name || null;
                    var height = Math.max(
                        document.body ? document.body.scrollHeight : 0,
                        document.documentElement ? document.documentElement.scrollHeight : 0
                    );
                    if (window.parent && tabId) {
                        window.parent.postMessage(
                            { type: 'nsc-iframe-height', tabId: tabId, height: height },
                            window.location.origin
                        );
                    }
                } catch (e) {
                    // ignore
                }
            }

            window.addEventListener('load', function () {
                postHeight();
                setTimeout(postHeight, 150);
                setTimeout(postHeight, 400);
            });

            // Si el contenido cambia dinámicamente, intentar reportar de nuevo
            var ro = null;
            try {
                ro = new ResizeObserver(function () { postHeight(); });
                ro.observe(document.body);
            } catch (e) {
                // ignore
            }
        })();
    </script>

    <script>
        // En iframe: mover modales a <body> para evitar problemas de posicionamiento/focus
        (function () {
            let modalCloseTimer = null;

            function isAnyModal(el) {
                if (!el) return false;
                return el.classList && el.classList.contains('modal');
            }

            function hoistModalsToBody() {
                try {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach((m) => {
                        if (m && m.parentElement !== document.body) {
                            document.body.appendChild(m);
                        }
                    });
                } catch (e) {
                    // ignore
                }
            }

            // Hoist ASAP
            hoistModalsToBody();
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hoistModalsToBody);
            }

            // Interceptar setAttribute para prevenir que se agregue aria-hidden a modales o elementos visibles
            const originalSetAttribute = Element.prototype.setAttribute;
            Element.prototype.setAttribute = function(name, value) {
                if (name === 'aria-hidden' && value === 'true') {
                    if (this.classList && (this.classList.contains('show') || this.querySelector('.show') || this.classList.contains('modal'))) {
                        return;
                    }
                }
                return originalSetAttribute.call(this, name, value);
            };

            // MutationObserver global para limpiar aria-hidden de cualquier elemento visible o con foco
            const globalAriaObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    const target = mutation.target;
                    if (target.getAttribute && target.getAttribute('aria-hidden') === 'true') {
                        if (target.classList && (target.classList.contains('show') || target.querySelector('.show') || target === document.activeElement || target.contains(document.activeElement))) {
                            target.removeAttribute('aria-hidden');
                            target.setAttribute('aria-modal', 'true');
                        }
                    }
                });
            });
            globalAriaObserver.observe(document.documentElement, {
                attributes: true,
                subtree: true,
                attributeFilter: ['aria-hidden']
            });

            // Limpieza periódica como último recurso
            setInterval(function() {
                const hiddenElements = document.querySelectorAll('.modal.show[aria-hidden="true"]');
                hiddenElements.forEach(el => {
                    el.removeAttribute('aria-hidden');
                    el.setAttribute('aria-modal', 'true');
                });
            }, 500);

            // Before opening any modal, hoist again and reset iframe scroll to avoid "appears far below"
            document.addEventListener('show.bs.modal', function (evt) {
                if (!isAnyModal(evt.target)) return;

                // Cancelar cualquier temporizador de cierre de modal (transición entre modales)
                if (modalCloseTimer) {
                    clearTimeout(modalCloseTimer);
                    modalCloseTimer = null;
                }

                hoistModalsToBody();

                // Notificar al padre que haga scroll hacia el inicio del iframe y aplique estado de modal
                if (window.parent) {
                    window.parent.postMessage({ type: 'nsc-scroll-to-top', tabId: window.name }, window.location.origin);
                    window.parent.postMessage({ type: 'nsc-modal-state', state: 'open' }, window.location.origin);
                }

                // Asegurar que otros modales tengan aria-hidden
                const allModals = document.querySelectorAll('.modal');
                allModals.forEach(m => {
                    if (m !== evt.target) {
                        m.setAttribute('aria-hidden', 'true');
                    }
                });
                // Remover aria-hidden del modal que se está abriendo
                evt.target.removeAttribute('aria-hidden');
                evt.target.setAttribute('aria-modal', 'true');
            });

            // After open, enforce top positioning if the dialog appears below viewport
            document.addEventListener('shown.bs.modal', function (evt) {
                if (!isAnyModal(evt.target)) return;
                try {
                    const modalEl = evt.target;

                    // Asegurar que el modal tenga el scroll al inicio
                    modalEl.scrollTop = 0;

                    const dlg = modalEl.querySelector('.modal-dialog');
                    if (dlg) {
                        // Forzar el scroll del elemento modal
                        modalEl.scrollTo(0, 0);
                        dlg.scrollIntoView({ block: 'start', behavior: 'instant' });
                    }

                    // Forzar el enfoque al primer input o al propio modal
                    const firstInput = modalEl.querySelector('input, select, textarea, button:not(.btn-close)');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 100);
                    } else {
                        modalEl.focus();
                    }
                } catch (e) {
                    // ignore
                }
            });

            // Cuando se cierra un modal, asegurar que tenga aria-hidden y quitar estado de modal en el padre
            document.addEventListener('hidden.bs.modal', function (evt) {
                if (!isAnyModal(evt.target)) return;

                // Usar un temporizador para manejar la transición entre un modal y otro
                if (modalCloseTimer) clearTimeout(modalCloseTimer);

                modalCloseTimer = setTimeout(function() {
                    const openModals = document.querySelectorAll('.modal.show');
                    if (window.parent && openModals.length === 0) {
                        window.parent.postMessage({ type: 'nsc-modal-state', state: 'closed' }, window.location.origin);
                    } else if (window.parent && openModals.length > 0) {
                        // Si todavía hay modales, asegurar que el padre mantenga el estado 'open'
                        window.parent.postMessage({ type: 'nsc-modal-state', state: 'open' }, window.location.origin);
                    }
                    modalCloseTimer = null;
                }, 250); // Un poco más de tiempo para cubrir la cadena de eventos de Bootstrap

                try {
                    evt.target.setAttribute('aria-hidden', 'true');
                    evt.target.removeAttribute('aria-modal');
                } catch (e) {
                    // ignore
                }
            });
        })();
    </script>
</body>
</html>


